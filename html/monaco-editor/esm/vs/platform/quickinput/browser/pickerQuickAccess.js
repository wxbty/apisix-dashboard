var __awaiter=this&&this.__awaiter||function(i,e,t,n){function s(i){return i instanceof t?i:new t((function(e){e(i)}))}return new(t||(t=Promise))((function(t,o){function c(i){try{a(n.next(i))}catch(e){o(e)}}function r(i){try{a(n["throw"](i))}catch(e){o(e)}}function a(i){i.done?t(i.value):s(i.value).then(c,r)}a((n=n.apply(i,e||[])).next())}))};import{timeout}from"../../../base/common/async.js";import{CancellationTokenSource}from"../../../base/common/cancellation.js";import{Disposable,DisposableStore,MutableDisposable}from"../../../base/common/lifecycle.js";export var TriggerAction;function isPicksWithActive(i){const e=i;return Array.isArray(e.items)}function isFastAndSlowPicks(i){const e=i;return!!e.picks&&e.additionalPicks instanceof Promise}(function(i){i[i["NO_ACTION"]=0]="NO_ACTION",i[i["CLOSE_PICKER"]=1]="CLOSE_PICKER",i[i["REFRESH_PICKER"]=2]="REFRESH_PICKER",i[i["REMOVE_ITEM"]=3]="REMOVE_ITEM"})(TriggerAction||(TriggerAction={}));export class PickerQuickAccessProvider extends Disposable{constructor(i,e){super(),this.prefix=i,this.options=e}provide(i,e){var t;const n=new DisposableStore;let s;i.canAcceptInBackground=!!(null===(t=this.options)||void 0===t?void 0:t.canAcceptInBackground),i.matchOnLabel=i.matchOnDescription=i.matchOnDetail=i.sortByLabel=!1;const o=n.add(new MutableDisposable),c=()=>__awaiter(this,void 0,void 0,(function*(){const t=o.value=new DisposableStore;null===s||void 0===s||s.dispose(!0),i.busy=!1,s=new CancellationTokenSource(e);const n=s.token,c=i.value.substr(this.prefix.length).trim(),r=this._getPicks(c,t,n),a=(e,t)=>{var n;let s,o;if(isPicksWithActive(e)?(s=e.items,o=e.active):s=e,0===s.length){if(t)return!1;c.length>0&&(null===(n=this.options)||void 0===n?void 0:n.noResultsPick)&&(s=[this.options.noResultsPick])}return i.items=s,o&&(i.activeItems=[o]),!0};if(null===r);else if(isFastAndSlowPicks(r)){let e=!1,t=!1;yield Promise.all([(()=>__awaiter(this,void 0,void 0,(function*(){yield timeout(PickerQuickAccessProvider.FAST_PICKS_RACE_DELAY),n.isCancellationRequested||t||(e=a(r.picks,!0))})))(),(()=>__awaiter(this,void 0,void 0,(function*(){i.busy=!0;try{const s=yield r.additionalPicks;if(n.isCancellationRequested)return;let o,c,l,u;if(isPicksWithActive(r.picks)?(o=r.picks.items,c=r.picks.active):o=r.picks,isPicksWithActive(s)?(l=s.items,u=s.active):l=s,l.length>0||!e){let e;if(!c&&!u){const t=i.activeItems[0];t&&-1!==o.indexOf(t)&&(e=t)}a({items:[...o,...l],active:c||u||e})}}finally{n.isCancellationRequested||(i.busy=!1),t=!0}})))()])}else if(r instanceof Promise){i.busy=!0;try{const e=yield r;if(n.isCancellationRequested)return;a(e)}finally{n.isCancellationRequested||(i.busy=!1)}}else a(r)}));return n.add(i.onDidChangeValue((()=>c()))),c(),n.add(i.onDidAccept((e=>{const[t]=i.selectedItems;"function"===typeof(null===t||void 0===t?void 0:t.accept)&&(e.inBackground||i.hide(),t.accept(i.keyMods,e))}))),n.add(i.onDidTriggerItemButton((({button:t,item:n})=>__awaiter(this,void 0,void 0,(function*(){var s,o;if("function"===typeof n.trigger){const r=null!==(o=null===(s=n.buttons)||void 0===s?void 0:s.indexOf(t))&&void 0!==o?o:-1;if(r>=0){const t=n.trigger(r,i.keyMods),s="number"===typeof t?t:yield t;if(e.isCancellationRequested)return;switch(s){case TriggerAction.NO_ACTION:break;case TriggerAction.CLOSE_PICKER:i.hide();break;case TriggerAction.REFRESH_PICKER:c();break;case TriggerAction.REMOVE_ITEM:{const e=i.items.indexOf(n);if(-1!==e){const t=i.items.slice(),n=t.splice(e,1),s=i.activeItems.filter((i=>i!==n[0])),o=i.keepScrollPosition;i.keepScrollPosition=!0,i.items=t,s&&(i.activeItems=s),i.keepScrollPosition=o}break}}}}}))))),n}}PickerQuickAccessProvider.FAST_PICKS_RACE_DELAY=200;