var __decorate=this&&this.__decorate||function(e,t,o,i){var r,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)n=Reflect.decorate(e,t,o,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(n=(s<3?r(n):s>3?r(t,o,n):r(t,o))||n);return s>3&&n&&Object.defineProperty(t,o,n),n},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}},__awaiter=this&&this.__awaiter||function(e,t,o,i){function r(e){return e instanceof o?e:new o((function(t){t(e)}))}return new(o||(o=Promise))((function(o,s){function n(e){try{c(i.next(e))}catch(t){s(t)}}function a(e){try{c(i["throw"](e))}catch(t){s(t)}}function c(e){e.done?o(e.value):r(e.value).then(n,a)}c((i=i.apply(e,t||[])).next())}))};import{toErrorMessage}from"../../../base/common/errorMessage.js";import{isCancellationError}from"../../../base/common/errors.js";import{matchesContiguousSubString,matchesPrefix,matchesWords,or}from"../../../base/common/filters.js";import{Disposable}from"../../../base/common/lifecycle.js";import{LRUCache}from"../../../base/common/map.js";import Severity from"../../../base/common/severity.js";import{withNullAsUndefined}from"../../../base/common/types.js";import{localize}from"../../../nls.js";import{ICommandService}from"../../commands/common/commands.js";import{IConfigurationService}from"../../configuration/common/configuration.js";import{IDialogService}from"../../dialogs/common/dialogs.js";import{IInstantiationService}from"../../instantiation/common/instantiation.js";import{IKeybindingService}from"../../keybinding/common/keybinding.js";import{PickerQuickAccessProvider}from"./pickerQuickAccess.js";import{IStorageService}from"../../storage/common/storage.js";import{ITelemetryService}from"../../telemetry/common/telemetry.js";let AbstractCommandsQuickAccessProvider=class e extends PickerQuickAccessProvider{constructor(t,o,i,r,s,n){super(e.PREFIX,t),this.instantiationService=o,this.keybindingService=i,this.commandService=r,this.telemetryService=s,this.dialogService=n,this.commandsHistory=this._register(this.instantiationService.createInstance(CommandsHistory)),this.options=t}_getPicks(t,o,i){return __awaiter(this,void 0,void 0,(function*(){const r=yield this.getCommandPicks(o,i);if(i.isCancellationRequested)return[];const s=[];for(const o of r){const i=withNullAsUndefined(e.WORD_FILTER(t,o.label)),r=o.commandAlias?withNullAsUndefined(e.WORD_FILTER(t,o.commandAlias)):void 0;i||r?(o.highlights={label:i,detail:this.options.showAlias?r:void 0},s.push(o)):t===o.commandId&&s.push(o)}const n=new Map;for(const e of s){const t=n.get(e.label);t?(e.description=e.commandId,t.description=t.commandId):n.set(e.label,e)}s.sort(((e,t)=>{const o=this.commandsHistory.peek(e.commandId),i=this.commandsHistory.peek(t.commandId);return o&&i?o>i?-1:1:o?-1:i?1:e.label.localeCompare(t.label)}));const a=[];let c=!1;for(let e=0;e<s.length;e++){const t=s[e],o=this.keybindingService.lookupKeybinding(t.commandId),i=o?localize("commandPickAriaLabelWithKeybinding","{0}, {1}",t.label,o.getAriaLabel()):t.label;0===e&&this.commandsHistory.peek(t.commandId)&&(a.push({type:"separator",label:localize("recentlyUsed","recently used")}),c=!0),0!==e&&c&&!this.commandsHistory.peek(t.commandId)&&(a.push({type:"separator",label:localize("morecCommands","other commands")}),c=!1),a.push(Object.assign(Object.assign({},t),{ariaLabel:i,detail:this.options.showAlias&&t.commandAlias!==t.label?t.commandAlias:void 0,keybinding:o,accept:()=>__awaiter(this,void 0,void 0,(function*(){this.commandsHistory.push(t.commandId),this.telemetryService.publicLog2("workbenchActionExecuted",{id:t.commandId,from:"quick open"});try{yield this.commandService.executeCommand(t.commandId)}catch(e){isCancellationError(e)||this.dialogService.show(Severity.Error,localize("canNotRun","Command '{0}' resulted in an error ({1})",t.label,toErrorMessage(e)))}}))}))}return a}))}};AbstractCommandsQuickAccessProvider.PREFIX=">",AbstractCommandsQuickAccessProvider.WORD_FILTER=or(matchesPrefix,matchesWords,matchesContiguousSubString),AbstractCommandsQuickAccessProvider=__decorate([__param(1,IInstantiationService),__param(2,IKeybindingService),__param(3,ICommandService),__param(4,ITelemetryService),__param(5,IDialogService)],AbstractCommandsQuickAccessProvider);export{AbstractCommandsQuickAccessProvider};let CommandsHistory=class e extends Disposable{constructor(e,t){super(),this.storageService=e,this.configurationService=t,this.configuredCommandsHistoryLength=0,this.updateConfiguration(),this.load(),this.registerListeners()}registerListeners(){this._register(this.configurationService.onDidChangeConfiguration((()=>this.updateConfiguration())))}updateConfiguration(){this.configuredCommandsHistoryLength=e.getConfiguredCommandHistoryLength(this.configurationService),e.cache&&e.cache.limit!==this.configuredCommandsHistoryLength&&(e.cache.limit=this.configuredCommandsHistoryLength,e.saveState(this.storageService))}load(){const t=this.storageService.get(e.PREF_KEY_CACHE,0);let o;if(t)try{o=JSON.parse(t)}catch(r){}const i=e.cache=new LRUCache(this.configuredCommandsHistoryLength,1);if(o){let e;e=o.usesLRU?o.entries:o.entries.sort(((e,t)=>e.value-t.value)),e.forEach((e=>i.set(e.key,e.value)))}e.counter=this.storageService.getNumber(e.PREF_KEY_COUNTER,0,e.counter)}push(t){e.cache&&(e.cache.set(t,e.counter++),e.saveState(this.storageService))}peek(t){var o;return null===(o=e.cache)||void 0===o?void 0:o.peek(t)}static saveState(t){if(!e.cache)return;const o={usesLRU:!0,entries:[]};e.cache.forEach(((e,t)=>o.entries.push({key:t,value:e}))),t.store(e.PREF_KEY_CACHE,JSON.stringify(o),0,0),t.store(e.PREF_KEY_COUNTER,e.counter,0,0)}static getConfiguredCommandHistoryLength(t){var o,i;const r=t.getValue(),s=null===(i=null===(o=r.workbench)||void 0===o?void 0:o.commandPalette)||void 0===i?void 0:i.history;return"number"===typeof s?s:e.DEFAULT_COMMANDS_HISTORY_LENGTH}};CommandsHistory.DEFAULT_COMMANDS_HISTORY_LENGTH=50,CommandsHistory.PREF_KEY_CACHE="commandPalette.mru.cache",CommandsHistory.PREF_KEY_COUNTER="commandPalette.mru.counter",CommandsHistory.counter=1,CommandsHistory=__decorate([__param(0,IStorageService),__param(1,IConfigurationService)],CommandsHistory);export{CommandsHistory};