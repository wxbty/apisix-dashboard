var __decorate=this&&this.__decorate||function(e,i,t,o){var r,s=arguments.length,c=s<3?i:null===o?o=Object.getOwnPropertyDescriptor(i,t):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)c=Reflect.decorate(e,i,t,o);else for(var n=e.length-1;n>=0;n--)(r=e[n])&&(c=(s<3?r(c):s>3?r(i,t,c):r(i,t))||c);return s>3&&c&&Object.defineProperty(i,t,c),c},__param=this&&this.__param||function(e,i){return function(t,o){i(t,o,e)}};import{DeferredPromise}from"../../../base/common/async.js";import{CancellationTokenSource}from"../../../base/common/cancellation.js";import{once}from"../../../base/common/functional.js";import{Disposable,DisposableStore,toDisposable}from"../../../base/common/lifecycle.js";import{IInstantiationService}from"../../instantiation/common/instantiation.js";import{DefaultQuickAccessFilterValue,Extensions}from"../common/quickAccess.js";import{IQuickInputService,ItemActivation}from"../common/quickInput.js";import{Registry}from"../../registry/common/platform.js";let QuickAccessController=class extends Disposable{constructor(e,i){super(),this.quickInputService=e,this.instantiationService=i,this.registry=Registry.as(Extensions.Quickaccess),this.mapProviderToDescriptor=new Map,this.lastAcceptedPickerValues=new Map,this.visibleQuickAccess=void 0}show(e="",i){this.doShowOrPick(e,!1,i)}doShowOrPick(e,i,t){var o;const[r,s]=this.getOrInstantiateProvider(e),c=this.visibleQuickAccess,n=null===c||void 0===c?void 0:c.descriptor;if(c&&s&&n===s)return e===s.prefix||(null===t||void 0===t?void 0:t.preserveValue)||(c.picker.value=e),void this.adjustValueSelection(c.picker,s,t);if(s&&!(null===t||void 0===t?void 0:t.preserveValue)){let i;if(c&&n&&n!==s){const e=c.value.substr(n.prefix.length);e&&(i=`${s.prefix}${e}`)}if(!i){const e=null===r||void 0===r?void 0:r.defaultFilterValue;e===DefaultQuickAccessFilterValue.LAST?i=this.lastAcceptedPickerValues.get(s):"string"===typeof e&&(i=`${s.prefix}${e}`)}"string"===typeof i&&(e=i)}const l=new DisposableStore,a=l.add(this.quickInputService.createQuickPick());let u;a.value=e,this.adjustValueSelection(a,s,t),a.placeholder=null===s||void 0===s?void 0:s.placeholder,a.quickNavigate=null===t||void 0===t?void 0:t.quickNavigateConfiguration,a.hideInput=!!a.quickNavigate&&!c,("number"===typeof(null===t||void 0===t?void 0:t.itemActivation)||(null===t||void 0===t?void 0:t.quickNavigateConfiguration))&&(a.itemActivation=null!==(o=null===t||void 0===t?void 0:t.itemActivation)&&void 0!==o?o:ItemActivation.SECOND),a.contextKey=null===s||void 0===s?void 0:s.contextKey,a.filterValue=e=>e.substring(s?s.prefix.length:0),(null===s||void 0===s?void 0:s.placeholder)&&(a.ariaLabel=null===s||void 0===s?void 0:s.placeholder),i&&(u=new DeferredPromise,l.add(once(a.onWillAccept)((e=>{e.veto(),a.hide()})))),l.add(this.registerPickerListeners(a,r,s,e));const d=l.add(new CancellationTokenSource);return r&&l.add(r.provide(a,d.token)),once(a.onDidHide)((()=>{0===a.selectedItems.length&&d.cancel(),l.dispose(),null===u||void 0===u||u.complete(a.selectedItems.slice(0))})),a.show(),i?null===u||void 0===u?void 0:u.p:void 0}adjustValueSelection(e,i,t){var o;let r;r=(null===t||void 0===t?void 0:t.preserveValue)?[e.value.length,e.value.length]:[null!==(o=null===i||void 0===i?void 0:i.prefix.length)&&void 0!==o?o:0,e.value.length],e.valueSelection=r}registerPickerListeners(e,i,t,o){const r=new DisposableStore,s=this.visibleQuickAccess={picker:e,descriptor:t,value:o};return r.add(toDisposable((()=>{s===this.visibleQuickAccess&&(this.visibleQuickAccess=void 0)}))),r.add(e.onDidChangeValue((e=>{const[t]=this.getOrInstantiateProvider(e);t!==i?this.show(e,{preserveValue:!0}):s.value=e}))),t&&r.add(e.onDidAccept((()=>{this.lastAcceptedPickerValues.set(t,e.value)}))),r}getOrInstantiateProvider(e){const i=this.registry.getQuickAccessProvider(e);if(!i)return[void 0,void 0];let t=this.mapProviderToDescriptor.get(i);return t||(t=this.instantiationService.createInstance(i.ctor),this.mapProviderToDescriptor.set(i,t)),[t,i]}};QuickAccessController=__decorate([__param(0,IQuickInputService),__param(1,IInstantiationService)],QuickAccessController);export{QuickAccessController};