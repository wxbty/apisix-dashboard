import{isFalsyOrEmpty}from"../../../base/common/arrays.js";import{DebounceEmitter}from"../../../base/common/event.js";import{Iterable}from"../../../base/common/iterator.js";import{ResourceMap}from"../../../base/common/map.js";import{Schemas}from"../../../base/common/network.js";import{URI}from"../../../base/common/uri.js";import{MarkerSeverity}from"./markers.js";class DoubleResourceMap{constructor(){this._byResource=new ResourceMap,this._byOwner=new Map}set(e,r,t){let s=this._byResource.get(e);s||(s=new Map,this._byResource.set(e,s)),s.set(r,t);let o=this._byOwner.get(r);o||(o=new ResourceMap,this._byOwner.set(r,o)),o.set(e,t)}get(e,r){let t=this._byResource.get(e);return null===t||void 0===t?void 0:t.get(r)}delete(e,r){let t=!1,s=!1,o=this._byResource.get(e);o&&(t=o.delete(r));let n=this._byOwner.get(r);if(n&&(s=n.delete(e)),t!==s)throw new Error("illegal state");return t&&s}values(e){var r,t,s,o;return"string"===typeof e?null!==(t=null===(r=this._byOwner.get(e))||void 0===r?void 0:r.values())&&void 0!==t?t:Iterable.empty():URI.isUri(e)?null!==(o=null===(s=this._byResource.get(e))||void 0===s?void 0:s.values())&&void 0!==o?o:Iterable.empty():Iterable.map(Iterable.concat(...this._byOwner.values()),(e=>e[1]))}}class MarkerStats{constructor(e){this.errors=0,this.infos=0,this.warnings=0,this.unknowns=0,this._data=new ResourceMap,this._service=e,this._subscription=e.onMarkerChanged(this._update,this)}dispose(){this._subscription.dispose()}_update(e){for(const r of e){const e=this._data.get(r);e&&this._substract(e);const t=this._resourceStats(r);this._add(t),this._data.set(r,t)}}_resourceStats(e){const r={errors:0,warnings:0,infos:0,unknowns:0};if(e.scheme===Schemas.inMemory||e.scheme===Schemas.walkThrough||e.scheme===Schemas.walkThroughSnippet)return r;for(const{severity:t}of this._service.read({resource:e}))t===MarkerSeverity.Error?r.errors+=1:t===MarkerSeverity.Warning?r.warnings+=1:t===MarkerSeverity.Info?r.infos+=1:r.unknowns+=1;return r}_substract(e){this.errors-=e.errors,this.warnings-=e.warnings,this.infos-=e.infos,this.unknowns-=e.unknowns}_add(e){this.errors+=e.errors,this.warnings+=e.warnings,this.infos+=e.infos,this.unknowns+=e.unknowns}}export class MarkerService{constructor(){this._onMarkerChanged=new DebounceEmitter({delay:0,merge:MarkerService._merge}),this.onMarkerChanged=this._onMarkerChanged.event,this._data=new DoubleResourceMap,this._stats=new MarkerStats(this)}dispose(){this._stats.dispose(),this._onMarkerChanged.dispose()}remove(e,r){for(const t of r||[])this.changeOne(e,t,[])}changeOne(e,r,t){if(isFalsyOrEmpty(t)){const t=this._data.delete(r,e);t&&this._onMarkerChanged.fire([r])}else{const s=[];for(const o of t){const t=MarkerService._toMarker(e,r,o);t&&s.push(t)}this._data.set(r,e,s),this._onMarkerChanged.fire([r])}}static _toMarker(e,r,t){let{code:s,severity:o,message:n,source:i,startLineNumber:a,startColumn:c,endLineNumber:u,endColumn:h,relatedInformation:l,tags:m}=t;if(n)return a=a>0?a:1,c=c>0?c:1,u=u>=a?u:a,h=h>0?h:c,{resource:r,owner:e,code:s,severity:o,message:n,source:i,startLineNumber:a,startColumn:c,endLineNumber:u,endColumn:h,relatedInformation:l,tags:m}}read(e=Object.create(null)){let{owner:r,resource:t,severities:s,take:o}=e;if((!o||o<0)&&(o=-1),r&&t){const e=this._data.get(t,r);if(e){const r=[];for(const t of e)if(MarkerService._accept(t,s)){const e=r.push(t);if(o>0&&e===o)break}return r}return[]}if(r||t){const e=this._data.values(null!==t&&void 0!==t?t:r),n=[];for(const r of e)for(const e of r)if(MarkerService._accept(e,s)){const r=n.push(e);if(o>0&&r===o)return n}return n}{const e=[];for(let r of this._data.values())for(let t of r)if(MarkerService._accept(t,s)){const r=e.push(t);if(o>0&&r===o)return e}return e}}static _accept(e,r){return void 0===r||(r&e.severity)===e.severity}static _merge(e){const r=new ResourceMap;for(let t of e)for(let e of t)r.set(e,!0);return Array.from(r.keys())}}