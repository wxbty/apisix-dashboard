var __decorate=this&&this.__decorate||function(e,t,i,n){var o,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var r=e.length-1;r>=0;r--)(o=e[r])&&(a=(s<3?o(a):s>3?o(t,i,a):o(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},__param=this&&this.__param||function(e,t){return function(i,n){t(i,n,e)}},__awaiter=this&&this.__awaiter||function(e,t,i,n){function o(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function a(e){try{c(n.next(e))}catch(t){s(t)}}function r(e){try{c(n["throw"](e))}catch(t){s(t)}}function c(e){e.done?i(e.value):o(e.value).then(a,r)}c((n=n.apply(e,t||[])).next())}))};import{$,addDisposableListener,append,asCSSUrl,EventType,ModifierKeyEmitter,prepend}from"../../../base/browser/dom.js";import{StandardKeyboardEvent}from"../../../base/browser/keyboardEvent.js";import{ActionViewItem,BaseActionViewItem}from"../../../base/browser/ui/actionbar/actionViewItems.js";import{DropdownMenuActionViewItem}from"../../../base/browser/ui/dropdown/dropdownActionViewItem.js";import{ActionRunner,Separator,SubmenuAction}from"../../../base/common/actions.js";import{UILabelProvider}from"../../../base/common/keybindingLabels.js";import{DisposableStore,MutableDisposable,toDisposable}from"../../../base/common/lifecycle.js";import{isLinux,isWindows,OS}from"../../../base/common/platform.js";import"./menuEntryActionViewItem.css";import{localize}from"../../../nls.js";import{IMenuService,MenuItemAction,SubmenuItemAction}from"../common/actions.js";import{IContextKeyService}from"../../contextkey/common/contextkey.js";import{IContextMenuService}from"../../contextview/browser/contextView.js";import{IInstantiationService}from"../../instantiation/common/instantiation.js";import{IKeybindingService}from"../../keybinding/common/keybinding.js";import{INotificationService}from"../../notification/common/notification.js";import{IStorageService}from"../../storage/common/storage.js";import{ThemeIcon}from"../../theme/common/themeService.js";export function createAndFillInActionBarActions(e,t,i,n,o,s,a){const r=e.getActions(t),c="string"===typeof n?e=>e===n:n;return fillInActions(r,i,!1,c,o,s,a),asDisposable(r)}function asDisposable(e){const t=new DisposableStore;for(const[,i]of e)for(const e of i)t.add(e);return t}function fillInActions(e,t,i,n=(e=>"navigation"===e),o=Number.MAX_SAFE_INTEGER,s=(()=>!1),a=!1){let r,c;Array.isArray(t)?(r=t,c=t):(r=t.primary,c=t.secondary);const l=new Set;for(const[m,d]of e){let e;n(m)?(e=r,e.length>0&&a&&e.push(new Separator)):(e=c,e.length>0&&e.push(new Separator));for(let t of d){i&&(t=t instanceof MenuItemAction&&t.alt?t.alt:t);const n=e.push(t);t instanceof SubmenuAction&&l.add({group:m,action:t,index:n-1})}}for(const{group:m,action:d,index:u}of l){const e=n(m)?r:c,t=d.actions;(t.length<=1||e.length+t.length-2<=o)&&s(d,m,e.length)&&e.splice(u,1,...t)}if(r!==c&&r.length>o){const e=r.splice(o,r.length-o);c.unshift(...e,new Separator)}}let MenuEntryActionViewItem=class extends ActionViewItem{constructor(e,t,i,n,o){super(void 0,e,{icon:!(!e.class&&!e.item.icon),label:!e.class&&!e.item.icon,draggable:null===t||void 0===t?void 0:t.draggable}),this._keybindingService=i,this._notificationService=n,this._contextKeyService=o,this._wantsAltCommand=!1,this._itemClassDispose=this._register(new MutableDisposable),this._altKey=ModifierKeyEmitter.getInstance()}get _menuItemAction(){return this._action}get _commandAction(){return this._wantsAltCommand&&this._menuItemAction.alt||this._menuItemAction}onClick(e){return __awaiter(this,void 0,void 0,(function*(){e.preventDefault(),e.stopPropagation();try{yield this.actionRunner.run(this._commandAction,this._context)}catch(t){this._notificationService.error(t)}}))}render(e){super.render(e),e.classList.add("menu-entry"),this._updateItemClass(this._menuItemAction.item);let t=!1,i=this._altKey.keyStatus.altKey||(isWindows||isLinux)&&this._altKey.keyStatus.shiftKey;const n=()=>{const e=t&&i;e!==this._wantsAltCommand&&(this._wantsAltCommand=e,this.updateLabel(),this.updateTooltip(),this.updateClass())};this._menuItemAction.alt&&this._register(this._altKey.event((e=>{i=e.altKey||(isWindows||isLinux)&&e.shiftKey,n()}))),this._register(addDisposableListener(e,"mouseleave",(e=>{t=!1,n()}))),this._register(addDisposableListener(e,"mouseenter",(e=>{t=!0,n()})))}updateLabel(){this.options.label&&this.label&&(this.label.textContent=this._commandAction.label)}updateTooltip(){if(this.label){const e=this._keybindingService.lookupKeybinding(this._commandAction.id,this._contextKeyService),t=e&&e.getLabel(),i=this._commandAction.tooltip||this._commandAction.label;let n=t?localize("titleAndKb","{0} ({1})",i,t):i;if(!this._wantsAltCommand&&this._menuItemAction.alt){const e=this._menuItemAction.alt.tooltip||this._menuItemAction.alt.label,t=this._keybindingService.lookupKeybinding(this._menuItemAction.alt.id,this._contextKeyService),i=t&&t.getLabel(),o=i?localize("titleAndKb","{0} ({1})",e,i):e;n+=`\n[${UILabelProvider.modifierLabels[OS].altKey}] ${o}`}this.label.title=n}}updateClass(){this.options.icon&&(this._commandAction!==this._menuItemAction?this._menuItemAction.alt&&this._updateItemClass(this._menuItemAction.alt.item):this._menuItemAction.alt&&this._updateItemClass(this._menuItemAction.item))}_updateItemClass(e){var t;this._itemClassDispose.value=void 0;const{element:i,label:n}=this;if(!i||!n)return;const o=this._commandAction.checked&&(null===(t=e.toggled)||void 0===t?void 0:t.icon)?e.toggled.icon:e.icon;if(o)if(ThemeIcon.isThemeIcon(o)){const e=ThemeIcon.asClassNameArray(o);n.classList.add(...e),this._itemClassDispose.value=toDisposable((()=>{n.classList.remove(...e)}))}else o.light&&n.style.setProperty("--menu-entry-icon-light",asCSSUrl(o.light)),o.dark&&n.style.setProperty("--menu-entry-icon-dark",asCSSUrl(o.dark)),n.classList.add("icon"),this._itemClassDispose.value=toDisposable((()=>{n.classList.remove("icon"),n.style.removeProperty("--menu-entry-icon-light"),n.style.removeProperty("--menu-entry-icon-dark")}))}};MenuEntryActionViewItem=__decorate([__param(2,IKeybindingService),__param(3,INotificationService),__param(4,IContextKeyService)],MenuEntryActionViewItem);export{MenuEntryActionViewItem};let SubmenuEntryActionViewItem=class extends DropdownMenuActionViewItem{constructor(e,t,i){var n,o;const s=Object.assign({},null!==t&&void 0!==t?t:Object.create(null),{menuAsChild:null!==(n=null===t||void 0===t?void 0:t.menuAsChild)&&void 0!==n&&n,classNames:null!==(o=null===t||void 0===t?void 0:t.classNames)&&void 0!==o?o:ThemeIcon.isThemeIcon(e.item.icon)?ThemeIcon.asClassName(e.item.icon):void 0});super(e,{getActions:()=>e.actions},i,s)}render(e){if(super.render(e),this.element){e.classList.add("menu-entry");const{icon:t}=this._action.item;t&&!ThemeIcon.isThemeIcon(t)&&(this.element.classList.add("icon"),t.light&&this.element.style.setProperty("--menu-entry-icon-light",asCSSUrl(t.light)),t.dark&&this.element.style.setProperty("--menu-entry-icon-dark",asCSSUrl(t.dark)))}}};SubmenuEntryActionViewItem=__decorate([__param(2,IContextMenuService)],SubmenuEntryActionViewItem);export{SubmenuEntryActionViewItem};let DropdownWithDefaultActionViewItem=class extends BaseActionViewItem{constructor(e,t,i,n,o,s,a,r){var c,l,m;let d;super(null,e),this._keybindingService=i,this._notificationService=n,this._contextMenuService=o,this._menuService=s,this._instaService=a,this._storageService=r,this._container=null,this._storageKey=`${e.item.submenu._debugName}_lastActionId`;let u=r.get(this._storageKey,1);u&&(d=e.actions.find((e=>u===e.id))),d||(d=e.actions[0]),this._defaultAction=this._instaService.createInstance(MenuEntryActionViewItem,d,void 0);const h=Object.assign({},null!==t&&void 0!==t?t:Object.create(null),{menuAsChild:null===(c=null===t||void 0===t?void 0:t.menuAsChild)||void 0===c||c,classNames:null!==(l=null===t||void 0===t?void 0:t.classNames)&&void 0!==l?l:["codicon","codicon-chevron-down"],actionRunner:null!==(m=null===t||void 0===t?void 0:t.actionRunner)&&void 0!==m?m:new ActionRunner});this._dropdown=new DropdownMenuActionViewItem(e,e.actions,this._contextMenuService,h),this._dropdown.actionRunner.onDidRun((e=>{e.action instanceof MenuItemAction&&this.update(e.action)}))}update(e){this._storageService.store(this._storageKey,e.id,1,0),this._defaultAction.dispose(),this._defaultAction=this._instaService.createInstance(MenuEntryActionViewItem,e,void 0),this._defaultAction.actionRunner=new class extends ActionRunner{runAction(e,t){return __awaiter(this,void 0,void 0,(function*(){yield e.run(void 0)}))}},this._container&&this._defaultAction.render(prepend(this._container,$(".action-container")))}setActionContext(e){super.setActionContext(e),this._defaultAction.setActionContext(e),this._dropdown.setActionContext(e)}render(e){this._container=e,super.render(this._container),this._container.classList.add("monaco-dropdown-with-default");const t=$(".action-container");this._defaultAction.render(append(this._container,t)),this._register(addDisposableListener(t,EventType.KEY_DOWN,(e=>{const t=new StandardKeyboardEvent(e);t.equals(17)&&(this._defaultAction.element.tabIndex=-1,this._dropdown.focus(),t.stopPropagation())})));const i=$(".dropdown-action-container");this._dropdown.render(append(this._container,i)),this._register(addDisposableListener(i,EventType.KEY_DOWN,(e=>{var t;const i=new StandardKeyboardEvent(e);i.equals(15)&&(this._defaultAction.element.tabIndex=0,this._dropdown.setFocusable(!1),null===(t=this._defaultAction.element)||void 0===t||t.focus(),i.stopPropagation())})))}focus(e){e?this._dropdown.focus():(this._defaultAction.element.tabIndex=0,this._defaultAction.element.focus())}blur(){this._defaultAction.element.tabIndex=-1,this._dropdown.blur(),this._container.blur()}setFocusable(e){e?this._defaultAction.element.tabIndex=0:(this._defaultAction.element.tabIndex=-1,this._dropdown.setFocusable(!1))}dispose(){this._defaultAction.dispose(),this._dropdown.dispose(),super.dispose()}};DropdownWithDefaultActionViewItem=__decorate([__param(2,IKeybindingService),__param(3,INotificationService),__param(4,IContextMenuService),__param(5,IMenuService),__param(6,IInstantiationService),__param(7,IStorageService)],DropdownWithDefaultActionViewItem);export function createActionViewItem(e,t,i){return t instanceof MenuItemAction?e.createInstance(MenuEntryActionViewItem,t,void 0):t instanceof SubmenuItemAction?t.item.rememberDefaultAction?e.createInstance(DropdownWithDefaultActionViewItem,t,i):e.createInstance(SubmenuEntryActionViewItem,t,i):void 0}