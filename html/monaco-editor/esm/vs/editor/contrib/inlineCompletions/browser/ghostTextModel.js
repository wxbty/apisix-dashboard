var __decorate=this&&this.__decorate||function(e,t,i,o){var n,s=arguments.length,r=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var l=e.length-1;l>=0;l--)(n=e[l])&&(r=(s<3?n(r):s>3?n(t,i,r):n(t,i))||r);return s>3&&r&&Object.defineProperty(t,i,r),r},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}},__awaiter=this&&this.__awaiter||function(e,t,i,o){function n(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function r(e){try{a(o.next(e))}catch(t){s(t)}}function l(e){try{a(o["throw"](e))}catch(t){s(t)}}function a(e){e.done?i(e.value):n(e.value).then(r,l)}a((o=o.apply(e,t||[])).next())}))};import{Emitter}from"../../../../base/common/event.js";import{Disposable,MutableDisposable}from"../../../../base/common/lifecycle.js";import{Position}from"../../../common/core/position.js";import{InlineCompletionTriggerKind}from"../../../common/languages.js";import{ILanguageConfigurationService}from"../../../common/languages/languageConfigurationRegistry.js";import{InlineCompletionsModel,SynchronizedInlineCompletionsCache}from"./inlineCompletionsModel.js";import{SuggestWidgetPreviewModel}from"./suggestWidgetPreviewModel.js";import{createDisposableRef}from"./utils.js";import{ICommandService}from"../../../../platform/commands/common/commands.js";export class DelegatingModel extends Disposable{constructor(){super(...arguments),this.onDidChangeEmitter=new Emitter,this.onDidChange=this.onDidChangeEmitter.event,this.hasCachedGhostText=!1,this.currentModelRef=this._register(new MutableDisposable)}get targetModel(){var e;return null===(e=this.currentModelRef.value)||void 0===e?void 0:e.object}setTargetModel(e){var t;(null===(t=this.currentModelRef.value)||void 0===t?void 0:t.object)!==e&&(this.currentModelRef.clear(),this.currentModelRef.value=e?createDisposableRef(e,e.onDidChange((()=>{this.hasCachedGhostText=!1,this.onDidChangeEmitter.fire()}))):void 0,this.hasCachedGhostText=!1,this.onDidChangeEmitter.fire())}get ghostText(){var e,t;return this.hasCachedGhostText||(this.cachedGhostText=null===(t=null===(e=this.currentModelRef.value)||void 0===e?void 0:e.object)||void 0===t?void 0:t.ghostText,this.hasCachedGhostText=!0),this.cachedGhostText}setExpanded(e){var t;null===(t=this.targetModel)||void 0===t||t.setExpanded(e)}get minReservedLineCount(){return this.targetModel?this.targetModel.minReservedLineCount:0}}let GhostTextModel=class extends DelegatingModel{constructor(e,t,i){super(),this.editor=e,this.commandService=t,this.languageConfigurationService=i,this.sharedCache=this._register(new SharedInlineCompletionCache),this.suggestWidgetAdapterModel=this._register(new SuggestWidgetPreviewModel(this.editor,this.sharedCache)),this.inlineCompletionsModel=this._register(new InlineCompletionsModel(this.editor,this.sharedCache,this.commandService,this.languageConfigurationService)),this._register(this.suggestWidgetAdapterModel.onDidChange((()=>{this.updateModel()}))),this.updateModel()}get activeInlineCompletionsModel(){if(this.targetModel===this.inlineCompletionsModel)return this.inlineCompletionsModel}updateModel(){this.setTargetModel(this.suggestWidgetAdapterModel.isActive?this.suggestWidgetAdapterModel:this.inlineCompletionsModel),this.inlineCompletionsModel.setActive(this.targetModel===this.inlineCompletionsModel)}shouldShowHoverAt(e){var t;const i=null===(t=this.activeInlineCompletionsModel)||void 0===t?void 0:t.ghostText;return!!i&&i.parts.some((t=>e.containsPosition(new Position(i.lineNumber,t.column))))}triggerInlineCompletion(){var e;null===(e=this.activeInlineCompletionsModel)||void 0===e||e.trigger(InlineCompletionTriggerKind.Explicit)}commitInlineCompletion(){var e;null===(e=this.activeInlineCompletionsModel)||void 0===e||e.commitCurrentSuggestion()}hideInlineCompletion(){var e;null===(e=this.activeInlineCompletionsModel)||void 0===e||e.hide()}showNextInlineCompletion(){var e;null===(e=this.activeInlineCompletionsModel)||void 0===e||e.showNext()}showPreviousInlineCompletion(){var e;null===(e=this.activeInlineCompletionsModel)||void 0===e||e.showPrevious()}hasMultipleInlineCompletions(){var e;return __awaiter(this,void 0,void 0,(function*(){const t=yield null===(e=this.activeInlineCompletionsModel)||void 0===e?void 0:e.hasMultipleInlineCompletions();return void 0!==t&&t}))}};GhostTextModel=__decorate([__param(1,ICommandService),__param(2,ILanguageConfigurationService)],GhostTextModel);export{GhostTextModel};export class SharedInlineCompletionCache extends Disposable{constructor(){super(...arguments),this.onDidChangeEmitter=new Emitter,this.onDidChange=this.onDidChangeEmitter.event,this.cache=this._register(new MutableDisposable)}get value(){return this.cache.value}setValue(e,t,i){this.cache.value=new SynchronizedInlineCompletionsCache(e,t,(()=>this.onDidChangeEmitter.fire()),i)}clearAndLeak(){return this.cache.clearAndLeak()}clear(){this.cache.clear()}}