var __awaiter=this&&this.__awaiter||function(e,t,i,n){function o(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function r(e){try{d(n.next(e))}catch(t){s(t)}}function l(e){try{d(n["throw"](e))}catch(t){s(t)}}function d(e){e.done?i(e.value):o(e.value).then(r,l)}d((n=n.apply(e,t||[])).next())}))};import{createCancelablePromise,RunOnceScheduler}from"../../../../base/common/async.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{MutableDisposable,toDisposable}from"../../../../base/common/lifecycle.js";import{InlineCompletionTriggerKind}from"../../../common/languages.js";import{BaseGhostTextWidgetModel,GhostText}from"./ghostText.js";import{minimizeInlineCompletion,provideInlineCompletions,UpdateOperation}from"./inlineCompletionsModel.js";import{inlineCompletionToGhostText}from"./inlineCompletionToGhostText.js";import{SuggestWidgetInlineCompletionProvider}from"./suggestWidgetInlineCompletionProvider.js";export class SuggestWidgetPreviewModel extends BaseGhostTextWidgetModel{constructor(e,t){super(e),this.cache=t,this.suggestionInlineCompletionSource=this._register(new SuggestWidgetInlineCompletionProvider(this.editor,(()=>{var e,t;return null===(t=null===(e=this.cache.value)||void 0===e?void 0:e.completions[0])||void 0===t?void 0:t.toLiveInlineCompletion()}))),this.updateOperation=this._register(new MutableDisposable),this.updateCacheSoon=this._register(new RunOnceScheduler((()=>this.updateCache()),50)),this.minReservedLineCount=0,this._register(this.suggestionInlineCompletionSource.onDidChange((()=>{this.updateCacheSoon.schedule();const e=this.suggestionInlineCompletionSource.state;e||(this.minReservedLineCount=0);const t=this.ghostText;t&&(this.minReservedLineCount=Math.max(this.minReservedLineCount,sum(t.parts.map((e=>e.lines.length-1))))),this.minReservedLineCount>=1?this.suggestionInlineCompletionSource.forceRenderingAbove():this.suggestionInlineCompletionSource.stopForceRenderingAbove(),this.onDidChangeEmitter.fire()}))),this._register(this.cache.onDidChange((()=>{this.onDidChangeEmitter.fire()}))),this._register(this.editor.onDidChangeCursorPosition((e=>{this.minReservedLineCount=0,this.updateCacheSoon.schedule(),this.onDidChangeEmitter.fire()}))),this._register(toDisposable((()=>this.suggestionInlineCompletionSource.stopForceRenderingAbove())))}get isActive(){return void 0!==this.suggestionInlineCompletionSource.state}isSuggestionPreviewEnabled(){const e=this.editor.getOption(106);return e.preview}updateCache(){return __awaiter(this,void 0,void 0,(function*(){const e=this.suggestionInlineCompletionSource.state;if(!e||!e.selectedItem)return;const t={text:e.selectedItem.normalizedInlineCompletion.text,range:e.selectedItem.normalizedInlineCompletion.range,isSnippetText:e.selectedItem.isSnippetText,completionKind:e.selectedItem.completionItemKind},i=this.editor.getPosition(),n=createCancelablePromise((e=>__awaiter(this,void 0,void 0,(function*(){let n;try{n=yield provideInlineCompletions(i,this.editor.getModel(),{triggerKind:InlineCompletionTriggerKind.Automatic,selectedSuggestionInfo:t},e)}catch(o){return void onUnexpectedError(o)}e.isCancellationRequested||(this.cache.setValue(this.editor,n,InlineCompletionTriggerKind.Automatic),this.onDidChangeEmitter.fire())})))),o=new UpdateOperation(n,InlineCompletionTriggerKind.Automatic);this.updateOperation.value=o,yield n,this.updateOperation.value===o&&this.updateOperation.clear()}))}get ghostText(){var e,t,i;const n=this.isSuggestionPreviewEnabled(),o=minimizeInlineCompletion(this.editor.getModel(),null===(t=null===(e=this.cache.value)||void 0===e?void 0:e.completions[0])||void 0===t?void 0:t.toLiveInlineCompletion()),s=this.suggestionInlineCompletionSource.state,r=minimizeInlineCompletion(this.editor.getModel(),null===(i=null===s||void 0===s?void 0:s.selectedItem)||void 0===i?void 0:i.normalizedInlineCompletion),l=o&&r&&o.text.startsWith(r.text)&&o.range.equalsRange(r.range);if(!n&&!l)return;const d=l?o:r||o,a=l?d.text.length-r.text.length:0,h=this.toGhostText(d,a);return h}toGhostText(e,t){const i=this.editor.getOptions().get(106).previewMode;return e?inlineCompletionToGhostText(e,this.editor.getModel(),i,this.editor.getPosition(),t)||new GhostText(e.range.endLineNumber,[],this.minReservedLineCount):void 0}}function sum(e){return e.reduce(((e,t)=>e+t),0)}