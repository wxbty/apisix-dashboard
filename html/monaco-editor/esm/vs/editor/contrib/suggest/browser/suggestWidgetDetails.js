var __decorate=this&&this.__decorate||function(t,e,i,o){var s,d=arguments.length,n=d<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)n=Reflect.decorate(t,e,i,o);else for(var h=t.length-1;h>=0;h--)(s=t[h])&&(n=(d<3?s(n):d>3?s(e,i,n):s(e,i))||n);return d>3&&n&&Object.defineProperty(e,i,n),n},__param=this&&this.__param||function(t,e){return function(i,o){e(i,o,t)}};import{isSafari}from"../../../../base/browser/browser.js";import*as dom from"../../../../base/browser/dom.js";import{DomScrollableElement}from"../../../../base/browser/ui/scrollbar/scrollableElement.js";import{Codicon}from"../../../../base/common/codicons.js";import{Emitter}from"../../../../base/common/event.js";import{MarkdownString}from"../../../../base/common/htmlContent.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{MarkdownRenderer}from"../../markdownRenderer/browser/markdownRenderer.js";import{EDITOR_FONT_DEFAULTS}from"../../../common/config/editorOptions.js";import{ResizableHTMLElement}from"./resizable.js";import*as nls from"../../../../nls.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";export function canExpandCompletionItem(t){return!!t&&Boolean(t.completion.documentation||t.completion.detail&&t.completion.detail!==t.completion.label)}let SuggestDetailsWidget=class{constructor(t,e){this._editor=t,this._onDidClose=new Emitter,this.onDidClose=this._onDidClose.event,this._onDidChangeContents=new Emitter,this.onDidChangeContents=this._onDidChangeContents.event,this._disposables=new DisposableStore,this._renderDisposeable=new DisposableStore,this._borderWidth=1,this._size=new dom.Dimension(330,0),this.domNode=dom.$(".suggest-details"),this.domNode.classList.add("no-docs"),this._markdownRenderer=e.createInstance(MarkdownRenderer,{editor:t}),this._body=dom.$(".body"),this._scrollbar=new DomScrollableElement(this._body,{}),dom.append(this.domNode,this._scrollbar.getDomNode()),this._disposables.add(this._scrollbar),this._header=dom.append(this._body,dom.$(".header")),this._close=dom.append(this._header,dom.$("span"+Codicon.close.cssSelector)),this._close.title=nls.localize("details.close","Close"),this._type=dom.append(this._header,dom.$("p.type")),this._docs=dom.append(this._body,dom.$("p.docs")),this._configureFont(),this._disposables.add(this._editor.onDidChangeConfiguration((t=>{t.hasChanged(44)&&this._configureFont()})))}dispose(){this._disposables.dispose(),this._renderDisposeable.dispose()}_configureFont(){const t=this._editor.getOptions(),e=t.get(44),i=e.getMassagedFontFamily(isSafari?EDITOR_FONT_DEFAULTS.fontFamily:null),o=t.get(107)||e.fontSize,s=t.get(108)||e.lineHeight,d=e.fontWeight,n=`${o}px`,h=`${s}px`;this.domNode.style.fontSize=n,this.domNode.style.lineHeight=""+s/o,this.domNode.style.fontWeight=d,this.domNode.style.fontFeatureSettings=e.fontFeatureSettings,this._type.style.fontFamily=i,this._close.style.height=h,this._close.style.width=h}getLayoutInfo(){const t=this._editor.getOption(108)||this._editor.getOption(44).lineHeight,e=this._borderWidth,i=2*e;return{lineHeight:t,borderWidth:e,borderHeight:i,verticalPadding:22,horizontalPadding:14}}renderLoading(){this._type.textContent=nls.localize("loading","Loading..."),this._docs.textContent="",this.domNode.classList.remove("no-docs","no-type"),this.layout(this.size.width,2*this.getLayoutInfo().lineHeight),this._onDidChangeContents.fire(this)}renderItem(t,e){var i,o;this._renderDisposeable.clear();let{detail:s,documentation:d}=t.completion;if(e){let e="";e+=`score: ${t.score[0]}\n`,e+=`prefix: ${null!==(i=t.word)&&void 0!==i?i:"(no prefix)"}\n`,e+=`word: ${t.completion.filterText?t.completion.filterText+" (filterText)":t.textLabel}\n`,e+=`distance: ${t.distance} (localityBonus-setting)\n`,e+=`index: ${t.idx}, based on ${t.completion.sortText&&`sortText: "${t.completion.sortText}"`||"label"}\n`,e+=`commit_chars: ${null===(o=t.completion.commitCharacters)||void 0===o?void 0:o.join("")}\n`,d=(new MarkdownString).appendCodeblock("empty",e),s=`Provider: ${t.provider._debugDisplayName}`}if(e||canExpandCompletionItem(t)){if(this.domNode.classList.remove("no-docs","no-type"),s){const t=s.length>1e5?`${s.substr(0,1e5)}\u2026`:s;this._type.textContent=t,this._type.title=t,dom.show(this._type),this._type.classList.toggle("auto-wrap",!/\r?\n^\s+/gim.test(t))}else dom.clearNode(this._type),this._type.title="",dom.hide(this._type),this.domNode.classList.add("no-type");if(dom.clearNode(this._docs),"string"===typeof d)this._docs.classList.remove("markdown-docs"),this._docs.textContent=d;else if(d){this._docs.classList.add("markdown-docs"),dom.clearNode(this._docs);const t=this._markdownRenderer.render(d);this._docs.appendChild(t.element),this._renderDisposeable.add(t),this._renderDisposeable.add(this._markdownRenderer.onDidRenderAsync((()=>{this.layout(this._size.width,this._type.clientHeight+this._docs.clientHeight),this._onDidChangeContents.fire(this)})))}this.domNode.style.userSelect="text",this.domNode.tabIndex=-1,this._close.onmousedown=t=>{t.preventDefault(),t.stopPropagation()},this._close.onclick=t=>{t.preventDefault(),t.stopPropagation(),this._onDidClose.fire()},this._body.scrollTop=0,this.layout(this._size.width,this._type.clientHeight+this._docs.clientHeight),this._onDidChangeContents.fire(this)}else this.clearContents()}clearContents(){this.domNode.classList.add("no-docs"),this._type.textContent="",this._docs.textContent=""}get size(){return this._size}layout(t,e){const i=new dom.Dimension(t,e);dom.Dimension.equals(i,this._size)||(this._size=i,dom.size(this.domNode,t,e)),this._scrollbar.scanDomNode()}scrollDown(t=8){this._body.scrollTop+=t}scrollUp(t=8){this._body.scrollTop-=t}scrollTop(){this._body.scrollTop=0}scrollBottom(){this._body.scrollTop=this._body.scrollHeight}pageDown(){this.scrollDown(80)}pageUp(){this.scrollUp(80)}set borderWidth(t){this._borderWidth=t}get borderWidth(){return this._borderWidth}};SuggestDetailsWidget=__decorate([__param(1,IInstantiationService)],SuggestDetailsWidget);export{SuggestDetailsWidget};export class SuggestDetailsOverlay{constructor(t,e){let i,o;this.widget=t,this._editor=e,this._disposables=new DisposableStore,this._added=!1,this._preferAlignAtTop=!0,this._resizable=new ResizableHTMLElement,this._resizable.domNode.classList.add("suggest-details-container"),this._resizable.domNode.appendChild(t.domNode),this._resizable.enableSashes(!1,!0,!0,!1);let s=0,d=0;this._disposables.add(this._resizable.onDidWillResize((()=>{i=this._topLeft,o=this._resizable.size}))),this._disposables.add(this._resizable.onDidResize((t=>{if(i&&o){this.widget.layout(t.dimension.width,t.dimension.height);let e=!1;t.west&&(d=o.width-t.dimension.width,e=!0),t.north&&(s=o.height-t.dimension.height,e=!0),e&&this._applyTopLeft({top:i.top+s,left:i.left+d})}t.done&&(i=void 0,o=void 0,s=0,d=0,this._userSize=t.dimension)}))),this._disposables.add(this.widget.onDidChangeContents((()=>{var t;this._anchorBox&&this._placeAtAnchor(this._anchorBox,null!==(t=this._userSize)&&void 0!==t?t:this.widget.size,this._preferAlignAtTop)})))}dispose(){this._resizable.dispose(),this._disposables.dispose(),this.hide()}getId(){return"suggest.details"}getDomNode(){return this._resizable.domNode}getPosition(){return null}show(){this._added||(this._editor.addOverlayWidget(this),this.getDomNode().style.position="fixed",this._added=!0)}hide(t=!1){this._resizable.clearSashHoverState(),this._added&&(this._editor.removeOverlayWidget(this),this._added=!1,this._anchorBox=void 0,this._topLeft=void 0),t&&(this._userSize=void 0,this.widget.clearContents())}placeAtAnchor(t,e){var i;const o=t.getBoundingClientRect();this._anchorBox=o,this._preferAlignAtTop=e,this._placeAtAnchor(this._anchorBox,null!==(i=this._userSize)&&void 0!==i?i:this.widget.size,e)}_placeAtAnchor(t,e,i){var o;const s=dom.getClientArea(document.body),d=this.widget.getLayoutInfo(),n=new dom.Dimension(220,2*d.lineHeight),h=t.top,r=function(){const i=s.width-(t.left+t.width+d.borderWidth+d.horizontalPadding),o=-d.borderWidth+t.left+t.width,r=new dom.Dimension(i,s.height-t.top-d.borderHeight-d.verticalPadding),a=r.with(void 0,t.top+t.height-d.borderHeight-d.verticalPadding);return{top:h,left:o,fit:i-e.width,maxSizeTop:r,maxSizeBottom:a,minSize:n.with(Math.min(i,n.width))}}(),a=function(){const i=t.left-d.borderWidth-d.horizontalPadding,o=Math.max(d.horizontalPadding,t.left-e.width-d.borderWidth),r=new dom.Dimension(i,s.height-t.top-d.borderHeight-d.verticalPadding),a=r.with(void 0,t.top+t.height-d.borderHeight-d.verticalPadding);return{top:h,left:o,fit:i-e.width,maxSizeTop:r,maxSizeBottom:a,minSize:n.with(Math.min(i,n.width))}}(),l=function(){const i=t.left,o=-d.borderWidth+t.top+t.height,h=new dom.Dimension(t.width-d.borderHeight,s.height-t.top-t.height-d.verticalPadding);return{top:o,left:i,fit:h.height-e.height,maxSizeBottom:h,maxSizeTop:h,minSize:n.with(h.width)}}(),m=[r,a,l],p=null!==(o=m.find((t=>t.fit>=0)))&&void 0!==o?o:m.sort(((t,e)=>e.fit-t.fit))[0],c=t.top+t.height-d.borderHeight;let _,g=e.height;const b=Math.max(p.maxSizeTop.height,p.maxSizeBottom.height);let f;g>b&&(g=b),i?g<=p.maxSizeTop.height?(_=!0,f=p.maxSizeTop):(_=!1,f=p.maxSizeBottom):g<=p.maxSizeBottom.height?(_=!1,f=p.maxSizeBottom):(_=!0,f=p.maxSizeTop),this._applyTopLeft({left:p.left,top:_?p.top:c-g}),this.getDomNode().style.position="fixed",this._resizable.enableSashes(!_,p===r,_,p!==r),this._resizable.minSize=p.minSize,this._resizable.maxSize=f,this._resizable.layout(g,Math.min(f.width,e.width)),this.widget.layout(this._resizable.size.width,this._resizable.size.height)}_applyTopLeft(t){this._topLeft=t,this.getDomNode().style.left=`${this._topLeft.left}px`,this.getDomNode().style.top=`${this._topLeft.top}px`}}