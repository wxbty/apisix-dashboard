var __decorate=this&&this.__decorate||function(e,t,r,o){var s,i=arguments.length,n=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)n=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(n=(i<3?s(n):i>3?s(t,r,n):s(t,r))||n);return i>3&&n&&Object.defineProperty(t,r,n),n},__param=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};import{RunOnceScheduler}from"../../../../base/common/async.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{LRUCache,TernarySearchTree}from"../../../../base/common/map.js";import{CompletionItemKinds}from"../../../common/languages.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";import{registerSingleton}from"../../../../platform/instantiation/common/extensions.js";import{createDecorator}from"../../../../platform/instantiation/common/instantiation.js";import{IStorageService,WillSaveStateReason}from"../../../../platform/storage/common/storage.js";export class Memory{constructor(e){this.name=e}select(e,t,r){if(0===r.length)return 0;let o=r[0].score[0];for(let s=0;s<r.length;s++){const{score:e,completion:t}=r[s];if(e[0]!==o)break;if(t.preselect)return s}return 0}}export class NoMemory extends Memory{constructor(){super("first")}memorize(e,t,r){}toJSON(){}fromJSON(){}}export class LRUMemory extends Memory{constructor(){super("recentlyUsed"),this._cache=new LRUCache(300,.66),this._seq=0}memorize(e,t,r){const o=`${e.getLanguageId()}/${r.textLabel}`;this._cache.set(o,{touch:this._seq++,type:r.completion.kind,insertText:r.completion.insertText})}select(e,t,r){if(0===r.length)return 0;const o=e.getLineContent(t.lineNumber).substr(t.column-10,t.column-1);if(/\s$/.test(o))return super.select(e,t,r);let s=r[0].score[0],i=-1,n=-1,c=-1;for(let a=0;a<r.length;a++){if(r[a].score[0]!==s)break;const t=`${e.getLanguageId()}/${r[a].textLabel}`,o=this._cache.peek(t);if(o&&o.touch>c&&o.type===r[a].completion.kind&&o.insertText===r[a].completion.insertText&&(c=o.touch,n=a),r[a].completion.preselect&&-1===i)return a}return-1!==n?n:-1!==i?i:0}toJSON(){return this._cache.toJSON()}fromJSON(e){this._cache.clear();let t=0;for(const[r,o]of e)o.touch=t,o.type="number"===typeof o.type?o.type:CompletionItemKinds.fromString(o.type),this._cache.set(r,o);this._seq=this._cache.size}}export class PrefixMemory extends Memory{constructor(){super("recentlyUsedByPrefix"),this._trie=TernarySearchTree.forStrings(),this._seq=0}memorize(e,t,r){const{word:o}=e.getWordUntilPosition(t),s=`${e.getLanguageId()}/${o}`;this._trie.set(s,{type:r.completion.kind,insertText:r.completion.insertText,touch:this._seq++})}select(e,t,r){let{word:o}=e.getWordUntilPosition(t);if(!o)return super.select(e,t,r);let s=`${e.getLanguageId()}/${o}`,i=this._trie.get(s);if(i||(i=this._trie.findSubstr(s)),i)for(let n=0;n<r.length;n++){let{kind:e,insertText:t}=r[n].completion;if(e===i.type&&t===i.insertText)return n}return super.select(e,t,r)}toJSON(){let e=[];return this._trie.forEach(((t,r)=>e.push([r,t]))),e.sort(((e,t)=>-(e[1].touch-t[1].touch))).forEach(((e,t)=>e[1].touch=t)),e.slice(0,200)}fromJSON(e){if(this._trie.clear(),e.length>0){this._seq=e[0][1].touch+1;for(const[t,r]of e)r.type="number"===typeof r.type?r.type:CompletionItemKinds.fromString(r.type),this._trie.set(t,r)}}}let SuggestMemoryService=class e{constructor(e,t){this._storageService=e,this._configService=t,this._disposables=new DisposableStore,this._persistSoon=new RunOnceScheduler((()=>this._saveState()),500),this._disposables.add(e.onWillSaveState((e=>{e.reason===WillSaveStateReason.SHUTDOWN&&this._saveState()})))}dispose(){this._disposables.dispose(),this._persistSoon.dispose()}memorize(e,t,r){this._withStrategy(e,t).memorize(e,t,r),this._persistSoon.schedule()}select(e,t,r){return this._withStrategy(e,t).select(e,t,r)}_withStrategy(t,r){var o;const s=this._configService.getValue("editor.suggestSelection",{overrideIdentifier:t.getLanguageIdAtPosition(r.lineNumber,r.column),resource:t.uri});if((null===(o=this._strategy)||void 0===o?void 0:o.name)!==s){this._saveState();const t=e._strategyCtors.get(s)||NoMemory;this._strategy=new t;try{const t=this._configService.getValue("editor.suggest.shareSuggestSelections"),r=t?0:1,o=this._storageService.get(`${e._storagePrefix}/${s}`,r);o&&this._strategy.fromJSON(JSON.parse(o))}catch(i){}}return this._strategy}_saveState(){if(this._strategy){const t=this._configService.getValue("editor.suggest.shareSuggestSelections"),r=t?0:1,o=JSON.stringify(this._strategy);this._storageService.store(`${e._storagePrefix}/${this._strategy.name}`,o,r,1)}}};SuggestMemoryService._strategyCtors=new Map([["recentlyUsedByPrefix",PrefixMemory],["recentlyUsed",LRUMemory],["first",NoMemory]]),SuggestMemoryService._storagePrefix="suggest/memories",SuggestMemoryService=__decorate([__param(0,IStorageService),__param(1,IConfigurationService)],SuggestMemoryService);export{SuggestMemoryService};export const ISuggestMemoryService=createDecorator("ISuggestMemories");registerSingleton(ISuggestMemoryService,SuggestMemoryService,!0);