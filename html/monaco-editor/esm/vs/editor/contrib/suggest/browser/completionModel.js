import{quickSelect}from"../../../../base/common/arrays.js";import{anyScore,fuzzyScore,FuzzyScore,fuzzyScoreGracefulAggressive}from"../../../../base/common/filters.js";import{compareIgnoreCase}from"../../../../base/common/strings.js";export class LineContext{constructor(e,t){this.leadingLineContent=e,this.characterCountDelta=t}}export class CompletionModel{constructor(e,t,i,o,n,s,r){this.clipboardText=r,this._snippetCompareFn=CompletionModel._compareCompletionItems,this._items=e,this._column=t,this._wordDistance=o,this._options=n,this._refilterKind=1,this._lineContext=i,"top"===s?this._snippetCompareFn=CompletionModel._compareCompletionItemsSnippetsUp:"bottom"===s&&(this._snippetCompareFn=CompletionModel._compareCompletionItemsSnippetsDown)}get lineContext(){return this._lineContext}set lineContext(e){this._lineContext.leadingLineContent===e.leadingLineContent&&this._lineContext.characterCountDelta===e.characterCountDelta||(this._refilterKind=this._lineContext.characterCountDelta<e.characterCountDelta&&this._filteredItems?2:1,this._lineContext=e)}get items(){return this._ensureCachedState(),this._filteredItems}get allProvider(){return this._ensureCachedState(),this._providerInfo.keys()}get incomplete(){this._ensureCachedState();const e=new Set;for(let[t,i]of this._providerInfo)i&&e.add(t);return e}adopt(e){let t=[];for(let i=0;i<this._items.length;)e.has(this._items[i].provider)?i++:(t.push(this._items[i]),this._items[i]=this._items[this._items.length-1],this._items.pop());return this._refilterKind=1,t}get stats(){return this._ensureCachedState(),this._stats}_ensureCachedState(){0!==this._refilterKind&&this._createCachedState()}_createCachedState(){this._providerInfo=new Map;const e=[],{leadingLineContent:t,characterCountDelta:i}=this._lineContext;let o="",n="";const s=1===this._refilterKind?this._items:this._filteredItems,r=[],l=!this._options.filterGraceful||s.length>2e3?fuzzyScore:fuzzyScoreGracefulAggressive;for(let c=0;c<s.length;c++){const a=s[c];if(a.isInvalid)continue;this._providerInfo.set(a.provider,Boolean(a.container.incomplete));const p=a.position.column-a.editStart.column,m=p+i-(a.position.column-this._column);if(o.length!==m&&(o=0===m?"":t.slice(-m),n=o.toLowerCase()),a.word=o,0===m)a.score=FuzzyScore.Default;else{let e=0;while(e<p){const t=o.charCodeAt(e);if(32!==t&&9!==t)break;e+=1}if(e>=m)a.score=FuzzyScore.Default;else if("string"===typeof a.completion.filterText){let t=l(o,n,e,a.completion.filterText,a.filterTextLow,0,!1);if(!t)continue;0===compareIgnoreCase(a.completion.filterText,a.textLabel)?a.score=t:(a.score=anyScore(o,n,e,a.textLabel,a.labelLow,0),a.score[0]=t[0])}else{let t=l(o,n,e,a.textLabel,a.labelLow,0,!1);if(!t)continue;a.score=t}}a.idx=c,a.distance=this._wordDistance.distance(a.position,a.completion),r.push(a),e.push(a.textLabel.length)}this._filteredItems=r.sort(this._snippetCompareFn),this._refilterKind=0,this._stats={pLabelLen:e.length?quickSelect(e.length-.85,e,((e,t)=>e-t)):0}}static _compareCompletionItems(e,t){return e.score[0]>t.score[0]?-1:e.score[0]<t.score[0]?1:e.distance<t.distance?-1:e.distance>t.distance?1:e.idx<t.idx?-1:e.idx>t.idx?1:0}static _compareCompletionItemsSnippetsDown(e,t){if(e.completion.kind!==t.completion.kind){if(27===e.completion.kind)return 1;if(27===t.completion.kind)return-1}return CompletionModel._compareCompletionItems(e,t)}static _compareCompletionItemsSnippetsUp(e,t){if(e.completion.kind!==t.completion.kind){if(27===e.completion.kind)return-1;if(27===t.completion.kind)return 1}return CompletionModel._compareCompletionItems(e,t)}}