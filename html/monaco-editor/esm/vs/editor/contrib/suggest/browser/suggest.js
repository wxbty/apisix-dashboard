var __awaiter=this&&this.__awaiter||function(e,t,o,i){function n(e){return e instanceof o?e:new o((function(t){t(e)}))}return new(o||(o=Promise))((function(o,s){function r(e){try{l(i.next(e))}catch(t){s(t)}}function a(e){try{l(i["throw"](e))}catch(t){s(t)}}function l(e){e.done?o(e.value):n(e.value).then(r,a)}l((i=i.apply(e,t||[])).next())}))};import{CancellationToken}from"../../../../base/common/cancellation.js";import{canceled,isCancellationError,onUnexpectedExternalError}from"../../../../base/common/errors.js";import{FuzzyScore}from"../../../../base/common/filters.js";import{DisposableStore,isDisposable}from"../../../../base/common/lifecycle.js";import{StopWatch}from"../../../../base/common/stopwatch.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import*as modes from"../../../common/languages.js";import{ITextModelService}from"../../../common/services/resolverService.js";import{SnippetParser}from"../../snippet/browser/snippetParser.js";import{localize}from"../../../../nls.js";import{MenuId}from"../../../../platform/actions/common/actions.js";import{CommandsRegistry}from"../../../../platform/commands/common/commands.js";import{RawContextKey}from"../../../../platform/contextkey/common/contextkey.js";export const Context={Visible:new RawContextKey("suggestWidgetVisible",!1,localize("suggestWidgetVisible","Whether suggestion are visible")),DetailsVisible:new RawContextKey("suggestWidgetDetailsVisible",!1,localize("suggestWidgetDetailsVisible","Whether suggestion details are visible")),MultipleSuggestions:new RawContextKey("suggestWidgetMultipleSuggestions",!1,localize("suggestWidgetMultipleSuggestions","Whether there are multiple suggestions to pick from")),MakesTextEdit:new RawContextKey("suggestionMakesTextEdit",!0,localize("suggestionMakesTextEdit","Whether inserting the current suggestion yields in a change or has everything already been typed")),AcceptSuggestionsOnEnter:new RawContextKey("acceptSuggestionOnEnter",!0,localize("acceptSuggestionOnEnter","Whether suggestions are inserted when pressing Enter")),HasInsertAndReplaceRange:new RawContextKey("suggestionHasInsertAndReplaceRange",!1,localize("suggestionHasInsertAndReplaceRange","Whether the current suggestion has insert and replace behaviour")),InsertMode:new RawContextKey("suggestionInsertMode",void 0,{type:"string",description:localize("suggestionInsertMode","Whether the default behaviour is to insert or replace")}),CanResolve:new RawContextKey("suggestionCanResolve",!1,localize("suggestionCanResolve","Whether the current suggestion supports to resolve further details"))};export const suggestWidgetStatusbarMenu=new MenuId("suggestWidgetStatusBar");export class CompletionItem{constructor(e,t,o,i){this.position=e,this.completion=t,this.container=o,this.provider=i,this.isInvalid=!1,this.score=FuzzyScore.Default,this.distance=0,this.textLabel="string"===typeof t.label?t.label:t.label.label,this.labelLow=this.textLabel.toLowerCase(),this.isInvalid=!this.textLabel,this.sortTextLow=t.sortText&&t.sortText.toLowerCase(),this.filterTextLow=t.filterText&&t.filterText.toLowerCase(),Range.isIRange(t.range)?(this.editStart=new Position(t.range.startLineNumber,t.range.startColumn),this.editInsertEnd=new Position(t.range.endLineNumber,t.range.endColumn),this.editReplaceEnd=new Position(t.range.endLineNumber,t.range.endColumn),this.isInvalid=this.isInvalid||Range.spansMultipleLines(t.range)||t.range.startLineNumber!==e.lineNumber):(this.editStart=new Position(t.range.insert.startLineNumber,t.range.insert.startColumn),this.editInsertEnd=new Position(t.range.insert.endLineNumber,t.range.insert.endColumn),this.editReplaceEnd=new Position(t.range.replace.endLineNumber,t.range.replace.endColumn),this.isInvalid=this.isInvalid||Range.spansMultipleLines(t.range.insert)||Range.spansMultipleLines(t.range.replace)||t.range.insert.startLineNumber!==e.lineNumber||t.range.replace.startLineNumber!==e.lineNumber||t.range.insert.startColumn!==t.range.replace.startColumn),"function"!==typeof i.resolveCompletionItem&&(this._resolveCache=Promise.resolve(),this._isResolved=!0)}get isResolved(){return!!this._isResolved}resolve(e){return __awaiter(this,void 0,void 0,(function*(){if(!this._resolveCache){const t=e.onCancellationRequested((()=>{this._resolveCache=void 0,this._isResolved=!1}));this._resolveCache=Promise.resolve(this.provider.resolveCompletionItem(this.completion,e)).then((e=>{Object.assign(this.completion,e),this._isResolved=!0,t.dispose()}),(e=>{isCancellationError(e)&&(this._resolveCache=void 0,this._isResolved=!1)}))}return this._resolveCache}))}}export class CompletionOptions{constructor(e=2,t=new Set,o=new Set,i=!0){this.snippetSortOrder=e,this.kindFilter=t,this.providerFilter=o,this.showDeprecated=i}}let _snippetSuggestSupport;CompletionOptions.default=new CompletionOptions;export function getSnippetSuggestSupport(){return _snippetSuggestSupport}export class CompletionItemModel{constructor(e,t,o,i){this.items=e,this.needsClipboard=t,this.durations=o,this.disposable=i}}export function provideSuggestionItems(e,t,o=CompletionOptions.default,i={triggerKind:0},n=CancellationToken.None){return __awaiter(this,void 0,void 0,(function*(){const s=new StopWatch(!0);t=t.clone();const r=e.getWordAtPosition(t),a=r?new Range(t.lineNumber,r.startColumn,t.lineNumber,r.endColumn):Range.fromPositions(t),l={replace:a,insert:a.setEndPosition(t.lineNumber,t.column)},p=[],u=new DisposableStore,c=[];let d=!1;const m=(e,i,n)=>{var s,r,a;let m=!1;if(!i)return m;for(let u of i.suggestions)if(!o.kindFilter.has(u.kind)){if(!o.showDeprecated&&(null===(s=null===u||void 0===u?void 0:u.tags)||void 0===s?void 0:s.includes(1)))continue;u.range||(u.range=l),u.sortText||(u.sortText="string"===typeof u.label?u.label:u.label.label),!d&&u.insertTextRules&&4&u.insertTextRules&&(d=SnippetParser.guessNeedsClipboard(u.insertText)),p.push(new CompletionItem(t,u,i,e)),m=!0}return isDisposable(i)&&u.add(i),c.push({providerName:null!==(r=e._debugDisplayName)&&void 0!==r?r:"unkown_provider",elapsedProvider:null!==(a=i.duration)&&void 0!==a?a:-1,elapsedOverall:n.elapsed()}),m},g=(()=>__awaiter(this,void 0,void 0,(function*(){if(!_snippetSuggestSupport||o.kindFilter.has(27))return;if(o.providerFilter.size>0&&!o.providerFilter.has(_snippetSuggestSupport))return;const s=new StopWatch(!0),r=yield _snippetSuggestSupport.provideCompletionItems(e,t,i,n);m(_snippetSuggestSupport,r,s)})))();for(let h of modes.CompletionProviderRegistry.orderedGroups(e)){let s=!1;if(yield Promise.all(h.map((r=>__awaiter(this,void 0,void 0,(function*(){if(!(o.providerFilter.size>0)||o.providerFilter.has(r))try{const o=new StopWatch(!0),a=yield r.provideCompletionItems(e,t,i,n);s=m(r,a,o)||s}catch(a){onUnexpectedExternalError(a)}}))))),s||n.isCancellationRequested)break}return yield g,n.isCancellationRequested?(u.dispose(),Promise.reject(canceled())):new CompletionItemModel(p.sort(getSuggestionComparator(o.snippetSortOrder)),d,{entries:c,elapsed:s.elapsed()},u)}))}function defaultComparator(e,t){if(e.sortTextLow&&t.sortTextLow){if(e.sortTextLow<t.sortTextLow)return-1;if(e.sortTextLow>t.sortTextLow)return 1}return e.completion.label<t.completion.label?-1:e.completion.label>t.completion.label?1:e.completion.kind-t.completion.kind}function snippetUpComparator(e,t){if(e.completion.kind!==t.completion.kind){if(27===e.completion.kind)return-1;if(27===t.completion.kind)return 1}return defaultComparator(e,t)}function snippetDownComparator(e,t){if(e.completion.kind!==t.completion.kind){if(27===e.completion.kind)return 1;if(27===t.completion.kind)return-1}return defaultComparator(e,t)}const _snippetComparators=new Map;_snippetComparators.set(0,snippetUpComparator),_snippetComparators.set(2,snippetDownComparator),_snippetComparators.set(1,defaultComparator);export function getSuggestionComparator(e){return _snippetComparators.get(e)}CommandsRegistry.registerCommand("_executeCompletionItemProvider",((e,...t)=>__awaiter(void 0,void 0,void 0,(function*(){const[o,i,n,s]=t;assertType(URI.isUri(o)),assertType(Position.isIPosition(i)),assertType("string"===typeof n||!n),assertType("number"===typeof s||!s);const r=yield e.get(ITextModelService).createModelReference(o);try{const e={incomplete:!1,suggestions:[]},t=[],o=yield provideSuggestionItems(r.object.textEditorModel,Position.lift(i),void 0,{triggerCharacter:n,triggerKind:n?1:0});for(const i of o.items)t.length<(null!==s&&void 0!==s?s:0)&&t.push(i.resolve(CancellationToken.None)),e.incomplete=e.incomplete||i.container.incomplete,e.suggestions.push(i.completion);try{return yield Promise.all(t),e}finally{setTimeout((()=>o.disposable.dispose()),100)}}finally{r.dispose()}}))));const _provider=new class{constructor(){this.onlyOnceSuggestions=[]}provideCompletionItems(){let e=this.onlyOnceSuggestions.slice(0),t={suggestions:e};return this.onlyOnceSuggestions.length=0,t}};modes.CompletionProviderRegistry.register("*",_provider);export function showSimpleSuggestions(e,t){setTimeout((()=>{var o;_provider.onlyOnceSuggestions.push(...t),null===(o=e.getContribution("editor.contrib.suggestController"))||void 0===o||o.triggerSuggest((new Set).add(_provider))}),0)}