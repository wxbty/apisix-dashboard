var __decorate=this&&this.__decorate||function(e,t,i,o){var s,r=arguments.length,n=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)n=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(n=(r<3?s(n):r>3?s(t,i,n):s(t,i))||n);return r>3&&n&&Object.defineProperty(t,i,n),n},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}},__awaiter=this&&this.__awaiter||function(e,t,i,o){function s(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,r){function n(e){try{d(o.next(e))}catch(t){r(t)}}function a(e){try{d(o["throw"](e))}catch(t){r(t)}}function d(e){e.done?i(e.value):s(e.value).then(n,a)}d((o=o.apply(e,t||[])).next())}))};import{TimeoutTimer}from"../../../../base/common/async.js";import{CancellationTokenSource}from"../../../../base/common/cancellation.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{Emitter}from"../../../../base/common/event.js";import{DisposableStore,dispose}from"../../../../base/common/lifecycle.js";import{getLeadingWhitespace,isHighSurrogate,isLowSurrogate}from"../../../../base/common/strings.js";import{Selection}from"../../../common/core/selection.js";import{CompletionProviderRegistry}from"../../../common/languages.js";import{IEditorWorkerService}from"../../../common/services/editorWorker.js";import{SnippetController2}from"../../snippet/browser/snippetController2.js";import{WordDistance}from"./wordDistance.js";import{IClipboardService}from"../../../../platform/clipboard/common/clipboardService.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService}from"../../../../platform/contextkey/common/contextkey.js";import{ILogService}from"../../../../platform/log/common/log.js";import{ITelemetryService}from"../../../../platform/telemetry/common/telemetry.js";import{CompletionModel}from"./completionModel.js";import{CompletionOptions,getSnippetSuggestSupport,getSuggestionComparator,provideSuggestionItems}from"./suggest.js";export class LineContext{constructor(e,t,i,o){this.leadingLineContent=e.getLineContent(t.lineNumber).substr(0,t.column-1),this.leadingWord=e.getWordUntilPosition(t),this.lineNumber=t.lineNumber,this.column=t.column,this.auto=i,this.shy=o}static shouldAutoTrigger(e){if(!e.hasModel())return!1;const t=e.getModel(),i=e.getPosition();t.tokenizeIfCheap(i.lineNumber);const o=t.getWordAtPosition(i);return!!o&&(o.endColumn===i.column&&!!isNaN(Number(o.word)))}}function isSuggestPreviewEnabled(e){return e.getOption(106).preview}function canShowQuickSuggest(e,t,i){if(!Boolean(t.getContextKeyValue("inlineSuggestionVisible")))return!0;const o=i.getValue("editor.inlineSuggest.allowQuickSuggestions");return void 0!==o&&Boolean(o)}function canShowSuggestOnTriggerCharacters(e,t,i){if(!Boolean(t.getContextKeyValue("inlineSuggestionVisible")))return!0;const o=i.getValue("editor.inlineSuggest.allowSuggestOnTriggerCharacters");return void 0!==o&&Boolean(o)}let SuggestModel=class e{constructor(e,t,i,o,s,r,n){this._editor=e,this._editorWorkerService=t,this._clipboardService=i,this._telemetryService=o,this._logService=s,this._contextKeyService=r,this._configurationService=n,this._toDispose=new DisposableStore,this._quickSuggestDelay=10,this._triggerCharacterListener=new DisposableStore,this._triggerQuickSuggest=new TimeoutTimer,this._state=0,this._completionDisposables=new DisposableStore,this._onDidCancel=new Emitter,this._onDidTrigger=new Emitter,this._onDidSuggest=new Emitter,this.onDidCancel=this._onDidCancel.event,this.onDidTrigger=this._onDidTrigger.event,this.onDidSuggest=this._onDidSuggest.event,this._telemetryGate=0,this._currentSelection=this._editor.getSelection()||new Selection(1,1,1,1),this._toDispose.add(this._editor.onDidChangeModel((()=>{this._updateTriggerCharacters(),this.cancel()}))),this._toDispose.add(this._editor.onDidChangeModelLanguage((()=>{this._updateTriggerCharacters(),this.cancel()}))),this._toDispose.add(this._editor.onDidChangeConfiguration((()=>{this._updateTriggerCharacters(),this._updateQuickSuggest()}))),this._toDispose.add(CompletionProviderRegistry.onDidChange((()=>{this._updateTriggerCharacters(),this._updateActiveSuggestSession()})));let a=!1;this._toDispose.add(this._editor.onDidCompositionStart((()=>{a=!0}))),this._toDispose.add(this._editor.onDidCompositionEnd((()=>{a=!1,this._onCompositionEnd()}))),this._toDispose.add(this._editor.onDidChangeCursorSelection((e=>{a||this._onCursorChange(e)}))),this._toDispose.add(this._editor.onDidChangeModelContent((()=>{a||this._refilterCompletionItems()}))),this._updateTriggerCharacters(),this._updateQuickSuggest()}dispose(){dispose(this._triggerCharacterListener),dispose([this._onDidCancel,this._onDidSuggest,this._onDidTrigger,this._triggerQuickSuggest]),this._toDispose.dispose(),this._completionDisposables.dispose(),this.cancel()}_updateQuickSuggest(){this._quickSuggestDelay=this._editor.getOption(80),(isNaN(this._quickSuggestDelay)||!this._quickSuggestDelay&&0!==this._quickSuggestDelay||this._quickSuggestDelay<0)&&(this._quickSuggestDelay=10)}_updateTriggerCharacters(){if(this._triggerCharacterListener.clear(),this._editor.getOption(81)||!this._editor.hasModel()||!this._editor.getOption(109))return;const e=new Map;for(const i of CompletionProviderRegistry.all(this._editor.getModel()))for(const t of i.triggerCharacters||[]){let o=e.get(t);o||(o=new Set,o.add(getSnippetSuggestSupport()),e.set(t,o)),o.add(i)}const t=t=>{if(!canShowSuggestOnTriggerCharacters(this._editor,this._contextKeyService,this._configurationService))return;if(LineContext.shouldAutoTrigger(this._editor))return;if(!t){const e=this._editor.getPosition(),i=this._editor.getModel();t=i.getLineContent(e.lineNumber).substr(0,e.column-1)}let i="";isLowSurrogate(t.charCodeAt(t.length-1))?isHighSurrogate(t.charCodeAt(t.length-2))&&(i=t.substr(t.length-2)):i=t.charAt(t.length-1);const o=e.get(i);if(o){const e=this._completionModel?{items:this._completionModel.adopt(o),clipboardText:this._completionModel.clipboardText}:void 0;this.trigger({auto:!0,shy:!1,triggerCharacter:i},Boolean(this._completionModel),o,e)}};this._triggerCharacterListener.add(this._editor.onDidType(t)),this._triggerCharacterListener.add(this._editor.onDidCompositionEnd((()=>t())))}get state(){return this._state}cancel(e=!1){var t;0!==this._state&&(this._triggerQuickSuggest.cancel(),null===(t=this._requestToken)||void 0===t||t.cancel(),this._requestToken=void 0,this._state=0,this._completionModel=void 0,this._context=void 0,this._onDidCancel.fire({retrigger:e}))}clear(){this._completionDisposables.clear()}_updateActiveSuggestSession(){0!==this._state&&(this._editor.hasModel()&&CompletionProviderRegistry.has(this._editor.getModel())?this.trigger({auto:2===this._state,shy:!1},!0):this.cancel())}_onCursorChange(e){if(!this._editor.hasModel())return;const t=this._currentSelection;this._currentSelection=this._editor.getSelection(),!e.selection.isEmpty()||0!==e.reason&&3!==e.reason||"keyboard"!==e.source&&"deleteLeft"!==e.source?this.cancel():0===this._state&&0===e.reason?(t.containsRange(this._currentSelection)||t.getEndPosition().isBeforeOrEqual(this._currentSelection.getPosition()))&&this._doTriggerQuickSuggest():0!==this._state&&3===e.reason&&this._refilterCompletionItems()}_onCompositionEnd(){0===this._state?this._doTriggerQuickSuggest():this._refilterCompletionItems()}_doTriggerQuickSuggest(){var e;!1!==this._editor.getOption(79)&&(this._editor.getOption(106).snippetsPreventQuickSuggestions&&(null===(e=SnippetController2.get(this._editor))||void 0===e?void 0:e.isInSnippet())||(this.cancel(),this._triggerQuickSuggest.cancelAndSet((()=>{if(0!==this._state)return;if(!LineContext.shouldAutoTrigger(this._editor))return;if(!this._editor.hasModel())return;const e=this._editor.getModel(),t=this._editor.getPosition(),i=this._editor.getOption(79);if(!1!==i){if(!0===i);else{e.tokenizeIfCheap(t.lineNumber);const o=e.getLineTokens(t.lineNumber),s=o.getStandardTokenType(o.findTokenIndexAtOffset(Math.max(t.column-1-1,0))),r=i.other&&0===s||i.comments&&1===s||i.strings&&2===s;if(!r)return}canShowQuickSuggest(this._editor,this._contextKeyService,this._configurationService)&&CompletionProviderRegistry.has(e)&&this.trigger({auto:!0,shy:!1})}}),this._quickSuggestDelay)))}_refilterCompletionItems(){Promise.resolve().then((()=>{if(0===this._state)return;if(!this._editor.hasModel())return;const e=this._editor.getModel(),t=this._editor.getPosition(),i=new LineContext(e,t,2===this._state,!1);this._onNewContext(i)}))}trigger(t,i=!1,o,s){var r;if(!this._editor.hasModel())return;const n=this._editor.getModel(),a=t.auto,d=new LineContext(n,this._editor.getPosition(),a,t.shy);this.cancel(i),this._state=a?2:1,this._onDidTrigger.fire({auto:a,shy:t.shy,position:this._editor.getPosition()}),this._context=d;let h={triggerKind:null!==(r=t.triggerKind)&&void 0!==r?r:0};t.triggerCharacter&&(h={triggerKind:1,triggerCharacter:t.triggerCharacter}),this._requestToken=new CancellationTokenSource;const l=this._editor.getOption(101);let c=1;switch(l){case"top":c=0;break;case"bottom":c=2;break}const{itemKind:g,showDeprecated:u}=e._createSuggestFilter(this._editor),_=WordDistance.create(this._editorWorkerService,this._editor),p=provideSuggestionItems(n,this._editor.getPosition(),new CompletionOptions(c,g,o,u),h,this._requestToken.token);Promise.all([p,_]).then((([e,i])=>__awaiter(this,void 0,void 0,(function*(){var o;if(null===(o=this._requestToken)||void 0===o||o.dispose(),!this._editor.hasModel())return;let r=null===s||void 0===s?void 0:s.clipboardText;if(!r&&e.needsClipboard&&(r=yield this._clipboardService.readText()),0===this._state)return;const n=this._editor.getModel();let d=e.items;if(s){const e=getSuggestionComparator(c);d=d.concat(s.items).sort(e)}const h=new LineContext(n,this._editor.getPosition(),a,t.shy);this._completionModel=new CompletionModel(d,this._context.column,{leadingLineContent:h.leadingLineContent,characterCountDelta:h.column-this._context.column},i,this._editor.getOption(106),this._editor.getOption(101),r),this._completionDisposables.add(e.disposable),this._onNewContext(h),this._reportDurationsTelemetry(e.durations)})))).catch(onUnexpectedError)}_reportDurationsTelemetry(e){this._telemetryGate++%230===0&&setTimeout((()=>{this._telemetryService.publicLog2("suggest.durations.json",{data:JSON.stringify(e)}),this._logService.debug("suggest.durations.json",e)}))}static _createSuggestFilter(e){const t=new Set,i=e.getOption(101);"none"===i&&t.add(27);const o=e.getOption(106);return o.showMethods||t.add(0),o.showFunctions||t.add(1),o.showConstructors||t.add(2),o.showFields||t.add(3),o.showVariables||t.add(4),o.showClasses||t.add(5),o.showStructs||t.add(6),o.showInterfaces||t.add(7),o.showModules||t.add(8),o.showProperties||t.add(9),o.showEvents||t.add(10),o.showOperators||t.add(11),o.showUnits||t.add(12),o.showValues||t.add(13),o.showConstants||t.add(14),o.showEnums||t.add(15),o.showEnumMembers||t.add(16),o.showKeywords||t.add(17),o.showWords||t.add(18),o.showColors||t.add(19),o.showFiles||t.add(20),o.showReferences||t.add(21),o.showColors||t.add(22),o.showFolders||t.add(23),o.showTypeParameters||t.add(24),o.showSnippets||t.add(27),o.showUsers||t.add(25),o.showIssues||t.add(26),{itemKind:t,showDeprecated:o.showDeprecated}}_onNewContext(e){if(this._context)if(e.lineNumber===this._context.lineNumber)if(getLeadingWhitespace(e.leadingLineContent)===getLeadingWhitespace(this._context.leadingLineContent)){if(e.column<this._context.column)e.leadingWord.word?this.trigger({auto:this._context.auto,shy:!1},!0):this.cancel();else if(this._completionModel)if(0!==e.leadingWord.word.length&&e.leadingWord.startColumn>this._context.leadingWord.startColumn){const e=new Set(CompletionProviderRegistry.all(this._editor.getModel()));for(let i of this._completionModel.allProvider)e.delete(i);const t=this._completionModel.adopt(new Set);this.trigger({auto:this._context.auto,shy:!1},!0,e,{items:t,clipboardText:this._completionModel.clipboardText})}else if(e.column>this._context.column&&this._completionModel.incomplete.size>0&&0!==e.leadingWord.word.length){const{incomplete:e}=this._completionModel,t=this._completionModel.adopt(e);this.trigger({auto:2===this._state,shy:!1,triggerKind:2},!0,e,{items:t,clipboardText:this._completionModel.clipboardText})}else{let t=this._completionModel.lineContext,i=!1;if(this._completionModel.lineContext={leadingLineContent:e.leadingLineContent,characterCountDelta:e.column-this._context.column},0===this._completionModel.items.length){if(LineContext.shouldAutoTrigger(this._editor)&&this._context.leadingWord.endColumn<e.leadingWord.startColumn)return void this.trigger({auto:this._context.auto,shy:!1},!0);if(this._context.auto)return void this.cancel();if(this._completionModel.lineContext=t,i=this._completionModel.items.length>0,i&&0===e.leadingWord.word.length)return void this.cancel()}this._onDidSuggest.fire({completionModel:this._completionModel,auto:this._context.auto,shy:this._context.shy,isFrozen:i})}}else this.cancel();else this.cancel()}};SuggestModel=__decorate([__param(1,IEditorWorkerService),__param(2,IClipboardService),__param(3,ITelemetryService),__param(4,ILogService),__param(5,IContextKeyService),__param(6,IConfigurationService)],SuggestModel);export{SuggestModel};