import{RunOnceScheduler}from"../../../../base/common/async.js";import{Disposable}from"../../../../base/common/lifecycle.js";import"./bracketMatching.css";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{OverviewRulerLane}from"../../../common/model.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";import{editorBracketMatchBackground,editorBracketMatchBorder}from"../../../common/core/editorColorRegistry.js";import*as nls from"../../../../nls.js";import{MenuId,MenuRegistry}from"../../../../platform/actions/common/actions.js";import{registerColor}from"../../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant,themeColorFromId}from"../../../../platform/theme/common/themeService.js";const overviewRulerBracketMatchForeground=registerColor("editorOverviewRuler.bracketMatchForeground",{dark:"#A0A0A0",light:"#A0A0A0",hc:"#A0A0A0"},nls.localize("overviewRulerBracketMatchForeground","Overview ruler marker color for matching brackets."));class JumpToBracketAction extends EditorAction{constructor(){super({id:"editor.action.jumpToBracket",label:nls.localize("smartSelect.jumpBracket","Go to Bracket"),alias:"Go to Bracket",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:3160,weight:100}})}run(t,e){var o;null===(o=BracketMatchingController.get(e))||void 0===o||o.jumpToBracket()}}class SelectToBracketAction extends EditorAction{constructor(){super({id:"editor.action.selectToBracket",label:nls.localize("smartSelect.selectToBracket","Select to Bracket"),alias:"Select to Bracket",precondition:void 0,description:{description:"Select to Bracket",args:[{name:"args",schema:{type:"object",properties:{selectBrackets:{type:"boolean",default:!0}}}}]}})}run(t,e,o){var r;let i=!0;o&&!1===o.selectBrackets&&(i=!1),null===(r=BracketMatchingController.get(e))||void 0===r||r.selectToBracket(i)}}class BracketsData{constructor(t,e,o){this.position=t,this.brackets=e,this.options=o}}export class BracketMatchingController extends Disposable{constructor(t){super(),this._editor=t,this._lastBracketsData=[],this._lastVersionId=0,this._decorations=[],this._updateBracketsSoon=this._register(new RunOnceScheduler((()=>this._updateBrackets()),50)),this._matchBrackets=this._editor.getOption(64),this._updateBracketsSoon.schedule(),this._register(t.onDidChangeCursorPosition((t=>{"never"!==this._matchBrackets&&this._updateBracketsSoon.schedule()}))),this._register(t.onDidChangeModelContent((t=>{this._updateBracketsSoon.schedule()}))),this._register(t.onDidChangeModel((t=>{this._lastBracketsData=[],this._decorations=[],this._updateBracketsSoon.schedule()}))),this._register(t.onDidChangeModelLanguageConfiguration((t=>{this._lastBracketsData=[],this._updateBracketsSoon.schedule()}))),this._register(t.onDidChangeConfiguration((t=>{t.hasChanged(64)&&(this._matchBrackets=this._editor.getOption(64),this._decorations=this._editor.deltaDecorations(this._decorations,[]),this._lastBracketsData=[],this._lastVersionId=0,this._updateBracketsSoon.schedule())}))),this._register(t.onDidBlurEditorWidget((()=>{this._updateBracketsSoon.schedule()}))),this._register(t.onDidFocusEditorWidget((()=>{this._updateBracketsSoon.schedule()})))}static get(t){return t.getContribution(BracketMatchingController.ID)}jumpToBracket(){if(!this._editor.hasModel())return;const t=this._editor.getModel(),e=this._editor.getSelections().map((e=>{const o=e.getStartPosition(),r=t.bracketPairs.matchBracket(o);let i=null;if(r)r[0].containsPosition(o)?i=r[1].getStartPosition():r[1].containsPosition(o)&&(i=r[0].getStartPosition());else{const e=t.bracketPairs.findEnclosingBrackets(o);if(e)i=e[0].getStartPosition();else{const e=t.bracketPairs.findNextBracket(o);e&&e.range&&(i=e.range.getStartPosition())}}return i?new Selection(i.lineNumber,i.column,i.lineNumber,i.column):new Selection(o.lineNumber,o.column,o.lineNumber,o.column)}));this._editor.setSelections(e),this._editor.revealRange(e[0])}selectToBracket(t){if(!this._editor.hasModel())return;const e=this._editor.getModel(),o=[];this._editor.getSelections().forEach((r=>{const i=r.getStartPosition();let s=e.bracketPairs.matchBracket(i);if(!s&&(s=e.bracketPairs.findEnclosingBrackets(i),!s)){const t=e.bracketPairs.findNextBracket(i);t&&t.range&&(s=e.bracketPairs.matchBracket(t.range.getStartPosition()))}let a=null,n=null;if(s){s.sort(Range.compareRangesUsingStarts);const[e,o]=s;if(a=t?e.getStartPosition():e.getEndPosition(),n=t?o.getEndPosition():o.getStartPosition(),o.containsPosition(i)){const t=a;a=n,n=t}}a&&n&&o.push(new Selection(a.lineNumber,a.column,n.lineNumber,n.column))})),o.length>0&&(this._editor.setSelections(o),this._editor.revealRange(o[0]))}_updateBrackets(){if("never"===this._matchBrackets)return;this._recomputeBrackets();let t=[],e=0;for(const o of this._lastBracketsData){let r=o.brackets;r&&(t[e++]={range:r[0],options:o.options},t[e++]={range:r[1],options:o.options})}this._decorations=this._editor.deltaDecorations(this._decorations,t)}_recomputeBrackets(){if(!this._editor.hasModel()||!this._editor.hasWidgetFocus())return this._lastBracketsData=[],void(this._lastVersionId=0);const t=this._editor.getSelections();if(t.length>100)return this._lastBracketsData=[],void(this._lastVersionId=0);const e=this._editor.getModel(),o=e.getVersionId();let r=[];this._lastVersionId===o&&(r=this._lastBracketsData);let i=[],s=0;for(let d=0,h=t.length;d<h;d++){let e=t[d];e.isEmpty()&&(i[s++]=e.getStartPosition())}i.length>1&&i.sort(Position.compare);let a=[],n=0,c=0,l=r.length;for(let d=0,h=i.length;d<h;d++){let t=i[d];while(c<l&&r[c].position.isBefore(t))c++;if(c<l&&r[c].position.equals(t))a[n++]=r[c];else{let o=e.bracketPairs.matchBracket(t),r=BracketMatchingController._DECORATION_OPTIONS_WITH_OVERVIEW_RULER;o||"always"!==this._matchBrackets||(o=e.bracketPairs.findEnclosingBrackets(t,20),r=BracketMatchingController._DECORATION_OPTIONS_WITHOUT_OVERVIEW_RULER),a[n++]=new BracketsData(t,o,r)}}this._lastBracketsData=a,this._lastVersionId=o}}BracketMatchingController.ID="editor.contrib.bracketMatchingController",BracketMatchingController._DECORATION_OPTIONS_WITH_OVERVIEW_RULER=ModelDecorationOptions.register({description:"bracket-match-overview",stickiness:1,className:"bracket-match",overviewRuler:{color:themeColorFromId(overviewRulerBracketMatchForeground),position:OverviewRulerLane.Center}}),BracketMatchingController._DECORATION_OPTIONS_WITHOUT_OVERVIEW_RULER=ModelDecorationOptions.register({description:"bracket-match-no-overview",stickiness:1,className:"bracket-match"}),registerEditorContribution(BracketMatchingController.ID,BracketMatchingController),registerEditorAction(SelectToBracketAction),registerEditorAction(JumpToBracketAction),registerThemingParticipant(((t,e)=>{const o=t.getColor(editorBracketMatchBackground);o&&e.addRule(`.monaco-editor .bracket-match { background-color: ${o}; }`);const r=t.getColor(editorBracketMatchBorder);r&&e.addRule(`.monaco-editor .bracket-match { border: 1px solid ${r}; }`)})),MenuRegistry.appendMenuItem(MenuId.MenubarGoMenu,{group:"5_infile_nav",command:{id:"editor.action.jumpToBracket",title:nls.localize({key:"miGoToBracket",comment:["&& denotes a mnemonic"]},"Go to &&Bracket")},order:2});