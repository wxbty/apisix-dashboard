var __decorate=this&&this.__decorate||function(e,t,o,i){var n,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,o,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(r<3?n(s):r>3?n(t,o,s):n(t,o))||s);return r>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}};import{createCancelablePromise,RunOnceScheduler}from"../../../../base/common/async.js";import{Disposable}from"../../../../base/common/lifecycle.js";import{registerEditorContribution}from"../../../browser/editorExtensions.js";import{DocumentRangeSemanticTokensProviderRegistry}from"../../../common/languages.js";import{getDocumentRangeSemanticTokens,hasDocumentRangeSemanticTokensProvider}from"../../../common/services/getSemanticTokens.js";import{IModelService}from"../../../common/services/model.js";import{isSemanticColoringEnabled,SEMANTIC_HIGHLIGHTING_SETTING_ID}from"../../../common/services/modelService.js";import{toMultilineTokens2}from"../../../common/services/semanticTokensProviderStyling.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";import{IThemeService}from"../../../../platform/theme/common/themeService.js";import{ILanguageFeatureDebounceService}from"../../../common/services/languageFeatureDebounce.js";import{StopWatch}from"../../../../base/common/stopwatch.js";let ViewportSemanticTokensContribution=class extends Disposable{constructor(e,t,o,i,n){super(),this._modelService=t,this._themeService=o,this._configurationService=i,this._editor=e,this._debounceInformation=n.for(DocumentRangeSemanticTokensProviderRegistry,"DocumentRangeSemanticTokens",{min:100,max:500}),this._tokenizeViewport=new RunOnceScheduler((()=>this._tokenizeViewportNow()),100),this._outstandingRequests=[];const r=()=>{this._editor.hasModel()&&this._tokenizeViewport.schedule(this._debounceInformation.get(this._editor.getModel()))};this._register(this._editor.onDidScrollChange((()=>{r()}))),this._register(this._editor.onDidChangeModel((()=>{this._cancelAll(),r()}))),this._register(this._editor.onDidChangeModelContent((e=>{this._cancelAll(),r()}))),this._register(DocumentRangeSemanticTokensProviderRegistry.onDidChange((()=>{this._cancelAll(),r()}))),this._register(this._configurationService.onDidChangeConfiguration((e=>{e.affectsConfiguration(SEMANTIC_HIGHLIGHTING_SETTING_ID)&&(this._cancelAll(),r())}))),this._register(this._themeService.onDidColorThemeChange((()=>{this._cancelAll(),r()})))}_cancelAll(){for(const e of this._outstandingRequests)e.cancel();this._outstandingRequests=[]}_removeOutstandingRequest(e){for(let t=0,o=this._outstandingRequests.length;t<o;t++)if(this._outstandingRequests[t]===e)return void this._outstandingRequests.splice(t,1)}_tokenizeViewportNow(){if(!this._editor.hasModel())return;const e=this._editor.getModel();if(e.hasCompleteSemanticTokens())return;if(!isSemanticColoringEnabled(e,this._themeService,this._configurationService))return void(e.hasSomeSemanticTokens()&&e.setSemanticTokens(null,!1));if(!hasDocumentRangeSemanticTokensProvider(e))return void(e.hasSomeSemanticTokens()&&e.setSemanticTokens(null,!1));const t=this._editor.getVisibleRangesPlusViewportAboveBelow();this._outstandingRequests=this._outstandingRequests.concat(t.map((t=>this._requestRange(e,t))))}_requestRange(e,t){const o=e.getVersionId(),i=createCancelablePromise((o=>Promise.resolve(getDocumentRangeSemanticTokens(e,t,o)))),n=new StopWatch(!1);return i.then((i=>{if(this._debounceInformation.update(e,n.elapsed()),!i||!i.tokens||e.isDisposed()||e.getVersionId()!==o)return;const{provider:r,tokens:s}=i,a=this._modelService.getSemanticTokensProviderStyling(r);e.setPartialSemanticTokens(t,toMultilineTokens2(s,a,e.getLanguageId()))})).then((()=>this._removeOutstandingRequest(i)),(()=>this._removeOutstandingRequest(i))),i}};ViewportSemanticTokensContribution.ID="editor.contrib.viewportSemanticTokens",ViewportSemanticTokensContribution=__decorate([__param(1,IModelService),__param(2,IThemeService),__param(3,IConfigurationService),__param(4,ILanguageFeatureDebounceService)],ViewportSemanticTokensContribution),registerEditorContribution(ViewportSemanticTokensContribution.ID,ViewportSemanticTokensContribution);