import{status}from"../../../../base/browser/ui/aria/aria.js";import{RunOnceScheduler}from"../../../../base/common/async.js";import{KeyChord}from"../../../../base/common/keyCodes.js";import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{CursorMoveCommands}from"../../../common/cursor/cursorMoveCommands.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{OverviewRulerLane,MinimapPosition}from"../../../common/model.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";import{DocumentHighlightProviderRegistry}from"../../../common/languages.js";import{CommonFindController}from"../../find/browser/findController.js";import*as nls from"../../../../nls.js";import{MenuId}from"../../../../platform/actions/common/actions.js";import{ContextKeyExpr}from"../../../../platform/contextkey/common/contextkey.js";import{overviewRulerSelectionHighlightForeground,minimapSelectionOccurrenceHighlight}from"../../../../platform/theme/common/colorRegistry.js";import{themeColorFromId}from"../../../../platform/theme/common/themeService.js";function announceCursorChange(e,t){const o=t.filter((t=>!e.find((e=>e.equals(t)))));if(o.length>=1){const e=o.map((e=>`line ${e.viewState.position.lineNumber} column ${e.viewState.position.column}`)).join(", "),t=1===o.length?nls.localize("cursorAdded","Cursor added: {0}",e):nls.localize("cursorsAdded","Cursors added: {0}",e);status(t)}}export class InsertCursorAbove extends EditorAction{constructor(){super({id:"editor.action.insertCursorAbove",label:nls.localize("mutlicursor.insertAbove","Add Cursor Above"),alias:"Add Cursor Above",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:2576,linux:{primary:1552,secondary:[3088]},weight:100},menuOpts:{menuId:MenuId.MenubarSelectionMenu,group:"3_multi",title:nls.localize({key:"miInsertCursorAbove",comment:["&& denotes a mnemonic"]},"&&Add Cursor Above"),order:2}})}run(e,t,o){if(!t.hasModel())return;let i=!0;o&&!1===o.logicalLine&&(i=!1);const n=t._getViewModel();if(n.cursorConfig.readOnly)return;n.pushStackElement();const s=n.getCursorStates();n.setCursorStates(o.source,3,CursorMoveCommands.addCursorUp(n,s,i)),n.revealTopMostCursor(o.source),announceCursorChange(s,n.getCursorStates())}}export class InsertCursorBelow extends EditorAction{constructor(){super({id:"editor.action.insertCursorBelow",label:nls.localize("mutlicursor.insertBelow","Add Cursor Below"),alias:"Add Cursor Below",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:2578,linux:{primary:1554,secondary:[3090]},weight:100},menuOpts:{menuId:MenuId.MenubarSelectionMenu,group:"3_multi",title:nls.localize({key:"miInsertCursorBelow",comment:["&& denotes a mnemonic"]},"A&&dd Cursor Below"),order:3}})}run(e,t,o){if(!t.hasModel())return;let i=!0;o&&!1===o.logicalLine&&(i=!1);const n=t._getViewModel();if(n.cursorConfig.readOnly)return;n.pushStackElement();const s=n.getCursorStates();n.setCursorStates(o.source,3,CursorMoveCommands.addCursorDown(n,s,i)),n.revealBottomMostCursor(o.source),announceCursorChange(s,n.getCursorStates())}}class InsertCursorAtEndOfEachLineSelected extends EditorAction{constructor(){super({id:"editor.action.insertCursorAtEndOfEachLineSelected",label:nls.localize("mutlicursor.insertAtEndOfEachLineSelected","Add Cursors to Line Ends"),alias:"Add Cursors to Line Ends",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:1575,weight:100},menuOpts:{menuId:MenuId.MenubarSelectionMenu,group:"3_multi",title:nls.localize({key:"miInsertCursorAtEndOfEachLineSelected",comment:["&& denotes a mnemonic"]},"Add C&&ursors to Line Ends"),order:4}})}getCursorsForSelection(e,t,o){if(!e.isEmpty()){for(let i=e.startLineNumber;i<e.endLineNumber;i++){let e=t.getLineMaxColumn(i);o.push(new Selection(i,e,i,e))}e.endColumn>1&&o.push(new Selection(e.endLineNumber,e.endColumn,e.endLineNumber,e.endColumn))}}run(e,t){if(!t.hasModel())return;const o=t.getModel(),i=t.getSelections(),n=t._getViewModel(),s=n.getCursorStates();let r=[];i.forEach((e=>this.getCursorsForSelection(e,o,r))),r.length>0&&t.setSelections(r),announceCursorChange(s,n.getCursorStates())}}class InsertCursorAtEndOfLineSelected extends EditorAction{constructor(){super({id:"editor.action.addCursorsToBottom",label:nls.localize("mutlicursor.addCursorsToBottom","Add Cursors To Bottom"),alias:"Add Cursors To Bottom",precondition:void 0})}run(e,t){if(!t.hasModel())return;const o=t.getSelections(),i=t.getModel().getLineCount();let n=[];for(let l=o[0].startLineNumber;l<=i;l++)n.push(new Selection(l,o[0].startColumn,l,o[0].endColumn));const s=t._getViewModel(),r=s.getCursorStates();n.length>0&&t.setSelections(n),announceCursorChange(r,s.getCursorStates())}}class InsertCursorAtTopOfLineSelected extends EditorAction{constructor(){super({id:"editor.action.addCursorsToTop",label:nls.localize("mutlicursor.addCursorsToTop","Add Cursors To Top"),alias:"Add Cursors To Top",precondition:void 0})}run(e,t){if(!t.hasModel())return;const o=t.getSelections();let i=[];for(let r=o[0].startLineNumber;r>=1;r--)i.push(new Selection(r,o[0].startColumn,r,o[0].endColumn));const n=t._getViewModel(),s=n.getCursorStates();i.length>0&&t.setSelections(i),announceCursorChange(s,n.getCursorStates())}}export class MultiCursorSessionResult{constructor(e,t,o){this.selections=e,this.revealRange=t,this.revealScrollType=o}}export class MultiCursorSession{constructor(e,t,o,i,n,s,r){this._editor=e,this.findController=t,this.isDisconnectedFromFindController=o,this.searchText=i,this.wholeWord=n,this.matchCase=s,this.currentMatch=r}static create(e,t){if(!e.hasModel())return null;const o=t.getState();if(!e.hasTextFocus()&&o.isRevealed&&o.searchString.length>0)return new MultiCursorSession(e,t,!1,o.searchString,o.wholeWord,o.matchCase,null);let i,n,s=!1;const r=e.getSelections();1===r.length&&r[0].isEmpty()?(s=!0,i=!0,n=!0):(i=o.wholeWord,n=o.matchCase);const l=e.getSelection();let c,a=null;if(l.isEmpty()){const t=e.getConfiguredWordAtPosition(l.getStartPosition());if(!t)return null;c=t.word,a=new Selection(l.startLineNumber,t.startColumn,l.startLineNumber,t.endColumn)}else c=e.getModel().getValueInRange(l).replace(/\r\n/g,"\n");return new MultiCursorSession(e,t,s,c,i,n,a)}addSelectionToNextFindMatch(){if(!this._editor.hasModel())return null;const e=this._getNextMatch();if(!e)return null;const t=this._editor.getSelections();return new MultiCursorSessionResult(t.concat(e),e,0)}moveSelectionToNextFindMatch(){if(!this._editor.hasModel())return null;const e=this._getNextMatch();if(!e)return null;const t=this._editor.getSelections();return new MultiCursorSessionResult(t.slice(0,t.length-1).concat(e),e,0)}_getNextMatch(){if(!this._editor.hasModel())return null;if(this.currentMatch){const e=this.currentMatch;return this.currentMatch=null,e}this.findController.highlightFindOptions();const e=this._editor.getSelections(),t=e[e.length-1],o=this._editor.getModel().findNextMatch(this.searchText,t.getEndPosition(),!1,this.matchCase,this.wholeWord?this._editor.getOption(117):null,!1);return o?new Selection(o.range.startLineNumber,o.range.startColumn,o.range.endLineNumber,o.range.endColumn):null}addSelectionToPreviousFindMatch(){if(!this._editor.hasModel())return null;const e=this._getPreviousMatch();if(!e)return null;const t=this._editor.getSelections();return new MultiCursorSessionResult(t.concat(e),e,0)}moveSelectionToPreviousFindMatch(){if(!this._editor.hasModel())return null;const e=this._getPreviousMatch();if(!e)return null;const t=this._editor.getSelections();return new MultiCursorSessionResult(t.slice(0,t.length-1).concat(e),e,0)}_getPreviousMatch(){if(!this._editor.hasModel())return null;if(this.currentMatch){const e=this.currentMatch;return this.currentMatch=null,e}this.findController.highlightFindOptions();const e=this._editor.getSelections(),t=e[e.length-1],o=this._editor.getModel().findPreviousMatch(this.searchText,t.getStartPosition(),!1,this.matchCase,this.wholeWord?this._editor.getOption(117):null,!1);return o?new Selection(o.range.startLineNumber,o.range.startColumn,o.range.endLineNumber,o.range.endColumn):null}selectAll(){return this._editor.hasModel()?(this.findController.highlightFindOptions(),this._editor.getModel().findMatches(this.searchText,!0,!1,this.matchCase,this.wholeWord?this._editor.getOption(117):null,!1,1073741824)):[]}}export class MultiCursorSelectionController extends Disposable{constructor(e){super(),this._sessionDispose=this._register(new DisposableStore),this._editor=e,this._ignoreSelectionChange=!1,this._session=null}static get(e){return e.getContribution(MultiCursorSelectionController.ID)}dispose(){this._endSession(),super.dispose()}_beginSessionIfNeeded(e){if(!this._session){const t=MultiCursorSession.create(this._editor,e);if(!t)return;this._session=t;const o={searchString:this._session.searchText};this._session.isDisconnectedFromFindController&&(o.wholeWordOverride=1,o.matchCaseOverride=1,o.isRegexOverride=2),e.getState().change(o,!1),this._sessionDispose.add(this._editor.onDidChangeCursorSelection((e=>{this._ignoreSelectionChange||this._endSession()}))),this._sessionDispose.add(this._editor.onDidBlurEditorText((()=>{this._endSession()}))),this._sessionDispose.add(e.getState().onFindReplaceStateChange((e=>{(e.matchCase||e.wholeWord)&&this._endSession()})))}}_endSession(){if(this._sessionDispose.clear(),this._session&&this._session.isDisconnectedFromFindController){const e={wholeWordOverride:0,matchCaseOverride:0,isRegexOverride:0};this._session.findController.getState().change(e,!1)}this._session=null}_setSelections(e){this._ignoreSelectionChange=!0,this._editor.setSelections(e),this._ignoreSelectionChange=!1}_expandEmptyToWord(e,t){if(!t.isEmpty())return t;const o=this._editor.getConfiguredWordAtPosition(t.getStartPosition());return o?new Selection(t.startLineNumber,o.startColumn,t.startLineNumber,o.endColumn):t}_applySessionResult(e){e&&(this._setSelections(e.selections),e.revealRange&&this._editor.revealRangeInCenterIfOutsideViewport(e.revealRange,e.revealScrollType))}getSession(e){return this._session}addSelectionToNextFindMatch(e){if(this._editor.hasModel()){if(!this._session){const t=this._editor.getSelections();if(t.length>1){const o=e.getState(),i=o.matchCase,n=modelRangesContainSameText(this._editor.getModel(),t,i);if(!n){const e=this._editor.getModel();let o=[];for(let i=0,n=t.length;i<n;i++)o[i]=this._expandEmptyToWord(e,t[i]);return void this._editor.setSelections(o)}}}this._beginSessionIfNeeded(e),this._session&&this._applySessionResult(this._session.addSelectionToNextFindMatch())}}addSelectionToPreviousFindMatch(e){this._beginSessionIfNeeded(e),this._session&&this._applySessionResult(this._session.addSelectionToPreviousFindMatch())}moveSelectionToNextFindMatch(e){this._beginSessionIfNeeded(e),this._session&&this._applySessionResult(this._session.moveSelectionToNextFindMatch())}moveSelectionToPreviousFindMatch(e){this._beginSessionIfNeeded(e),this._session&&this._applySessionResult(this._session.moveSelectionToPreviousFindMatch())}selectAll(e){if(!this._editor.hasModel())return;let t=null;const o=e.getState();if(o.isRevealed&&o.searchString.length>0&&o.isRegex)t=this._editor.getModel().findMatches(o.searchString,!0,o.isRegex,o.matchCase,o.wholeWord?this._editor.getOption(117):null,!1,1073741824);else{if(this._beginSessionIfNeeded(e),!this._session)return;t=this._session.selectAll()}if(o.searchScope){const e=o.searchScope;let i=[];t.forEach((t=>{e.forEach((e=>{t.range.endLineNumber<=e.endLineNumber&&t.range.startLineNumber>=e.startLineNumber&&i.push(t)}))})),t=i}if(t.length>0){const e=this._editor.getSelection();for(let o=0,i=t.length;o<i;o++){const i=t[o],n=i.range.intersectRanges(e);if(n){t[o]=t[0],t[0]=i;break}}this._setSelections(t.map((e=>new Selection(e.range.startLineNumber,e.range.startColumn,e.range.endLineNumber,e.range.endColumn))))}}}MultiCursorSelectionController.ID="editor.contrib.multiCursorController";export class MultiCursorSelectionControllerAction extends EditorAction{run(e,t){const o=MultiCursorSelectionController.get(t);if(!o)return;const i=CommonFindController.get(t);if(!i)return;const n=t._getViewModel();if(n){const e=n.getCursorStates();this._run(o,i),announceCursorChange(e,n.getCursorStates())}}}export class AddSelectionToNextFindMatchAction extends MultiCursorSelectionControllerAction{constructor(){super({id:"editor.action.addSelectionToNextFindMatch",label:nls.localize("addSelectionToNextFindMatch","Add Selection To Next Find Match"),alias:"Add Selection To Next Find Match",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.focus,primary:2082,weight:100},menuOpts:{menuId:MenuId.MenubarSelectionMenu,group:"3_multi",title:nls.localize({key:"miAddSelectionToNextFindMatch",comment:["&& denotes a mnemonic"]},"Add &&Next Occurrence"),order:5}})}_run(e,t){e.addSelectionToNextFindMatch(t)}}export class AddSelectionToPreviousFindMatchAction extends MultiCursorSelectionControllerAction{constructor(){super({id:"editor.action.addSelectionToPreviousFindMatch",label:nls.localize("addSelectionToPreviousFindMatch","Add Selection To Previous Find Match"),alias:"Add Selection To Previous Find Match",precondition:void 0,menuOpts:{menuId:MenuId.MenubarSelectionMenu,group:"3_multi",title:nls.localize({key:"miAddSelectionToPreviousFindMatch",comment:["&& denotes a mnemonic"]},"Add P&&revious Occurrence"),order:6}})}_run(e,t){e.addSelectionToPreviousFindMatch(t)}}export class MoveSelectionToNextFindMatchAction extends MultiCursorSelectionControllerAction{constructor(){super({id:"editor.action.moveSelectionToNextFindMatch",label:nls.localize("moveSelectionToNextFindMatch","Move Last Selection To Next Find Match"),alias:"Move Last Selection To Next Find Match",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.focus,primary:KeyChord(2089,2082),weight:100}})}_run(e,t){e.moveSelectionToNextFindMatch(t)}}export class MoveSelectionToPreviousFindMatchAction extends MultiCursorSelectionControllerAction{constructor(){super({id:"editor.action.moveSelectionToPreviousFindMatch",label:nls.localize("moveSelectionToPreviousFindMatch","Move Last Selection To Previous Find Match"),alias:"Move Last Selection To Previous Find Match",precondition:void 0})}_run(e,t){e.moveSelectionToPreviousFindMatch(t)}}export class SelectHighlightsAction extends MultiCursorSelectionControllerAction{constructor(){super({id:"editor.action.selectHighlights",label:nls.localize("selectAllOccurrencesOfFindMatch","Select All Occurrences of Find Match"),alias:"Select All Occurrences of Find Match",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.focus,primary:3114,weight:100},menuOpts:{menuId:MenuId.MenubarSelectionMenu,group:"3_multi",title:nls.localize({key:"miSelectHighlights",comment:["&& denotes a mnemonic"]},"Select All &&Occurrences"),order:7}})}_run(e,t){e.selectAll(t)}}export class CompatChangeAll extends MultiCursorSelectionControllerAction{constructor(){super({id:"editor.action.changeAll",label:nls.localize("changeAll.label","Change All Occurrences"),alias:"Change All Occurrences",precondition:ContextKeyExpr.and(EditorContextKeys.writable,EditorContextKeys.editorTextFocus),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:2108,weight:100},contextMenuOpts:{group:"1_modification",order:1.2}})}_run(e,t){e.selectAll(t)}}class SelectionHighlighterState{constructor(e,t,o,i,n){this._model=e,this._searchText=t,this._matchCase=o,this._wordSeparators=i,this._modelVersionId=this._model.getVersionId(),this._cachedFindMatches=null,n&&this._model===n._model&&this._searchText===n._searchText&&this._matchCase===n._matchCase&&this._wordSeparators===n._wordSeparators&&this._modelVersionId===n._modelVersionId&&(this._cachedFindMatches=n._cachedFindMatches)}findMatches(){return null===this._cachedFindMatches&&(this._cachedFindMatches=this._model.findMatches(this._searchText,!0,!1,this._matchCase,this._wordSeparators,!1).map((e=>e.range)),this._cachedFindMatches.sort(Range.compareRangesUsingStarts)),this._cachedFindMatches}}export class SelectionHighlighter extends Disposable{constructor(e){super(),this.editor=e,this._isEnabled=e.getOption(97),this.decorations=[],this.updateSoon=this._register(new RunOnceScheduler((()=>this._update()),300)),this.state=null,this._register(e.onDidChangeConfiguration((t=>{this._isEnabled=e.getOption(97)}))),this._register(e.onDidChangeCursorSelection((e=>{this._isEnabled&&(e.selection.isEmpty()?3===e.reason?(this.state&&this._setState(null),this.updateSoon.schedule()):this._setState(null):this._update())}))),this._register(e.onDidChangeModel((e=>{this._setState(null)}))),this._register(e.onDidChangeModelContent((e=>{this._isEnabled&&this.updateSoon.schedule()})));const t=CommonFindController.get(e);t&&this._register(t.getState().onFindReplaceStateChange((e=>{this._update()})))}_update(){this._setState(SelectionHighlighter._createState(this.state,this._isEnabled,this.editor))}static _createState(e,t,o){if(!t)return null;if(!o.hasModel())return null;const i=o.getSelection();if(i.startLineNumber!==i.endLineNumber)return null;const n=MultiCursorSelectionController.get(o);if(!n)return null;const s=CommonFindController.get(o);if(!s)return null;let r=n.getSession(s);if(!r){const e=o.getSelections();if(e.length>1){const t=s.getState(),i=t.matchCase,n=modelRangesContainSameText(o.getModel(),e,i);if(!n)return null}r=MultiCursorSession.create(o,s)}if(!r)return null;if(r.currentMatch)return null;if(/^[ \t]+$/.test(r.searchText))return null;if(r.searchText.length>200)return null;const l=s.getState(),c=l.matchCase;if(l.isRevealed){let e=l.searchString;c||(e=e.toLowerCase());let t=r.searchText;if(c||(t=t.toLowerCase()),e===t&&r.matchCase===l.matchCase&&r.wholeWord===l.wholeWord&&!l.isRegex)return null}return new SelectionHighlighterState(o.getModel(),r.searchText,r.matchCase,r.wholeWord?o.getOption(117):null,e)}_setState(e){if(this.state=e,!this.state)return void(this.decorations=this.editor.deltaDecorations(this.decorations,[]));if(!this.editor.hasModel())return;const t=this.editor.getModel();if(t.isTooLargeForTokenization())return;const o=this.state.findMatches(),i=this.editor.getSelections();i.sort(Range.compareRangesUsingStarts);const n=[];for(let l=0,c=0,a=o.length,d=i.length;l<a;){const e=o[l];if(c>=d)n.push(e),l++;else{const t=Range.compareRangesUsingStarts(e,i[c]);t<0?(!i[c].isEmpty()&&Range.areIntersecting(e,i[c])||n.push(e),l++):(t>0||l++,c++)}}const s=DocumentHighlightProviderRegistry.has(t)&&this.editor.getOption(72),r=n.map((e=>({range:e,options:s?SelectionHighlighter._SELECTION_HIGHLIGHT:SelectionHighlighter._SELECTION_HIGHLIGHT_OVERVIEW})));this.decorations=this.editor.deltaDecorations(this.decorations,r)}dispose(){this._setState(null),super.dispose()}}function modelRangesContainSameText(e,t,o){const i=getValueInRange(e,t[0],!o);for(let n=1,s=t.length;n<s;n++){const s=t[n];if(s.isEmpty())return!1;const r=getValueInRange(e,s,!o);if(i!==r)return!1}return!0}function getValueInRange(e,t,o){const i=e.getValueInRange(t);return o?i.toLowerCase():i}SelectionHighlighter.ID="editor.contrib.selectionHighlighter",SelectionHighlighter._SELECTION_HIGHLIGHT_OVERVIEW=ModelDecorationOptions.register({description:"selection-highlight-overview",stickiness:1,className:"selectionHighlight",minimap:{color:themeColorFromId(minimapSelectionOccurrenceHighlight),position:MinimapPosition.Inline},overviewRuler:{color:themeColorFromId(overviewRulerSelectionHighlightForeground),position:OverviewRulerLane.Center}}),SelectionHighlighter._SELECTION_HIGHLIGHT=ModelDecorationOptions.register({description:"selection-highlight",stickiness:1,className:"selectionHighlight"}),registerEditorContribution(MultiCursorSelectionController.ID,MultiCursorSelectionController),registerEditorContribution(SelectionHighlighter.ID,SelectionHighlighter),registerEditorAction(InsertCursorAbove),registerEditorAction(InsertCursorBelow),registerEditorAction(InsertCursorAtEndOfEachLineSelected),registerEditorAction(AddSelectionToNextFindMatchAction),registerEditorAction(AddSelectionToPreviousFindMatchAction),registerEditorAction(MoveSelectionToNextFindMatchAction),registerEditorAction(MoveSelectionToPreviousFindMatchAction),registerEditorAction(SelectHighlightsAction),registerEditorAction(CompatChangeAll),registerEditorAction(InsertCursorAtEndOfLineSelected),registerEditorAction(InsertCursorAtTopOfLineSelected);