var __decorate=this&&this.__decorate||function(i,e,t,o){var n,r=arguments.length,s=r<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,t):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(i,e,t,o);else for(var a=i.length-1;a>=0;a--)(n=i[a])&&(s=(r<3?n(s):r>3?n(e,t,s):n(e,t))||s);return r>3&&s&&Object.defineProperty(e,t,s),s},__param=this&&this.__param||function(i,e){return function(t,o){e(t,o,i)}},__awaiter=this&&this.__awaiter||function(i,e,t,o){function n(i){return i instanceof t?i:new t((function(e){e(i)}))}return new(t||(t=Promise))((function(t,r){function s(i){try{c(o.next(i))}catch(e){r(e)}}function a(i){try{c(o["throw"](i))}catch(e){r(e)}}function c(i){i.done?t(i.value):n(i.value).then(s,a)}c((o=o.apply(i,e||[])).next())}))};import{RunOnceScheduler}from"../../../../base/common/async.js";import{Codicon}from"../../../../base/common/codicons.js";import{Disposable}from"../../../../base/common/lifecycle.js";import*as platform from"../../../../base/common/platform.js";import{InvisibleCharacters}from"../../../../base/common/strings.js";import"./unicodeHighlighter.css";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{inUntrustedWorkspace,unicodeHighlightConfigKeys}from"../../../common/config/editorOptions.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";import{UnicodeTextModelHighlighter}from"../../../common/languages/unicodeTextModelHighlighter.js";import{IEditorWorkerService}from"../../../common/services/editorWorker.js";import{ILanguageService}from"../../../common/services/language.js";import{isModelDecorationInComment,isModelDecorationInString,isModelDecorationVisible}from"../../../common/viewModel/viewModelDecorations.js";import{MarkdownHover,renderMarkdownHovers}from"../../hover/browser/markdownHoverParticipant.js";import{BannerController}from"./bannerController.js";import*as nls from"../../../../nls.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";import{IQuickInputService}from"../../../../platform/quickinput/common/quickInput.js";import{registerIcon}from"../../../../platform/theme/common/iconRegistry.js";import{IWorkspaceTrustManagementService}from"../../../../platform/workspace/common/workspaceTrust.js";export const warningIcon=registerIcon("extensions-warning-message",Codicon.warning,nls.localize("warningIcon","Icon shown with a warning message in the extensions editor."));let UnicodeHighlighter=class extends Disposable{constructor(i,e,t,o){super(),this._editor=i,this._editorWorkerService=e,this._workspaceTrustService=t,this._highlighter=null,this._bannerClosed=!1,this._updateState=i=>{if(i&&i.hasMore){if(this._bannerClosed)return;const e=Math.max(i.ambiguousCharacterCount,i.nonBasicAsciiCharacterCount,i.invisibleCharacterCount);let t;if(i.nonBasicAsciiCharacterCount>=e)t={message:nls.localize("unicodeHighlighting.thisDocumentHasManyNonBasicAsciiUnicodeCharacters","This document contains many non-basic ASCII unicode characters"),command:new DisableHighlightingOfNonBasicAsciiCharactersAction};else if(i.ambiguousCharacterCount>=e)t={message:nls.localize("unicodeHighlighting.thisDocumentHasManyAmbiguousUnicodeCharacters","This document contains many ambiguous unicode characters"),command:new DisableHighlightingOfAmbiguousCharactersAction};else{if(!(i.invisibleCharacterCount>=e))throw new Error("Unreachable");t={message:nls.localize("unicodeHighlighting.thisDocumentHasManyInvisibleUnicodeCharacters","This document contains many invisible unicode characters"),command:new DisableHighlightingOfInvisibleCharactersAction}}this._bannerController.show({id:"unicodeHighlightBanner",message:t.message,icon:warningIcon,actions:[{label:t.command.shortLabel,href:`command:${t.command.id}`}],onClose:()=>{this._bannerClosed=!0}})}else this._bannerController.hide()},this._bannerController=this._register(o.createInstance(BannerController,i)),this._register(this._editor.onDidChangeModel((()=>{this._bannerClosed=!1,this._updateHighlighter()}))),this._options=i.getOption(113),this._register(t.onDidChangeTrust((i=>{this._updateHighlighter()}))),this._register(i.onDidChangeConfiguration((e=>{e.hasChanged(113)&&(this._options=i.getOption(113),this._updateHighlighter())}))),this._updateHighlighter()}dispose(){this._highlighter&&(this._highlighter.dispose(),this._highlighter=null),super.dispose()}_updateHighlighter(){if(this._updateState(null),this._highlighter&&(this._highlighter.dispose(),this._highlighter=null),!this._editor.hasModel())return;const i=resolveOptions(this._workspaceTrustService.isWorkspaceTrusted(),this._options);if([i.nonBasicASCII,i.ambiguousCharacters,i.invisibleCharacters].every((i=>!1===i)))return;const e={nonBasicASCII:i.nonBasicASCII,ambiguousCharacters:i.ambiguousCharacters,invisibleCharacters:i.invisibleCharacters,includeComments:i.includeComments,includeStrings:i.includeStrings,allowedCodePoints:Object.keys(i.allowedCharacters).map((i=>i.codePointAt(0))),allowedLocales:Object.keys(i.allowedLocales).map((i=>{if("_os"===i){let i=(new Intl.NumberFormat).resolvedOptions().locale;return i}return"_vscode"===i?platform.language:i}))};this._editorWorkerService.canComputeUnicodeHighlights(this._editor.getModel().uri)?this._highlighter=new DocumentUnicodeHighlighter(this._editor,e,this._updateState,this._editorWorkerService):this._highlighter=new ViewportUnicodeHighlighter(this._editor,e,this._updateState)}getDecorationInfo(i){return this._highlighter?this._highlighter.getDecorationInfo(i):null}};UnicodeHighlighter.ID="editor.contrib.unicodeHighlighter",UnicodeHighlighter=__decorate([__param(1,IEditorWorkerService),__param(2,IWorkspaceTrustManagementService),__param(3,IInstantiationService)],UnicodeHighlighter);export{UnicodeHighlighter};function resolveOptions(i,e){return{nonBasicASCII:e.nonBasicASCII===inUntrustedWorkspace?!i:e.nonBasicASCII,ambiguousCharacters:e.ambiguousCharacters,invisibleCharacters:e.invisibleCharacters,includeComments:e.includeComments===inUntrustedWorkspace?!i:e.includeComments,includeStrings:e.includeStrings===inUntrustedWorkspace?!i:e.includeStrings,allowedCharacters:e.allowedCharacters,allowedLocales:e.allowedLocales}}let DocumentUnicodeHighlighter=class extends Disposable{constructor(i,e,t,o){super(),this._editor=i,this._options=e,this._updateState=t,this._editorWorkerService=o,this._model=this._editor.getModel(),this._decorationIds=new Set,this._updateSoon=this._register(new RunOnceScheduler((()=>this._update()),250)),this._register(this._editor.onDidChangeModelContent((()=>{this._updateSoon.schedule()}))),this._updateSoon.schedule()}dispose(){this._decorationIds=new Set(this._model.deltaDecorations(Array.from(this._decorationIds),[])),super.dispose()}_update(){if(this._model.isDisposed())return;if(!this._model.mightContainNonBasicASCII())return void(this._decorationIds=new Set(this._editor.deltaDecorations(Array.from(this._decorationIds),[])));const i=this._model.getVersionId();this._editorWorkerService.computedUnicodeHighlights(this._model.uri,this._options).then((e=>{if(this._model.isDisposed())return;if(this._model.getVersionId()!==i)return;this._updateState(e);const t=[];if(!e.hasMore)for(const i of e.ranges)t.push({range:i,options:Decorations.instance.getDecorationFromOptions(this._options)});this._decorationIds=new Set(this._editor.deltaDecorations(Array.from(this._decorationIds),t))}))}getDecorationInfo(i){if(!this._decorationIds.has(i))return null;const e=this._editor.getModel(),t=e.getDecorationRange(i),o={range:t,options:Decorations.instance.getDecorationFromOptions(this._options),id:i,ownerId:0};if(!isModelDecorationVisible(e,o))return null;const n=e.getValueInRange(t);return{reason:computeReason(n,this._options),inComment:isModelDecorationInComment(e,o),inString:isModelDecorationInString(e,o)}}};DocumentUnicodeHighlighter=__decorate([__param(3,IEditorWorkerService)],DocumentUnicodeHighlighter);class ViewportUnicodeHighlighter extends Disposable{constructor(i,e,t){super(),this._editor=i,this._options=e,this._updateState=t,this._model=this._editor.getModel(),this._decorationIds=new Set,this._updateSoon=this._register(new RunOnceScheduler((()=>this._update()),250)),this._register(this._editor.onDidLayoutChange((()=>{this._updateSoon.schedule()}))),this._register(this._editor.onDidScrollChange((()=>{this._updateSoon.schedule()}))),this._register(this._editor.onDidChangeHiddenAreas((()=>{this._updateSoon.schedule()}))),this._register(this._editor.onDidChangeModelContent((()=>{this._updateSoon.schedule()}))),this._updateSoon.schedule()}dispose(){this._decorationIds=new Set(this._model.deltaDecorations(Array.from(this._decorationIds),[])),super.dispose()}_update(){if(this._model.isDisposed())return;if(!this._model.mightContainNonBasicASCII())return void(this._decorationIds=new Set(this._editor.deltaDecorations(Array.from(this._decorationIds),[])));const i=this._editor.getVisibleRanges(),e=[],t={ranges:[],ambiguousCharacterCount:0,invisibleCharacterCount:0,nonBasicAsciiCharacterCount:0,hasMore:!1};for(const o of i){const i=UnicodeTextModelHighlighter.computeUnicodeHighlights(this._model,this._options,o);for(const e of i.ranges)t.ranges.push(e);t.ambiguousCharacterCount+=t.ambiguousCharacterCount,t.invisibleCharacterCount+=t.invisibleCharacterCount,t.nonBasicAsciiCharacterCount+=t.nonBasicAsciiCharacterCount,t.hasMore=t.hasMore||i.hasMore}if(!t.hasMore)for(const o of t.ranges)e.push({range:o,options:Decorations.instance.getDecorationFromOptions(this._options)});this._updateState(t),this._decorationIds=new Set(this._editor.deltaDecorations(Array.from(this._decorationIds),e))}getDecorationInfo(i){if(!this._decorationIds.has(i))return null;const e=this._editor.getModel(),t=e.getDecorationRange(i),o=e.getValueInRange(t),n={range:t,options:Decorations.instance.getDecorationFromOptions(this._options),id:i,ownerId:0};return isModelDecorationVisible(e,n)?{reason:computeReason(o,this._options),inComment:isModelDecorationInComment(e,n),inString:isModelDecorationInString(e,n)}:null}}let UnicodeHighlighterHoverParticipant=class{constructor(i,e,t){this._editor=i,this._languageService=e,this._openerService=t}computeSync(i,e){if(!this._editor.hasModel()||1!==i.type)return[];const t=this._editor.getModel(),o=this._editor.getContribution(UnicodeHighlighter.ID);if(!o)return[];const n=[];let r=300;for(const s of e){const i=o.getDecorationInfo(s.id);if(!i)continue;const e=t.getValueInRange(s.range),a=e.codePointAt(0),c=formatCodePointMarkdown(a);let h;switch(i.reason.kind){case 0:h=nls.localize("unicodeHighlight.characterIsAmbiguous","The character {0} could be confused with the character {1}, which is more common in source code.",c,formatCodePointMarkdown(i.reason.confusableWith.codePointAt(0)));break;case 1:h=nls.localize("unicodeHighlight.characterIsInvisible","The character {0} is invisible.",c);break;case 2:h=nls.localize("unicodeHighlight.characterIsNonBasicAscii","The character {0} is not a basic ASCII character.",c);break}const l={codePoint:a,reason:i.reason,inComment:i.inComment,inString:i.inString},g=nls.localize("unicodeHighlight.adjustSettings","Adjust settings"),d=[{value:`${h} [${g}](command:${ShowExcludeOptions.ID}?${encodeURIComponent(JSON.stringify(l))})`,isTrusted:!0}];n.push(new MarkdownHover(this,s.range,d,r++))}return n}renderHoverParts(i,e){return renderMarkdownHovers(i,e,this._editor,this._languageService,this._openerService)}};UnicodeHighlighterHoverParticipant=__decorate([__param(1,ILanguageService),__param(2,IOpenerService)],UnicodeHighlighterHoverParticipant);export{UnicodeHighlighterHoverParticipant};function codePointToHex(i){return`U+${i.toString(16).padStart(4,"0")}`}function formatCodePointMarkdown(i){let e=`\`${codePointToHex(i)}\``;return InvisibleCharacters.isInvisibleCharacter(i)||(e+=` "${renderCodePointAsInlineCode(i)}"`),e}function renderCodePointAsInlineCode(i){return 96===i?"`` ` ``":"`"+String.fromCodePoint(i)+"`"}function computeReason(i,e){return UnicodeTextModelHighlighter.computeUnicodeHighlightReason(i,e)}class Decorations{constructor(){this.map=new Map}getDecorationFromOptions(i){return this.getDecoration(!i.includeComments,!i.includeStrings)}getDecoration(i,e){const t=`${i}${e}`;let o=this.map.get(t);return o||(o=ModelDecorationOptions.createDynamic({description:"unicode-highlight",stickiness:1,className:"unicode-highlight",showIfCollapsed:!0,overviewRuler:null,minimap:null,hideInCommentTokens:i,hideInStringTokens:e}),this.map.set(t,o)),o}}Decorations.instance=new Decorations;export class DisableHighlightingInCommentsAction extends EditorAction{constructor(){super({id:DisableHighlightingOfAmbiguousCharactersAction.ID,label:nls.localize("action.unicodeHighlight.disableHighlightingInComments","Disable highlighting of characters in comments"),alias:"Disable highlighting of characters in comments",precondition:void 0}),this.shortLabel=nls.localize("unicodeHighlight.disableHighlightingInComments.shortLabel","Disable Highlight In Comments")}run(i,e,t){return __awaiter(this,void 0,void 0,(function*(){let e=null===i||void 0===i?void 0:i.get(IConfigurationService);e&&this.runAction(e)}))}runAction(i){return __awaiter(this,void 0,void 0,(function*(){yield i.updateValue(unicodeHighlightConfigKeys.includeComments,!1,1)}))}}export class DisableHighlightingInStringsAction extends EditorAction{constructor(){super({id:DisableHighlightingOfAmbiguousCharactersAction.ID,label:nls.localize("action.unicodeHighlight.disableHighlightingInStrings","Disable highlighting of characters in strings"),alias:"Disable highlighting of characters in strings",precondition:void 0}),this.shortLabel=nls.localize("unicodeHighlight.disableHighlightingInStrings.shortLabel","Disable Highlight In Strings")}run(i,e,t){return __awaiter(this,void 0,void 0,(function*(){let e=null===i||void 0===i?void 0:i.get(IConfigurationService);e&&this.runAction(e)}))}runAction(i){return __awaiter(this,void 0,void 0,(function*(){yield i.updateValue(unicodeHighlightConfigKeys.includeStrings,!1,1)}))}}export class DisableHighlightingOfAmbiguousCharactersAction extends EditorAction{constructor(){super({id:DisableHighlightingOfAmbiguousCharactersAction.ID,label:nls.localize("action.unicodeHighlight.disableHighlightingOfAmbiguousCharacters","Disable highlighting of ambiguous characters"),alias:"Disable highlighting of ambiguous characters",precondition:void 0}),this.shortLabel=nls.localize("unicodeHighlight.disableHighlightingOfAmbiguousCharacters.shortLabel","Disable Ambiguous Highlight")}run(i,e,t){return __awaiter(this,void 0,void 0,(function*(){let e=null===i||void 0===i?void 0:i.get(IConfigurationService);e&&this.runAction(e)}))}runAction(i){return __awaiter(this,void 0,void 0,(function*(){yield i.updateValue(unicodeHighlightConfigKeys.ambiguousCharacters,!1,1)}))}}DisableHighlightingOfAmbiguousCharactersAction.ID="editor.action.unicodeHighlight.disableHighlightingOfAmbiguousCharacters";export class DisableHighlightingOfInvisibleCharactersAction extends EditorAction{constructor(){super({id:DisableHighlightingOfInvisibleCharactersAction.ID,label:nls.localize("action.unicodeHighlight.disableHighlightingOfInvisibleCharacters","Disable highlighting of invisible characters"),alias:"Disable highlighting of invisible characters",precondition:void 0}),this.shortLabel=nls.localize("unicodeHighlight.disableHighlightingOfInvisibleCharacters.shortLabel","Disable Invisible Highlight")}run(i,e,t){return __awaiter(this,void 0,void 0,(function*(){let e=null===i||void 0===i?void 0:i.get(IConfigurationService);e&&this.runAction(e)}))}runAction(i){return __awaiter(this,void 0,void 0,(function*(){yield i.updateValue(unicodeHighlightConfigKeys.invisibleCharacters,!1,1)}))}}DisableHighlightingOfInvisibleCharactersAction.ID="editor.action.unicodeHighlight.disableHighlightingOfInvisibleCharacters";export class DisableHighlightingOfNonBasicAsciiCharactersAction extends EditorAction{constructor(){super({id:DisableHighlightingOfNonBasicAsciiCharactersAction.ID,label:nls.localize("action.unicodeHighlight.disableHighlightingOfNonBasicAsciiCharacters","Disable highlighting of non basic ASCII characters"),alias:"Disable highlighting of non basic ASCII characters",precondition:void 0}),this.shortLabel=nls.localize("unicodeHighlight.disableHighlightingOfNonBasicAsciiCharacters.shortLabel","Disable Non ASCII Highlight")}run(i,e,t){return __awaiter(this,void 0,void 0,(function*(){let e=null===i||void 0===i?void 0:i.get(IConfigurationService);e&&this.runAction(e)}))}runAction(i){return __awaiter(this,void 0,void 0,(function*(){yield i.updateValue(unicodeHighlightConfigKeys.nonBasicASCII,!1,1)}))}}DisableHighlightingOfNonBasicAsciiCharactersAction.ID="editor.action.unicodeHighlight.disableHighlightingOfNonBasicAsciiCharacters";export class ShowExcludeOptions extends EditorAction{constructor(){super({id:ShowExcludeOptions.ID,label:nls.localize("action.unicodeHighlight.showExcludeOptions","Show Exclude Options"),alias:"Show Exclude Options",precondition:void 0})}run(i,e,t){return __awaiter(this,void 0,void 0,(function*(){const{codePoint:e,reason:o,inString:n,inComment:r}=t,s=String.fromCodePoint(e),a=i.get(IQuickInputService),c=i.get(IConfigurationService);function h(i){return InvisibleCharacters.isInvisibleCharacter(i)?nls.localize("unicodeHighlight.excludeInvisibleCharFromBeingHighlighted","Exclude {0} (invisible character) from being highlighted",codePointToHex(i)):nls.localize("unicodeHighlight.excludeCharFromBeingHighlighted","Exclude {0} from being highlighted",`${codePointToHex(i)} "${s}"`)}const l=[];if(0===o.kind)for(const i of o.notAmbiguousInLocales)l.push({label:nls.localize("unicodeHighlight.allowCommonCharactersInLanguage",'Allow unicode characters that are more common in the language "{0}".',i),run:()=>__awaiter(this,void 0,void 0,(function*(){excludeLocaleFromBeingHighlighted(c,[i])}))});if(l.push({label:h(e),run:()=>excludeCharFromBeingHighlighted(c,[e])}),r){const i=new DisableHighlightingInCommentsAction;l.push({label:i.label,run:()=>__awaiter(this,void 0,void 0,(function*(){return i.runAction(c)}))})}else if(n){const i=new DisableHighlightingInStringsAction;l.push({label:i.label,run:()=>__awaiter(this,void 0,void 0,(function*(){return i.runAction(c)}))})}if(0===o.kind){const i=new DisableHighlightingOfAmbiguousCharactersAction;l.push({label:i.label,run:()=>__awaiter(this,void 0,void 0,(function*(){return i.runAction(c)}))})}else if(1===o.kind){const i=new DisableHighlightingOfInvisibleCharactersAction;l.push({label:i.label,run:()=>__awaiter(this,void 0,void 0,(function*(){return i.runAction(c)}))})}else if(2===o.kind){const i=new DisableHighlightingOfNonBasicAsciiCharactersAction;l.push({label:i.label,run:()=>__awaiter(this,void 0,void 0,(function*(){return i.runAction(c)}))})}else expectNever(o);const g=yield a.pick(l,{title:nls.localize("unicodeHighlight.configureUnicodeHighlightOptions","Configure Unicode Highlight Options")});g&&(yield g.run())}))}}function excludeCharFromBeingHighlighted(i,e){return __awaiter(this,void 0,void 0,(function*(){const t=i.getValue(unicodeHighlightConfigKeys.allowedCharacters);let o;o="object"===typeof t&&t?t:{};for(const i of e)o[String.fromCodePoint(i)]=!0;yield i.updateValue(unicodeHighlightConfigKeys.allowedCharacters,o,1)}))}function excludeLocaleFromBeingHighlighted(i,e){var t;return __awaiter(this,void 0,void 0,(function*(){const o=null===(t=i.inspect(unicodeHighlightConfigKeys.allowedLocales).user)||void 0===t?void 0:t.value;let n;n="object"===typeof o&&o?Object.assign({},o):{};for(const i of e)n[i]=!0;yield i.updateValue(unicodeHighlightConfigKeys.allowedLocales,n,1)}))}function expectNever(i){throw new Error(`Unexpected value: ${i}`)}ShowExcludeOptions.ID="editor.action.unicodeHighlight.showExcludeOptions",registerEditorAction(DisableHighlightingOfAmbiguousCharactersAction),registerEditorAction(DisableHighlightingOfInvisibleCharactersAction),registerEditorAction(DisableHighlightingOfNonBasicAsciiCharactersAction),registerEditorAction(ShowExcludeOptions),registerEditorContribution(UnicodeHighlighter.ID,UnicodeHighlighter);