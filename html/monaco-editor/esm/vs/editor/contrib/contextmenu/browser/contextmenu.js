var __decorate=this&&this.__decorate||function(t,e,o,i){var n,r=arguments.length,s=r<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,o):i;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(t,e,o,i);else for(var c=t.length-1;c>=0;c--)(n=t[c])&&(s=(r<3?n(s):r>3?n(e,o,s):n(e,o))||s);return r>3&&s&&Object.defineProperty(e,o,s),s},__param=this&&this.__param||function(t,e){return function(o,i){e(o,i,t)}};import*as dom from"../../../../base/browser/dom.js";import{ActionViewItem}from"../../../../base/browser/ui/actionbar/actionViewItems.js";import{Separator,SubmenuAction}from"../../../../base/common/actions.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{isIOS}from"../../../../base/common/platform.js";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import*as nls from"../../../../nls.js";import{IMenuService,MenuId,SubmenuItemAction}from"../../../../platform/actions/common/actions.js";import{IContextKeyService}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService,IContextViewService}from"../../../../platform/contextview/browser/contextView.js";import{IKeybindingService}from"../../../../platform/keybinding/common/keybinding.js";let ContextMenuController=class t{constructor(t,e,o,i,n,r){this._contextMenuService=e,this._contextViewService=o,this._contextKeyService=i,this._keybindingService=n,this._menuService=r,this._toDispose=new DisposableStore,this._contextMenuIsBeingShownCount=0,this._editor=t,this._toDispose.add(this._editor.onContextMenu((t=>this._onContextMenu(t)))),this._toDispose.add(this._editor.onMouseWheel((t=>{if(this._contextMenuIsBeingShownCount>0){const e=this._contextViewService.getContextViewElement(),o=t.srcElement;o.shadowRoot&&dom.getShadowRoot(e)===o.shadowRoot||this._contextViewService.hideContextView()}}))),this._toDispose.add(this._editor.onKeyDown((t=>{58===t.keyCode&&(t.preventDefault(),t.stopPropagation(),this.showContextMenu())})))}static get(e){return e.getContribution(t.ID)}_onContextMenu(t){if(!this._editor.hasModel())return;if(!this._editor.getOption(20))return this._editor.focus(),void(t.target.position&&!this._editor.getSelection().containsPosition(t.target.position)&&this._editor.setPosition(t.target.position));if(12===t.target.type)return;if(6===t.target.type&&t.target.detail.injectedText)return;if(t.event.preventDefault(),t.event.stopPropagation(),6!==t.target.type&&7!==t.target.type&&1!==t.target.type)return;if(this._editor.focus(),t.target.position){let e=!1;for(const o of this._editor.getSelections())if(o.containsPosition(t.target.position)){e=!0;break}e||this._editor.setPosition(t.target.position)}let e=null;1!==t.target.type&&(e={x:t.event.posx-1,width:2,y:t.event.posy-1,height:2}),this.showContextMenu(e)}showContextMenu(t){if(!this._editor.getOption(20))return;if(!this._editor.hasModel())return;if(!this._contextMenuService)return void this._editor.focus();const e=this._getMenuActions(this._editor.getModel(),this._editor.isSimpleWidget?MenuId.SimpleEditorContext:MenuId.EditorContext);e.length>0&&this._doShowContextMenu(e,t)}_getMenuActions(t,e){const o=[],i=this._menuService.createMenu(e,this._contextKeyService),n=i.getActions({arg:t.uri});i.dispose();for(let r of n){const[,e]=r;let i=0;for(const n of e)if(n instanceof SubmenuItemAction){const e=this._getMenuActions(t,n.item.submenu);e.length>0&&(o.push(new SubmenuAction(n.id,n.label,e)),i++)}else o.push(n),i++;i&&o.push(new Separator)}return o.length&&o.pop(),o}_doShowContextMenu(t,e=null){if(!this._editor.hasModel())return;const o=this._editor.getOption(53);if(this._editor.updateOptions({hover:{enabled:!1}}),!e){this._editor.revealPosition(this._editor.getPosition(),1),this._editor.render();const t=this._editor.getScrolledVisiblePosition(this._editor.getPosition()),o=dom.getDomNodePagePosition(this._editor.getDomNode()),i=o.left+t.left,n=o.top+t.top+t.height;e={x:i,y:n}}const i=this._editor.getOption(115)&&!isIOS;this._contextMenuIsBeingShownCount++,this._contextMenuService.showContextMenu({domForShadowRoot:i?this._editor.getDomNode():void 0,getAnchor:()=>e,getActions:()=>t,getActionViewItem:t=>{const e=this._keybindingFor(t);if(e)return new ActionViewItem(t,t,{label:!0,keybinding:e.getLabel(),isMenu:!0});const o=t;return"function"===typeof o.getActionViewItem?o.getActionViewItem():new ActionViewItem(t,t,{icon:!0,label:!0,isMenu:!0})},getKeyBinding:t=>this._keybindingFor(t),onHide:t=>{this._contextMenuIsBeingShownCount--,this._editor.focus(),this._editor.updateOptions({hover:o})}})}_keybindingFor(t){return this._keybindingService.lookupKeybinding(t.id)}dispose(){this._contextMenuIsBeingShownCount>0&&this._contextViewService.hideContextView(),this._toDispose.dispose()}};ContextMenuController.ID="editor.contrib.contextmenu",ContextMenuController=__decorate([__param(1,IContextMenuService),__param(2,IContextViewService),__param(3,IContextKeyService),__param(4,IKeybindingService),__param(5,IMenuService)],ContextMenuController);export{ContextMenuController};class ShowContextMenu extends EditorAction{constructor(){super({id:"editor.action.showContextMenu",label:nls.localize("action.showContextMenu.label","Show Editor Context Menu"),alias:"Show Editor Context Menu",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.textInputFocus,primary:1092,weight:100}})}run(t,e){var o;null===(o=ContextMenuController.get(e))||void 0===o||o.showContextMenu()}}registerEditorContribution(ContextMenuController.ID,ContextMenuController),registerEditorAction(ShowContextMenu);