export class Scanner{constructor(){this.value="",this.pos=0}static isDigitCharacter(e){return e>=48&&e<=57}static isVariableCharacter(e){return 95===e||e>=97&&e<=122||e>=65&&e<=90}text(e){this.value=e,this.pos=0}tokenText(e){return this.value.substr(e.pos,e.len)}next(){if(this.pos>=this.value.length)return{type:14,pos:this.pos,len:0};let e,t=this.pos,r=0,i=this.value.charCodeAt(t);if(e=Scanner._table[i],"number"===typeof e)return this.pos+=1,{type:e,pos:t,len:1};if(Scanner.isDigitCharacter(i)){e=8;do{r+=1,i=this.value.charCodeAt(t+r)}while(Scanner.isDigitCharacter(i));return this.pos+=r,{type:e,pos:t,len:r}}if(Scanner.isVariableCharacter(i)){e=9;do{i=this.value.charCodeAt(t+ ++r)}while(Scanner.isVariableCharacter(i)||Scanner.isDigitCharacter(i));return this.pos+=r,{type:e,pos:t,len:r}}e=10;do{r+=1,i=this.value.charCodeAt(t+r)}while(!isNaN(i)&&"undefined"===typeof Scanner._table[i]&&!Scanner.isDigitCharacter(i)&&!Scanner.isVariableCharacter(i));return this.pos+=r,{type:e,pos:t,len:r}}}Scanner._table={[36]:0,[58]:1,[44]:2,[123]:3,[125]:4,[92]:5,[47]:6,[124]:7,[43]:11,[45]:12,[63]:13};export class Marker{constructor(){this._children=[]}appendChild(e){return e instanceof Text&&this._children[this._children.length-1]instanceof Text?this._children[this._children.length-1].value+=e.value:(e.parent=this,this._children.push(e)),this}replace(e,t){const{parent:r}=e,i=r.children.indexOf(e),s=r.children.slice(0);s.splice(i,1,...t),r._children=s,function e(t,r){for(const i of t)i.parent=r,e(i.children,i)}(t,r)}get children(){return this._children}get snippet(){let e=this;while(1){if(!e)return;if(e instanceof TextmateSnippet)return e;e=e.parent}}toString(){return this.children.reduce(((e,t)=>e+t.toString()),"")}len(){return 0}}export class Text extends Marker{constructor(e){super(),this.value=e}toString(){return this.value}len(){return this.value.length}clone(){return new Text(this.value)}}export class TransformableMarker extends Marker{}export class Placeholder extends TransformableMarker{constructor(e){super(),this.index=e}static compareByIndex(e,t){return e.index===t.index?0:e.isFinalTabstop?1:t.isFinalTabstop||e.index<t.index?-1:e.index>t.index?1:0}get isFinalTabstop(){return 0===this.index}get choice(){return 1===this._children.length&&this._children[0]instanceof Choice?this._children[0]:void 0}clone(){let e=new Placeholder(this.index);return this.transform&&(e.transform=this.transform.clone()),e._children=this.children.map((e=>e.clone())),e}}export class Choice extends Marker{constructor(){super(...arguments),this.options=[]}appendChild(e){return e instanceof Text&&(e.parent=this,this.options.push(e)),this}toString(){return this.options[0].value}len(){return this.options[0].len()}clone(){let e=new Choice;return this.options.forEach(e.appendChild,e),e}}export class Transform extends Marker{constructor(){super(...arguments),this.regexp=new RegExp("")}resolve(e){const t=this;let r=!1,i=e.replace(this.regexp,(function(){return r=!0,t._replace(Array.prototype.slice.call(arguments,0,-2))}));return!r&&this._children.some((e=>e instanceof FormatString&&Boolean(e.elseValue)))&&(i=this._replace([])),i}_replace(e){let t="";for(const r of this._children)if(r instanceof FormatString){let i=e[r.index]||"";i=r.resolve(i),t+=i}else t+=r.toString();return t}toString(){return""}clone(){let e=new Transform;return e.regexp=new RegExp(this.regexp.source,(this.regexp.ignoreCase?"i":"")+(this.regexp.global?"g":"")),e._children=this.children.map((e=>e.clone())),e}}export class FormatString extends Marker{constructor(e,t,r,i){super(),this.index=e,this.shorthandName=t,this.ifValue=r,this.elseValue=i}resolve(e){return"upcase"===this.shorthandName?e?e.toLocaleUpperCase():"":"downcase"===this.shorthandName?e?e.toLocaleLowerCase():"":"capitalize"===this.shorthandName?e?e[0].toLocaleUpperCase()+e.substr(1):"":"pascalcase"===this.shorthandName?e?this._toPascalCase(e):"":"camelcase"===this.shorthandName?e?this._toCamelCase(e):"":Boolean(e)&&"string"===typeof this.ifValue?this.ifValue:Boolean(e)||"string"!==typeof this.elseValue?e||"":this.elseValue}_toPascalCase(e){const t=e.match(/[a-z0-9]+/gi);return t?t.map((e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())).join(""):e}_toCamelCase(e){const t=e.match(/[a-z0-9]+/gi);return t?t.map(((e,t)=>0===t?e.toLowerCase():e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())).join(""):e}clone(){let e=new FormatString(this.index,this.shorthandName,this.ifValue,this.elseValue);return e}}export class Variable extends TransformableMarker{constructor(e){super(),this.name=e}resolve(e){let t=e.resolve(this);return this.transform&&(t=this.transform.resolve(t||"")),void 0!==t&&(this._children=[new Text(t)],!0)}clone(){const e=new Variable(this.name);return this.transform&&(e.transform=this.transform.clone()),e._children=this.children.map((e=>e.clone())),e}}function walk(e,t){const r=[...e];while(r.length>0){const e=r.shift(),i=t(e);if(!i)break;r.unshift(...e.children)}}export class TextmateSnippet extends Marker{get placeholderInfo(){if(!this._placeholders){let e,t=[];this.walk((function(r){return r instanceof Placeholder&&(t.push(r),e=!e||e.index<r.index?r:e),!0})),this._placeholders={all:t,last:e}}return this._placeholders}get placeholders(){const{all:e}=this.placeholderInfo;return e}offset(e){let t=0,r=!1;return this.walk((i=>i===e?(r=!0,!1):(t+=i.len(),!0))),r?t:-1}fullLen(e){let t=0;return walk([e],(e=>(t+=e.len(),!0))),t}enclosingPlaceholders(e){let t=[],{parent:r}=e;while(r)r instanceof Placeholder&&t.push(r),r=r.parent;return t}resolveVariables(e){return this.walk((t=>(t instanceof Variable&&t.resolve(e)&&(this._placeholders=void 0),!0))),this}appendChild(e){return this._placeholders=void 0,super.appendChild(e)}replace(e,t){return this._placeholders=void 0,super.replace(e,t)}clone(){let e=new TextmateSnippet;return this._children=this.children.map((e=>e.clone())),e}walk(e){walk(this.children,e)}}export class SnippetParser{constructor(){this._scanner=new Scanner,this._token={type:14,pos:0,len:0}}static escape(e){return e.replace(/\$|}|\\/g,"\\$&")}static guessNeedsClipboard(e){return/\${?CLIPBOARD/.test(e)}parse(e,t,r){this._scanner.text(e),this._token=this._scanner.next();const i=new TextmateSnippet;while(this._parse(i));const s=new Map,n=[];let a=0;i.walk((e=>(e instanceof Placeholder&&(a+=1,e.isFinalTabstop?s.set(0,void 0):!s.has(e.index)&&e.children.length>0?s.set(e.index,e.children):n.push(e)),!0)));for(const h of n){const e=s.get(h.index);if(e){const t=new Placeholder(h.index);t.transform=h.transform;for(const r of e)t.appendChild(r.clone());i.replace(h,[t])}}return r||(r=a>0&&t),!s.has(0)&&r&&i.appendChild(new Placeholder(0)),i}_accept(e,t){if(void 0===e||this._token.type===e){let e=!t||this._scanner.tokenText(this._token);return this._token=this._scanner.next(),e}return!1}_backTo(e){return this._scanner.pos=e.pos+e.len,this._token=e,!1}_until(e){const t=this._token;while(this._token.type!==e){if(14===this._token.type)return!1;if(5===this._token.type){const e=this._scanner.next();if(0!==e.type&&4!==e.type&&5!==e.type)return!1}this._token=this._scanner.next()}const r=this._scanner.value.substring(t.pos,this._token.pos).replace(/\\(\$|}|\\)/g,"$1");return this._token=this._scanner.next(),r}_parse(e){return this._parseEscaped(e)||this._parseTabstopOrVariableName(e)||this._parseComplexPlaceholder(e)||this._parseComplexVariable(e)||this._parseAnything(e)}_parseEscaped(e){let t;return!!(t=this._accept(5,!0))&&(t=this._accept(0,!0)||this._accept(4,!0)||this._accept(5,!0)||t,e.appendChild(new Text(t)),!0)}_parseTabstopOrVariableName(e){let t;const r=this._token,i=this._accept(0)&&(t=this._accept(9,!0)||this._accept(8,!0));return i?(e.appendChild(/^\d+$/.test(t)?new Placeholder(Number(t)):new Variable(t)),!0):this._backTo(r)}_parseComplexPlaceholder(e){let t;const r=this._token,i=this._accept(0)&&this._accept(3)&&(t=this._accept(8,!0));if(!i)return this._backTo(r);const s=new Placeholder(Number(t));if(this._accept(1))while(1){if(this._accept(4))return e.appendChild(s),!0;if(!this._parse(s))return e.appendChild(new Text("${"+t+":")),s.children.forEach(e.appendChild,e),!0}else{if(!(s.index>0&&this._accept(7)))return this._accept(6)?this._parseTransform(s)?(e.appendChild(s),!0):(this._backTo(r),!1):this._accept(4)?(e.appendChild(s),!0):this._backTo(r);{const t=new Choice;while(1){if(this._parseChoiceElement(t)){if(this._accept(2))continue;if(this._accept(7)&&(s.appendChild(t),this._accept(4)))return e.appendChild(s),!0}return this._backTo(r),!1}}}}_parseChoiceElement(e){const t=this._token,r=[];while(1){if(2===this._token.type||7===this._token.type)break;let e;if(e=(e=this._accept(5,!0))?this._accept(2,!0)||this._accept(7,!0)||this._accept(5,!0)||e:this._accept(void 0,!0),!e)return this._backTo(t),!1;r.push(e)}return 0===r.length?(this._backTo(t),!1):(e.appendChild(new Text(r.join(""))),!0)}_parseComplexVariable(e){let t;const r=this._token,i=this._accept(0)&&this._accept(3)&&(t=this._accept(9,!0));if(!i)return this._backTo(r);const s=new Variable(t);if(!this._accept(1))return this._accept(6)?this._parseTransform(s)?(e.appendChild(s),!0):(this._backTo(r),!1):this._accept(4)?(e.appendChild(s),!0):this._backTo(r);while(1){if(this._accept(4))return e.appendChild(s),!0;if(!this._parse(s))return e.appendChild(new Text("${"+t+":")),s.children.forEach(e.appendChild,e),!0}}_parseTransform(e){let t=new Transform,r="",i="";while(1){if(this._accept(6))break;let e;if(e=this._accept(5,!0))e=this._accept(6,!0)||e,r+=e;else{if(14===this._token.type)return!1;r+=this._accept(void 0,!0)}}while(1){if(this._accept(6))break;let e;if(e=this._accept(5,!0))e=this._accept(5,!0)||this._accept(6,!0)||e,t.appendChild(new Text(e));else if(!this._parseFormatString(t)&&!this._parseAnything(t))return!1}while(1){if(this._accept(4))break;if(14===this._token.type)return!1;i+=this._accept(void 0,!0)}try{t.regexp=new RegExp(r,i)}catch(s){return!1}return e.transform=t,!0}_parseFormatString(e){const t=this._token;if(!this._accept(0))return!1;let r=!1;this._accept(3)&&(r=!0);let i=this._accept(8,!0);if(!i)return this._backTo(t),!1;if(!r)return e.appendChild(new FormatString(Number(i))),!0;if(this._accept(4))return e.appendChild(new FormatString(Number(i))),!0;if(!this._accept(1))return this._backTo(t),!1;if(this._accept(6)){let r=this._accept(9,!0);return r&&this._accept(4)?(e.appendChild(new FormatString(Number(i),r)),!0):(this._backTo(t),!1)}if(this._accept(11)){let t=this._until(4);if(t)return e.appendChild(new FormatString(Number(i),void 0,t,void 0)),!0}else if(this._accept(12)){let t=this._until(4);if(t)return e.appendChild(new FormatString(Number(i),void 0,void 0,t)),!0}else if(this._accept(13)){let t=this._until(1);if(t){let r=this._until(4);if(r)return e.appendChild(new FormatString(Number(i),void 0,t,r)),!0}}else{let t=this._until(4);if(t)return e.appendChild(new FormatString(Number(i),void 0,void 0,t)),!0}return this._backTo(t),!1}_parseAnything(e){return 14!==this._token.type&&(e.appendChild(new Text(this._scanner.tokenText(this._token))),this._accept(void 0),!0)}}