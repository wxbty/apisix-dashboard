import{groupBy}from"../../../../base/common/arrays.js";import{dispose}from"../../../../base/common/lifecycle.js";import{getLeadingWhitespace}from"../../../../base/common/strings.js";import"./snippetSession.css";import{EditOperation}from"../../../common/core/editOperation.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";import{ILabelService}from"../../../../platform/label/common/label.js";import{IWorkspaceContextService}from"../../../../platform/workspace/common/workspace.js";import{Choice,Placeholder,SnippetParser,Text}from"./snippetParser.js";import{ClipboardBasedVariableResolver,CommentBasedVariableResolver,CompositeSnippetVariableResolver,ModelBasedVariableResolver,RandomBasedVariableResolver,SelectionBasedVariableResolver,TimeBasedVariableResolver,WorkspaceBasedVariableResolver}from"./snippetVariables.js";export class OneSnippet{constructor(e,t,i,o){this._editor=e,this._snippet=t,this._offset=i,this._snippetLineLeadingWhitespace=o,this._nestingLevel=1,this._placeholderGroups=groupBy(t.placeholders,Placeholder.compareByIndex),this._placeholderGroupsIdx=-1}dispose(){this._placeholderDecorations&&this._editor.deltaDecorations([...this._placeholderDecorations.values()],[]),this._placeholderGroups.length=0}_initDecorations(){if(this._placeholderDecorations)return;this._placeholderDecorations=new Map;const e=this._editor.getModel();this._editor.changeDecorations((t=>{for(const i of this._snippet.placeholders){const o=this._snippet.offset(i),s=this._snippet.fullLen(i),n=Range.fromPositions(e.getPositionAt(this._offset+o),e.getPositionAt(this._offset+o+s)),r=i.isFinalTabstop?OneSnippet._decor.inactiveFinal:OneSnippet._decor.inactive,a=t.addDecoration(n,r);this._placeholderDecorations.set(i,a)}}))}move(e){if(!this._editor.hasModel())return[];if(this._initDecorations(),this._placeholderGroupsIdx>=0){let e=[];for(const t of this._placeholderGroups[this._placeholderGroupsIdx])if(t.transform){const i=this._placeholderDecorations.get(t),o=this._editor.getModel().getDecorationRange(i),s=this._editor.getModel().getValueInRange(o),n=t.transform.resolve(s).split(/\r\n|\r|\n/);for(let e=1;e<n.length;e++)n[e]=this._editor.getModel().normalizeIndentation(this._snippetLineLeadingWhitespace+n[e]);e.push(EditOperation.replace(o,n.join(this._editor.getModel().getEOL())))}e.length>0&&this._editor.executeEdits("snippet.placeholderTransform",e)}let t=!1;!0===e&&this._placeholderGroupsIdx<this._placeholderGroups.length-1?(this._placeholderGroupsIdx+=1,t=!0):!1===e&&this._placeholderGroupsIdx>0&&(this._placeholderGroupsIdx-=1,t=!0);const i=this._editor.getModel().changeDecorations((e=>{const i=new Set,o=[];for(const s of this._placeholderGroups[this._placeholderGroupsIdx]){const n=this._placeholderDecorations.get(s),r=this._editor.getModel().getDecorationRange(n);o.push(new Selection(r.startLineNumber,r.startColumn,r.endLineNumber,r.endColumn)),t=t&&this._hasPlaceholderBeenCollapsed(s),e.changeDecorationOptions(n,s.isFinalTabstop?OneSnippet._decor.activeFinal:OneSnippet._decor.active),i.add(s);for(const t of this._snippet.enclosingPlaceholders(s)){const o=this._placeholderDecorations.get(t);e.changeDecorationOptions(o,t.isFinalTabstop?OneSnippet._decor.activeFinal:OneSnippet._decor.active),i.add(t)}}for(const[t,s]of this._placeholderDecorations)i.has(t)||e.changeDecorationOptions(s,t.isFinalTabstop?OneSnippet._decor.inactiveFinal:OneSnippet._decor.inactive);return o}));return t?this.move(e):null!==i&&void 0!==i?i:[]}_hasPlaceholderBeenCollapsed(e){let t=e;while(t){if(t instanceof Placeholder){const e=this._placeholderDecorations.get(t),i=this._editor.getModel().getDecorationRange(e);if(i.isEmpty()&&t.toString().length>0)return!0}t=t.parent}return!1}get isAtFirstPlaceholder(){return this._placeholderGroupsIdx<=0||0===this._placeholderGroups.length}get isAtLastPlaceholder(){return this._placeholderGroupsIdx===this._placeholderGroups.length-1}get hasPlaceholder(){return this._snippet.placeholders.length>0}computePossibleSelections(){const e=new Map;for(const t of this._placeholderGroups){let i;for(const o of t){if(o.isFinalTabstop)break;i||(i=[],e.set(o.index,i));const t=this._placeholderDecorations.get(o),s=this._editor.getModel().getDecorationRange(t);if(!s){e.delete(o.index);break}i.push(s)}}return e}get choice(){return this._placeholderGroups[this._placeholderGroupsIdx][0].choice}merge(e){const t=this._editor.getModel();this._nestingLevel*=10,this._editor.changeDecorations((i=>{for(const o of this._placeholderGroups[this._placeholderGroupsIdx]){const s=e.shift();console.assert(!s._placeholderDecorations);const n=s._snippet.placeholderInfo.last.index;for(const e of s._snippet.placeholderInfo.all)e.isFinalTabstop?e.index=o.index+(n+1)/this._nestingLevel:e.index=o.index+e.index/this._nestingLevel;this._snippet.replace(o,s._snippet.children);const r=this._placeholderDecorations.get(o);i.removeDecoration(r),this._placeholderDecorations.delete(o);for(const e of s._snippet.placeholders){const o=s._snippet.offset(e),n=s._snippet.fullLen(e),r=Range.fromPositions(t.getPositionAt(s._offset+o),t.getPositionAt(s._offset+o+n)),a=i.addDecoration(r,OneSnippet._decor.inactive);this._placeholderDecorations.set(e,a)}}this._placeholderGroups=groupBy(this._snippet.placeholders,Placeholder.compareByIndex)}))}}OneSnippet._decor={active:ModelDecorationOptions.register({description:"snippet-placeholder-1",stickiness:0,className:"snippet-placeholder"}),inactive:ModelDecorationOptions.register({description:"snippet-placeholder-2",stickiness:1,className:"snippet-placeholder"}),activeFinal:ModelDecorationOptions.register({description:"snippet-placeholder-3",stickiness:1,className:"finish-snippet-placeholder"}),inactiveFinal:ModelDecorationOptions.register({description:"snippet-placeholder-4",stickiness:1,className:"finish-snippet-placeholder"})};const _defaultOptions={overwriteBefore:0,overwriteAfter:0,adjustWhitespace:!0,clipboardText:void 0,overtypingCapturer:void 0};export class SnippetSession{constructor(e,t,i=_defaultOptions){this._templateMerges=[],this._snippets=[],this._editor=e,this._template=t,this._options=i}static adjustWhitespace(e,t,i,o,s){const n=e.getLineContent(t.lineNumber),r=getLeadingWhitespace(n,0,t.column-1);let a;return i.walk((t=>{if(!(t instanceof Text)||t.parent instanceof Choice)return!0;const s=t.value.split(/\r\n|\r|\n/);if(o){const o=i.offset(t);if(0===o)s[0]=e.normalizeIndentation(s[0]);else{a=null!==a&&void 0!==a?a:i.toString();let t=a.charCodeAt(o-1);10!==t&&13!==t||(s[0]=e.normalizeIndentation(r+s[0]))}for(let t=1;t<s.length;t++)s[t]=e.normalizeIndentation(r+s[t])}const n=s.join(e.getEOL());return n!==t.value&&(t.parent.replace(t,[new Text(n)]),a=void 0),!0})),r}static adjustSelection(e,t,i,o){if(0!==i||0!==o){const{positionLineNumber:s,positionColumn:n}=t,r=n-i,a=n+o,l=e.validateRange({startLineNumber:s,startColumn:r,endLineNumber:s,endColumn:a});t=Selection.createWithDirection(l.startLineNumber,l.startColumn,l.endLineNumber,l.endColumn,t.getDirection())}return t}static createEditsAndSnippets(e,t,i,o,s,n,r,a){const l=[],p=[];if(!e.hasModel())return{edits:l,snippets:p};const c=e.getModel(),d=e.invokeWithinContext((e=>e.get(IWorkspaceContextService))),h=e.invokeWithinContext((e=>new ModelBasedVariableResolver(e.get(ILabelService),c))),g=()=>r;let _=0,m=c.getValueInRange(SnippetSession.adjustSelection(c,e.getSelection(),i,0)),f=c.getValueInRange(SnippetSession.adjustSelection(c,e.getSelection(),0,o)),u=c.getLineFirstNonWhitespaceColumn(e.getSelection().positionLineNumber);const v=e.getSelections().map(((e,t)=>({selection:e,idx:t}))).sort(((e,t)=>Range.compareRangesUsingStarts(e.selection,t.selection)));for(const{selection:S,idx:b}of v){let r=SnippetSession.adjustSelection(c,S,i,0),R=SnippetSession.adjustSelection(c,S,0,o);m!==c.getValueInRange(r)&&(r=S),f!==c.getValueInRange(R)&&(R=S);const x=S.setStartPosition(r.startLineNumber,r.startColumn).setEndPosition(R.endLineNumber,R.endColumn),P=(new SnippetParser).parse(t,!0,s),D=x.getStartPosition(),I=SnippetSession.adjustWhitespace(c,D,P,n||b>0&&u!==c.getLineFirstNonWhitespaceColumn(S.positionLineNumber),!0);P.resolveVariables(new CompositeSnippetVariableResolver([h,new ClipboardBasedVariableResolver(g,b,v.length,"spread"===e.getOption(71)),new SelectionBasedVariableResolver(c,S,b,a),new CommentBasedVariableResolver(c,S),new TimeBasedVariableResolver,new WorkspaceBasedVariableResolver(d),new RandomBasedVariableResolver]));const L=c.getOffsetAt(D)+_;_+=P.toString().length-c.getValueLengthInRange(x),l[b]=EditOperation.replace(x,P.toString()),l[b].identifier={major:b,minor:0},p[b]=new OneSnippet(e,P,L,I)}return{edits:l,snippets:p}}dispose(){dispose(this._snippets)}_logInfo(){return`template="${this._template}", merged_templates="${this._templateMerges.join(" -> ")}"`}insert(){if(!this._editor.hasModel())return;const{edits:e,snippets:t}=SnippetSession.createEditsAndSnippets(this._editor,this._template,this._options.overwriteBefore,this._options.overwriteAfter,!1,this._options.adjustWhitespace,this._options.clipboardText,this._options.overtypingCapturer);this._snippets=t,this._editor.executeEdits("snippet",e,(e=>this._snippets[0].hasPlaceholder?this._move(!0):e.filter((e=>!!e.identifier)).map((e=>Selection.fromPositions(e.range.getEndPosition()))))),this._editor.revealRange(this._editor.getSelections()[0])}merge(e,t=_defaultOptions){if(!this._editor.hasModel())return;this._templateMerges.push([this._snippets[0]._nestingLevel,this._snippets[0]._placeholderGroupsIdx,e]);const{edits:i,snippets:o}=SnippetSession.createEditsAndSnippets(this._editor,e,t.overwriteBefore,t.overwriteAfter,!0,t.adjustWhitespace,t.clipboardText,t.overtypingCapturer);this._editor.executeEdits("snippet",i,(e=>{for(const t of this._snippets)t.merge(o);return console.assert(0===o.length),this._snippets[0].hasPlaceholder?this._move(void 0):e.filter((e=>!!e.identifier)).map((e=>Selection.fromPositions(e.range.getEndPosition())))}))}next(){const e=this._move(!0);this._editor.setSelections(e),this._editor.revealPositionInCenterIfOutsideViewport(e[0].getPosition())}prev(){const e=this._move(!1);this._editor.setSelections(e),this._editor.revealPositionInCenterIfOutsideViewport(e[0].getPosition())}_move(e){const t=[];for(const i of this._snippets){const o=i.move(e);t.push(...o)}return t}get isAtFirstPlaceholder(){return this._snippets[0].isAtFirstPlaceholder}get isAtLastPlaceholder(){return this._snippets[0].isAtLastPlaceholder}get hasPlaceholder(){return this._snippets[0].hasPlaceholder}get choice(){return this._snippets[0].choice}isSelectionWithinPlaceholders(){if(!this.hasPlaceholder)return!1;const e=this._editor.getSelections();if(e.length<this._snippets.length)return!1;let t=new Map;for(const i of this._snippets){const o=i.computePossibleSelections();if(0===t.size)for(const[i,s]of o){s.sort(Range.compareRangesUsingStarts);for(const o of e)if(s[0].containsRange(o)){t.set(i,[]);break}}if(0===t.size)return!1;t.forEach(((e,t)=>{e.push(...o.get(t))}))}e.sort(Range.compareRangesUsingStarts);for(let[i,o]of t)if(o.length===e.length){o.sort(Range.compareRangesUsingStarts);for(let s=0;s<o.length;s++)o[s].containsRange(e[s])||t.delete(i)}else t.delete(i);return t.size>0}}