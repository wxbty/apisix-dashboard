var __decorate=this&&this.__decorate||function(e,t,o,i){var r,n=arguments.length,s=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,o,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(n<3?r(s):n>3?r(t,o,s):r(t,o))||s);return n>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}},__awaiter=this&&this.__awaiter||function(e,t,o,i){function r(e){return e instanceof o?e:new o((function(t){t(e)}))}return new(o||(o=Promise))((function(o,n){function s(e){try{c(i.next(e))}catch(t){n(t)}}function a(e){try{c(i["throw"](e))}catch(t){n(t)}}function c(e){e.done?o(e.value):r(e.value).then(s,a)}c((i=i.apply(e,t||[])).next())}))};import{alert}from"../../../../base/browser/ui/aria/aria.js";import{IdleValue,raceCancellation}from"../../../../base/common/async.js";import{CancellationToken,CancellationTokenSource}from"../../../../base/common/cancellation.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{EditorStateCancellationTokenSource}from"../../editorState/browser/editorState.js";import{EditorAction,EditorCommand,registerEditorAction,registerEditorCommand,registerEditorContribution,registerModelAndPositionCommand}from"../../../browser/editorExtensions.js";import{IBulkEditService,ResourceEdit}from"../../../browser/services/bulkEditService.js";import{ICodeEditorService}from"../../../browser/services/codeEditorService.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{RenameProviderRegistry}from"../../../common/languages.js";import{ITextResourceConfigurationService}from"../../../common/services/textResourceConfiguration.js";import{MessageController}from"../../message/browser/messageController.js";import*as nls from"../../../../nls.js";import{Extensions}from"../../../../platform/configuration/common/configurationRegistry.js";import{ContextKeyExpr}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{ILogService}from"../../../../platform/log/common/log.js";import{INotificationService}from"../../../../platform/notification/common/notification.js";import{IEditorProgressService}from"../../../../platform/progress/common/progress.js";import{Registry}from"../../../../platform/registry/common/platform.js";import{CONTEXT_RENAME_INPUT_VISIBLE,RenameInputField}from"./renameInputField.js";class RenameSkeleton{constructor(e,t){this.model=e,this.position=t,this._providerRenameIdx=0,this._providers=RenameProviderRegistry.ordered(e)}hasProvider(){return this._providers.length>0}resolveRenameLocation(e){return __awaiter(this,void 0,void 0,(function*(){const t=[];for(this._providerRenameIdx=0;this._providerRenameIdx<this._providers.length;this._providerRenameIdx++){const o=this._providers[this._providerRenameIdx];if(!o.resolveRenameLocation)break;let i=yield o.resolveRenameLocation(this.model,this.position,e);if(i){if(!i.rejectReason)return i;t.push(i.rejectReason)}}const o=this.model.getWordAtPosition(this.position);return o?{range:new Range(this.position.lineNumber,o.startColumn,this.position.lineNumber,o.endColumn),text:o.word,rejectReason:t.length>0?t.join("\n"):void 0}:{range:Range.fromPositions(this.position),text:"",rejectReason:t.length>0?t.join("\n"):void 0}}))}provideRenameEdits(e,t){return __awaiter(this,void 0,void 0,(function*(){return this._provideRenameEdits(e,this._providerRenameIdx,[],t)}))}_provideRenameEdits(e,t,o,i){return __awaiter(this,void 0,void 0,(function*(){const r=this._providers[t];if(!r)return{edits:[],rejectReason:o.join("\n")};const n=yield r.provideRenameEdits(this.model,this.position,e,i);return n?n.rejectReason?this._provideRenameEdits(e,t+1,o.concat(n.rejectReason),i):n:this._provideRenameEdits(e,t+1,o.concat(nls.localize("no result","No result.")),i)}))}}export function rename(e,t,o){return __awaiter(this,void 0,void 0,(function*(){const i=new RenameSkeleton(e,t),r=yield i.resolveRenameLocation(CancellationToken.None);return(null===r||void 0===r?void 0:r.rejectReason)?{edits:[],rejectReason:r.rejectReason}:i.provideRenameEdits(o,CancellationToken.None)}))}let RenameController=class e{constructor(e,t,o,i,r,n,s){this.editor=e,this._instaService=t,this._notificationService=o,this._bulkEditService=i,this._progressService=r,this._logService=n,this._configService=s,this._dispoableStore=new DisposableStore,this._cts=new CancellationTokenSource,this._renameInputField=this._dispoableStore.add(new IdleValue((()=>this._dispoableStore.add(this._instaService.createInstance(RenameInputField,this.editor,["acceptRenameInput","acceptRenameInputWithPreview"])))))}static get(t){return t.getContribution(e.ID)}dispose(){this._dispoableStore.dispose(),this._cts.dispose(!0)}run(){var e,t;return __awaiter(this,void 0,void 0,(function*(){if(this._cts.dispose(!0),!this.editor.hasModel())return;const o=this.editor.getPosition(),i=new RenameSkeleton(this.editor.getModel(),o);if(!i.hasProvider())return;let r;this._cts=new EditorStateCancellationTokenSource(this.editor,5);try{const e=i.resolveRenameLocation(this._cts.token);this._progressService.showWhile(e,250),r=yield e}catch(d){return void(null===(e=MessageController.get(this.editor))||void 0===e||e.showMessage(d||nls.localize("resolveRenameLocationFailed","An unknown error occurred while resolving rename location"),o))}if(!r)return;if(r.rejectReason)return void(null===(t=MessageController.get(this.editor))||void 0===t||t.showMessage(r.rejectReason,o));if(this._cts.token.isCancellationRequested)return;this._cts.dispose(),this._cts=new EditorStateCancellationTokenSource(this.editor,5,r.range);let n=this.editor.getSelection(),s=0,a=r.text.length;Range.isEmpty(n)||Range.spansMultipleLines(n)||!Range.containsRange(r.range,n)||(s=Math.max(0,n.startColumn-r.range.startColumn),a=Math.min(r.range.endColumn,n.endColumn)-r.range.startColumn);const c=this._bulkEditService.hasPreviewHandler()&&this._configService.getValue(this.editor.getModel().uri,"editor.rename.enablePreview"),l=yield this._renameInputField.value.getInput(r.range,r.text,s,a,c,this._cts.token);if("boolean"===typeof l)return void(l&&this.editor.focus());this.editor.focus();const m=raceCancellation(i.provideRenameEdits(l.newName,this._cts.token),this._cts.token).then((e=>__awaiter(this,void 0,void 0,(function*(){e&&this.editor.hasModel()&&(e.rejectReason?this._notificationService.info(e.rejectReason):(this.editor.setSelection(Range.fromPositions(this.editor.getSelection().getPosition())),this._bulkEditService.apply(ResourceEdit.convert(e),{editor:this.editor,showPreview:l.wantsPreview,label:nls.localize("label","Renaming '{0}'",null===r||void 0===r?void 0:r.text),quotableLabel:nls.localize("quotableLabel","Renaming {0}",null===r||void 0===r?void 0:r.text)}).then((e=>{e.ariaSummary&&alert(nls.localize("aria","Successfully renamed '{0}' to '{1}'. Summary: {2}",r.text,l.newName,e.ariaSummary))})).catch((e=>{this._notificationService.error(nls.localize("rename.failedApply","Rename failed to apply edits")),this._logService.error(e)}))))}))),(e=>{this._notificationService.error(nls.localize("rename.failed","Rename failed to compute edits")),this._logService.error(e)}));return this._progressService.showWhile(m,250),m}))}acceptRenameInput(e){this._renameInputField.value.acceptInput(e)}cancelRenameInput(){this._renameInputField.value.cancelInput(!0)}};RenameController.ID="editor.contrib.renameController",RenameController=__decorate([__param(1,IInstantiationService),__param(2,INotificationService),__param(3,IBulkEditService),__param(4,IEditorProgressService),__param(5,ILogService),__param(6,ITextResourceConfigurationService)],RenameController);export class RenameAction extends EditorAction{constructor(){super({id:"editor.action.rename",label:nls.localize("rename.label","Rename Symbol"),alias:"Rename Symbol",precondition:ContextKeyExpr.and(EditorContextKeys.writable,EditorContextKeys.hasRenameProvider),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:60,weight:100},contextMenuOpts:{group:"1_modification",order:1.1}})}runCommand(e,t){const o=e.get(ICodeEditorService),[i,r]=Array.isArray(t)&&t||[void 0,void 0];return URI.isUri(i)&&Position.isIPosition(r)?o.openCodeEditor({resource:i},o.getActiveCodeEditor()).then((e=>{e&&(e.setPosition(r),e.invokeWithinContext((t=>(this.reportTelemetry(t,e),this.run(t,e)))))}),onUnexpectedError):super.runCommand(e,t)}run(e,t){const o=RenameController.get(t);return o?o.run():Promise.resolve()}}registerEditorContribution(RenameController.ID,RenameController),registerEditorAction(RenameAction);const RenameCommand=EditorCommand.bindToContribution(RenameController.get);registerEditorCommand(new RenameCommand({id:"acceptRenameInput",precondition:CONTEXT_RENAME_INPUT_VISIBLE,handler:e=>e.acceptRenameInput(!1),kbOpts:{weight:199,kbExpr:EditorContextKeys.focus,primary:3}})),registerEditorCommand(new RenameCommand({id:"acceptRenameInputWithPreview",precondition:ContextKeyExpr.and(CONTEXT_RENAME_INPUT_VISIBLE,ContextKeyExpr.has("config.editor.rename.enablePreview")),handler:e=>e.acceptRenameInput(!0),kbOpts:{weight:199,kbExpr:EditorContextKeys.focus,primary:1027}})),registerEditorCommand(new RenameCommand({id:"cancelRenameInput",precondition:CONTEXT_RENAME_INPUT_VISIBLE,handler:e=>e.cancelRenameInput(),kbOpts:{weight:199,kbExpr:EditorContextKeys.focus,primary:9,secondary:[1033]}})),registerModelAndPositionCommand("_executeDocumentRenameProvider",(function(e,t,...o){const[i]=o;return assertType("string"===typeof i),rename(e,t,i)})),registerModelAndPositionCommand("_executePrepareRename",(function(e,t){return __awaiter(this,void 0,void 0,(function*(){const o=new RenameSkeleton(e,t),i=yield o.resolveRenameLocation(CancellationToken.None);if(null===i||void 0===i?void 0:i.rejectReason)throw new Error(i.rejectReason);return i}))})),Registry.as(Extensions.Configuration).registerConfiguration({id:"editor",properties:{"editor.rename.enablePreview":{scope:5,description:nls.localize("enablePreview","Enable/disable the ability to preview changes before renaming"),default:!0,type:"boolean"}}});