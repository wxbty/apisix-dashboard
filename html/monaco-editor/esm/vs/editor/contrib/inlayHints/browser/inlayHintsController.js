var __decorate=this&&this.__decorate||function(e,t,o,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)a=Reflect.decorate(e,t,o,n);else for(var r=e.length-1;r>=0;r--)(i=e[r])&&(a=(s<3?i(a):s>3?i(t,o,a):i(t,o))||a);return s>3&&a&&Object.defineProperty(t,o,a),a},__param=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}},__awaiter=this&&this.__awaiter||function(e,t,o,n){function i(e){return e instanceof o?e:new o((function(t){t(e)}))}return new(o||(o=Promise))((function(o,s){function a(e){try{l(n.next(e))}catch(t){s(t)}}function r(e){try{l(n["throw"](e))}catch(t){s(t)}}function l(e){e.done?o(e.value):i(e.value).then(a,r)}l((n=n.apply(e,t||[])).next())}))};import{RunOnceScheduler}from"../../../../base/common/async.js";import{CancellationToken,CancellationTokenSource}from"../../../../base/common/cancellation.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import{LRUCache}from"../../../../base/common/map.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{DynamicCssRules}from"../../../browser/editorDom.js";import{registerEditorContribution}from"../../../browser/editorExtensions.js";import{EDITOR_FONT_DEFAULTS}from"../../../common/config/editorOptions.js";import{Range}from"../../../common/core/range.js";import*as languages from"../../../common/languages.js";import{InjectedTextCursorStops}from"../../../common/model.js";import{ModelDecorationInjectedTextOptions}from"../../../common/model/textModel.js";import{ILanguageFeatureDebounceService}from"../../../common/services/languageFeatureDebounce.js";import{ITextModelService}from"../../../common/services/resolverService.js";import{ClickLinkGesture}from"../../gotoSymbol/browser/link/clickLinkGesture.js";import{InlayHintAnchor,InlayHintsFragments}from"./inlayHints.js";import{goToDefinitionWithLocation,showGoToContextMenu}from"./inlayHintsLocations.js";import{CommandsRegistry,ICommandService}from"../../../../platform/commands/common/commands.js";import{registerSingleton}from"../../../../platform/instantiation/common/extensions.js";import{createDecorator,IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{INotificationService,Severity}from"../../../../platform/notification/common/notification.js";import*as colors from"../../../../platform/theme/common/colorRegistry.js";import{themeColorFromId}from"../../../../platform/theme/common/themeService.js";class InlayHintsCache{constructor(){this._entries=new LRUCache(50)}get(e){const t=InlayHintsCache._key(e);return this._entries.get(t)}set(e,t){const o=InlayHintsCache._key(e);this._entries.set(o,t)}static _key(e){return`${e.uri.toString()}/${e.getVersionId()}`}}const IInlayHintsCache=createDecorator("IInlayHintsCache");registerSingleton(IInlayHintsCache,InlayHintsCache,!0);export class RenderedInlayHintLabelPart{constructor(e,t){this.item=e,this.index=t}get part(){const e=this.item.hint.label;return"string"===typeof e?{label:e}:e[this.index]}}let InlayHintsController=class e{constructor(e,t,o,n,i,s){this._editor=e,this._inlayHintsCache=o,this._commandService=n,this._notificationService=i,this._instaService=s,this._disposables=new DisposableStore,this._sessionDisposables=new DisposableStore,this._decorationsMetadata=new Map,this._ruleFactory=new DynamicCssRules(this._editor),this._debounceInfo=t.for(languages.InlayHintsProviderRegistry,"InlayHint",{min:25}),this._disposables.add(languages.InlayHintsProviderRegistry.onDidChange((()=>this._update()))),this._disposables.add(e.onDidChangeModel((()=>this._update()))),this._disposables.add(e.onDidChangeModelLanguage((()=>this._update()))),this._disposables.add(e.onDidChangeConfiguration((e=>{e.hasChanged(127)&&this._update()}))),this._update()}static get(t){var o;return null!==(o=t.getContribution(e.ID))&&void 0!==o?o:void 0}dispose(){this._sessionDisposables.dispose(),this._removeAllDecorations(),this._disposables.dispose()}_update(){if(this._sessionDisposables.clear(),this._removeAllDecorations(),!this._editor.getOption(127).enabled)return;const e=this._editor.getModel();if(!e||!languages.InlayHintsProviderRegistry.has(e))return;const t=this._inlayHintsCache.get(e);let o;t&&this._updateHintsDecorators([e.getFullModelRange()],t),this._sessionDisposables.add(toDisposable((()=>{e.isDisposed()||this._cacheHintsForFastRestore(e)})));let n=new Set;const i=new RunOnceScheduler((()=>__awaiter(this,void 0,void 0,(function*(){const t=Date.now();null===o||void 0===o||o.dispose(!0),o=new CancellationTokenSource;const s=e.onWillDispose((()=>null===o||void 0===o?void 0:o.cancel()));try{const a=o.token,r=yield InlayHintsFragments.create(e,this._getHintsRanges(),a);if(i.delay=this._debounceInfo.update(e,Date.now()-t),a.isCancellationRequested)return void r.dispose();for(const e of r.provider)"function"!==typeof e.onDidChangeInlayHints||n.has(e)||(n.add(e),this._sessionDisposables.add(e.onDidChangeInlayHints((()=>{i.isScheduled()||i.schedule()}))));this._sessionDisposables.add(r),this._updateHintsDecorators(r.ranges,r.items),this._cacheHintsForFastRestore(e)}catch(a){onUnexpectedError(a)}finally{o.dispose(),s.dispose()}}))),this._debounceInfo.get(e));this._sessionDisposables.add(i),this._sessionDisposables.add(toDisposable((()=>null===o||void 0===o?void 0:o.dispose(!0)))),i.schedule(0),this._sessionDisposables.add(this._editor.onDidScrollChange((e=>{!e.scrollTopChanged&&i.isScheduled()||i.schedule()}))),this._sessionDisposables.add(this._editor.onDidChangeModelContent((e=>{const t=Math.max(i.delay,1250);i.schedule(t)}))),this._sessionDisposables.add(this._installLinkGesture()),this._sessionDisposables.add(this._installContextMenu())}_installLinkGesture(){let e=()=>{};const t=new ClickLinkGesture(this._editor);return t.onMouseMoveOrRelevantKeyDown((t=>{const[o]=t,n=this._getInlayHintLabelPart(o),i=this._editor.getModel();if(n&&o.hasTriggerModifier&&i){if(o.hasTriggerModifier&&(n.part.command||n.part.location)){const t=new CancellationTokenSource;n.item.resolve(t.token),this._activeInlayHintPart=n;const o=this._activeInlayHintPart.item.hint.position.lineNumber,s=new Range(o,1,o,i.getLineMaxColumn(o)),a=new Set;for(const e of this._decorationsMetadata.values())s.containsRange(e.item.anchor.range)&&a.add(e.item);this._updateHintsDecorators([s],Array.from(a)),e=()=>{t.dispose(!0),this._activeInlayHintPart=void 0,this._updateHintsDecorators([s],Array.from(a))}}}else e()})),t.onCancel(e),t.onExecute((e=>__awaiter(this,void 0,void 0,(function*(){var t;const o=this._getInlayHintLabelPart(e);if(o){const i=o.part;if(i.location)this._instaService.invokeFunction(goToDefinitionWithLocation,e,this._editor,i.location);else if(languages.Command.is(i.command))try{yield this._commandService.executeCommand(i.command.id,...null!==(t=i.command.arguments)&&void 0!==t?t:[])}catch(n){this._notificationService.notify({severity:Severity.Error,source:o.item.provider.displayName,message:n})}}})))),t}_installContextMenu(){return this._editor.onContextMenu((e=>__awaiter(this,void 0,void 0,(function*(){if(!(e.event.target instanceof HTMLElement))return;const t=this._getInlayHintLabelPart(e);t&&(yield this._instaService.invokeFunction(showGoToContextMenu,this._editor,e.event.target,t))}))))}_getInlayHintLabelPart(e){var t;if(6!==e.target.type)return;const o=null===(t=e.target.detail.injectedText)||void 0===t?void 0:t.options;return o instanceof ModelDecorationInjectedTextOptions&&(null===o||void 0===o?void 0:o.attachedData)instanceof RenderedInlayHintLabelPart?o.attachedData:void 0}_cacheHintsForFastRestore(e){const t=new Map;for(const[o,n]of this._decorationsMetadata){if(t.has(n.item))continue;let i=n.item;const s=e.getDecorationRange(o);if(s){const e=new InlayHintAnchor(s,n.item.anchor.direction);i=n.item.with({anchor:e})}t.set(n.item,i)}this._inlayHintsCache.set(e,Array.from(t.values()))}_getHintsRanges(){const e=30,t=this._editor.getModel(),o=this._editor.getVisibleRangesPlusViewportAboveBelow(),n=[];for(const i of o.sort(Range.compareRangesUsingStarts)){const o=t.validateRange(new Range(i.startLineNumber-e,i.startColumn,i.endLineNumber+e,i.endColumn));0!==n.length&&Range.areIntersectingOrTouching(n[n.length-1],o)?n[n.length-1]=Range.plusRange(n[n.length-1],o):n.push(o)}return n}_updateHintsDecorators(t,o){var n,i;const s=[],a=(e,t,o,n,i)=>{s.push({item:e,classNameRef:t,decoration:{range:e.anchor.range,options:{description:"InlayHint",showIfCollapsed:e.anchor.range.isEmpty(),collapseOnReplaceEdit:!e.anchor.range.isEmpty(),stickiness:0,[e.anchor.direction]:{content:o,inlineClassNameAffectsLetterSpacing:!0,inlineClassName:t.className,cursorStops:n,attachedData:i}}}})},r=(e,t)=>{const o=this._ruleFactory.createClassNameRef({width:(l/3|0)+"px",display:"inline-block"});a(e,o,"\u200a",t?InjectedTextCursorStops.Right:InjectedTextCursorStops.None)},{fontSize:l,fontFamily:c}=this._getLayoutInfo(),d="--code-editorInlayHintsFontFamily";this._editor.getContainerDomNode().style.setProperty(d,c);for(const p of o){p.hint.paddingLeft&&r(p,!1);const t="string"===typeof p.hint.label?[{label:p.hint.label}]:p.hint.label;for(let e=0;e<t.length;e++){const o=t[e],i=0===e,s=e===t.length-1,r={fontSize:`${l}px`,fontFamily:`var(${d}), ${EDITOR_FONT_DEFAULTS.fontFamily}`,verticalAlign:"middle"};this._fillInColors(r,p.hint),(o.command||o.location)&&(null===(n=this._activeInlayHintPart)||void 0===n?void 0:n.item)===p&&this._activeInlayHintPart.index===e&&(r.textDecoration="underline",r.cursor="pointer",r.color=themeColorFromId(colors.editorActiveLinkForeground)),i&&s?(r.padding=`1px ${0|Math.max(1,l/4)}px`,r.borderRadius=(l/4|0)+"px"):i?(r.padding=`1px 0 1px ${0|Math.max(1,l/4)}px`,r.borderRadius=`${l/4|0}px 0 0 ${l/4|0}px`):s?(r.padding=`1px ${0|Math.max(1,l/4)}px 1px 0`,r.borderRadius=`0 ${l/4|0}px ${l/4|0}px 0`):r.padding="1px 0 1px 0",a(p,this._ruleFactory.createClassNameRef(r),fixSpace(o.label),s&&!p.hint.paddingRight?InjectedTextCursorStops.Right:InjectedTextCursorStops.None,new RenderedInlayHintLabelPart(p,e))}if(p.hint.paddingRight&&r(p,!0),s.length>e._MAX_DECORATORS)break}const m=[];for(const e of t)for(const{id:t}of null!==(i=this._editor.getDecorationsInRange(e))&&void 0!==i?i:[]){const e=this._decorationsMetadata.get(t);e&&(m.push(t),e.classNameRef.dispose(),this._decorationsMetadata.delete(t))}const h=this._editor.deltaDecorations(m,s.map((e=>e.decoration)));for(let e=0;e<h.length;e++){const t=s[e];this._decorationsMetadata.set(h[e],{item:t.item,classNameRef:t.classNameRef})}}_fillInColors(e,t){t.kind===languages.InlayHintKind.Parameter?(e.backgroundColor=themeColorFromId(colors.editorInlayHintParameterBackground),e.color=themeColorFromId(colors.editorInlayHintParameterForeground)):t.kind===languages.InlayHintKind.Type?(e.backgroundColor=themeColorFromId(colors.editorInlayHintTypeBackground),e.color=themeColorFromId(colors.editorInlayHintTypeForeground)):(e.backgroundColor=themeColorFromId(colors.editorInlayHintBackground),e.color=themeColorFromId(colors.editorInlayHintForeground))}_getLayoutInfo(){const e=this._editor.getOption(127),t=this._editor.getOption(46);let o=e.fontSize;(!o||o<5||o>t)&&(o=.9*t|0);const n=e.fontFamily||this._editor.getOption(43);return{fontSize:o,fontFamily:n}}_removeAllDecorations(){this._editor.deltaDecorations(Array.from(this._decorationsMetadata.keys()),[]);for(let e of this._decorationsMetadata.values())e.classNameRef.dispose();this._decorationsMetadata.clear()}};InlayHintsController.ID="editor.contrib.InlayHints",InlayHintsController._MAX_DECORATORS=1500,InlayHintsController=__decorate([__param(1,ILanguageFeatureDebounceService),__param(2,IInlayHintsCache),__param(3,ICommandService),__param(4,INotificationService),__param(5,IInstantiationService)],InlayHintsController);export{InlayHintsController};function fixSpace(e){const t="\xa0";return e.replace(/[ \t]/g,t)}registerEditorContribution(InlayHintsController.ID,InlayHintsController),CommandsRegistry.registerCommand("_executeInlayHintProvider",((e,...t)=>__awaiter(void 0,void 0,void 0,(function*(){const[o,n]=t;assertType(URI.isUri(o)),assertType(Range.isIRange(n));const i=yield e.get(ITextModelService).createModelReference(o);try{const e=yield InlayHintsFragments.create(i.object.textEditorModel,[Range.lift(n)],CancellationToken.None),t=e.items.map((e=>e.hint));return setTimeout((()=>e.dispose()),0),t}finally{i.dispose()}}))));