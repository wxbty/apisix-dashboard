var __awaiter=this&&this.__awaiter||function(e,t,s,i){function r(e){return e instanceof s?e:new s((function(t){t(e)}))}return new(s||(s=Promise))((function(s,n){function a(e){try{o(i.next(e))}catch(t){n(t)}}function c(e){try{o(i["throw"](e))}catch(t){n(t)}}function o(e){e.done?s(e.value):r(e.value).then(a,c)}o((i=i.apply(e,t||[])).next())}))},__asyncValues=this&&this.__asyncValues||function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,s=e[Symbol.asyncIterator];return s?s.call(e):(e="function"===typeof __values?__values(e):e[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(s){t[s]=e[s]&&function(t){return new Promise((function(i,n){t=e[s](t),r(i,n,t.done,t.value)}))}}function r(e,t,s,i){Promise.resolve(i).then((function(t){e({value:t,done:s})}),t)}};import{createCancelableAsyncIterable,RunOnceScheduler}from"../../../../base/common/async.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{Emitter}from"../../../../base/common/event.js";import{Disposable}from"../../../../base/common/lifecycle.js";export class HoverResult{constructor(e,t,s){this.value=e,this.isComplete=t,this.hasLoadingMessage=s}}export class HoverOperation extends Disposable{constructor(e,t){super(),this._editor=e,this._computer=t,this._onResult=this._register(new Emitter),this.onResult=this._onResult.event,this._firstWaitScheduler=this._register(new RunOnceScheduler((()=>this._triggerAsyncComputation()),0)),this._secondWaitScheduler=this._register(new RunOnceScheduler((()=>this._triggerSyncComputation()),0)),this._loadingMessageScheduler=this._register(new RunOnceScheduler((()=>this._triggerLoadingMessage()),0)),this._state=0,this._asyncIterable=null,this._asyncIterableDone=!1,this._result=[]}dispose(){this._asyncIterable&&(this._asyncIterable.cancel(),this._asyncIterable=null),super.dispose()}get _hoverTime(){return this._editor.getOption(53).delay}get _firstWaitTime(){return this._hoverTime/2}get _secondWaitTime(){return this._hoverTime-this._firstWaitTime}get _loadingMessageTime(){return 3*this._hoverTime}_setState(e,t=!0){this._state=e,t&&this._fireResult()}_triggerAsyncComputation(){this._setState(2),this._secondWaitScheduler.schedule(this._secondWaitTime),this._computer.computeAsync?(this._asyncIterableDone=!1,this._asyncIterable=createCancelableAsyncIterable((e=>this._computer.computeAsync(e))),(()=>{__awaiter(this,void 0,void 0,(function*(){var e,t;try{try{for(var s,i=__asyncValues(this._asyncIterable);s=yield i.next(),!s.done;){const e=s.value;e&&(this._result.push(e),this._fireResult())}}catch(r){e={error:r}}finally{try{s&&!s.done&&(t=i.return)&&(yield t.call(i))}finally{if(e)throw e.error}}this._asyncIterableDone=!0,3!==this._state&&4!==this._state||this._setState(0)}catch(n){onUnexpectedError(n)}}))})()):this._asyncIterableDone=!0}_triggerSyncComputation(){this._computer.computeSync&&(this._result=this._result.concat(this._computer.computeSync())),this._setState(this._asyncIterableDone?0:3)}_triggerLoadingMessage(){3===this._state&&this._setState(4)}_fireResult(){if(1===this._state||2===this._state)return;const e=0===this._state,t=4===this._state;this._onResult.fire(new HoverResult(this._result.slice(0),e,t))}start(e){if(0===e)0===this._state&&(this._setState(1),this._firstWaitScheduler.schedule(this._firstWaitTime),this._loadingMessageScheduler.schedule(this._loadingMessageTime));else switch(this._state){case 0:this._triggerAsyncComputation(),this._secondWaitScheduler.cancel(),this._triggerSyncComputation();break;case 2:this._secondWaitScheduler.cancel(),this._triggerSyncComputation();break}}cancel(){this._firstWaitScheduler.cancel(),this._secondWaitScheduler.cancel(),this._loadingMessageScheduler.cancel(),this._asyncIterable&&(this._asyncIterable.cancel(),this._asyncIterable=null),this._result=[],this._setState(0,!1)}}