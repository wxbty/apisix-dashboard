var __decorate=this&&this.__decorate||function(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(i<3?n(a):i>3?n(t,o,a):n(t,o))||a);return i>3&&a&&Object.defineProperty(t,o,a),a},__param=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}},__awaiter=this&&this.__awaiter||function(e,t,o,r){function n(e){return e instanceof o?e:new o((function(t){t(e)}))}return new(o||(o=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(t){i(t)}}function s(e){try{c(r["throw"](e))}catch(t){i(t)}}function c(e){e.done?o(e.value):n(e.value).then(a,s)}c((r=r.apply(e,t||[])).next())}))};import{AsyncIterableObject}from"../../../../base/common/async.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{Color,RGBA}from"../../../../base/common/color.js";import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{Range}from"../../../common/core/range.js";import{getColorPresentations}from"../../colorPicker/browser/color.js";import{ColorDetector}from"../../colorPicker/browser/colorDetector.js";import{ColorPickerModel}from"../../colorPicker/browser/colorPickerModel.js";import{ColorPickerWidget}from"../../colorPicker/browser/colorPickerWidget.js";import{IThemeService}from"../../../../platform/theme/common/themeService.js";export class ColorHover{constructor(e,t,o,r){this.owner=e,this.range=t,this.model=o,this.provider=r,this.forceShowAtRange=!0}isValidForHoverAnchor(e){return 1===e.type&&this.range.startColumn<=e.range.startColumn&&this.range.endColumn>=e.range.endColumn}}let ColorHoverParticipant=class{constructor(e,t){this._editor=e,this._themeService=t}computeSync(e,t){return[]}computeAsync(e,t,o){return AsyncIterableObject.fromPromise(this._computeAsync(e,t,o))}_computeAsync(e,t,o){return __awaiter(this,void 0,void 0,(function*(){if(!this._editor.hasModel())return[];const e=ColorDetector.get(this._editor);if(!e)return[];for(const o of t){if(!e.isColorDecorationId(o.id))continue;const t=e.getColorData(o.range.getStartPosition());if(t){const e=yield this._createColorHover(this._editor.getModel(),t.colorInfo,t.provider);return[e]}}return[]}))}_createColorHover(e,t,o){return __awaiter(this,void 0,void 0,(function*(){const r=e.getValueInRange(t.range),{red:n,green:i,blue:a,alpha:s}=t.color,c=new RGBA(Math.round(255*n),Math.round(255*i),Math.round(255*a),s),l=new Color(c),d=yield getColorPresentations(e,t,o,CancellationToken.None),u=new ColorPickerModel(l,[],0);return u.colorPresentations=d||[],u.guessColorPresentation(l,r),new ColorHover(this,Range.lift(t.range),u,o)}))}renderHoverParts(e,t){if(0===t.length||!this._editor.hasModel())return Disposable.None;const o=new DisposableStore,r=t[0],n=this._editor.getModel(),i=r.model,a=o.add(new ColorPickerWidget(e.fragment,i,this._editor.getOption(129),this._themeService));e.setColorPicker(a);let s=new Range(r.range.startLineNumber,r.range.startColumn,r.range.endLineNumber,r.range.endColumn);const c=()=>{let t,o;if(i.presentation.textEdit){t=[i.presentation.textEdit],o=new Range(i.presentation.textEdit.range.startLineNumber,i.presentation.textEdit.range.startColumn,i.presentation.textEdit.range.endLineNumber,i.presentation.textEdit.range.endColumn);const e=this._editor.getModel()._setTrackedRange(null,o,3);this._editor.pushUndoStop(),this._editor.executeEdits("colorpicker",t),o=this._editor.getModel()._getTrackedRange(e)||o}else t=[{identifier:null,range:s,text:i.presentation.label,forceMoveMarkers:!1}],o=s.setEndPosition(s.endLineNumber,s.startColumn+i.presentation.label.length),this._editor.pushUndoStop(),this._editor.executeEdits("colorpicker",t);i.presentation.additionalTextEdits&&(t=[...i.presentation.additionalTextEdits],this._editor.executeEdits("colorpicker",t),e.hide()),this._editor.pushUndoStop(),s=o},l=e=>getColorPresentations(n,{range:s,color:{red:e.rgba.r/255,green:e.rgba.g/255,blue:e.rgba.b/255,alpha:e.rgba.a}},r.provider,CancellationToken.None).then((e=>{i.colorPresentations=e||[]}));return o.add(i.onColorFlushed((e=>{l(e).then(c)}))),o.add(i.onDidChangeColor(l)),o}};ColorHoverParticipant=__decorate([__param(1,IThemeService)],ColorHoverParticipant);export{ColorHoverParticipant};