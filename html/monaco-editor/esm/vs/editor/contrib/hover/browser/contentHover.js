var __decorate=this&&this.__decorate||function(t,e,o,i){var s,n=arguments.length,r=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,o):i;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)r=Reflect.decorate(t,e,o,i);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(r=(n<3?s(r):n>3?s(e,o,r):s(e,o))||r);return n>3&&r&&Object.defineProperty(e,o,r),r},__param=this&&this.__param||function(t,e){return function(o,i){e(o,i,t)}};import*as dom from"../../../../base/browser/dom.js";import{HoverAction,HoverWidget}from"../../../../base/browser/ui/hover/hoverWidget.js";import{coalesce}from"../../../../base/common/arrays.js";import{Disposable,DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";import{TokenizationRegistry}from"../../../common/languages.js";import{ColorHoverParticipant}from"./colorHoverParticipant.js";import{HoverOperation}from"./hoverOperation.js";import{HoverRangeAnchor}from"./hoverTypes.js";import{MarkdownHoverParticipant}from"./markdownHoverParticipant.js";import{MarkerHoverParticipant}from"./markerHoverParticipant.js";import{InlineCompletionsHoverParticipant}from"../../inlineCompletions/browser/inlineCompletionsHoverParticipant.js";import{IContextKeyService}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService}from"../../../../platform/keybinding/common/keybinding.js";import{Context as SuggestContext}from"../../suggest/browser/suggest.js";import{UnicodeHighlighterHoverParticipant}from"../../unicodeHighlighter/browser/unicodeHighlighter.js";import{AsyncIterableObject}from"../../../../base/common/async.js";import{InlayHintsHover}from"../../inlayHints/browser/inlayHintsHover.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{Emitter}from"../../../../base/common/event.js";const $=dom.$;let ContentHoverController=class t extends Disposable{constructor(t,e,o){super(),this._editor=t,this._instantiationService=e,this._keybindingService=o,this._participants=[this._instantiationService.createInstance(ColorHoverParticipant,this._editor),this._instantiationService.createInstance(MarkdownHoverParticipant,this._editor),this._instantiationService.createInstance(InlineCompletionsHoverParticipant,this._editor),this._instantiationService.createInstance(UnicodeHighlighterHoverParticipant,this._editor),this._instantiationService.createInstance(MarkerHoverParticipant,this._editor),this._instantiationService.createInstance(InlayHintsHover,this._editor)],this._widget=this._register(this._instantiationService.createInstance(ContentHoverWidget,this._editor)),this._decorationsChangerListener=this._register(new EditorDecorationsChangerListener(this._editor)),this._computer=new ContentHoverComputer(this._editor,this._participants),this._hoverOperation=this._register(new HoverOperation(this._editor,this._computer)),this._messages=[],this._messagesAreComplete=!1,this._register(this._hoverOperation.onResult((t=>{this._withResult(t.value,t.isComplete,t.hasLoadingMessage)}))),this._register(this._decorationsChangerListener.onDidChangeModelDecorations((()=>this._onModelDecorationsChanged()))),this._register(dom.addStandardDisposableListener(this._widget.getDomNode(),"keydown",(t=>{t.equals(9)&&this.hide()}))),this._register(TokenizationRegistry.onDidChange((()=>{this._widget.position&&this._computer.anchor&&this._messages.length>0&&(this._widget.clear(),this._renderMessages(this._computer.anchor,this._messages))})))}_onModelDecorationsChanged(){this._widget.position&&(this._hoverOperation.cancel(),this._widget.colorPicker||this._hoverOperation.start(0))}maybeShowAt(t){const e=[];for(const i of this._participants)if(i.suggestHoverAnchor){const o=i.suggestHoverAnchor(t);o&&e.push(o)}const o=t.target;if(6===o.type&&e.push(new HoverRangeAnchor(0,o.range)),7===o.type){const t=this._editor.getOption(44).typicalHalfwidthCharacterWidth/2;!o.detail.isAfterLines&&"number"===typeof o.detail.horizontalDistanceToText&&o.detail.horizontalDistanceToText<t&&e.push(new HoverRangeAnchor(0,o.range))}return 0!==e.length&&(e.sort(((t,e)=>e.priority-t.priority)),this._startShowingAt(e[0],0,!1),!0)}startShowingAtRange(t,e,o){this._startShowingAt(new HoverRangeAnchor(0,t),e,o)}_startShowingAt(t,e,o){if(!this._computer.anchor||!this._computer.anchor.equals(t)){if(this._hoverOperation.cancel(),this._widget.position)if(this._computer.anchor&&t.canAdoptVisibleHover(this._computer.anchor,this._widget.position)){const e=this._messages.filter((e=>e.isValidForHoverAnchor(t)));if(0===e.length)this.hide();else{if(e.length===this._messages.length&&this._messagesAreComplete)return;this._renderMessages(t,e)}}else this.hide();this._computer.anchor=t,this._computer.shouldFocus=o,this._hoverOperation.start(e)}}hide(){this._computer.anchor=null,this._hoverOperation.cancel(),this._widget.hide()}isColorPickerVisible(){return!!this._widget.colorPicker}_addLoadingMessage(t){if(this._computer.anchor)for(const e of this._participants)if(e.createLoadingMessage){const o=e.createLoadingMessage(this._computer.anchor);if(o)return t.slice(0).concat([o])}return t}_withResult(t,e,o){this._messages=o?this._addLoadingMessage(t):t,this._messagesAreComplete=e,this._computer.anchor&&this._messages.length>0?this._renderMessages(this._computer.anchor,this._messages):e&&this.hide()}_renderMessages(e,o){let i=1073741824,s=o[0].range,n=null;for(const t of o)i=Math.min(i,t.range.startColumn),s=Range.plusRange(s,t.range),t.forceShowAtRange&&(n=t.range);const r=new DisposableStore,a=r.add(new EditorHoverStatusBar(this._keybindingService)),h=document.createDocumentFragment();let c=null;const l={fragment:h,statusBar:a,setColorPicker:t=>c=t,onContentsChanged:()=>this._widget.onContentsChanged(),hide:()=>this.hide()};for(const t of this._participants){const e=o.filter((e=>e.owner===t));e.length>0&&r.add(t.renderHoverParts(l,e))}if(a.hasContent&&h.appendChild(a.hoverElement),h.hasChildNodes()){if(s){const e=this._decorationsChangerListener.deltaDecorations([],[{range:s,options:t._DECORATION_OPTIONS}]);r.add(toDisposable((()=>{this._decorationsChangerListener.deltaDecorations(e,[])})))}this._widget.showAt(h,new ContentHoverVisibleData(c,n?n.getStartPosition():new Position(e.range.startLineNumber,i),n||s,this._editor.getOption(53).above,this._computer.shouldFocus,r))}else r.dispose()}};ContentHoverController._DECORATION_OPTIONS=ModelDecorationOptions.register({description:"content-hover-highlight",className:"hoverHighlight"}),ContentHoverController=__decorate([__param(1,IInstantiationService),__param(2,IKeybindingService)],ContentHoverController);export{ContentHoverController};class EditorDecorationsChangerListener extends Disposable{constructor(t){super(),this._editor=t,this._onDidChangeModelDecorations=this._register(new Emitter),this.onDidChangeModelDecorations=this._onDidChangeModelDecorations.event,this._isChangingDecorations=!1,this._register(this._editor.onDidChangeModelDecorations((t=>{this._isChangingDecorations||this._onDidChangeModelDecorations.fire(t)})))}deltaDecorations(t,e){try{return this._isChangingDecorations=!0,this._editor.deltaDecorations(t,e)}finally{this._isChangingDecorations=!1}}}class ContentHoverVisibleData{constructor(t,e,o,i,s,n){this.colorPicker=t,this.showAtPosition=e,this.showAtRange=o,this.preferAbove=i,this.stoleFocus=s,this.disposables=n}}let ContentHoverWidget=class t extends Disposable{constructor(t,e){super(),this._editor=t,this._contextKeyService=e,this.allowEditorOverflow=!0,this._hoverVisibleKey=EditorContextKeys.hoverVisible.bindTo(this._contextKeyService),this._hover=this._register(new HoverWidget),this._visibleData=null,this._register(this._editor.onDidLayoutChange((()=>this._layout()))),this._register(this._editor.onDidChangeConfiguration((t=>{t.hasChanged(44)&&this._updateFont()}))),this._setVisibleData(null),this._layout(),this._editor.addContentWidget(this)}get position(){var t,e;return null!==(e=null===(t=this._visibleData)||void 0===t?void 0:t.showAtPosition)&&void 0!==e?e:null}get colorPicker(){var t,e;return null!==(e=null===(t=this._visibleData)||void 0===t?void 0:t.colorPicker)&&void 0!==e?e:null}dispose(){this._editor.removeContentWidget(this),this._visibleData&&this._visibleData.disposables.dispose(),super.dispose()}getId(){return t.ID}getDomNode(){return this._hover.containerDomNode}getPosition(){if(!this._visibleData)return null;let t=this._visibleData.preferAbove;return!t&&this._contextKeyService.getContextKeyValue(SuggestContext.Visible.key)&&(t=!0),{position:this._visibleData.showAtPosition,range:this._visibleData.showAtRange,preference:t?[1,2]:[2,1]}}_setVisibleData(t){this._visibleData&&this._visibleData.disposables.dispose(),this._visibleData=t,this._hoverVisibleKey.set(!!this._visibleData),this._hover.containerDomNode.classList.toggle("hidden",!this._visibleData)}_layout(){const t=Math.max(this._editor.getLayoutInfo().height/4,250),{fontSize:e,lineHeight:o}=this._editor.getOption(44);this._hover.contentsDomNode.style.fontSize=`${e}px`,this._hover.contentsDomNode.style.lineHeight=""+o/e,this._hover.contentsDomNode.style.maxHeight=`${t}px`,this._hover.contentsDomNode.style.maxWidth=`${Math.max(.66*this._editor.getLayoutInfo().width,500)}px`}_updateFont(){const t=Array.prototype.slice.call(this._hover.contentsDomNode.getElementsByClassName("code"));t.forEach((t=>this._editor.applyFontInfo(t)))}showAt(t,e){this._setVisibleData(e),this._hover.contentsDomNode.textContent="",this._hover.contentsDomNode.appendChild(t),this._hover.contentsDomNode.style.paddingBottom="",this._updateFont(),this._editor.layoutContentWidget(this),this.onContentsChanged(),this._editor.render(),this._editor.layoutContentWidget(this),this.onContentsChanged(),e.stoleFocus&&this._hover.containerDomNode.focus(),e.colorPicker&&e.colorPicker.layout()}hide(){if(this._visibleData){const t=this._visibleData.stoleFocus;this._setVisibleData(null),this._editor.layoutContentWidget(this),t&&this._editor.focus()}}onContentsChanged(){this._hover.onContentsChanged();const t=this._hover.scrollbar.getScrollDimensions(),e=t.scrollWidth>t.width;if(e){const t=`${this._hover.scrollbar.options.horizontalScrollbarSize}px`;this._hover.contentsDomNode.style.paddingBottom!==t&&(this._hover.contentsDomNode.style.paddingBottom=t,this._editor.layoutContentWidget(this),this._hover.onContentsChanged())}}clear(){this._hover.contentsDomNode.textContent=""}};ContentHoverWidget.ID="editor.contrib.contentHoverWidget",ContentHoverWidget=__decorate([__param(1,IContextKeyService)],ContentHoverWidget);export{ContentHoverWidget};let EditorHoverStatusBar=class extends Disposable{constructor(t){super(),this._keybindingService=t,this._hasContent=!1,this.hoverElement=$("div.hover-row.status-bar"),this.actionsElement=dom.append(this.hoverElement,$("div.actions"))}get hasContent(){return this._hasContent}addAction(t){const e=this._keybindingService.lookupKeybinding(t.commandId),o=e?e.getLabel():null;return this._hasContent=!0,this._register(HoverAction.render(this.actionsElement,t,o))}append(t){const e=dom.append(this.actionsElement,t);return this._hasContent=!0,e}};EditorHoverStatusBar=__decorate([__param(0,IKeybindingService)],EditorHoverStatusBar);class ContentHoverComputer{constructor(t,e){this._editor=t,this._participants=e,this._anchor=null,this._shouldFocus=!1}get anchor(){return this._anchor}set anchor(t){this._anchor=t}get shouldFocus(){return this._shouldFocus}set shouldFocus(t){this._shouldFocus=t}static _getLineDecorations(t,e){if(1!==e.type)return[];const o=t.getModel(),i=e.range.startLineNumber,s=o.getLineMaxColumn(i);return t.getLineDecorations(i).filter((t=>{if(t.options.isWholeLine)return!0;const o=t.range.startLineNumber===i?t.range.startColumn:1,n=t.range.endLineNumber===i?t.range.endColumn:s;if(t.options.showIfCollapsed){if(o>e.range.startColumn+1||e.range.endColumn-1>n)return!1}else if(o>e.range.startColumn||e.range.endColumn>n)return!1;return!0}))}computeAsync(t){const e=this._anchor;if(!this._editor.hasModel()||!e)return AsyncIterableObject.EMPTY;const o=ContentHoverComputer._getLineDecorations(this._editor,e);return AsyncIterableObject.merge(this._participants.map((i=>i.computeAsync?i.computeAsync(e,o,t):AsyncIterableObject.EMPTY)))}computeSync(){if(!this._editor.hasModel()||!this._anchor)return[];const t=ContentHoverComputer._getLineDecorations(this._editor,this._anchor);let e=[];for(const o of this._participants)e=e.concat(o.computeSync(this._anchor,t));return coalesce(e)}}