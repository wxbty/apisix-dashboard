var __decorate=this&&this.__decorate||function(e,r,o,t){var n,i=arguments.length,s=i<3?r:null===t?t=Object.getOwnPropertyDescriptor(r,o):t;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,r,o,t);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(i<3?n(s):i>3?n(r,o,s):n(r,o))||s);return i>3&&s&&Object.defineProperty(r,o,s),s},__param=this&&this.__param||function(e,r){return function(o,t){r(o,t,e)}};import*as dom from"../../../../base/browser/dom.js";import{isNonEmptyArray}from"../../../../base/common/arrays.js";import{createCancelablePromise,disposableTimeout}from"../../../../base/common/async.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{Disposable,DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import{basename}from"../../../../base/common/resources.js";import{Range}from"../../../common/core/range.js";import{IMarkerDecorationsService}from"../../../common/services/markerDecorations.js";import{getCodeActions}from"../../codeAction/browser/codeAction.js";import{QuickFixAction,QuickFixController}from"../../codeAction/browser/codeActionCommands.js";import{CodeActionKind}from"../../codeAction/browser/types.js";import{MarkerController,NextMarkerAction}from"../../gotoError/browser/gotoError.js";import*as nls from"../../../../nls.js";import{IMarkerData,MarkerSeverity}from"../../../../platform/markers/common/markers.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";import{Progress}from"../../../../platform/progress/common/progress.js";import{textLinkActiveForeground,textLinkForeground}from"../../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";const $=dom.$;export class MarkerHover{constructor(e,r,o){this.owner=e,this.range=r,this.marker=o}isValidForHoverAnchor(e){return 1===e.type&&this.range.startColumn<=e.range.startColumn&&this.range.endColumn>=e.range.endColumn}}const markerCodeActionTrigger={type:1,filter:{include:CodeActionKind.QuickFix}};let MarkerHoverParticipant=class{constructor(e,r,o){this._editor=e,this._markerDecorationsService=r,this._openerService=o,this.recentMarkerCodeActionsInfo=void 0}computeSync(e,r){if(!this._editor.hasModel()||1!==e.type)return[];const o=this._editor.getModel(),t=e.range.startLineNumber,n=o.getLineMaxColumn(t),i=[];for(const s of r){const r=s.range.startLineNumber===t?s.range.startColumn:1,a=s.range.endLineNumber===t?s.range.endColumn:n,c=this._markerDecorationsService.getMarker(o.uri,s);if(!c)continue;const m=new Range(e.range.startLineNumber,r,e.range.startLineNumber,a);i.push(new MarkerHover(this,m,c))}return i}renderHoverParts(e,r){if(!r.length)return Disposable.None;const o=new DisposableStore;r.forEach((r=>e.fragment.appendChild(this.renderMarkerHover(r,o))));const t=1===r.length?r[0]:r.sort(((e,r)=>MarkerSeverity.compare(e.marker.severity,r.marker.severity)))[0];return this.renderMarkerStatusbar(e,t,o),o}renderMarkerHover(e,r){const o=$("div.hover-row"),t=dom.append(o,$("div.marker.hover-contents")),{source:n,message:i,code:s,relatedInformation:a}=e.marker;this._editor.applyFontInfo(t);const c=dom.append(t,$("span"));if(c.style.whiteSpace="pre-wrap",c.innerText=i,n||s)if(s&&"string"!==typeof s){const e=$("span");if(n){const r=dom.append(e,$("span"));r.innerText=n}const o=dom.append(e,$("a.code-link"));o.setAttribute("href",s.target.toString()),r.add(dom.addDisposableListener(o,"click",(e=>{this._openerService.open(s.target,{allowCommands:!0}),e.preventDefault(),e.stopPropagation()})));const i=dom.append(o,$("span"));i.innerText=s.value;const a=dom.append(t,e);a.style.opacity="0.6",a.style.paddingLeft="6px"}else{const e=dom.append(t,$("span"));e.style.opacity="0.6",e.style.paddingLeft="6px",e.innerText=n&&s?`${n}(${s})`:n||`(${s})`}if(isNonEmptyArray(a))for(const{message:m,resource:d,startLineNumber:p,startColumn:l}of a){const e=dom.append(t,$("div"));e.style.marginTop="8px";const o=dom.append(e,$("a"));o.innerText=`${basename(d)}(${p}, ${l}): `,o.style.cursor="pointer",r.add(dom.addDisposableListener(o,"click",(e=>{e.stopPropagation(),e.preventDefault(),this._openerService&&this._openerService.open(d,{fromUserGesture:!0,editorOptions:{selection:{startLineNumber:p,startColumn:l}}}).catch(onUnexpectedError)})));const n=dom.append(e,$("span"));n.innerText=m,this._editor.applyFontInfo(n)}return o}renderMarkerStatusbar(e,r,o){if(r.marker.severity!==MarkerSeverity.Error&&r.marker.severity!==MarkerSeverity.Warning&&r.marker.severity!==MarkerSeverity.Info||e.statusBar.addAction({label:nls.localize("view problem","View Problem"),commandId:NextMarkerAction.ID,run:()=>{var o;e.hide(),null===(o=MarkerController.get(this._editor))||void 0===o||o.showAtMarker(r.marker),this._editor.focus()}}),!this._editor.getOption(81)){const t=e.statusBar.append($("div"));this.recentMarkerCodeActionsInfo&&(IMarkerData.makeKey(this.recentMarkerCodeActionsInfo.marker)===IMarkerData.makeKey(r.marker)?this.recentMarkerCodeActionsInfo.hasCodeActions||(t.textContent=nls.localize("noQuickFixes","No quick fixes available")):this.recentMarkerCodeActionsInfo=void 0);const n=this.recentMarkerCodeActionsInfo&&!this.recentMarkerCodeActionsInfo.hasCodeActions?Disposable.None:o.add(disposableTimeout((()=>t.textContent=nls.localize("checkingForQuickFixes","Checking for quick fixes...")),200));t.textContent||(t.textContent=String.fromCharCode(160));const i=this.getCodeActions(r.marker);o.add(toDisposable((()=>i.cancel()))),i.then((i=>{if(n.dispose(),this.recentMarkerCodeActionsInfo={marker:r.marker,hasCodeActions:i.validActions.length>0},!this.recentMarkerCodeActionsInfo.hasCodeActions)return i.dispose(),void(t.textContent=nls.localize("noQuickFixes","No quick fixes available"));t.style.display="none";let s=!1;o.add(toDisposable((()=>{s||i.dispose()}))),e.statusBar.addAction({label:nls.localize("quick fixes","Quick Fix..."),commandId:QuickFixAction.Id,run:r=>{s=!0;const o=QuickFixController.get(this._editor),t=dom.getDomNodePagePosition(r);e.hide(),null===o||void 0===o||o.showCodeActions(markerCodeActionTrigger,i,{x:t.left+6,y:t.top+t.height+6})}})}),onUnexpectedError)}}getCodeActions(e){return createCancelablePromise((r=>getCodeActions(this._editor.getModel(),new Range(e.startLineNumber,e.startColumn,e.endLineNumber,e.endColumn),markerCodeActionTrigger,Progress.None,r)))}};MarkerHoverParticipant=__decorate([__param(1,IMarkerDecorationsService),__param(2,IOpenerService)],MarkerHoverParticipant);export{MarkerHoverParticipant};registerThemingParticipant(((e,r)=>{const o=e.getColor(textLinkForeground);o&&r.addRule(`.monaco-hover .hover-contents a.code-link span { color: ${o}; }`);const t=e.getColor(textLinkActiveForeground);t&&r.addRule(`.monaco-hover .hover-contents a.code-link span:hover { color: ${t}; }`)}));