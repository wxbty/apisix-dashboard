var __decorate=this&&this.__decorate||function(e,r,o,n){var t,a=arguments.length,i=a<3?r:null===n?n=Object.getOwnPropertyDescriptor(r,o):n;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)i=Reflect.decorate(e,r,o,n);else for(var s=e.length-1;s>=0;s--)(t=e[s])&&(i=(a<3?t(i):a>3?t(r,o,i):t(r,o))||i);return a>3&&i&&Object.defineProperty(r,o,i),i},__param=this&&this.__param||function(e,r){return function(o,n){r(o,n,e)}};import*as dom from"../../../../base/browser/dom.js";import{asArray}from"../../../../base/common/arrays.js";import{AsyncIterableObject}from"../../../../base/common/async.js";import{isEmptyMarkdownString,MarkdownString}from"../../../../base/common/htmlContent.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{MarkdownRenderer}from"../../markdownRenderer/browser/markdownRenderer.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{HoverProviderRegistry}from"../../../common/languages.js";import{ILanguageService}from"../../../common/services/language.js";import{getHover}from"./getHover.js";import*as nls from"../../../../nls.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";const $=dom.$;export class MarkdownHover{constructor(e,r,o,n){this.owner=e,this.range=r,this.contents=o,this.ordinal=n}isValidForHoverAnchor(e){return 1===e.type&&this.range.startColumn<=e.range.startColumn&&this.range.endColumn>=e.range.endColumn}}let MarkdownHoverParticipant=class{constructor(e,r,o,n){this._editor=e,this._languageService=r,this._openerService=o,this._configurationService=n}createLoadingMessage(e){return new MarkdownHover(this,e.range,[(new MarkdownString).appendText(nls.localize("modesContentHover.loading","Loading..."))],2e3)}computeSync(e,r){if(!this._editor.hasModel()||1!==e.type)return[];const o=this._editor.getModel(),n=e.range.startLineNumber,t=o.getLineMaxColumn(n),a=[];let i=1e3;const s=o.getLineLength(n),c=o.getLanguageIdAtPosition(e.range.startLineNumber,e.range.startColumn),m=this._configurationService.getValue("editor.maxTokenizationLineLength",{overrideIdentifier:c});"number"===typeof m&&s>=m&&a.push(new MarkdownHover(this,e.range,[{value:nls.localize("too many characters","Tokenization is skipped for long lines for performance reasons. This can be configured via `editor.maxTokenizationLineLength`.")}],i++));for(const d of r){const r=d.range.startLineNumber===n?d.range.startColumn:1,o=d.range.endLineNumber===n?d.range.endColumn:t,s=d.options.hoverMessage;if(!s||isEmptyMarkdownString(s))continue;const c=new Range(e.range.startLineNumber,r,e.range.startLineNumber,o);a.push(new MarkdownHover(this,c,asArray(s),i++))}return a}computeAsync(e,r,o){if(!this._editor.hasModel()||1!==e.type)return AsyncIterableObject.EMPTY;const n=this._editor.getModel();if(!HoverProviderRegistry.has(n))return AsyncIterableObject.EMPTY;const t=new Position(e.range.startLineNumber,e.range.startColumn);return getHover(n,t,o).filter((e=>!isEmptyMarkdownString(e.hover.contents))).map((r=>{const o=r.hover.range?Range.lift(r.hover.range):e.range;return new MarkdownHover(this,o,r.hover.contents,r.ordinal)}))}renderHoverParts(e,r){return renderMarkdownHovers(e,r,this._editor,this._languageService,this._openerService)}};MarkdownHoverParticipant=__decorate([__param(1,ILanguageService),__param(2,IOpenerService),__param(3,IConfigurationService)],MarkdownHoverParticipant);export{MarkdownHoverParticipant};export function renderMarkdownHovers(e,r,o,n,t){r.sort(((e,r)=>e.ordinal-r.ordinal));const a=new DisposableStore;for(const i of r)for(const r of i.contents){if(isEmptyMarkdownString(r))continue;const i=$("div.hover-row.markdown-hover"),s=dom.append(i,$("div.hover-contents")),c=a.add(new MarkdownRenderer({editor:o},n,t));a.add(c.onDidRenderAsync((()=>{s.className="hover-contents code-hover-contents",e.onContentsChanged()})));const m=a.add(c.render(r));s.appendChild(m.element),e.fragment.appendChild(i)}return a}