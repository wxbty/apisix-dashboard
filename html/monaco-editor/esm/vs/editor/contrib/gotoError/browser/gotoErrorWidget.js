var __decorate=this&&this.__decorate||function(e,t,r,o){var i,a=arguments.length,n=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)n=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(n=(a<3?i(n):a>3?i(t,r,n):i(t,r))||n);return a>3&&n&&Object.defineProperty(t,r,n),n},__param=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};import*as dom from"../../../../base/browser/dom.js";import{ScrollableElement}from"../../../../base/browser/ui/scrollbar/scrollableElement.js";import{isNonEmptyArray}from"../../../../base/common/arrays.js";import{Color}from"../../../../base/common/color.js";import{Emitter}from"../../../../base/common/event.js";import{getBaseLabel}from"../../../../base/common/labels.js";import{DisposableStore,dispose}from"../../../../base/common/lifecycle.js";import{basename}from"../../../../base/common/resources.js";import{splitLines}from"../../../../base/common/strings.js";import"./media/gotoErrorWidget.css";import{Range}from"../../../common/core/range.js";import{peekViewTitleForeground,peekViewTitleInfoForeground,PeekViewWidget}from"../../peekView/browser/peekView.js";import*as nls from"../../../../nls.js";import{createAndFillInActionBarActions}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService,MenuId}from"../../../../platform/actions/common/actions.js";import{IContextKeyService}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{ILabelService}from"../../../../platform/label/common/label.js";import{MarkerSeverity}from"../../../../platform/markers/common/markers.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";import{SeverityIcon}from"../../../../platform/severityIcon/common/severityIcon.js";import{contrastBorder,editorBackground,editorErrorBorder,editorErrorForeground,editorInfoBorder,editorInfoForeground,editorWarningBorder,editorWarningForeground,oneOf,registerColor,transparent}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService}from"../../../../platform/theme/common/themeService.js";class MessageWidget{constructor(e,t,r,o,i){this._openerService=o,this._labelService=i,this._lines=0,this._longestLineLength=0,this._relatedDiagnostics=new WeakMap,this._disposables=new DisposableStore,this._editor=t;const a=document.createElement("div");a.className="descriptioncontainer",this._messageBlock=document.createElement("div"),this._messageBlock.classList.add("message"),this._messageBlock.setAttribute("aria-live","assertive"),this._messageBlock.setAttribute("role","alert"),a.appendChild(this._messageBlock),this._relatedBlock=document.createElement("div"),a.appendChild(this._relatedBlock),this._disposables.add(dom.addStandardDisposableListener(this._relatedBlock,"click",(e=>{e.preventDefault();const t=this._relatedDiagnostics.get(e.target);t&&r(t)}))),this._scrollable=new ScrollableElement(a,{horizontal:1,vertical:1,useShadows:!1,horizontalScrollbarSize:6,verticalScrollbarSize:6}),e.appendChild(this._scrollable.getDomNode()),this._disposables.add(this._scrollable.onScroll((e=>{a.style.left=`-${e.scrollLeft}px`,a.style.top=`-${e.scrollTop}px`}))),this._disposables.add(this._scrollable)}dispose(){dispose(this._disposables)}update(e){const{source:t,message:r,relatedInformation:o,code:i}=e;let a=((null===t||void 0===t?void 0:t.length)||0)+"()".length;i&&(a+="string"===typeof i?i.length:i.value.length);const n=splitLines(r);this._lines=n.length,this._longestLineLength=0;for(const g of n)this._longestLineLength=Math.max(g.length+a,this._longestLineLength);dom.clearNode(this._messageBlock),this._messageBlock.setAttribute("aria-label",this.getAriaLabel(e)),this._editor.applyFontInfo(this._messageBlock);let s=this._messageBlock;for(const g of n)s=document.createElement("div"),s.innerText=g,""===g&&(s.style.height=this._messageBlock.style.lineHeight),this._messageBlock.appendChild(s);if(t||i){const e=document.createElement("span");if(e.classList.add("details"),s.appendChild(e),t){const r=document.createElement("span");r.innerText=t,r.classList.add("source"),e.appendChild(r)}if(i)if("string"===typeof i){const t=document.createElement("span");t.innerText=`(${i})`,t.classList.add("code"),e.appendChild(t)}else{this._codeLink=dom.$("a.code-link"),this._codeLink.setAttribute("href",`${i.target.toString()}`),this._codeLink.onclick=e=>{this._openerService.open(i.target,{allowCommands:!0}),e.preventDefault(),e.stopPropagation()};const t=dom.append(this._codeLink,dom.$("span"));t.innerText=i.value,e.appendChild(this._codeLink)}}if(dom.clearNode(this._relatedBlock),this._editor.applyFontInfo(this._relatedBlock),isNonEmptyArray(o)){const e=this._relatedBlock.appendChild(document.createElement("div"));e.style.paddingTop=`${Math.floor(.66*this._editor.getOption(59))}px`,this._lines+=1;for(const t of o){let r=document.createElement("div"),o=document.createElement("a");o.classList.add("filename"),o.innerText=`${getBaseLabel(t.resource)}(${t.startLineNumber}, ${t.startColumn}): `,o.title=this._labelService.getUriLabel(t.resource),this._relatedDiagnostics.set(o,t);let i=document.createElement("span");i.innerText=t.message,r.appendChild(o),r.appendChild(i),this._lines+=1,e.appendChild(r)}}const l=this._editor.getOption(44),d=Math.ceil(l.typicalFullwidthCharacterWidth*this._longestLineLength*.75),c=l.lineHeight*this._lines;this._scrollable.setScrollDimensions({scrollWidth:d,scrollHeight:c})}layout(e,t){this._scrollable.getDomNode().style.height=`${e}px`,this._scrollable.getDomNode().style.width=`${t}px`,this._scrollable.setScrollDimensions({width:t,height:e})}getHeightInLines(){return Math.min(17,this._lines)}getAriaLabel(e){let t="";switch(e.severity){case MarkerSeverity.Error:t=nls.localize("Error","Error");break;case MarkerSeverity.Warning:t=nls.localize("Warning","Warning");break;case MarkerSeverity.Info:t=nls.localize("Info","Info");break;case MarkerSeverity.Hint:t=nls.localize("Hint","Hint");break}let r=nls.localize("marker aria","{0} at {1}. ",t,e.startLineNumber+":"+e.startColumn);const o=this._editor.getModel();if(o&&e.startLineNumber<=o.getLineCount()&&e.startLineNumber>=1){const t=o.getLineContent(e.startLineNumber);r=`${t}, ${r}`}return r}}let MarkerNavigationWidget=class e extends PeekViewWidget{constructor(e,t,r,o,i,a,n){super(e,{showArrow:!0,showFrame:!0,isAccessible:!0,frameWidth:1},i),this._themeService=t,this._openerService=r,this._menuService=o,this._contextKeyService=a,this._labelService=n,this._callOnDispose=new DisposableStore,this._onDidSelectRelatedInformation=new Emitter,this.onDidSelectRelatedInformation=this._onDidSelectRelatedInformation.event,this._severity=MarkerSeverity.Warning,this._backgroundColor=Color.white,this._applyTheme(t.getColorTheme()),this._callOnDispose.add(t.onDidColorThemeChange(this._applyTheme.bind(this))),this.create()}_applyTheme(e){this._backgroundColor=e.getColor(editorMarkerNavigationBackground);let t=editorMarkerNavigationError,r=editorMarkerNavigationErrorHeader;this._severity===MarkerSeverity.Warning?(t=editorMarkerNavigationWarning,r=editorMarkerNavigationWarningHeader):this._severity===MarkerSeverity.Info&&(t=editorMarkerNavigationInfo,r=editorMarkerNavigationInfoHeader);const o=e.getColor(t),i=e.getColor(r);this.style({arrowColor:o,frameColor:o,headerBackgroundColor:i,primaryHeadingColor:e.getColor(peekViewTitleForeground),secondaryHeadingColor:e.getColor(peekViewTitleInfoForeground)})}_applyStyles(){this._parentContainer&&(this._parentContainer.style.backgroundColor=this._backgroundColor?this._backgroundColor.toString():""),super._applyStyles()}dispose(){this._callOnDispose.dispose(),super.dispose()}_fillHead(t){super._fillHead(t),this._disposables.add(this._actionbarWidget.actionRunner.onBeforeRun((e=>this.editor.focus())));const r=[],o=this._menuService.createMenu(e.TitleMenu,this._contextKeyService);createAndFillInActionBarActions(o,void 0,r),this._actionbarWidget.push(r,{label:!1,icon:!0,index:0}),o.dispose()}_fillTitleIcon(e){this._icon=dom.append(e,dom.$(""))}_fillBody(e){this._parentContainer=e,e.classList.add("marker-widget"),this._parentContainer.tabIndex=0,this._parentContainer.setAttribute("role","tooltip"),this._container=document.createElement("div"),e.appendChild(this._container),this._message=new MessageWidget(this._container,this.editor,(e=>this._onDidSelectRelatedInformation.fire(e)),this._openerService,this._labelService),this._disposables.add(this._message)}show(){throw new Error("call showAtMarker")}showAtMarker(e,t,r){this._container.classList.remove("stale"),this._message.update(e),this._severity=e.severity,this._applyTheme(this._themeService.getColorTheme());let o=Range.lift(e);const i=this.editor.getPosition();let a=i&&o.containsPosition(i)?i:o.getStartPosition();super.show(a,this.computeRequiredHeight());const n=this.editor.getModel();if(n){const e=r>1?nls.localize("problems","{0} of {1} problems",t,r):nls.localize("change","{0} of {1} problem",t,r);this.setTitle(basename(n.uri),e)}this._icon.className=`codicon ${SeverityIcon.className(MarkerSeverity.toSeverity(this._severity))}`,this.editor.revealPositionNearTop(a,0),this.editor.focus()}updateMarker(e){this._container.classList.remove("stale"),this._message.update(e)}showStale(){this._container.classList.add("stale"),this._relayout()}_doLayoutBody(e,t){super._doLayoutBody(e,t),this._heightInPixel=e,this._message.layout(e,t),this._container.style.height=`${e}px`}_onWidth(e){this._message.layout(this._heightInPixel,e)}_relayout(){super._relayout(this.computeRequiredHeight())}computeRequiredHeight(){return 3+this._message.getHeightInLines()}};MarkerNavigationWidget.TitleMenu=new MenuId("gotoErrorTitleMenu"),MarkerNavigationWidget=__decorate([__param(1,IThemeService),__param(2,IOpenerService),__param(3,IMenuService),__param(4,IInstantiationService),__param(5,IContextKeyService),__param(6,ILabelService)],MarkerNavigationWidget);export{MarkerNavigationWidget};let errorDefault=oneOf(editorErrorForeground,editorErrorBorder),warningDefault=oneOf(editorWarningForeground,editorWarningBorder),infoDefault=oneOf(editorInfoForeground,editorInfoBorder);export const editorMarkerNavigationError=registerColor("editorMarkerNavigationError.background",{dark:errorDefault,light:errorDefault,hc:contrastBorder},nls.localize("editorMarkerNavigationError","Editor marker navigation widget error color."));export const editorMarkerNavigationErrorHeader=registerColor("editorMarkerNavigationError.headerBackground",{dark:transparent(editorMarkerNavigationError,.1),light:transparent(editorMarkerNavigationError,.1),hc:null},nls.localize("editorMarkerNavigationErrorHeaderBackground","Editor marker navigation widget error heading background."));export const editorMarkerNavigationWarning=registerColor("editorMarkerNavigationWarning.background",{dark:warningDefault,light:warningDefault,hc:contrastBorder},nls.localize("editorMarkerNavigationWarning","Editor marker navigation widget warning color."));export const editorMarkerNavigationWarningHeader=registerColor("editorMarkerNavigationWarning.headerBackground",{dark:transparent(editorMarkerNavigationWarning,.1),light:transparent(editorMarkerNavigationWarning,.1),hc:"#0C141F"},nls.localize("editorMarkerNavigationWarningBackground","Editor marker navigation widget warning heading background."));export const editorMarkerNavigationInfo=registerColor("editorMarkerNavigationInfo.background",{dark:infoDefault,light:infoDefault,hc:contrastBorder},nls.localize("editorMarkerNavigationInfo","Editor marker navigation widget info color."));export const editorMarkerNavigationInfoHeader=registerColor("editorMarkerNavigationInfo.headerBackground",{dark:transparent(editorMarkerNavigationInfo,.1),light:transparent(editorMarkerNavigationInfo,.1),hc:null},nls.localize("editorMarkerNavigationInfoHeaderBackground","Editor marker navigation widget info heading background."));export const editorMarkerNavigationBackground=registerColor("editorMarkerNavigation.background",{dark:editorBackground,light:editorBackground,hc:editorBackground},nls.localize("editorMarkerNavigationBackground","Editor marker navigation widget background."));