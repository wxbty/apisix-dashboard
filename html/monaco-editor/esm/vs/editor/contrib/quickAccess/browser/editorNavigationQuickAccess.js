import{once}from"../../../../base/common/functional.js";import{DisposableStore,MutableDisposable,toDisposable}from"../../../../base/common/lifecycle.js";import{withNullAsUndefined}from"../../../../base/common/types.js";import{getCodeEditor,isDiffEditor}from"../../../browser/editorBrowser.js";import{OverviewRulerLane}from"../../../common/model.js";import{overviewRulerRangeHighlight}from"../../../common/core/editorColorRegistry.js";import{themeColorFromId}from"../../../../platform/theme/common/themeService.js";export class AbstractEditorNavigationQuickAccessProvider{constructor(e){this.options=e,this.rangeHighlightDecorationId=void 0}provide(e,o){var i;const t=new DisposableStore;e.canAcceptInBackground=!!(null===(i=this.options)||void 0===i?void 0:i.canAcceptInBackground),e.matchOnLabel=e.matchOnDescription=e.matchOnDetail=e.sortByLabel=!1;const r=t.add(new MutableDisposable);return r.value=this.doProvide(e,o),t.add(this.onDidActiveTextEditorControlChange((()=>{r.value=void 0,r.value=this.doProvide(e,o)}))),t}doProvide(e,o){const i=new DisposableStore,t=this.activeTextEditorControl;if(t&&this.canProvideWithTextEditor(t)){const r={editor:t},n=getCodeEditor(t);if(n){let e=withNullAsUndefined(t.saveViewState());i.add(n.onDidChangeCursorPosition((()=>{e=withNullAsUndefined(t.saveViewState())}))),r.restoreViewState=()=>{e&&t===this.activeTextEditorControl&&t.restoreViewState(e)},i.add(once(o.onCancellationRequested)((()=>{var e;return null===(e=r.restoreViewState)||void 0===e?void 0:e.call(r)})))}i.add(toDisposable((()=>this.clearDecorations(t)))),i.add(this.provideWithTextEditor(r,e,o))}else i.add(this.provideWithoutTextEditor(e,o));return i}canProvideWithTextEditor(e){return!0}gotoLocation({editor:e},o){e.setSelection(o.range),e.revealRangeInCenter(o.range,0),o.preserveFocus||e.focus()}getModel(e){var o;return isDiffEditor(e)?null===(o=e.getModel())||void 0===o?void 0:o.modified:e.getModel()}addDecorations(e,o){e.changeDecorations((e=>{const i=[];this.rangeHighlightDecorationId&&(i.push(this.rangeHighlightDecorationId.overviewRulerDecorationId),i.push(this.rangeHighlightDecorationId.rangeHighlightId),this.rangeHighlightDecorationId=void 0);const t=[{range:o,options:{description:"quick-access-range-highlight",className:"rangeHighlight",isWholeLine:!0}},{range:o,options:{description:"quick-access-range-highlight-overview",overviewRuler:{color:themeColorFromId(overviewRulerRangeHighlight),position:OverviewRulerLane.Full}}}],[r,n]=e.deltaDecorations(i,t);this.rangeHighlightDecorationId={rangeHighlightId:r,overviewRulerDecorationId:n}}))}clearDecorations(e){const o=this.rangeHighlightDecorationId;o&&(e.changeDecorations((e=>{e.deltaDecorations([o.overviewRulerDecorationId,o.rangeHighlightId],[])})),this.rangeHighlightDecorationId=void 0)}}