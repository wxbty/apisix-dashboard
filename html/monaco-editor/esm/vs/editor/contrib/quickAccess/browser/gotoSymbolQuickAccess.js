var __decorate=this&&this.__decorate||function(e,o,t,i){var r,n=arguments.length,s=n<3?o:null===i?i=Object.getOwnPropertyDescriptor(o,t):i;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,o,t,i);else for(var c=e.length-1;c>=0;c--)(r=e[c])&&(s=(n<3?r(s):n>3?r(o,t,s):r(o,t))||s);return n>3&&s&&Object.defineProperty(o,t,s),s},__param=this&&this.__param||function(e,o){return function(t,i){o(t,i,e)}},__awaiter=this&&this.__awaiter||function(e,o,t,i){function r(e){return e instanceof t?e:new t((function(o){o(e)}))}return new(t||(t=Promise))((function(t,n){function s(e){try{a(i.next(e))}catch(o){n(o)}}function c(e){try{a(i["throw"](e))}catch(o){n(o)}}function a(e){e.done?t(e.value):r(e.value).then(s,c)}a((i=i.apply(e,o||[])).next())}))};import{DeferredPromise}from"../../../../base/common/async.js";import{CancellationTokenSource}from"../../../../base/common/cancellation.js";import{Codicon}from"../../../../base/common/codicons.js";import{pieceToQuery,prepareQuery,scoreFuzzy2}from"../../../../base/common/fuzzyScorer.js";import{Disposable,DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import{format,trim}from"../../../../base/common/strings.js";import{Range}from"../../../common/core/range.js";import{DocumentSymbolProviderRegistry,SymbolKinds}from"../../../common/languages.js";import{IOutlineModelService}from"../../documentSymbols/browser/outlineModel.js";import{AbstractEditorNavigationQuickAccessProvider}from"./editorNavigationQuickAccess.js";import{localize}from"../../../../nls.js";let AbstractGotoSymbolQuickAccessProvider=class e extends AbstractEditorNavigationQuickAccessProvider{constructor(e,o=Object.create(null)){super(o),this._outlineModelService=e,this.options=o,this.options.canAcceptInBackground=!0}provideWithoutTextEditor(e){return this.provideLabelPick(e,localize("cannotRunGotoSymbolWithoutEditor","To go to a symbol, first open a text editor with symbol information.")),Disposable.None}provideWithTextEditor(e,o,t){const i=e.editor,r=this.getModel(i);return r?DocumentSymbolProviderRegistry.has(r)?this.doProvideWithEditorSymbols(e,r,o,t):this.doProvideWithoutEditorSymbols(e,r,o,t):Disposable.None}doProvideWithoutEditorSymbols(e,o,t,i){const r=new DisposableStore;return this.provideLabelPick(t,localize("cannotRunGotoSymbolWithoutSymbolProvider","The active text editor does not provide symbol information.")),(()=>{__awaiter(this,void 0,void 0,(function*(){const n=yield this.waitForLanguageSymbolRegistry(o,r);n&&!i.isCancellationRequested&&r.add(this.doProvideWithEditorSymbols(e,o,t,i))}))})(),r}provideLabelPick(e,o){e.items=[{label:o,index:0,kind:14}],e.ariaLabel=o}waitForLanguageSymbolRegistry(e,o){return __awaiter(this,void 0,void 0,(function*(){if(DocumentSymbolProviderRegistry.has(e))return!0;const t=new DeferredPromise,i=o.add(DocumentSymbolProviderRegistry.onDidChange((()=>{DocumentSymbolProviderRegistry.has(e)&&(i.dispose(),t.complete(!0))})));return o.add(toDisposable((()=>t.complete(!1)))),t.p}))}doProvideWithEditorSymbols(o,t,i,r){const n=o.editor,s=new DisposableStore;s.add(i.onDidAccept((e=>{const[t]=i.selectedItems;t&&t.range&&(this.gotoLocation(o,{range:t.range.selection,keyMods:i.keyMods,preserveFocus:e.inBackground}),e.inBackground||i.hide())}))),s.add(i.onDidTriggerItemButton((({item:e})=>{e&&e.range&&(this.gotoLocation(o,{range:e.range.selection,keyMods:i.keyMods,forceSideBySide:!0}),i.hide())})));const c=this.getDocumentSymbols(t,r);let a;const l=()=>__awaiter(this,void 0,void 0,(function*(){null===a||void 0===a||a.dispose(!0),i.busy=!1,a=new CancellationTokenSource(r),i.busy=!0;try{const o=prepareQuery(i.value.substr(e.PREFIX.length).trim()),t=yield this.doGetSymbolPicks(c,o,void 0,a.token);if(r.isCancellationRequested)return;t.length>0?i.items=t:o.original.length>0?this.provideLabelPick(i,localize("noMatchingSymbolResults","No matching editor symbols")):this.provideLabelPick(i,localize("noSymbolResults","No editor symbols"))}finally{r.isCancellationRequested||(i.busy=!1)}}));s.add(i.onDidChangeValue((()=>l()))),l();let d=!0;return s.add(i.onDidChangeActive((()=>{const[e]=i.activeItems;if(e&&e.range){if(d)return void(d=!1);n.revealRangeInCenter(e.range.selection,0),this.addDecorations(n,e.range.decoration)}}))),s}doGetSymbolPicks(o,t,i,r){return __awaiter(this,void 0,void 0,(function*(){const n=yield o;if(r.isCancellationRequested)return[];const s=0===t.original.indexOf(e.SCOPE_PREFIX),c=s?1:0;let a,l;t.values&&t.values.length>1?(a=pieceToQuery(t.values[0]),l=pieceToQuery(t.values.slice(1))):a=t;const d=[];for(let e=0;e<n.length;e++){const o=n[e],r=trim(o.name),s=`$(${SymbolKinds.toIcon(o.kind).id}) ${r}`,u=s.length-r.length;let m,b,p,y,f=o.containerName;if((null===i||void 0===i?void 0:i.extraContainerLabel)&&(f=f?`${i.extraContainerLabel} \u2022 ${f}`:i.extraContainerLabel),t.original.length>c){let e=!1;if(a!==t&&([m,b]=scoreFuzzy2(s,Object.assign(Object.assign({},t),{values:void 0}),c,u),"number"===typeof m&&(e=!0)),"number"!==typeof m&&([m,b]=scoreFuzzy2(s,a,c,u),"number"!==typeof m))continue;if(!e&&l){if(f&&l.original.length>0&&([p,y]=scoreFuzzy2(f,l)),"number"!==typeof p)continue;"number"===typeof m&&(m+=p)}}const h=o.tags&&o.tags.indexOf(1)>=0;d.push({index:e,kind:o.kind,score:m,label:s,ariaLabel:r,description:f,highlights:h?void 0:{label:b,description:y},range:{selection:Range.collapseToStart(o.selectionRange),decoration:o.range},strikethrough:h,buttons:(()=>{var e,o;const t=(null===(e=this.options)||void 0===e?void 0:e.openSideBySideDirection)?null===(o=this.options)||void 0===o?void 0:o.openSideBySideDirection():void 0;if(t)return[{iconClass:"right"===t?Codicon.splitHorizontal.classNames:Codicon.splitVertical.classNames,tooltip:"right"===t?localize("openToSide","Open to the Side"):localize("openToBottom","Open to the Bottom")}]})()})}const u=d.sort(((e,o)=>s?this.compareByKindAndScore(e,o):this.compareByScore(e,o)));let m=[];if(s){let e,o,t=0;function b(){o&&"number"===typeof e&&t>0&&(o.label=format(NLS_SYMBOL_KIND_CACHE[e]||FALLBACK_NLS_SYMBOL_KIND,t))}for(const i of u)e!==i.kind?(b(),e=i.kind,t=1,o={type:"separator"},m.push(o)):t++,m.push(i);b()}else u.length>0&&(m=[{label:localize("symbols","symbols ({0})",d.length),type:"separator"},...u]);return m}))}compareByScore(e,o){if("number"!==typeof e.score&&"number"===typeof o.score)return 1;if("number"===typeof e.score&&"number"!==typeof o.score)return-1;if("number"===typeof e.score&&"number"===typeof o.score){if(e.score>o.score)return-1;if(e.score<o.score)return 1}return e.index<o.index?-1:e.index>o.index?1:0}compareByKindAndScore(e,o){const t=NLS_SYMBOL_KIND_CACHE[e.kind]||FALLBACK_NLS_SYMBOL_KIND,i=NLS_SYMBOL_KIND_CACHE[o.kind]||FALLBACK_NLS_SYMBOL_KIND,r=t.localeCompare(i);return 0===r?this.compareByScore(e,o):r}getDocumentSymbols(e,o){return __awaiter(this,void 0,void 0,(function*(){const t=yield this._outlineModelService.getOrCreate(e,o);return o.isCancellationRequested?[]:t.asListOfDocumentSymbols()}))}};AbstractGotoSymbolQuickAccessProvider.PREFIX="@",AbstractGotoSymbolQuickAccessProvider.SCOPE_PREFIX=":",AbstractGotoSymbolQuickAccessProvider.PREFIX_BY_CATEGORY=`${AbstractGotoSymbolQuickAccessProvider.PREFIX}${AbstractGotoSymbolQuickAccessProvider.SCOPE_PREFIX}`,AbstractGotoSymbolQuickAccessProvider=__decorate([__param(0,IOutlineModelService)],AbstractGotoSymbolQuickAccessProvider);export{AbstractGotoSymbolQuickAccessProvider};const FALLBACK_NLS_SYMBOL_KIND=localize("property","properties ({0})"),NLS_SYMBOL_KIND_CACHE={[5]:localize("method","methods ({0})"),[11]:localize("function","functions ({0})"),[8]:localize("_constructor","constructors ({0})"),[12]:localize("variable","variables ({0})"),[4]:localize("class","classes ({0})"),[22]:localize("struct","structs ({0})"),[23]:localize("event","events ({0})"),[24]:localize("operator","operators ({0})"),[10]:localize("interface","interfaces ({0})"),[2]:localize("namespace","namespaces ({0})"),[3]:localize("package","packages ({0})"),[25]:localize("typeParameter","type parameters ({0})"),[1]:localize("modules","modules ({0})"),[6]:localize("property","properties ({0})"),[9]:localize("enum","enumerations ({0})"),[21]:localize("enumMember","enumeration members ({0})"),[14]:localize("string","strings ({0})"),[0]:localize("file","files ({0})"),[17]:localize("array","arrays ({0})"),[15]:localize("number","numbers ({0})"),[16]:localize("boolean","booleans ({0})"),[18]:localize("object","objects ({0})"),[19]:localize("key","keys ({0})"),[7]:localize("field","fields ({0})"),[13]:localize("constant","constants ({0})")};