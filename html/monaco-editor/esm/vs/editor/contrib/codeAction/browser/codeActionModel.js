var _CodeActionModel_isDisposed,__classPrivateFieldGet=this&&this.__classPrivateFieldGet||function(e,t,i,o){if("a"===i&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"===typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?o:"a"===i?o.call(e):o?o.value:t.get(e)},__classPrivateFieldSet=this&&this.__classPrivateFieldSet||function(e,t,i,o,s){if("m"===o)throw new TypeError("Private method is not writable");if("a"===o&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"===typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===o?s.call(e,i):s?s.value=i:t.set(e,i),i};import{createCancelablePromise,TimeoutTimer}from"../../../../base/common/async.js";import{isCancellationError}from"../../../../base/common/errors.js";import{Emitter}from"../../../../base/common/event.js";import{Disposable,MutableDisposable}from"../../../../base/common/lifecycle.js";import{isEqual}from"../../../../base/common/resources.js";import{Range}from"../../../common/core/range.js";import{CodeActionProviderRegistry}from"../../../common/languages.js";import{RawContextKey}from"../../../../platform/contextkey/common/contextkey.js";import{Progress}from"../../../../platform/progress/common/progress.js";import{getCodeActions}from"./codeAction.js";export const SUPPORTED_CODE_ACTIONS=new RawContextKey("supportedCodeAction","");class CodeActionOracle extends Disposable{constructor(e,t,i,o=250){super(),this._editor=e,this._markerService=t,this._signalChange=i,this._delay=o,this._autoTriggerTimer=this._register(new TimeoutTimer),this._register(this._markerService.onMarkerChanged((e=>this._onMarkerChanges(e)))),this._register(this._editor.onDidChangeCursorPosition((()=>this._onCursorChange())))}trigger(e){const t=this._getRangeOfSelectionUnlessWhitespaceEnclosed(e);return this._createEventAndSignalChange(e,t)}_onMarkerChanges(e){const t=this._editor.getModel();t&&e.some((e=>isEqual(e,t.uri)))&&this._autoTriggerTimer.cancelAndSet((()=>{this.trigger({type:2})}),this._delay)}_onCursorChange(){this._autoTriggerTimer.cancelAndSet((()=>{this.trigger({type:2})}),this._delay)}_getRangeOfMarker(e){const t=this._editor.getModel();if(t)for(const i of this._markerService.read({resource:t.uri})){const o=t.validateRange(i);if(Range.intersectRanges(o,e))return Range.lift(o)}}_getRangeOfSelectionUnlessWhitespaceEnclosed(e){if(!this._editor.hasModel())return;const t=this._editor.getModel(),i=this._editor.getSelection();if(i.isEmpty()&&2===e.type){const{lineNumber:e,column:o}=i.getPosition(),s=t.getLineContent(e);if(0===s.length)return;if(1===o){if(/\s/.test(s[0]))return}else if(o===t.getLineMaxColumn(e)){if(/\s/.test(s[s.length-1]))return}else if(/\s/.test(s[o-2])&&/\s/.test(s[o-1]))return}return i}_createEventAndSignalChange(e,t){const i=this._editor.getModel();if(!t||!i)return void this._signalChange(void 0);const o=this._getRangeOfMarker(t),s=o?o.getStartPosition():t.getStartPosition(),r={trigger:e,selection:t,position:s};return this._signalChange(r),r}}export var CodeActionsState;(function(e){e.Empty={type:0};class t{constructor(e,t,i,o){this.trigger=e,this.rangeOrSelection=t,this.position=i,this._cancellablePromise=o,this.type=1,this.actions=o.catch((e=>{if(isCancellationError(e))return emptyCodeActionSet;throw e}))}cancel(){this._cancellablePromise.cancel()}}e.Triggered=t})(CodeActionsState||(CodeActionsState={}));const emptyCodeActionSet={allActions:[],validActions:[],dispose:()=>{},documentation:[],hasAutoFix:!1};export class CodeActionModel extends Disposable{constructor(e,t,i,o){super(),this._editor=e,this._markerService=t,this._progressService=o,this._codeActionOracle=this._register(new MutableDisposable),this._state=CodeActionsState.Empty,this._onDidChangeState=this._register(new Emitter),this.onDidChangeState=this._onDidChangeState.event,_CodeActionModel_isDisposed.set(this,!1),this._supportedCodeActions=SUPPORTED_CODE_ACTIONS.bindTo(i),this._register(this._editor.onDidChangeModel((()=>this._update()))),this._register(this._editor.onDidChangeModelLanguage((()=>this._update()))),this._register(CodeActionProviderRegistry.onDidChange((()=>this._update()))),this._update()}dispose(){__classPrivateFieldGet(this,_CodeActionModel_isDisposed,"f")||(__classPrivateFieldSet(this,_CodeActionModel_isDisposed,!0,"f"),super.dispose(),this.setState(CodeActionsState.Empty,!0))}_update(){if(__classPrivateFieldGet(this,_CodeActionModel_isDisposed,"f"))return;this._codeActionOracle.value=void 0,this.setState(CodeActionsState.Empty);const e=this._editor.getModel();if(e&&CodeActionProviderRegistry.has(e)&&!this._editor.getOption(81)){const t=[];for(const i of CodeActionProviderRegistry.all(e))Array.isArray(i.providedCodeActionKinds)&&t.push(...i.providedCodeActionKinds);this._supportedCodeActions.set(t.join(" ")),this._codeActionOracle.value=new CodeActionOracle(this._editor,this._markerService,(t=>{var i;if(!t)return void this.setState(CodeActionsState.Empty);const o=createCancelablePromise((i=>getCodeActions(e,t.selection,t.trigger,Progress.None,i)));1===t.trigger.type&&(null===(i=this._progressService)||void 0===i||i.showWhile(o,250)),this.setState(new CodeActionsState.Triggered(t.trigger,t.selection,t.position,o))}),void 0),this._codeActionOracle.value.trigger({type:2})}else this._supportedCodeActions.reset()}trigger(e){this._codeActionOracle.value&&this._codeActionOracle.value.trigger(e)}setState(e,t){e!==this._state&&(1===this._state.type&&this._state.cancel(),this._state=e,t||__classPrivateFieldGet(this,_CodeActionModel_isDisposed,"f")||this._onDidChangeState.fire(e))}}_CodeActionModel_isDisposed=new WeakMap;