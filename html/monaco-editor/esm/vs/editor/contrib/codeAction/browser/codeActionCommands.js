var __decorate=this&&this.__decorate||function(e,o,t,i){var r,n=arguments.length,c=n<3?o:null===i?i=Object.getOwnPropertyDescriptor(o,t):i;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)c=Reflect.decorate(e,o,t,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(c=(n<3?r(c):n>3?r(o,t,c):r(o,t))||c);return n>3&&c&&Object.defineProperty(o,t,c),c},__param=this&&this.__param||function(e,o){return function(t,i){o(t,i,e)}},__awaiter=this&&this.__awaiter||function(e,o,t,i){function r(e){return e instanceof t?e:new t((function(o){o(e)}))}return new(t||(t=Promise))((function(t,n){function c(e){try{s(i.next(e))}catch(o){n(o)}}function a(e){try{s(i["throw"](e))}catch(o){n(o)}}function s(e){e.done?t(e.value):r(e.value).then(c,a)}s((i=i.apply(e,o||[])).next())}))};import{CancellationToken}from"../../../../base/common/cancellation.js";import{Lazy}from"../../../../base/common/lazy.js";import{Disposable}from"../../../../base/common/lifecycle.js";import{escapeRegExpCharacters}from"../../../../base/common/strings.js";import{EditorAction,EditorCommand}from"../../../browser/editorExtensions.js";import{IBulkEditService,ResourceEdit}from"../../../browser/services/bulkEditService.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{codeActionCommandId,fixAllCommandId,organizeImportsCommandId,refactorCommandId,sourceActionCommandId}from"./codeAction.js";import{CodeActionUi}from"./codeActionUi.js";import{MessageController}from"../../message/browser/messageController.js";import*as nls from"../../../../nls.js";import{ICommandService}from"../../../../platform/commands/common/commands.js";import{ContextKeyExpr,IContextKeyService}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{IMarkerService}from"../../../../platform/markers/common/markers.js";import{INotificationService}from"../../../../platform/notification/common/notification.js";import{IEditorProgressService}from"../../../../platform/progress/common/progress.js";import{ITelemetryService}from"../../../../platform/telemetry/common/telemetry.js";import{CodeActionModel,SUPPORTED_CODE_ACTIONS}from"./codeActionModel.js";import{CodeActionCommandArgs,CodeActionKind}from"./types.js";function contextKeyForSupportedActions(e){return ContextKeyExpr.regex(SUPPORTED_CODE_ACTIONS.keys()[0],new RegExp("(\\s|^)"+escapeRegExpCharacters(e.value)+"\\b"))}const argsSchema={type:"object",defaultSnippets:[{body:{kind:""}}],properties:{kind:{type:"string",description:nls.localize("args.schema.kind","Kind of the code action to run.")},apply:{type:"string",description:nls.localize("args.schema.apply","Controls when the returned actions are applied."),default:"ifSingle",enum:["first","ifSingle","never"],enumDescriptions:[nls.localize("args.schema.apply.first","Always apply the first returned code action."),nls.localize("args.schema.apply.ifSingle","Apply the first returned code action if it is the only one."),nls.localize("args.schema.apply.never","Do not apply the returned code actions.")]},preferred:{type:"boolean",default:!1,description:nls.localize("args.schema.preferred","Controls if only preferred code actions should be returned.")}}};let QuickFixController=class e extends Disposable{constructor(e,o,t,i,r){super(),this._instantiationService=r,this._editor=e,this._model=this._register(new CodeActionModel(this._editor,o,t,i)),this._register(this._model.onDidChangeState((e=>this.update(e)))),this._ui=new Lazy((()=>this._register(new CodeActionUi(e,QuickFixAction.Id,AutoFixAction.Id,{applyCodeAction:(e,o)=>__awaiter(this,void 0,void 0,(function*(){try{yield this._applyCodeAction(e)}finally{o&&this._trigger({type:2,filter:{}})}}))},this._instantiationService))))}static get(o){return o.getContribution(e.ID)}update(e){this._ui.getValue().update(e)}showCodeActions(e,o,t){return this._ui.getValue().showCodeActionList(e,o,t,{includeDisabledActions:!1})}manualTriggerAtCurrentPosition(e,o,t){var i;if(!this._editor.hasModel())return;null===(i=MessageController.get(this._editor))||void 0===i||i.closeMessage();const r=this._editor.getPosition();this._trigger({type:1,filter:o,autoApply:t,context:{notAvailableMessage:e,position:r}})}_trigger(e){return this._model.trigger(e)}_applyCodeAction(e){return this._instantiationService.invokeFunction(applyCodeAction,e,this._editor)}};QuickFixController.ID="editor.contrib.quickFixController",QuickFixController=__decorate([__param(1,IMarkerService),__param(2,IContextKeyService),__param(3,IEditorProgressService),__param(4,IInstantiationService)],QuickFixController);export{QuickFixController};export function applyCodeAction(e,o,t){return __awaiter(this,void 0,void 0,(function*(){const i=e.get(IBulkEditService),r=e.get(ICommandService),n=e.get(ITelemetryService),c=e.get(INotificationService);if(n.publicLog2("codeAction.applyCodeAction",{codeActionTitle:o.action.title,codeActionKind:o.action.kind,codeActionIsPreferred:!!o.action.isPreferred}),yield o.resolve(CancellationToken.None),o.action.edit&&(yield i.apply(ResourceEdit.convert(o.action.edit),{editor:t,label:o.action.title})),o.action.command)try{yield r.executeCommand(o.action.command.id,...o.action.command.arguments||[])}catch(a){const e=asMessage(a);c.error("string"===typeof e?e:nls.localize("applyCodeActionFailed","An unknown error occurred while applying the code action"))}}))}function asMessage(e){return"string"===typeof e?e:e instanceof Error&&"string"===typeof e.message?e.message:void 0}function triggerCodeActionsForEditorSelection(e,o,t,i){if(e.hasModel()){const r=QuickFixController.get(e);r&&r.manualTriggerAtCurrentPosition(o,t,i)}}export class QuickFixAction extends EditorAction{constructor(){super({id:QuickFixAction.Id,label:nls.localize("quickfix.trigger.label","Quick Fix..."),alias:"Quick Fix...",precondition:ContextKeyExpr.and(EditorContextKeys.writable,EditorContextKeys.hasCodeActionsProvider),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:2132,weight:100}})}run(e,o){return triggerCodeActionsForEditorSelection(o,nls.localize("editor.action.quickFix.noneMessage","No code actions available"),void 0,void 0)}}QuickFixAction.Id="editor.action.quickFix";export class CodeActionCommand extends EditorCommand{constructor(){super({id:codeActionCommandId,precondition:ContextKeyExpr.and(EditorContextKeys.writable,EditorContextKeys.hasCodeActionsProvider),description:{description:"Trigger a code action",args:[{name:"args",schema:argsSchema}]}})}runEditorCommand(e,o,t){const i=CodeActionCommandArgs.fromUser(t,{kind:CodeActionKind.Empty,apply:"ifSingle"});return triggerCodeActionsForEditorSelection(o,"string"===typeof(null===t||void 0===t?void 0:t.kind)?i.preferred?nls.localize("editor.action.codeAction.noneMessage.preferred.kind","No preferred code actions for '{0}' available",t.kind):nls.localize("editor.action.codeAction.noneMessage.kind","No code actions for '{0}' available",t.kind):i.preferred?nls.localize("editor.action.codeAction.noneMessage.preferred","No preferred code actions available"):nls.localize("editor.action.codeAction.noneMessage","No code actions available"),{include:i.kind,includeSourceActions:!0,onlyIncludePreferredActions:i.preferred},i.apply)}}export class RefactorAction extends EditorAction{constructor(){super({id:refactorCommandId,label:nls.localize("refactor.label","Refactor..."),alias:"Refactor...",precondition:ContextKeyExpr.and(EditorContextKeys.writable,EditorContextKeys.hasCodeActionsProvider),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:3120,mac:{primary:1328},weight:100},contextMenuOpts:{group:"1_modification",order:2,when:ContextKeyExpr.and(EditorContextKeys.writable,contextKeyForSupportedActions(CodeActionKind.Refactor))},description:{description:"Refactor...",args:[{name:"args",schema:argsSchema}]}})}run(e,o,t){const i=CodeActionCommandArgs.fromUser(t,{kind:CodeActionKind.Refactor,apply:"never"});return triggerCodeActionsForEditorSelection(o,"string"===typeof(null===t||void 0===t?void 0:t.kind)?i.preferred?nls.localize("editor.action.refactor.noneMessage.preferred.kind","No preferred refactorings for '{0}' available",t.kind):nls.localize("editor.action.refactor.noneMessage.kind","No refactorings for '{0}' available",t.kind):i.preferred?nls.localize("editor.action.refactor.noneMessage.preferred","No preferred refactorings available"):nls.localize("editor.action.refactor.noneMessage","No refactorings available"),{include:CodeActionKind.Refactor.contains(i.kind)?i.kind:CodeActionKind.None,onlyIncludePreferredActions:i.preferred},i.apply)}}export class SourceAction extends EditorAction{constructor(){super({id:sourceActionCommandId,label:nls.localize("source.label","Source Action..."),alias:"Source Action...",precondition:ContextKeyExpr.and(EditorContextKeys.writable,EditorContextKeys.hasCodeActionsProvider),contextMenuOpts:{group:"1_modification",order:2.1,when:ContextKeyExpr.and(EditorContextKeys.writable,contextKeyForSupportedActions(CodeActionKind.Source))},description:{description:"Source Action...",args:[{name:"args",schema:argsSchema}]}})}run(e,o,t){const i=CodeActionCommandArgs.fromUser(t,{kind:CodeActionKind.Source,apply:"never"});return triggerCodeActionsForEditorSelection(o,"string"===typeof(null===t||void 0===t?void 0:t.kind)?i.preferred?nls.localize("editor.action.source.noneMessage.preferred.kind","No preferred source actions for '{0}' available",t.kind):nls.localize("editor.action.source.noneMessage.kind","No source actions for '{0}' available",t.kind):i.preferred?nls.localize("editor.action.source.noneMessage.preferred","No preferred source actions available"):nls.localize("editor.action.source.noneMessage","No source actions available"),{include:CodeActionKind.Source.contains(i.kind)?i.kind:CodeActionKind.None,includeSourceActions:!0,onlyIncludePreferredActions:i.preferred},i.apply)}}export class OrganizeImportsAction extends EditorAction{constructor(){super({id:organizeImportsCommandId,label:nls.localize("organizeImports.label","Organize Imports"),alias:"Organize Imports",precondition:ContextKeyExpr.and(EditorContextKeys.writable,contextKeyForSupportedActions(CodeActionKind.SourceOrganizeImports)),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:1581,weight:100}})}run(e,o){return triggerCodeActionsForEditorSelection(o,nls.localize("editor.action.organize.noneMessage","No organize imports action available"),{include:CodeActionKind.SourceOrganizeImports,includeSourceActions:!0},"ifSingle")}}export class FixAllAction extends EditorAction{constructor(){super({id:fixAllCommandId,label:nls.localize("fixAll.label","Fix All"),alias:"Fix All",precondition:ContextKeyExpr.and(EditorContextKeys.writable,contextKeyForSupportedActions(CodeActionKind.SourceFixAll))})}run(e,o){return triggerCodeActionsForEditorSelection(o,nls.localize("fixAll.noneMessage","No fix all action available"),{include:CodeActionKind.SourceFixAll,includeSourceActions:!0},"ifSingle")}}export class AutoFixAction extends EditorAction{constructor(){super({id:AutoFixAction.Id,label:nls.localize("autoFix.label","Auto Fix..."),alias:"Auto Fix...",precondition:ContextKeyExpr.and(EditorContextKeys.writable,contextKeyForSupportedActions(CodeActionKind.QuickFix)),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:1620,mac:{primary:2644},weight:100}})}run(e,o){return triggerCodeActionsForEditorSelection(o,nls.localize("editor.action.autoFix.noneMessage","No auto fixes available"),{include:CodeActionKind.QuickFix,onlyIncludePreferredActions:!0},"ifSingle")}}AutoFixAction.Id="editor.action.autoFix";