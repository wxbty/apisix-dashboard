var _CodeActionUi_disposed,__decorate=this&&this.__decorate||function(t,e,i,o){var n,s=arguments.length,r=s<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)r=Reflect.decorate(t,e,i,o);else for(var a=t.length-1;a>=0;a--)(n=t[a])&&(r=(s<3?n(r):s>3?n(e,i,r):n(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},__param=this&&this.__param||function(t,e){return function(i,o){e(i,o,t)}},__awaiter=this&&this.__awaiter||function(t,e,i,o){function n(t){return t instanceof i?t:new i((function(e){e(t)}))}return new(i||(i=Promise))((function(i,s){function r(t){try{l(o.next(t))}catch(e){s(e)}}function a(t){try{l(o["throw"](t))}catch(e){s(e)}}function l(t){t.done?i(t.value):n(t.value).then(r,a)}l((o=o.apply(t,e||[])).next())}))},__classPrivateFieldSet=this&&this.__classPrivateFieldSet||function(t,e,i,o,n){if("m"===o)throw new TypeError("Private method is not writable");if("a"===o&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"===typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===o?n.call(t,i):n?n.value=i:e.set(t,i),i},__classPrivateFieldGet=this&&this.__classPrivateFieldGet||function(t,e,i,o){if("a"===i&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"===typeof e?t!==e||!o:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?o:"a"===i?o.call(t):o?o.value:e.get(t)};import{onUnexpectedError}from"../../../../base/common/errors.js";import{Lazy}from"../../../../base/common/lazy.js";import{Disposable,MutableDisposable}from"../../../../base/common/lifecycle.js";import{MessageController}from"../../message/browser/messageController.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{CodeActionMenu}from"./codeActionMenu.js";import{LightBulbWidget}from"./lightBulbWidget.js";let CodeActionUi=class extends Disposable{constructor(t,e,i,o,n){super(),this._editor=t,this.delegate=o,this._activeCodeActions=this._register(new MutableDisposable),_CodeActionUi_disposed.set(this,!1),this._codeActionWidget=new Lazy((()=>this._register(n.createInstance(CodeActionMenu,this._editor,{onSelectCodeAction:t=>__awaiter(this,void 0,void 0,(function*(){this.delegate.applyCodeAction(t,!0)}))})))),this._lightBulbWidget=new Lazy((()=>{const t=this._register(n.createInstance(LightBulbWidget,this._editor,e,i));return this._register(t.onClick((t=>this.showCodeActionList(t.trigger,t.actions,t,{includeDisabledActions:!1})))),t}))}dispose(){__classPrivateFieldSet(this,_CodeActionUi_disposed,!0,"f"),super.dispose()}update(t){var e,i,o,n,s;return __awaiter(this,void 0,void 0,(function*(){if(1!==t.type)return void(null===(e=this._lightBulbWidget.rawValue)||void 0===e||e.hide());let r;try{r=yield t.actions}catch(a){return void onUnexpectedError(a)}if(!__classPrivateFieldGet(this,_CodeActionUi_disposed,"f"))if(this._lightBulbWidget.getValue().update(r,t.trigger,t.position),1===t.trigger.type){if(null===(i=t.trigger.filter)||void 0===i?void 0:i.include){const e=this.tryGetValidActionToApply(t.trigger,r);if(e){try{this._lightBulbWidget.getValue().hide(),yield this.delegate.applyCodeAction(e,!1)}finally{r.dispose()}return}if(t.trigger.context){const e=this.getInvalidActionThatWouldHaveBeenApplied(t.trigger,r);if(e&&e.action.disabled)return null===(o=MessageController.get(this._editor))||void 0===o||o.showMessage(e.action.disabled,t.trigger.context.position),void r.dispose()}}const e=!!(null===(n=t.trigger.filter)||void 0===n?void 0:n.include);if(t.trigger.context&&(!r.allActions.length||!e&&!r.validActions.length))return null===(s=MessageController.get(this._editor))||void 0===s||s.showMessage(t.trigger.context.notAvailableMessage,t.trigger.context.position),this._activeCodeActions.value=r,void r.dispose();this._activeCodeActions.value=r,this._codeActionWidget.getValue().show(t.trigger,r,t.position,{includeDisabledActions:e})}else this._codeActionWidget.getValue().isVisible?r.dispose():this._activeCodeActions.value=r}))}getInvalidActionThatWouldHaveBeenApplied(t,e){if(e.allActions.length)return"first"===t.autoApply&&0===e.validActions.length||"ifSingle"===t.autoApply&&1===e.allActions.length?e.allActions.find((({action:t})=>t.disabled)):void 0}tryGetValidActionToApply(t,e){if(e.validActions.length)return"first"===t.autoApply&&e.validActions.length>0||"ifSingle"===t.autoApply&&1===e.validActions.length?e.validActions[0]:void 0}showCodeActionList(t,e,i,o){return __awaiter(this,void 0,void 0,(function*(){this._codeActionWidget.getValue().show(t,e,i,o)}))}};_CodeActionUi_disposed=new WeakMap,CodeActionUi=__decorate([__param(4,IInstantiationService)],CodeActionUi);export{CodeActionUi};