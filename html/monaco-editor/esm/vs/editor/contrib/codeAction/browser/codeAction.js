var __awaiter=this&&this.__awaiter||function(o,e,t,n){function i(o){return o instanceof t?o:new t((function(e){e(o)}))}return new(t||(t=Promise))((function(t,r){function s(o){try{a(n.next(o))}catch(e){r(e)}}function c(o){try{a(n["throw"](o))}catch(e){r(e)}}function a(o){o.done?t(o.value):i(o.value).then(s,c)}a((n=n.apply(o,e||[])).next())}))};import{coalesce,equals,flatten,isNonEmptyArray}from"../../../../base/common/arrays.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{illegalArgument,isCancellationError,onUnexpectedExternalError}from"../../../../base/common/errors.js";import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{URI}from"../../../../base/common/uri.js";import{TextModelCancellationTokenSource}from"../../editorState/browser/editorState.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import*as modes from"../../../common/languages.js";import{IModelService}from"../../../common/services/model.js";import{CommandsRegistry}from"../../../../platform/commands/common/commands.js";import{Progress}from"../../../../platform/progress/common/progress.js";import{CodeActionKind,filtersAction,mayIncludeActionsOfKind}from"./types.js";export const codeActionCommandId="editor.action.codeAction";export const refactorCommandId="editor.action.refactor";export const sourceActionCommandId="editor.action.sourceAction";export const organizeImportsCommandId="editor.action.organizeImports";export const fixAllCommandId="editor.action.fixAll";export class CodeActionItem{constructor(o,e){this.action=o,this.provider=e}resolve(o){var e;return __awaiter(this,void 0,void 0,(function*(){if((null===(e=this.provider)||void 0===e?void 0:e.resolveCodeAction)&&!this.action.edit){let e;try{e=yield this.provider.resolveCodeAction(this.action,o)}catch(t){onUnexpectedExternalError(t)}e&&(this.action.edit=e.edit)}return this}))}}class ManagedCodeActionSet extends Disposable{constructor(o,e,t){super(),this.documentation=e,this._register(t),this.allActions=[...o].sort(ManagedCodeActionSet.codeActionsComparator),this.validActions=this.allActions.filter((({action:o})=>!o.disabled))}static codeActionsComparator({action:o},{action:e}){return o.isPreferred&&!e.isPreferred?-1:!o.isPreferred&&e.isPreferred?1:isNonEmptyArray(o.diagnostics)?isNonEmptyArray(e.diagnostics)?o.diagnostics[0].message.localeCompare(e.diagnostics[0].message):-1:isNonEmptyArray(e.diagnostics)?1:0}get hasAutoFix(){return this.validActions.some((({action:o})=>!!o.kind&&CodeActionKind.QuickFix.contains(new CodeActionKind(o.kind))&&!!o.isPreferred))}}const emptyCodeActionsResponse={actions:[],documentation:void 0};export function getCodeActions(o,e,t,n,i){var r;const s=t.filter||{},c={only:null===(r=s.include)||void 0===r?void 0:r.value,trigger:t.type},a=new TextModelCancellationTokenSource(o,i),d=getCodeActionProviders(o,s),l=new DisposableStore,m=d.map((t=>__awaiter(this,void 0,void 0,(function*(){try{n.report(t);const i=yield t.provideCodeActions(o,e,c,a.token);if(i&&l.add(i),a.token.isCancellationRequested)return emptyCodeActionsResponse;const r=((null===i||void 0===i?void 0:i.actions)||[]).filter((o=>o&&filtersAction(s,o))),d=getDocumentation(t,r,s.include);return{actions:r.map((o=>new CodeActionItem(o,t))),documentation:d}}catch(i){if(isCancellationError(i))throw i;return onUnexpectedExternalError(i),emptyCodeActionsResponse}})))),f=modes.CodeActionProviderRegistry.onDidChange((()=>{const e=modes.CodeActionProviderRegistry.all(o);equals(e,d)||a.cancel()}));return Promise.all(m).then((o=>{const e=flatten(o.map((o=>o.actions))),t=coalesce(o.map((o=>o.documentation)));return new ManagedCodeActionSet(e,t,l)})).finally((()=>{f.dispose(),a.dispose()}))}function getCodeActionProviders(o,e){return modes.CodeActionProviderRegistry.all(o).filter((o=>!o.providedCodeActionKinds||o.providedCodeActionKinds.some((o=>mayIncludeActionsOfKind(e,new CodeActionKind(o))))))}function getDocumentation(o,e,t){if(!o.documentation)return;const n=o.documentation.map((o=>({kind:new CodeActionKind(o.kind),command:o.command})));if(t){let o;for(const e of n)e.kind.contains(t)&&(o?o.kind.contains(e.kind)&&(o=e):o=e);if(o)return null===o||void 0===o?void 0:o.command}for(const i of e)if(i.kind)for(const o of n)if(o.kind.contains(new CodeActionKind(i.kind)))return o.command}CommandsRegistry.registerCommand("_executeCodeActionProvider",(function(o,e,t,n,i){return __awaiter(this,void 0,void 0,(function*(){if(!(e instanceof URI))throw illegalArgument();const r=o.get(IModelService).getModel(e);if(!r)throw illegalArgument();const s=Selection.isISelection(t)?Selection.liftSelection(t):Range.isIRange(t)?r.validateRange(t):void 0;if(!s)throw illegalArgument();const c="string"===typeof n?new CodeActionKind(n):void 0,a=yield getCodeActions(r,s,{type:1,filter:{includeSourceActions:!0,include:c}},Progress.None,CancellationToken.None),d=[],l=Math.min(a.validActions.length,"number"===typeof i?i:0);for(let o=0;o<l;o++)d.push(a.validActions[o].resolve(CancellationToken.None));try{return yield Promise.all(d),a.validActions.map((o=>o.action))}finally{setTimeout((()=>a.dispose()),100)}}))}));