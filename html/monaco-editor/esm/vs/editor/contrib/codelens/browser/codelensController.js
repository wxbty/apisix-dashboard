var __decorate=this&&this.__decorate||function(e,o,s,t){var i,n=arguments.length,r=n<3?o:null===t?t=Object.getOwnPropertyDescriptor(o,s):t;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)r=Reflect.decorate(e,o,s,t);else for(var d=e.length-1;d>=0;d--)(i=e[d])&&(r=(n<3?i(r):n>3?i(o,s,r):i(o,s))||r);return n>3&&r&&Object.defineProperty(o,s,r),r},__param=this&&this.__param||function(e,o){return function(s,t){o(s,t,e)}},__awaiter=this&&this.__awaiter||function(e,o,s,t){function i(e){return e instanceof s?e:new s((function(o){o(e)}))}return new(s||(s=Promise))((function(s,n){function r(e){try{l(t.next(e))}catch(o){n(o)}}function d(e){try{l(t["throw"](e))}catch(o){n(o)}}function l(e){e.done?s(e.value):i(e.value).then(r,d)}l((t=t.apply(e,o||[])).next())}))};import*as dom from"../../../../base/browser/dom.js";import{createCancelablePromise,disposableTimeout,RunOnceScheduler}from"../../../../base/common/async.js";import{onUnexpectedError,onUnexpectedExternalError}from"../../../../base/common/errors.js";import{hash}from"../../../../base/common/hash.js";import{DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import{StableEditorScrollState}from"../../../browser/stableEditorScroll.js";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{EDITOR_FONT_DEFAULTS}from"../../../common/config/editorOptions.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{CodeLensProviderRegistry}from"../../../common/languages.js";import{getCodeLensModel}from"./codelens.js";import{ICodeLensCache}from"./codeLensCache.js";import{CodeLensHelper,CodeLensWidget}from"./codelensWidget.js";import{localize}from"../../../../nls.js";import{ICommandService}from"../../../../platform/commands/common/commands.js";import{INotificationService}from"../../../../platform/notification/common/notification.js";import{IQuickInputService}from"../../../../platform/quickinput/common/quickInput.js";import{ILanguageFeatureDebounceService}from"../../../common/services/languageFeatureDebounce.js";let CodeLensContribution=class{constructor(e,o,s,t,i){this._editor=e,this._commandService=s,this._notificationService=t,this._codeLensCache=i,this._disposables=new DisposableStore,this._localToDispose=new DisposableStore,this._lenses=[],this._oldCodeLensModels=new DisposableStore,this._provideCodeLensDebounce=o.for(CodeLensProviderRegistry,"CodeLensProvide",{min:250}),this._resolveCodeLensesDebounce=o.for(CodeLensProviderRegistry,"CodeLensResolve",{min:250,salt:"resolve"}),this._resolveCodeLensesScheduler=new RunOnceScheduler((()=>this._resolveCodeLensesInViewport()),this._resolveCodeLensesDebounce.default()),this._disposables.add(this._editor.onDidChangeModel((()=>this._onModelChange()))),this._disposables.add(this._editor.onDidChangeModelLanguage((()=>this._onModelChange()))),this._disposables.add(this._editor.onDidChangeConfiguration((e=>{(e.hasChanged(44)||e.hasChanged(16)||e.hasChanged(15))&&this._updateLensStyle(),e.hasChanged(14)&&this._onModelChange()}))),this._disposables.add(CodeLensProviderRegistry.onDidChange(this._onModelChange,this)),this._onModelChange(),this._styleClassName="_"+hash(this._editor.getId()).toString(16),this._styleElement=dom.createStyleSheet(dom.isInShadowDOM(this._editor.getContainerDomNode())?this._editor.getContainerDomNode():void 0),this._updateLensStyle()}dispose(){var e;this._localDispose(),this._disposables.dispose(),this._oldCodeLensModels.dispose(),null===(e=this._currentCodeLensModel)||void 0===e||e.dispose(),this._styleElement.remove()}_getLayoutInfo(){let e,o=this._editor.getOption(16);return!o||o<5?(o=.9*this._editor.getOption(46)|0,e=this._editor.getOption(59)):e=o*Math.max(1.3,this._editor.getOption(59)/this._editor.getOption(46))|0,{codeLensHeight:e,fontSize:o}}_updateLensStyle(){const{codeLensHeight:e,fontSize:o}=this._getLayoutInfo(),s=this._editor.getOption(15),t=this._editor.getOption(44),i=`--codelens-font-family${this._styleClassName}`,n=`--codelens-font-features${this._styleClassName}`;let r=`\n\t\t.monaco-editor .codelens-decoration.${this._styleClassName} { line-height: ${e}px; font-size: ${o}px; padding-right: ${Math.round(.5*o)}px; font-feature-settings: var(${n}) }\n\t\t.monaco-editor .codelens-decoration.${this._styleClassName} span.codicon { line-height: ${e}px; font-size: ${o}px; }\n\t\t`;s&&(r+=`.monaco-editor .codelens-decoration.${this._styleClassName} { font-family: var(${i}), ${EDITOR_FONT_DEFAULTS.fontFamily}}`),this._styleElement.textContent=r,this._editor.getContainerDomNode().style.setProperty(i,null!==s&&void 0!==s?s:"inherit"),this._editor.getContainerDomNode().style.setProperty(n,t.fontFeatureSettings),this._editor.changeViewZones((o=>{for(let s of this._lenses)s.updateHeight(e,o)}))}_localDispose(){var e,o,s;null===(e=this._getCodeLensModelPromise)||void 0===e||e.cancel(),this._getCodeLensModelPromise=void 0,null===(o=this._resolveCodeLensesPromise)||void 0===o||o.cancel(),this._resolveCodeLensesPromise=void 0,this._localToDispose.clear(),this._oldCodeLensModels.clear(),null===(s=this._currentCodeLensModel)||void 0===s||s.dispose()}_onModelChange(){this._localDispose();const e=this._editor.getModel();if(!e)return;if(!this._editor.getOption(14))return;const o=this._codeLensCache.get(e);if(o&&this._renderCodeLensSymbols(o),!CodeLensProviderRegistry.has(e))return void(o&&this._localToDispose.add(disposableTimeout((()=>{const s=this._codeLensCache.get(e);o===s&&(this._codeLensCache.delete(e),this._onModelChange())}),3e4)));for(const t of CodeLensProviderRegistry.all(e))if("function"===typeof t.onDidChange){let e=t.onDidChange((()=>s.schedule()));this._localToDispose.add(e)}const s=new RunOnceScheduler((()=>{var o;const t=Date.now();null===(o=this._getCodeLensModelPromise)||void 0===o||o.cancel(),this._getCodeLensModelPromise=createCancelablePromise((o=>getCodeLensModel(e,o))),this._getCodeLensModelPromise.then((o=>{this._currentCodeLensModel&&this._oldCodeLensModels.add(this._currentCodeLensModel),this._currentCodeLensModel=o,this._codeLensCache.put(e,o);const i=this._provideCodeLensDebounce.update(e,Date.now()-t);s.delay=i,this._renderCodeLensSymbols(o),this._resolveCodeLensesInViewportSoon()}),onUnexpectedError)}),this._provideCodeLensDebounce.get(e));this._localToDispose.add(s),this._localToDispose.add(toDisposable((()=>this._resolveCodeLensesScheduler.cancel()))),this._localToDispose.add(this._editor.onDidChangeModelContent((()=>{this._editor.changeDecorations((e=>{this._editor.changeViewZones((o=>{let s=[],t=-1;this._lenses.forEach((e=>{e.isValid()&&t!==e.getLineNumber()?(e.update(o),t=e.getLineNumber()):s.push(e)}));let i=new CodeLensHelper;s.forEach((e=>{e.dispose(i,o),this._lenses.splice(this._lenses.indexOf(e),1)})),i.commit(e)}))})),s.schedule()}))),this._localToDispose.add(this._editor.onDidFocusEditorWidget((()=>{s.schedule()}))),this._localToDispose.add(this._editor.onDidScrollChange((e=>{e.scrollTopChanged&&this._lenses.length>0&&this._resolveCodeLensesInViewportSoon()}))),this._localToDispose.add(this._editor.onDidLayoutChange((()=>{this._resolveCodeLensesInViewportSoon()}))),this._localToDispose.add(toDisposable((()=>{if(this._editor.getModel()){const e=StableEditorScrollState.capture(this._editor);this._editor.changeDecorations((e=>{this._editor.changeViewZones((o=>{this._disposeAllLenses(e,o)}))})),e.restore(this._editor)}else this._disposeAllLenses(void 0,void 0)}))),this._localToDispose.add(this._editor.onMouseDown((e=>{if(9!==e.target.type)return;let o=e.target.element;if("SPAN"===(null===o||void 0===o?void 0:o.tagName)&&(o=o.parentElement),"A"===(null===o||void 0===o?void 0:o.tagName))for(const s of this._lenses){let e=s.getCommand(o);if(e){this._commandService.executeCommand(e.id,...e.arguments||[]).catch((e=>this._notificationService.error(e)));break}}}))),s.schedule()}_disposeAllLenses(e,o){const s=new CodeLensHelper;for(const t of this._lenses)t.dispose(s,o);e&&s.commit(e),this._lenses.length=0}_renderCodeLensSymbols(e){if(!this._editor.hasModel())return;let o,s=this._editor.getModel().getLineCount(),t=[];for(let r of e.lenses){let e=r.symbol.range.startLineNumber;e<1||e>s||(o&&o[o.length-1].symbol.range.startLineNumber===e?o.push(r):(o=[r],t.push(o)))}const i=StableEditorScrollState.capture(this._editor),n=this._getLayoutInfo();this._editor.changeDecorations((e=>{this._editor.changeViewZones((o=>{const s=new CodeLensHelper;let i=0,r=0;while(r<t.length&&i<this._lenses.length){let e=t[r][0].symbol.range.startLineNumber,d=this._lenses[i].getLineNumber();d<e?(this._lenses[i].dispose(s,o),this._lenses.splice(i,1)):d===e?(this._lenses[i].updateCodeLensSymbols(t[r],s),r++,i++):(this._lenses.splice(i,0,new CodeLensWidget(t[r],this._editor,this._styleClassName,s,o,n.codeLensHeight,(()=>this._resolveCodeLensesInViewportSoon()))),i++,r++)}while(i<this._lenses.length)this._lenses[i].dispose(s,o),this._lenses.splice(i,1);while(r<t.length)this._lenses.push(new CodeLensWidget(t[r],this._editor,this._styleClassName,s,o,n.codeLensHeight,(()=>this._resolveCodeLensesInViewportSoon()))),r++;s.commit(e)}))})),i.restore(this._editor)}_resolveCodeLensesInViewportSoon(){const e=this._editor.getModel();e&&this._resolveCodeLensesScheduler.schedule()}_resolveCodeLensesInViewport(){var e;null===(e=this._resolveCodeLensesPromise)||void 0===e||e.cancel(),this._resolveCodeLensesPromise=void 0;const o=this._editor.getModel();if(!o)return;const s=[],t=[];if(this._lenses.forEach((e=>{const i=e.computeIfNecessary(o);i&&(s.push(i),t.push(e))})),0===s.length)return;const i=Date.now(),n=createCancelablePromise((e=>{const i=s.map(((s,i)=>{const n=new Array(s.length),r=s.map(((s,t)=>s.symbol.command||"function"!==typeof s.provider.resolveCodeLens?(n[t]=s.symbol,Promise.resolve(void 0)):Promise.resolve(s.provider.resolveCodeLens(o,s.symbol,e)).then((e=>{n[t]=e}),onUnexpectedExternalError)));return Promise.all(r).then((()=>{e.isCancellationRequested||t[i].isDisposed()||t[i].updateCommands(n)}))}));return Promise.all(i)}));this._resolveCodeLensesPromise=n,this._resolveCodeLensesPromise.then((()=>{const e=this._resolveCodeLensesDebounce.update(o,Date.now()-i);this._resolveCodeLensesScheduler.delay=e,this._currentCodeLensModel&&this._codeLensCache.put(o,this._currentCodeLensModel),this._oldCodeLensModels.clear(),n===this._resolveCodeLensesPromise&&(this._resolveCodeLensesPromise=void 0)}),(e=>{onUnexpectedError(e),n===this._resolveCodeLensesPromise&&(this._resolveCodeLensesPromise=void 0)}))}getModel(){return this._currentCodeLensModel}};CodeLensContribution.ID="css.editor.codeLens",CodeLensContribution=__decorate([__param(1,ILanguageFeatureDebounceService),__param(2,ICommandService),__param(3,INotificationService),__param(4,ICodeLensCache)],CodeLensContribution);export{CodeLensContribution};registerEditorContribution(CodeLensContribution.ID,CodeLensContribution),registerEditorAction(class extends EditorAction{constructor(){super({id:"codelens.showLensesInCurrentLine",precondition:EditorContextKeys.hasCodeLensProvider,label:localize("showLensOnLine","Show CodeLens Commands For Current Line"),alias:"Show CodeLens Commands For Current Line"})}run(e,o){return __awaiter(this,void 0,void 0,(function*(){if(!o.hasModel())return;const s=e.get(IQuickInputService),t=e.get(ICommandService),i=e.get(INotificationService),n=o.getSelection().positionLineNumber,r=o.getContribution(CodeLensContribution.ID);if(!r)return;const d=r.getModel();if(!d)return;const l=[];for(const e of d.lenses)e.symbol.command&&e.symbol.range.startLineNumber===n&&l.push({label:e.symbol.command.title,command:e.symbol.command});if(0===l.length)return;const a=yield s.pick(l,{canPickMany:!1});if(a){if(d.isDisposed)return yield t.executeCommand(this.id);try{yield t.executeCommand(a.command.id,...a.command.arguments||[])}catch(h){i.error(h)}}}))}});