var __decorate=this&&this.__decorate||function(t,e,o,i){var r,n=arguments.length,s=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,o):i;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(t,e,o,i);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(s=(n<3?r(s):n>3?r(e,o,s):r(e,o))||s);return n>3&&s&&Object.defineProperty(e,o,s),s},__param=this&&this.__param||function(t,e){return function(o,i){e(o,i,t)}},__awaiter=this&&this.__awaiter||function(t,e,o,i){function r(t){return t instanceof o?t:new o((function(e){e(t)}))}return new(o||(o=Promise))((function(o,n){function s(t){try{d(i.next(t))}catch(e){n(e)}}function a(t){try{d(i["throw"](t))}catch(e){n(e)}}function d(t){t.done?o(t.value):r(t.value).then(s,a)}d((i=i.apply(t,e||[])).next())}))};import{isNonEmptyArray}from"../../../../base/common/arrays.js";import{CancellationToken,CancellationTokenSource}from"../../../../base/common/cancellation.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{KeyChord}from"../../../../base/common/keyCodes.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{ICodeEditorService}from"../../../browser/services/codeEditorService.js";import{CharacterSet}from"../../../common/core/characterClassifier.js";import{Range}from"../../../common/core/range.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{DocumentRangeFormattingEditProviderRegistry,OnTypeFormattingEditProviderRegistry}from"../../../common/languages.js";import{IEditorWorkerService}from"../../../common/services/editorWorker.js";import{alertFormattingEdits,formatDocumentRangesWithSelectedProvider,formatDocumentWithSelectedProvider,getOnTypeFormattingEdits}from"./format.js";import{FormattingEdit}from"./formattingEdit.js";import*as nls from"../../../../nls.js";import{CommandsRegistry,ICommandService}from"../../../../platform/commands/common/commands.js";import{ContextKeyExpr}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{IEditorProgressService,Progress}from"../../../../platform/progress/common/progress.js";let FormatOnType=class{constructor(t,e){this._editor=t,this._workerService=e,this._disposables=new DisposableStore,this._sessionDisposables=new DisposableStore,this._disposables.add(OnTypeFormattingEditProviderRegistry.onDidChange(this._update,this)),this._disposables.add(t.onDidChangeModel((()=>this._update()))),this._disposables.add(t.onDidChangeModelLanguage((()=>this._update()))),this._disposables.add(t.onDidChangeConfiguration((t=>{t.hasChanged(49)&&this._update()})))}dispose(){this._disposables.dispose(),this._sessionDisposables.dispose()}_update(){if(this._sessionDisposables.clear(),!this._editor.getOption(49))return;if(!this._editor.hasModel())return;const t=this._editor.getModel(),[e]=OnTypeFormattingEditProviderRegistry.ordered(t);if(!e||!e.autoFormatTriggerCharacters)return;let o=new CharacterSet;for(let i of e.autoFormatTriggerCharacters)o.add(i.charCodeAt(0));this._sessionDisposables.add(this._editor.onDidType((t=>{let e=t.charCodeAt(t.length-1);o.has(e)&&this._trigger(String.fromCharCode(e))})))}_trigger(t){if(!this._editor.hasModel())return;if(this._editor.getSelections().length>1||!this._editor.getSelection().isEmpty())return;const e=this._editor.getModel(),o=this._editor.getPosition(),i=new CancellationTokenSource,r=this._editor.onDidChangeModelContent((t=>{if(t.isFlush)return i.cancel(),void r.dispose();for(let e=0,n=t.changes.length;e<n;e++){const n=t.changes[e];if(n.range.endLineNumber<=o.lineNumber)return i.cancel(),void r.dispose()}}));getOnTypeFormattingEdits(this._workerService,e,o,t,e.getFormattingOptions(),i.token).then((t=>{i.token.isCancellationRequested||isNonEmptyArray(t)&&(FormattingEdit.execute(this._editor,t,!0),alertFormattingEdits(t))})).finally((()=>{r.dispose()}))}};FormatOnType.ID="editor.contrib.autoFormat",FormatOnType=__decorate([__param(1,IEditorWorkerService)],FormatOnType);let FormatOnPaste=class{constructor(t,e){this.editor=t,this._instantiationService=e,this._callOnDispose=new DisposableStore,this._callOnModel=new DisposableStore,this._callOnDispose.add(t.onDidChangeConfiguration((()=>this._update()))),this._callOnDispose.add(t.onDidChangeModel((()=>this._update()))),this._callOnDispose.add(t.onDidChangeModelLanguage((()=>this._update()))),this._callOnDispose.add(DocumentRangeFormattingEditProviderRegistry.onDidChange(this._update,this))}dispose(){this._callOnDispose.dispose(),this._callOnModel.dispose()}_update(){this._callOnModel.clear(),this.editor.getOption(48)&&this.editor.hasModel()&&DocumentRangeFormattingEditProviderRegistry.has(this.editor.getModel())&&this._callOnModel.add(this.editor.onDidPaste((({range:t})=>this._trigger(t))))}_trigger(t){this.editor.hasModel()&&(this.editor.getSelections().length>1||this._instantiationService.invokeFunction(formatDocumentRangesWithSelectedProvider,this.editor,t,2,Progress.None,CancellationToken.None).catch(onUnexpectedError))}};FormatOnPaste.ID="editor.contrib.formatOnPaste",FormatOnPaste=__decorate([__param(1,IInstantiationService)],FormatOnPaste);class FormatDocumentAction extends EditorAction{constructor(){super({id:"editor.action.formatDocument",label:nls.localize("formatDocument.label","Format Document"),alias:"Format Document",precondition:ContextKeyExpr.and(EditorContextKeys.notInCompositeEditor,EditorContextKeys.writable,EditorContextKeys.hasDocumentFormattingProvider),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:1572,linux:{primary:3111},weight:100},contextMenuOpts:{group:"1_modification",order:1.3}})}run(t,e){return __awaiter(this,void 0,void 0,(function*(){if(e.hasModel()){const o=t.get(IInstantiationService),i=t.get(IEditorProgressService);yield i.showWhile(o.invokeFunction(formatDocumentWithSelectedProvider,e,1,Progress.None,CancellationToken.None),250)}}))}}class FormatSelectionAction extends EditorAction{constructor(){super({id:"editor.action.formatSelection",label:nls.localize("formatSelection.label","Format Selection"),alias:"Format Selection",precondition:ContextKeyExpr.and(EditorContextKeys.writable,EditorContextKeys.hasDocumentSelectionFormattingProvider),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:KeyChord(2089,2084),weight:100},contextMenuOpts:{when:EditorContextKeys.hasNonEmptySelection,group:"1_modification",order:1.31}})}run(t,e){return __awaiter(this,void 0,void 0,(function*(){if(!e.hasModel())return;const o=t.get(IInstantiationService),i=e.getModel(),r=e.getSelections().map((t=>t.isEmpty()?new Range(t.startLineNumber,1,t.startLineNumber,i.getLineMaxColumn(t.startLineNumber)):t)),n=t.get(IEditorProgressService);yield n.showWhile(o.invokeFunction(formatDocumentRangesWithSelectedProvider,e,r,1,Progress.None,CancellationToken.None),250)}))}}registerEditorContribution(FormatOnType.ID,FormatOnType),registerEditorContribution(FormatOnPaste.ID,FormatOnPaste),registerEditorAction(FormatDocumentAction),registerEditorAction(FormatSelectionAction),CommandsRegistry.registerCommand("editor.action.format",(t=>__awaiter(void 0,void 0,void 0,(function*(){const e=t.get(ICodeEditorService).getFocusedCodeEditor();if(!e||!e.hasModel())return;const o=t.get(ICommandService);e.getSelection().isEmpty()?yield o.executeCommand("editor.action.formatDocument"):yield o.executeCommand("editor.action.formatSelection")}))));