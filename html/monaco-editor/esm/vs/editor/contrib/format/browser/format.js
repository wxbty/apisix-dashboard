var __awaiter=this&&this.__awaiter||function(e,t,o,n){function r(e){return e instanceof o?e:new o((function(t){t(e)}))}return new(o||(o=Promise))((function(o,i){function s(e){try{d(n.next(e))}catch(t){i(t)}}function a(e){try{d(n["throw"](e))}catch(t){i(t)}}function d(e){e.done?o(e.value):r(e.value).then(s,a)}d((n=n.apply(e,t||[])).next())}))};import{alert}from"../../../../base/browser/ui/aria/aria.js";import{asArray,isNonEmptyArray}from"../../../../base/common/arrays.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError}from"../../../../base/common/errors.js";import{Iterable}from"../../../../base/common/iterator.js";import{LinkedList}from"../../../../base/common/linkedList.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{EditorStateCancellationTokenSource,TextModelCancellationTokenSource}from"../../editorState/browser/editorState.js";import{isCodeEditor}from"../../../browser/editorBrowser.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import{DocumentFormattingEditProviderRegistry,DocumentRangeFormattingEditProviderRegistry,OnTypeFormattingEditProviderRegistry}from"../../../common/languages.js";import{IEditorWorkerService}from"../../../common/services/editorWorker.js";import{ITextModelService}from"../../../common/services/resolverService.js";import{FormattingEdit}from"./formattingEdit.js";import*as nls from"../../../../nls.js";import{CommandsRegistry}from"../../../../platform/commands/common/commands.js";import{ExtensionIdentifier}from"../../../../platform/extensions/common/extensions.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";export function alertFormattingEdits(e){if(e=e.filter((e=>e.range)),!e.length)return;let{range:t}=e[0];for(let r=1;r<e.length;r++)t=Range.plusRange(t,e[r].range);const{startLineNumber:o,endLineNumber:n}=t;o===n?1===e.length?alert(nls.localize("hint11","Made 1 formatting edit on line {0}",o)):alert(nls.localize("hintn1","Made {0} formatting edits on line {1}",e.length,o)):1===e.length?alert(nls.localize("hint1n","Made 1 formatting edit between lines {0} and {1}",o,n)):alert(nls.localize("hintnn","Made {0} formatting edits between lines {1} and {2}",e.length,o,n))}export function getRealAndSyntheticDocumentFormattersOrdered(e){const t=[],o=new Set,n=DocumentFormattingEditProviderRegistry.ordered(e);for(const i of n)t.push(i),i.extensionId&&o.add(ExtensionIdentifier.toKey(i.extensionId));const r=DocumentRangeFormattingEditProviderRegistry.ordered(e);for(const i of r){if(i.extensionId){if(o.has(ExtensionIdentifier.toKey(i.extensionId)))continue;o.add(ExtensionIdentifier.toKey(i.extensionId))}t.push({displayName:i.displayName,extensionId:i.extensionId,provideDocumentFormattingEdits(e,t,o){return i.provideDocumentRangeFormattingEdits(e,e.getFullModelRange(),t,o)}})}return t}export class FormattingConflicts{static setFormatterSelector(e){const t=FormattingConflicts._selectors.unshift(e);return{dispose:t}}static select(e,t,o){return __awaiter(this,void 0,void 0,(function*(){if(0===e.length)return;const n=Iterable.first(FormattingConflicts._selectors);return n?yield n(e,t,o):void 0}))}}FormattingConflicts._selectors=new LinkedList;export function formatDocumentRangesWithSelectedProvider(e,t,o,n,r,i){return __awaiter(this,void 0,void 0,(function*(){const s=e.get(IInstantiationService),a=isCodeEditor(t)?t.getModel():t,d=DocumentRangeFormattingEditProviderRegistry.ordered(a),c=yield FormattingConflicts.select(d,a,n);c&&(r.report(c),yield s.invokeFunction(formatDocumentRangesWithProvider,c,t,o,i))}))}export function formatDocumentRangesWithProvider(e,t,o,n,r){return __awaiter(this,void 0,void 0,(function*(){const i=e.get(IEditorWorkerService);let s,a;isCodeEditor(o)?(s=o.getModel(),a=new EditorStateCancellationTokenSource(o,5,void 0,r)):(s=o,a=new TextModelCancellationTokenSource(o,r));let d=[],c=0;for(let e of asArray(n).sort(Range.compareRangesUsingStarts))c>0&&Range.areIntersectingOrTouching(d[c-1],e)?d[c-1]=Range.fromPositions(d[c-1].getStartPosition(),e.getEndPosition()):c=d.push(e);const l=e=>__awaiter(this,void 0,void 0,(function*(){return(yield t.provideDocumentRangeFormattingEdits(s,e,s.getFormattingOptions(),a.token))||[]})),m=(e,t)=>{if(!e.length||!t.length)return!1;const o=e.reduce(((e,t)=>Range.plusRange(e,t.range)),e[0].range);if(!t.some((e=>Range.intersectRanges(o,e.range))))return!1;for(let n of e)for(let e of t)if(Range.intersectRanges(n.range,e.range))return!0;return!1},u=[],g=[];try{for(let e of d){if(a.token.isCancellationRequested)return!0;g.push(yield l(e))}for(let e=0;e<d.length;++e)for(let t=e+1;t<d.length;++t){if(a.token.isCancellationRequested)return!0;if(m(g[e],g[t])){const o=Range.plusRange(d[e],d[t]),n=yield l(o);d.splice(t,1),d.splice(e,1),d.push(o),g.splice(t,1),g.splice(e,1),g.push(n),e=0,t=0}}for(let e of g){if(a.token.isCancellationRequested)return!0;const t=yield i.computeMoreMinimalEdits(s.uri,e);t&&u.push(...t)}}finally{a.dispose()}if(0===u.length)return!1;if(isCodeEditor(o))FormattingEdit.execute(o,u,!0),alertFormattingEdits(u),o.revealPositionInCenterIfOutsideViewport(o.getPosition(),1);else{const[{range:e}]=u,t=new Selection(e.startLineNumber,e.startColumn,e.endLineNumber,e.endColumn);s.pushEditOperations([t],u.map((e=>({text:e.text,range:Range.lift(e.range),forceMoveMarkers:!0}))),(e=>{for(const{range:o}of e)if(Range.areIntersectingOrTouching(o,t))return[new Selection(o.startLineNumber,o.startColumn,o.endLineNumber,o.endColumn)];return null}))}return!0}))}export function formatDocumentWithSelectedProvider(e,t,o,n,r){return __awaiter(this,void 0,void 0,(function*(){const i=e.get(IInstantiationService),s=isCodeEditor(t)?t.getModel():t,a=getRealAndSyntheticDocumentFormattersOrdered(s),d=yield FormattingConflicts.select(a,s,o);d&&(n.report(d),yield i.invokeFunction(formatDocumentWithProvider,d,t,o,r))}))}export function formatDocumentWithProvider(e,t,o,n,r){return __awaiter(this,void 0,void 0,(function*(){const i=e.get(IEditorWorkerService);let s,a,d;isCodeEditor(o)?(s=o.getModel(),a=new EditorStateCancellationTokenSource(o,5,void 0,r)):(s=o,a=new TextModelCancellationTokenSource(o,r));try{const e=yield t.provideDocumentFormattingEdits(s,s.getFormattingOptions(),a.token);if(d=yield i.computeMoreMinimalEdits(s.uri,e),a.token.isCancellationRequested)return!0}finally{a.dispose()}if(!d||0===d.length)return!1;if(isCodeEditor(o))FormattingEdit.execute(o,d,2!==n),2!==n&&(alertFormattingEdits(d),o.revealPositionInCenterIfOutsideViewport(o.getPosition(),1));else{const[{range:e}]=d,t=new Selection(e.startLineNumber,e.startColumn,e.endLineNumber,e.endColumn);s.pushEditOperations([t],d.map((e=>({text:e.text,range:Range.lift(e.range),forceMoveMarkers:!0}))),(e=>{for(const{range:o}of e)if(Range.areIntersectingOrTouching(o,t))return[new Selection(o.startLineNumber,o.startColumn,o.endLineNumber,o.endColumn)];return null}))}return!0}))}export function getDocumentRangeFormattingEditsUntilResult(e,t,o,n,r){return __awaiter(this,void 0,void 0,(function*(){const i=DocumentRangeFormattingEditProviderRegistry.ordered(t);for(const s of i){let i=yield Promise.resolve(s.provideDocumentRangeFormattingEdits(t,o,n,r)).catch(onUnexpectedExternalError);if(isNonEmptyArray(i))return yield e.computeMoreMinimalEdits(t.uri,i)}}))}export function getDocumentFormattingEditsUntilResult(e,t,o,n){return __awaiter(this,void 0,void 0,(function*(){const r=getRealAndSyntheticDocumentFormattersOrdered(t);for(const i of r){let r=yield Promise.resolve(i.provideDocumentFormattingEdits(t,o,n)).catch(onUnexpectedExternalError);if(isNonEmptyArray(r))return yield e.computeMoreMinimalEdits(t.uri,r)}}))}export function getOnTypeFormattingEdits(e,t,o,n,r,i){const s=OnTypeFormattingEditProviderRegistry.ordered(t);return 0===s.length||s[0].autoFormatTriggerCharacters.indexOf(n)<0?Promise.resolve(void 0):Promise.resolve(s[0].provideOnTypeFormattingEdits(t,o,n,r,i)).catch(onUnexpectedExternalError).then((o=>e.computeMoreMinimalEdits(t.uri,o)))}CommandsRegistry.registerCommand("_executeFormatRangeProvider",(function(e,...t){return __awaiter(this,void 0,void 0,(function*(){const[o,n,r]=t;assertType(URI.isUri(o)),assertType(Range.isIRange(n));const i=e.get(ITextModelService),s=e.get(IEditorWorkerService),a=yield i.createModelReference(o);try{return getDocumentRangeFormattingEditsUntilResult(s,a.object.textEditorModel,Range.lift(n),r,CancellationToken.None)}finally{a.dispose()}}))})),CommandsRegistry.registerCommand("_executeFormatDocumentProvider",(function(e,...t){return __awaiter(this,void 0,void 0,(function*(){const[o,n]=t;assertType(URI.isUri(o));const r=e.get(ITextModelService),i=e.get(IEditorWorkerService),s=yield r.createModelReference(o);try{return getDocumentFormattingEditsUntilResult(i,s.object.textEditorModel,n,CancellationToken.None)}finally{s.dispose()}}))})),CommandsRegistry.registerCommand("_executeFormatOnTypeProvider",(function(e,...t){return __awaiter(this,void 0,void 0,(function*(){const[o,n,r,i]=t;assertType(URI.isUri(o)),assertType(Position.isIPosition(n)),assertType("string"===typeof r);const s=e.get(ITextModelService),a=e.get(IEditorWorkerService),d=yield s.createModelReference(o);try{return getOnTypeFormattingEdits(a,d.object.textEditorModel,Position.lift(n),r,i,CancellationToken.None)}finally{d.dispose()}}))}));