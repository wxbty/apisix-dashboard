var __decorate=this&&this.__decorate||function(e,t,o,i){var r,n=arguments.length,s=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,o,i);else for(var h=e.length-1;h>=0;h--)(r=e[h])&&(s=(n<3?r(s):n>3?r(t,o,s):r(t,o))||s);return n>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}};import{alert}from"../../../../base/browser/ui/aria/aria.js";import*as arrays from"../../../../base/common/arrays.js";import{createCancelablePromise,first,timeout}from"../../../../base/common/async.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{onUnexpectedError,onUnexpectedExternalError}from"../../../../base/common/errors.js";import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{EditorAction,registerEditorAction,registerEditorContribution,registerModelAndPositionCommand}from"../../../browser/editorExtensions.js";import{Range}from"../../../common/core/range.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{MinimapPosition,OverviewRulerLane}from"../../../common/model.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";import{DocumentHighlightKind,DocumentHighlightProviderRegistry}from"../../../common/languages.js";import*as nls from"../../../../nls.js";import{IContextKeyService,RawContextKey}from"../../../../platform/contextkey/common/contextkey.js";import{activeContrastBorder,editorSelectionHighlight,editorSelectionHighlightBorder,minimapSelectionOccurrenceHighlight,overviewRulerSelectionHighlightForeground,registerColor}from"../../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant,themeColorFromId}from"../../../../platform/theme/common/themeService.js";const editorWordHighlight=registerColor("editor.wordHighlightBackground",{dark:"#575757B8",light:"#57575740",hc:null},nls.localize("wordHighlight","Background color of a symbol during read-access, like reading a variable. The color must not be opaque so as not to hide underlying decorations."),!0),editorWordHighlightStrong=registerColor("editor.wordHighlightStrongBackground",{dark:"#004972B8",light:"#0e639c40",hc:null},nls.localize("wordHighlightStrong","Background color of a symbol during write-access, like writing to a variable. The color must not be opaque so as not to hide underlying decorations."),!0),editorWordHighlightBorder=registerColor("editor.wordHighlightBorder",{light:null,dark:null,hc:activeContrastBorder},nls.localize("wordHighlightBorder","Border color of a symbol during read-access, like reading a variable.")),editorWordHighlightStrongBorder=registerColor("editor.wordHighlightStrongBorder",{light:null,dark:null,hc:activeContrastBorder},nls.localize("wordHighlightStrongBorder","Border color of a symbol during write-access, like writing to a variable.")),overviewRulerWordHighlightForeground=registerColor("editorOverviewRuler.wordHighlightForeground",{dark:"#A0A0A0CC",light:"#A0A0A0CC",hc:"#A0A0A0CC"},nls.localize("overviewRulerWordHighlightForeground","Overview ruler marker color for symbol highlights. The color must not be opaque so as not to hide underlying decorations."),!0),overviewRulerWordHighlightStrongForeground=registerColor("editorOverviewRuler.wordHighlightStrongForeground",{dark:"#C0A0C0CC",light:"#C0A0C0CC",hc:"#C0A0C0CC"},nls.localize("overviewRulerWordHighlightStrongForeground","Overview ruler marker color for write-access symbol highlights. The color must not be opaque so as not to hide underlying decorations."),!0),ctxHasWordHighlights=new RawContextKey("hasWordHighlights",!1);export function getOccurrencesAtPosition(e,t,o){const i=DocumentHighlightProviderRegistry.ordered(e);return first(i.map((i=>()=>Promise.resolve(i.provideDocumentHighlights(e,t,o)).then(void 0,onUnexpectedExternalError))),arrays.isNonEmptyArray)}class OccurenceAtPositionRequest{constructor(e,t,o){this._wordRange=this._getCurrentWordRange(e,t),this.result=createCancelablePromise((i=>this._compute(e,t,o,i)))}_getCurrentWordRange(e,t){const o=e.getWordAtPosition(t.getPosition());return o?new Range(t.startLineNumber,o.startColumn,t.startLineNumber,o.endColumn):null}isValid(e,t,o){const i=t.startLineNumber,r=t.startColumn,n=t.endColumn,s=this._getCurrentWordRange(e,t);let h=Boolean(this._wordRange&&this._wordRange.equalsRange(s));for(let l=0,g=o.length;!h&&l<g;l++){let t=e.getDecorationRange(o[l]);t&&t.startLineNumber===i&&t.startColumn<=r&&t.endColumn>=n&&(h=!0)}return h}cancel(){this.result.cancel()}}class SemanticOccurenceAtPositionRequest extends OccurenceAtPositionRequest{_compute(e,t,o,i){return getOccurrencesAtPosition(e,t.getPosition(),i).then((e=>e||[]))}}class TextualOccurenceAtPositionRequest extends OccurenceAtPositionRequest{constructor(e,t,o){super(e,t,o),this._selectionIsEmpty=t.isEmpty()}_compute(e,t,o,i){return timeout(250,i).then((()=>{if(!t.isEmpty())return[];const i=e.getWordAtPosition(t.getPosition());if(!i||i.word.length>1e3)return[];const r=e.findMatches(i.word,!0,!1,!0,o,!1);return r.map((e=>({range:e.range,kind:DocumentHighlightKind.Text})))}))}isValid(e,t,o){const i=t.isEmpty();return this._selectionIsEmpty===i&&super.isValid(e,t,o)}}function computeOccurencesAtPosition(e,t,o){return DocumentHighlightProviderRegistry.has(e)?new SemanticOccurenceAtPositionRequest(e,t,o):new TextualOccurenceAtPositionRequest(e,t,o)}registerModelAndPositionCommand("_executeDocumentHighlights",((e,t)=>getOccurrencesAtPosition(e,t,CancellationToken.None)));class WordHighlighter{constructor(e,t){this.toUnhook=new DisposableStore,this.workerRequestTokenId=0,this.workerRequestCompleted=!1,this.workerRequestValue=[],this.lastCursorPositionChangeTime=0,this.renderDecorationsTimer=-1,this.editor=e,this._hasWordHighlights=ctxHasWordHighlights.bindTo(t),this._ignorePositionChangeEvent=!1,this.occurrencesHighlight=this.editor.getOption(72),this.model=this.editor.getModel(),this.toUnhook.add(e.onDidChangeCursorPosition((e=>{this._ignorePositionChangeEvent||this.occurrencesHighlight&&this._onPositionChanged(e)}))),this.toUnhook.add(e.onDidChangeModelContent((e=>{this._stopAll()}))),this.toUnhook.add(e.onDidChangeConfiguration((e=>{let t=this.editor.getOption(72);this.occurrencesHighlight!==t&&(this.occurrencesHighlight=t,this._stopAll())}))),this._decorationIds=[],this.workerRequestTokenId=0,this.workerRequest=null,this.workerRequestCompleted=!1,this.lastCursorPositionChangeTime=0,this.renderDecorationsTimer=-1}hasDecorations(){return this._decorationIds.length>0}restore(){this.occurrencesHighlight&&this._run()}_getSortedHighlights(){return arrays.coalesce(this._decorationIds.map((e=>this.model.getDecorationRange(e))).sort(Range.compareRangesUsingStarts))}moveNext(){let e=this._getSortedHighlights(),t=e.findIndex((e=>e.containsPosition(this.editor.getPosition()))),o=(t+1)%e.length,i=e[o];try{this._ignorePositionChangeEvent=!0,this.editor.setPosition(i.getStartPosition()),this.editor.revealRangeInCenterIfOutsideViewport(i);const t=this._getWord();if(t){const r=this.editor.getModel().getLineContent(i.startLineNumber);alert(`${r}, ${o+1} of ${e.length} for '${t.word}'`)}}finally{this._ignorePositionChangeEvent=!1}}moveBack(){let e=this._getSortedHighlights(),t=e.findIndex((e=>e.containsPosition(this.editor.getPosition()))),o=(t-1+e.length)%e.length,i=e[o];try{this._ignorePositionChangeEvent=!0,this.editor.setPosition(i.getStartPosition()),this.editor.revealRangeInCenterIfOutsideViewport(i);const t=this._getWord();if(t){const r=this.editor.getModel().getLineContent(i.startLineNumber);alert(`${r}, ${o+1} of ${e.length} for '${t.word}'`)}}finally{this._ignorePositionChangeEvent=!1}}_removeDecorations(){this._decorationIds.length>0&&(this._decorationIds=this.editor.deltaDecorations(this._decorationIds,[]),this._hasWordHighlights.set(!1))}_stopAll(){this._removeDecorations(),-1!==this.renderDecorationsTimer&&(clearTimeout(this.renderDecorationsTimer),this.renderDecorationsTimer=-1),null!==this.workerRequest&&(this.workerRequest.cancel(),this.workerRequest=null),this.workerRequestCompleted||(this.workerRequestTokenId++,this.workerRequestCompleted=!0)}_onPositionChanged(e){this.occurrencesHighlight&&3===e.reason?this._run():this._stopAll()}_getWord(){let e=this.editor.getSelection(),t=e.startLineNumber,o=e.startColumn;return this.model.getWordAtPosition({lineNumber:t,column:o})}_run(){let e=this.editor.getSelection();if(e.startLineNumber!==e.endLineNumber)return void this._stopAll();let t=e.startColumn,o=e.endColumn;const i=this._getWord();if(!i||i.startColumn>t||i.endColumn<o)return void this._stopAll();const r=this.workerRequest&&this.workerRequest.isValid(this.model,e,this._decorationIds);if(this.lastCursorPositionChangeTime=(new Date).getTime(),r)this.workerRequestCompleted&&-1!==this.renderDecorationsTimer&&(clearTimeout(this.renderDecorationsTimer),this.renderDecorationsTimer=-1,this._beginRenderDecorations());else{this._stopAll();let e=++this.workerRequestTokenId;this.workerRequestCompleted=!1,this.workerRequest=computeOccurencesAtPosition(this.model,this.editor.getSelection(),this.editor.getOption(117)),this.workerRequest.result.then((t=>{e===this.workerRequestTokenId&&(this.workerRequestCompleted=!0,this.workerRequestValue=t||[],this._beginRenderDecorations())}),onUnexpectedError)}}_beginRenderDecorations(){let e=(new Date).getTime(),t=this.lastCursorPositionChangeTime+250;e>=t?(this.renderDecorationsTimer=-1,this.renderDecorations()):this.renderDecorationsTimer=setTimeout((()=>{this.renderDecorations()}),t-e)}renderDecorations(){this.renderDecorationsTimer=-1;let e=[];for(const t of this.workerRequestValue)t.range&&e.push({range:t.range,options:WordHighlighter._getDecorationOptions(t.kind)});this._decorationIds=this.editor.deltaDecorations(this._decorationIds,e),this._hasWordHighlights.set(this.hasDecorations())}static _getDecorationOptions(e){return e===DocumentHighlightKind.Write?this._WRITE_OPTIONS:e===DocumentHighlightKind.Text?this._TEXT_OPTIONS:this._REGULAR_OPTIONS}dispose(){this._stopAll(),this.toUnhook.dispose()}}WordHighlighter._WRITE_OPTIONS=ModelDecorationOptions.register({description:"word-highlight-strong",stickiness:1,className:"wordHighlightStrong",overviewRuler:{color:themeColorFromId(overviewRulerWordHighlightStrongForeground),position:OverviewRulerLane.Center},minimap:{color:themeColorFromId(minimapSelectionOccurrenceHighlight),position:MinimapPosition.Inline}}),WordHighlighter._TEXT_OPTIONS=ModelDecorationOptions.register({description:"selection-highlight",stickiness:1,className:"selectionHighlight",overviewRuler:{color:themeColorFromId(overviewRulerSelectionHighlightForeground),position:OverviewRulerLane.Center},minimap:{color:themeColorFromId(minimapSelectionOccurrenceHighlight),position:MinimapPosition.Inline}}),WordHighlighter._REGULAR_OPTIONS=ModelDecorationOptions.register({description:"word-highlight",stickiness:1,className:"wordHighlight",overviewRuler:{color:themeColorFromId(overviewRulerWordHighlightForeground),position:OverviewRulerLane.Center},minimap:{color:themeColorFromId(minimapSelectionOccurrenceHighlight),position:MinimapPosition.Inline}});let WordHighlighterContribution=class e extends Disposable{constructor(e,t){super(),this.wordHighlighter=null;const o=()=>{e.hasModel()&&(this.wordHighlighter=new WordHighlighter(e,t))};this._register(e.onDidChangeModel((e=>{this.wordHighlighter&&(this.wordHighlighter.dispose(),this.wordHighlighter=null),o()}))),o()}static get(t){return t.getContribution(e.ID)}saveViewState(){return!(!this.wordHighlighter||!this.wordHighlighter.hasDecorations())}moveNext(){this.wordHighlighter&&this.wordHighlighter.moveNext()}moveBack(){this.wordHighlighter&&this.wordHighlighter.moveBack()}restoreViewState(e){this.wordHighlighter&&e&&this.wordHighlighter.restore()}dispose(){this.wordHighlighter&&(this.wordHighlighter.dispose(),this.wordHighlighter=null),super.dispose()}};WordHighlighterContribution.ID="editor.contrib.wordHighlighter",WordHighlighterContribution=__decorate([__param(1,IContextKeyService)],WordHighlighterContribution);class WordHighlightNavigationAction extends EditorAction{constructor(e,t){super(t),this._isNext=e}run(e,t){const o=WordHighlighterContribution.get(t);o&&(this._isNext?o.moveNext():o.moveBack())}}class NextWordHighlightAction extends WordHighlightNavigationAction{constructor(){super(!0,{id:"editor.action.wordHighlight.next",label:nls.localize("wordHighlight.next.label","Go to Next Symbol Highlight"),alias:"Go to Next Symbol Highlight",precondition:ctxHasWordHighlights,kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:65,weight:100}})}}class PrevWordHighlightAction extends WordHighlightNavigationAction{constructor(){super(!1,{id:"editor.action.wordHighlight.prev",label:nls.localize("wordHighlight.previous.label","Go to Previous Symbol Highlight"),alias:"Go to Previous Symbol Highlight",precondition:ctxHasWordHighlights,kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:1089,weight:100}})}}class TriggerWordHighlightAction extends EditorAction{constructor(){super({id:"editor.action.wordHighlight.trigger",label:nls.localize("wordHighlight.trigger.label","Trigger Symbol Highlight"),alias:"Trigger Symbol Highlight",precondition:ctxHasWordHighlights.toNegated(),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:0,weight:100}})}run(e,t,o){const i=WordHighlighterContribution.get(t);i&&i.restoreViewState(!0)}}registerEditorContribution(WordHighlighterContribution.ID,WordHighlighterContribution),registerEditorAction(NextWordHighlightAction),registerEditorAction(PrevWordHighlightAction),registerEditorAction(TriggerWordHighlightAction),registerThemingParticipant(((e,t)=>{const o=e.getColor(editorSelectionHighlight);o&&(t.addRule(`.monaco-editor .focused .selectionHighlight { background-color: ${o}; }`),t.addRule(`.monaco-editor .selectionHighlight { background-color: ${o.transparent(.5)}; }`));const i=e.getColor(editorWordHighlight);i&&t.addRule(`.monaco-editor .wordHighlight { background-color: ${i}; }`);const r=e.getColor(editorWordHighlightStrong);r&&t.addRule(`.monaco-editor .wordHighlightStrong { background-color: ${r}; }`);const n=e.getColor(editorSelectionHighlightBorder);n&&t.addRule(`.monaco-editor .selectionHighlight { border: 1px ${"hc"===e.type?"dotted":"solid"} ${n}; box-sizing: border-box; }`);const s=e.getColor(editorWordHighlightBorder);s&&t.addRule(`.monaco-editor .wordHighlight { border: 1px ${"hc"===e.type?"dashed":"solid"} ${s}; box-sizing: border-box; }`);const h=e.getColor(editorWordHighlightStrongBorder);h&&t.addRule(`.monaco-editor .wordHighlightStrong { border: 1px ${"hc"===e.type?"dashed":"solid"} ${h}; box-sizing: border-box; }`)}));