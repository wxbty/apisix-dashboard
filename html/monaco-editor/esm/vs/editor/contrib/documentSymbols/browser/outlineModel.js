var __decorate=this&&this.__decorate||function(e,t,o,n){var r,i=arguments.length,s=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(i<3?r(s):i>3?r(t,o,s):r(t,o))||s);return i>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}},__awaiter=this&&this.__awaiter||function(e,t,o,n){function r(e){return e instanceof o?e:new o((function(t){t(e)}))}return new(o||(o=Promise))((function(o,i){function s(e){try{l(n.next(e))}catch(t){i(t)}}function a(e){try{l(n["throw"](e))}catch(t){i(t)}}function l(e){e.done?o(e.value):r(e.value).then(s,a)}l((n=n.apply(e,t||[])).next())}))};import{equals}from"../../../../base/common/arrays.js";import{CancellationTokenSource}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError}from"../../../../base/common/errors.js";import{Iterable}from"../../../../base/common/iterator.js";import{LRUCache}from"../../../../base/common/map.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{DocumentSymbolProviderRegistry}from"../../../common/languages.js";import{ILanguageFeatureDebounceService}from"../../../common/services/languageFeatureDebounce.js";import{createDecorator}from"../../../../platform/instantiation/common/instantiation.js";import{registerSingleton}from"../../../../platform/instantiation/common/extensions.js";import{IModelService}from"../../../common/services/model.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";export class TreeElement{remove(){this.parent&&this.parent.children.delete(this.id)}static findId(e,t){let o;"string"===typeof e?o=`${t.id}/${e}`:(o=`${t.id}/${e.name}`,void 0!==t.children.get(o)&&(o=`${t.id}/${e.name}_${e.range.startLineNumber}_${e.range.startColumn}`));let n=o;for(let r=0;void 0!==t.children.get(n);r++)n=`${o}_${r}`;return n}static empty(e){return 0===e.children.size}}export class OutlineElement extends TreeElement{constructor(e,t,o){super(),this.id=e,this.parent=t,this.symbol=o,this.children=new Map}}export class OutlineGroup extends TreeElement{constructor(e,t,o,n){super(),this.id=e,this.parent=t,this.label=o,this.order=n,this.children=new Map}}export class OutlineModel extends TreeElement{constructor(e){super(),this.uri=e,this.id="root",this.parent=void 0,this._groups=new Map,this.children=new Map,this.id="root",this.parent=void 0}static create(e,t){const o=new CancellationTokenSource(t),n=new OutlineModel(e.uri),r=DocumentSymbolProviderRegistry.ordered(e),i=r.map(((t,r)=>{var i;let s=TreeElement.findId(`provider_${r}`,n),a=new OutlineGroup(s,n,null!==(i=t.displayName)&&void 0!==i?i:"Unknown Outline Provider",r);return Promise.resolve(t.provideDocumentSymbols(e,o.token)).then((e=>{for(const t of e||[])OutlineModel._makeOutlineElement(t,a);return a}),(e=>(onUnexpectedExternalError(e),a))).then((e=>{TreeElement.empty(e)?e.remove():n._groups.set(s,e)}))})),s=DocumentSymbolProviderRegistry.onDidChange((()=>{const t=DocumentSymbolProviderRegistry.ordered(e);equals(t,r)||o.cancel()}));return Promise.all(i).then((()=>o.token.isCancellationRequested&&!t.isCancellationRequested?OutlineModel.create(e,t):n._compact())).finally((()=>{s.dispose()}))}static _makeOutlineElement(e,t){let o=TreeElement.findId(e,t),n=new OutlineElement(o,t,e);if(e.children)for(const r of e.children)OutlineModel._makeOutlineElement(r,n);t.children.set(n.id,n)}_compact(){let e=0;for(const[t,o]of this._groups)0===o.children.size?this._groups.delete(t):e+=1;if(1!==e)this.children=this._groups;else{let e=Iterable.first(this._groups.values());for(let[,t]of e.children)t.parent=this,this.children.set(t.id,t)}return this}getTopLevelSymbols(){const e=[];for(const t of this.children.values())t instanceof OutlineElement?e.push(t.symbol):e.push(...Iterable.map(t.children.values(),(e=>e.symbol)));return e.sort(((e,t)=>Range.compareRangesUsingStarts(e.range,t.range)))}asListOfDocumentSymbols(){const e=this.getTopLevelSymbols(),t=[];return OutlineModel._flattenDocumentSymbols(t,e,""),t.sort(((e,t)=>Position.compare(Range.getStartPosition(e.range),Range.getStartPosition(t.range))||Position.compare(Range.getEndPosition(t.range),Range.getEndPosition(e.range))))}static _flattenDocumentSymbols(e,t,o){for(const n of t)e.push({kind:n.kind,tags:n.tags,name:n.name,detail:n.detail,containerName:n.containerName||o,range:n.range,selectionRange:n.selectionRange,children:void 0}),n.children&&OutlineModel._flattenDocumentSymbols(e,n.children,n.name)}}export const IOutlineModelService=createDecorator("IOutlineModelService");let OutlineModelService=class{constructor(e,t){this._disposables=new DisposableStore,this._cache=new LRUCache(10,.7),this._debounceInformation=e.for(DocumentSymbolProviderRegistry,"DocumentSymbols",{min:350}),this._disposables.add(t.onModelRemoved((e=>{this._cache.delete(e.id)})))}dispose(){this._disposables.dispose()}getOrCreate(e,t){return __awaiter(this,void 0,void 0,(function*(){const o=DocumentSymbolProviderRegistry.ordered(e);let n=this._cache.get(e.id);if(!n||n.versionId!==e.getVersionId()||!equals(n.provider,o)){let t=new CancellationTokenSource;n={versionId:e.getVersionId(),provider:o,promiseCnt:0,source:t,promise:OutlineModel.create(e,t.token),model:void 0},this._cache.set(e.id,n);const r=Date.now();n.promise.then((t=>{n.model=t,this._debounceInformation.update(e,Date.now()-r)})).catch((t=>{this._cache.delete(e.id)}))}if(n.model)return n.model;n.promiseCnt+=1;const r=t.onCancellationRequested((()=>{0===--n.promiseCnt&&(n.source.cancel(),this._cache.delete(e.id))}));try{return yield n.promise}finally{r.dispose()}}))}};OutlineModelService=__decorate([__param(0,ILanguageFeatureDebounceService),__param(1,IModelService)],OutlineModelService);export{OutlineModelService};registerSingleton(IOutlineModelService,OutlineModelService,!0);