var __decorate=this&&this.__decorate||function(e,t,i,o){var n,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,i,o);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(s=(r<3?n(s):r>3?n(t,i,s):n(t,i))||s);return r>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}},__awaiter=this&&this.__awaiter||function(e,t,i,o){function n(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(t){r(t)}}function c(e){try{a(o["throw"](e))}catch(t){r(t)}}function a(e){e.done?i(e.value):n(e.value).then(s,c)}a((o=o.apply(e,t||[])).next())}))};import*as async from"../../../../base/common/async.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{MarkdownString}from"../../../../base/common/htmlContent.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{Schemas}from"../../../../base/common/network.js";import*as platform from"../../../../base/common/platform.js";import*as resources from"../../../../base/common/resources.js";import{URI}from"../../../../base/common/uri.js";import"./links.css";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";import{LinkProviderRegistry}from"../../../common/languages.js";import{ClickLinkGesture}from"../../gotoSymbol/browser/link/clickLinkGesture.js";import{getLinks}from"./getLinks.js";import*as nls from"../../../../nls.js";import{INotificationService}from"../../../../platform/notification/common/notification.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";import{editorActiveLinkForeground}from"../../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";function getHoverMessage(e,t){const i=e.url&&/^command:/i.test(e.url.toString()),o=e.tooltip?e.tooltip:i?nls.localize("links.navigate.executeCmd","Execute command"):nls.localize("links.navigate.follow","Follow link"),n=t?platform.isMacintosh?nls.localize("links.navigate.kb.meta.mac","cmd + click"):nls.localize("links.navigate.kb.meta","ctrl + click"):platform.isMacintosh?nls.localize("links.navigate.kb.alt.mac","option + click"):nls.localize("links.navigate.kb.alt","alt + click");if(e.url){let t="";if(/^command:/i.test(e.url.toString())){const i=e.url.toString().match(/^command:([^?#]+)/);if(i){const e=i[1],o=nls.localize("tooltip.explanation","Execute command {0}",e);t=` "${o}"`}}const i=new MarkdownString("",!0).appendMarkdown(`[${o}](${e.url.toString(!0).replace(/ /g,"%20")}${t}) (${n})`);return i}return(new MarkdownString).appendText(`${o} (${n})`)}const decoration={general:ModelDecorationOptions.register({description:"detected-link",stickiness:1,collapseOnReplaceEdit:!0,inlineClassName:"detected-link"}),active:ModelDecorationOptions.register({description:"detected-link-active",stickiness:1,collapseOnReplaceEdit:!0,inlineClassName:"detected-link-active"})};class LinkOccurrence{constructor(e,t){this.link=e,this.decorationId=t}static decoration(e,t){return{range:e.range,options:LinkOccurrence._getOptions(e,t,!1)}}static _getOptions(e,t,i){const o=Object.assign({},i?decoration.active:decoration.general);return o.hoverMessage=getHoverMessage(e,t),o}activate(e,t){e.changeDecorationOptions(this.decorationId,LinkOccurrence._getOptions(this.link,t,!0))}deactivate(e,t){e.changeDecorationOptions(this.decorationId,LinkOccurrence._getOptions(this.link,t,!1))}}let LinkDetector=class e{constructor(e,t,i){this.listenersToRemove=new DisposableStore,this.editor=e,this.openerService=t,this.notificationService=i;let o=new ClickLinkGesture(e);this.listenersToRemove.add(o),this.listenersToRemove.add(o.onMouseMoveOrRelevantKeyDown((([e,t])=>{this._onEditorMouseMove(e,t)}))),this.listenersToRemove.add(o.onExecute((e=>{this.onEditorMouseUp(e)}))),this.listenersToRemove.add(o.onCancel((e=>{this.cleanUpActiveLinkDecoration()}))),this.enabled=e.getOption(63),this.listenersToRemove.add(e.onDidChangeConfiguration((t=>{const i=e.getOption(63);this.enabled!==i&&(this.enabled=i,this.updateDecorations([]),this.stop(),this.beginCompute())}))),this.listenersToRemove.add(e.onDidChangeModelContent((e=>this.onChange()))),this.listenersToRemove.add(e.onDidChangeModel((e=>this.onModelChanged()))),this.listenersToRemove.add(e.onDidChangeModelLanguage((e=>this.onModelLanguageChanged()))),this.listenersToRemove.add(LinkProviderRegistry.onDidChange((e=>this.onModelLanguageChanged()))),this.timeout=new async.TimeoutTimer,this.computePromise=null,this.activeLinksList=null,this.currentOccurrences={},this.activeLinkDecorationId=null,this.beginCompute()}static get(t){return t.getContribution(e.ID)}onModelChanged(){this.currentOccurrences={},this.activeLinkDecorationId=null,this.stop(),this.beginCompute()}onModelLanguageChanged(){this.stop(),this.beginCompute()}onChange(){this.timeout.setIfNotSet((()=>this.beginCompute()),e.RECOMPUTE_TIME)}beginCompute(){return __awaiter(this,void 0,void 0,(function*(){if(!this.editor.hasModel()||!this.enabled)return;const e=this.editor.getModel();if(LinkProviderRegistry.has(e)){this.activeLinksList&&(this.activeLinksList.dispose(),this.activeLinksList=null),this.computePromise=async.createCancelablePromise((t=>getLinks(e,t)));try{this.activeLinksList=yield this.computePromise,this.updateDecorations(this.activeLinksList.links)}catch(t){onUnexpectedError(t)}finally{this.computePromise=null}}}))}updateDecorations(e){const t="altKey"===this.editor.getOption(70);let i=[],o=Object.keys(this.currentOccurrences);for(let s=0,c=o.length;s<c;s++){let e=o[s],t=this.currentOccurrences[e];i.push(t.decorationId)}let n=[];if(e)for(const s of e)n.push(LinkOccurrence.decoration(s,t));let r=this.editor.deltaDecorations(i,n);this.currentOccurrences={},this.activeLinkDecorationId=null;for(let s=0,c=r.length;s<c;s++){let t=new LinkOccurrence(e[s],r[s]);this.currentOccurrences[t.decorationId]=t}}_onEditorMouseMove(e,t){const i="altKey"===this.editor.getOption(70);if(this.isEnabled(e,t)){this.cleanUpActiveLinkDecoration();const t=this.getLinkOccurrence(e.target.position);t&&this.editor.changeDecorations((e=>{t.activate(e,i),this.activeLinkDecorationId=t.decorationId}))}else this.cleanUpActiveLinkDecoration()}cleanUpActiveLinkDecoration(){const e="altKey"===this.editor.getOption(70);if(this.activeLinkDecorationId){const t=this.currentOccurrences[this.activeLinkDecorationId];t&&this.editor.changeDecorations((i=>{t.deactivate(i,e)})),this.activeLinkDecorationId=null}}onEditorMouseUp(e){if(!this.isEnabled(e))return;const t=this.getLinkOccurrence(e.target.position);t&&this.openLinkOccurrence(t,e.hasSideBySideModifier,!0)}openLinkOccurrence(e,t,i=!1){if(!this.openerService)return;const{link:o}=e;o.resolve(CancellationToken.None).then((e=>{if("string"===typeof e&&this.editor.hasModel()){const t=this.editor.getModel().uri;if(t.scheme===Schemas.file&&e.startsWith(`${Schemas.file}:`)){const i=URI.parse(e);if(i.scheme===Schemas.file){const o=resources.originalFSPath(i);let n=null;o.startsWith("/./")?n=`.${o.substr(1)}`:o.startsWith("//./")&&(n=`.${o.substr(2)}`),n&&(e=resources.joinPath(t,n))}}}return this.openerService.open(e,{openToSide:t,fromUserGesture:i,allowContributedOpeners:!0,allowCommands:!0})}),(e=>{const t=e instanceof Error?e.message:e;"invalid"===t?this.notificationService.warn(nls.localize("invalid.url","Failed to open this link because it is not well-formed: {0}",o.url.toString())):"missing"===t?this.notificationService.warn(nls.localize("missing.url","Failed to open this link because its target is missing.")):onUnexpectedError(e)}))}getLinkOccurrence(e){if(!this.editor.hasModel()||!e)return null;const t=this.editor.getModel().getDecorationsInRange({startLineNumber:e.lineNumber,startColumn:e.column,endLineNumber:e.lineNumber,endColumn:e.column},0,!0);for(const i of t){const e=this.currentOccurrences[i.id];if(e)return e}return null}isEnabled(e,t){return Boolean(6===e.target.type&&(e.hasTriggerModifier||t&&t.keyCodeIsTriggerKey))}stop(){var e;this.timeout.cancel(),this.activeLinksList&&(null===(e=this.activeLinksList)||void 0===e||e.dispose(),this.activeLinksList=null),this.computePromise&&(this.computePromise.cancel(),this.computePromise=null)}dispose(){this.listenersToRemove.dispose(),this.stop(),this.timeout.dispose()}};LinkDetector.ID="editor.linkDetector",LinkDetector.RECOMPUTE_TIME=1e3,LinkDetector=__decorate([__param(1,IOpenerService),__param(2,INotificationService)],LinkDetector);export{LinkDetector};class OpenLinkAction extends EditorAction{constructor(){super({id:"editor.action.openLink",label:nls.localize("label","Open Link"),alias:"Open Link",precondition:void 0})}run(e,t){const i=LinkDetector.get(t);if(!i)return;if(!t.hasModel())return;let o=t.getSelections();for(let n of o){let e=i.getLinkOccurrence(n.getEndPosition());e&&i.openLinkOccurrence(e,!1)}}}registerEditorContribution(LinkDetector.ID,LinkDetector),registerEditorAction(OpenLinkAction),registerThemingParticipant(((e,t)=>{const i=e.getColor(editorActiveLinkForeground);i&&t.addRule(`.monaco-editor .detected-link-active { color: ${i} !important; }`)}));