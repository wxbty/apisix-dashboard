var __awaiter=this&&this.__awaiter||function(e,n,o,r){function i(e){return e instanceof o?e:new o((function(n){n(e)}))}return new(o||(o=Promise))((function(o,t){function s(e){try{a(r.next(e))}catch(n){t(n)}}function l(e){try{a(r["throw"](e))}catch(n){t(n)}}function a(e){e.done?o(e.value):i(e.value).then(s,l)}a((r=r.apply(e,n||[])).next())}))};import{coalesce}from"../../../../base/common/arrays.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError}from"../../../../base/common/errors.js";import{DisposableStore,isDisposable}from"../../../../base/common/lifecycle.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{Range}from"../../../common/core/range.js";import{LinkProviderRegistry}from"../../../common/languages.js";import{IModelService}from"../../../common/services/model.js";import{CommandsRegistry}from"../../../../platform/commands/common/commands.js";export class Link{constructor(e,n){this._link=e,this._provider=n}toJSON(){return{range:this.range,url:this.url,tooltip:this.tooltip}}get range(){return this._link.range}get url(){return this._link.url}get tooltip(){return this._link.tooltip}resolve(e){return __awaiter(this,void 0,void 0,(function*(){return this._link.url?this._link.url:"function"===typeof this._provider.resolveLink?Promise.resolve(this._provider.resolveLink(this._link,e)).then((n=>(this._link=n||this._link,this._link.url?this.resolve(e):Promise.reject(new Error("missing"))))):Promise.reject(new Error("missing"))}))}}export class LinksList{constructor(e){this._disposables=new DisposableStore;let n=[];for(const[o,r]of e){const e=o.links.map((e=>new Link(e,r)));n=LinksList._union(n,e),isDisposable(o)&&this._disposables.add(o)}this.links=n}dispose(){this._disposables.dispose(),this.links.length=0}static _union(e,n){let o,r,i,t,s=[];for(o=0,i=0,r=e.length,t=n.length;o<r&&i<t;){const r=e[o],t=n[i];if(Range.areIntersectingOrTouching(r.range,t.range)){o++;continue}const l=Range.compareRangesUsingStarts(r.range,t.range);l<0?(s.push(r),o++):(s.push(t),i++)}for(;o<r;o++)s.push(e[o]);for(;i<t;i++)s.push(n[i]);return s}}export function getLinks(e,n){const o=[],r=LinkProviderRegistry.ordered(e).reverse().map(((r,i)=>Promise.resolve(r.provideLinks(e,n)).then((e=>{e&&(o[i]=[e,r])}),onUnexpectedExternalError)));return Promise.all(r).then((()=>{const e=new LinksList(coalesce(o));return n.isCancellationRequested?(e.dispose(),new LinksList([])):e}))}CommandsRegistry.registerCommand("_executeLinkProvider",((e,...n)=>__awaiter(void 0,void 0,void 0,(function*(){let[o,r]=n;assertType(o instanceof URI),"number"!==typeof r&&(r=0);const i=e.get(IModelService).getModel(o);if(!i)return[];const t=yield getLinks(i,CancellationToken.None);if(!t)return[];for(let e=0;e<Math.min(r,t.links.length);e++)yield t.links[e].resolve(CancellationToken.None);const s=t.links.slice(0);return t.dispose(),s}))));