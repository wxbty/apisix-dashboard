import*as dom from"../../../../base/browser/dom.js";import{Sash}from"../../../../base/browser/ui/sash/sash.js";import{Color,RGBA}from"../../../../base/common/color.js";import{IdGenerator}from"../../../../base/common/idGenerator.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import*as objects from"../../../../base/common/objects.js";import"./zoneWidget.css";import{Range}from"../../../common/core/range.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";const defaultColor=new Color(new RGBA(0,122,204)),defaultOptions={showArrow:!0,showFrame:!0,className:"",frameColor:defaultColor,arrowColor:defaultColor,keepEditorSelection:!1},WIDGET_ID="vs.editor.contrib.zoneWidget";export class ViewZoneDelegate{constructor(t,e,i,o,s,r){this.id="",this.domNode=t,this.afterLineNumber=e,this.afterColumn=i,this.heightInLines=o,this._onDomNodeTop=s,this._onComputedHeight=r}onDomNodeTop(t){this._onDomNodeTop(t)}onComputedHeight(t){this._onComputedHeight(t)}}export class OverlayWidgetDelegate{constructor(t,e){this._id=t,this._domNode=e}getId(){return this._id}getDomNode(){return this._domNode}getPosition(){return null}}class Arrow{constructor(t){this._editor=t,this._ruleName=Arrow._IdGenerator.nextId(),this._decorations=[],this._color=null,this._height=-1}dispose(){this.hide(),dom.removeCSSRulesContainingSelector(this._ruleName)}set color(t){this._color!==t&&(this._color=t,this._updateStyle())}set height(t){this._height!==t&&(this._height=t,this._updateStyle())}_updateStyle(){dom.removeCSSRulesContainingSelector(this._ruleName),dom.createCSSRule(`.monaco-editor ${this._ruleName}`,`border-style: solid; border-color: transparent; border-bottom-color: ${this._color}; border-width: ${this._height}px; bottom: -${this._height}px; margin-left: -${this._height}px; `)}show(t){1===t.column&&(t={lineNumber:t.lineNumber,column:2}),this._decorations=this._editor.deltaDecorations(this._decorations,[{range:Range.fromPositions(t),options:{description:"zone-widget-arrow",className:this._ruleName,stickiness:1}}])}hide(){this._editor.deltaDecorations(this._decorations,[])}}Arrow._IdGenerator=new IdGenerator(".arrow-decoration-");export class ZoneWidget{constructor(t,e={}){this._arrow=null,this._overlayWidget=null,this._resizeSash=null,this._positionMarkerId=[],this._viewZone=null,this._disposables=new DisposableStore,this.container=null,this._isShowing=!1,this.editor=t,this.options=objects.deepClone(e),objects.mixin(this.options,defaultOptions,!1),this.domNode=document.createElement("div"),this.options.isAccessible||(this.domNode.setAttribute("aria-hidden","true"),this.domNode.setAttribute("role","presentation")),this._disposables.add(this.editor.onDidLayoutChange((t=>{const e=this._getWidth(t);this.domNode.style.width=e+"px",this.domNode.style.left=this._getLeft(t)+"px",this._onWidth(e)})))}dispose(){this._overlayWidget&&(this.editor.removeOverlayWidget(this._overlayWidget),this._overlayWidget=null),this._viewZone&&this.editor.changeViewZones((t=>{this._viewZone&&t.removeZone(this._viewZone.id),this._viewZone=null})),this.editor.deltaDecorations(this._positionMarkerId,[]),this._positionMarkerId=[],this._disposables.dispose()}create(){this.domNode.classList.add("zone-widget"),this.options.className&&this.domNode.classList.add(this.options.className),this.container=document.createElement("div"),this.container.classList.add("zone-widget-container"),this.domNode.appendChild(this.container),this.options.showArrow&&(this._arrow=new Arrow(this.editor),this._disposables.add(this._arrow)),this._fillContainer(this.container),this._initSash(),this._applyStyles()}style(t){t.frameColor&&(this.options.frameColor=t.frameColor),t.arrowColor&&(this.options.arrowColor=t.arrowColor),this._applyStyles()}_applyStyles(){if(this.container&&this.options.frameColor){let t=this.options.frameColor.toString();this.container.style.borderTopColor=t,this.container.style.borderBottomColor=t}if(this._arrow&&this.options.arrowColor){let t=this.options.arrowColor.toString();this._arrow.color=t}}_getWidth(t){return t.width-t.minimap.minimapWidth-t.verticalScrollbarWidth}_getLeft(t){return t.minimap.minimapWidth>0&&0===t.minimap.minimapLeft?t.minimap.minimapWidth:0}_onViewZoneTop(t){this.domNode.style.top=t+"px"}_onViewZoneHeight(t){if(this.domNode.style.height=`${t}px`,this.container){let e=t-this._decoratingElementsHeight();this.container.style.height=`${e}px`;const i=this.editor.getLayoutInfo();this._doLayout(e,this._getWidth(i))}this._resizeSash&&this._resizeSash.layout()}get position(){const[t]=this._positionMarkerId;if(!t)return;const e=this.editor.getModel();if(!e)return;const i=e.getDecorationRange(t);return i?i.getStartPosition():void 0}show(t,e){const i=Range.isIRange(t)?Range.lift(t):Range.fromPositions(t);this._isShowing=!0,this._showImpl(i,e),this._isShowing=!1,this._positionMarkerId=this.editor.deltaDecorations(this._positionMarkerId,[{range:i,options:ModelDecorationOptions.EMPTY}])}hide(){this._viewZone&&(this.editor.changeViewZones((t=>{this._viewZone&&t.removeZone(this._viewZone.id)})),this._viewZone=null),this._overlayWidget&&(this.editor.removeOverlayWidget(this._overlayWidget),this._overlayWidget=null),this._arrow&&this._arrow.hide()}_decoratingElementsHeight(){let t=this.editor.getOption(59),e=0;if(this.options.showArrow){let i=Math.round(t/3);e+=2*i}if(this.options.showFrame){let i=Math.round(t/9);e+=2*i}return e}_showImpl(t,e){const i=t.getStartPosition(),o=this.editor.getLayoutInfo(),s=this._getWidth(o);this.domNode.style.width=`${s}px`,this.domNode.style.left=this._getLeft(o)+"px";const r=document.createElement("div");r.style.overflow="hidden";const n=this.editor.getOption(59),h=Math.max(12,this.editor.getLayoutInfo().height/n*.8);e=Math.min(e,h);let a=0,d=0;if(this._arrow&&this.options.showArrow&&(a=Math.round(n/3),this._arrow.height=a,this._arrow.show(i)),this.options.showFrame&&(d=Math.round(n/9)),this.editor.changeViewZones((t=>{this._viewZone&&t.removeZone(this._viewZone.id),this._overlayWidget&&(this.editor.removeOverlayWidget(this._overlayWidget),this._overlayWidget=null),this.domNode.style.top="-1000px",this._viewZone=new ViewZoneDelegate(r,i.lineNumber,i.column,e,(t=>this._onViewZoneTop(t)),(t=>this._onViewZoneHeight(t))),this._viewZone.id=t.addZone(this._viewZone),this._overlayWidget=new OverlayWidgetDelegate(WIDGET_ID+this._viewZone.id,this.domNode),this.editor.addOverlayWidget(this._overlayWidget)})),this.container&&this.options.showFrame){const t=this.options.frameWidth?this.options.frameWidth:d;this.container.style.borderTopWidth=t+"px",this.container.style.borderBottomWidth=t+"px"}let l=e*n-this._decoratingElementsHeight();this.container&&(this.container.style.top=a+"px",this.container.style.height=l+"px",this.container.style.overflow="hidden"),this._doLayout(l,s),this.options.keepEditorSelection||this.editor.setSelection(t);const m=this.editor.getModel();if(m){const e=t.endLineNumber+1;e<=m.getLineCount()?this.revealLine(e,!1):this.revealLine(m.getLineCount(),!0)}}revealLine(t,e){e?this.editor.revealLineInCenter(t,0):this.editor.revealLine(t,0)}setCssClass(t,e){this.container&&(e&&this.container.classList.remove(e),this.container.classList.add(t))}_onWidth(t){}_doLayout(t,e){}_relayout(t){this._viewZone&&this._viewZone.heightInLines!==t&&this.editor.changeViewZones((e=>{this._viewZone&&(this._viewZone.heightInLines=t,e.layoutZone(this._viewZone.id))}))}_initSash(){if(this._resizeSash)return;let t;this._resizeSash=this._disposables.add(new Sash(this.domNode,this,{orientation:1})),this.options.isResizeable||(this._resizeSash.state=0),this._disposables.add(this._resizeSash.onDidStart((e=>{this._viewZone&&(t={startY:e.startY,heightInLines:this._viewZone.heightInLines})}))),this._disposables.add(this._resizeSash.onDidEnd((()=>{t=void 0}))),this._disposables.add(this._resizeSash.onDidChange((e=>{if(t){let i=(e.currentY-t.startY)/this.editor.getOption(59),o=i<0?Math.ceil(i):Math.floor(i),s=t.heightInLines+o;s>5&&s<35&&this._relayout(s)}})))}getHorizontalSashLeft(){return 0}getHorizontalSashTop(){return(null===this.domNode.style.height?0:parseInt(this.domNode.style.height))-this._decoratingElementsHeight()/2}getHorizontalSashWidth(){const t=this.editor.getLayoutInfo();return t.width-t.minimap.minimapWidth}}