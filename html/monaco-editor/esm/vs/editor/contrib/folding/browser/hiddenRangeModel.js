import{findFirstInSorted}from"../../../../base/common/arrays.js";import{Emitter}from"../../../../base/common/event.js";import{Range}from"../../../common/core/range.js";import{countEOL}from"../../../common/core/eolCounter.js";export class HiddenRangeModel{constructor(e){this._updateEventEmitter=new Emitter,this._hasLineChanges=!1,this._foldingModel=e,this._foldingModelListener=e.onDidChange((e=>this.updateHiddenRanges())),this._hiddenRanges=[],e.regions.length&&this.updateHiddenRanges()}get onDidChange(){return this._updateEventEmitter.event}get hiddenRanges(){return this._hiddenRanges}notifyChangeModelContent(e){this._hiddenRanges.length&&!this._hasLineChanges&&(this._hasLineChanges=e.changes.some((e=>e.range.endLineNumber!==e.range.startLineNumber||0!==countEOL(e.text)[0])))}updateHiddenRanges(){let e=!1,n=[],t=0,i=0,s=Number.MAX_VALUE,d=-1,r=this._foldingModel.regions;for(;t<r.length;t++){if(!r.isCollapsed(t))continue;let a=r.getStartLineNumber(t)+1,h=r.getEndLineNumber(t);s<=a&&h<=d||(!e&&i<this._hiddenRanges.length&&this._hiddenRanges[i].startLineNumber===a&&this._hiddenRanges[i].endLineNumber===h?(n.push(this._hiddenRanges[i]),i++):(e=!0,n.push(new Range(a,1,h,1))),s=a,d=h)}(this._hasLineChanges||e||i<this._hiddenRanges.length)&&this.applyHiddenRanges(n)}applyMemento(e){if(!Array.isArray(e)||0===e.length)return!1;let n=[];for(let t of e){if(!t.startLineNumber||!t.endLineNumber)return!1;n.push(new Range(t.startLineNumber+1,1,t.endLineNumber,1))}return this.applyHiddenRanges(n),!0}getMemento(){return this._hiddenRanges.map((e=>({startLineNumber:e.startLineNumber-1,endLineNumber:e.endLineNumber})))}applyHiddenRanges(e){this._hiddenRanges=e,this._hasLineChanges=!1,this._updateEventEmitter.fire(e)}hasRanges(){return this._hiddenRanges.length>0}isHidden(e){return null!==findRange(this._hiddenRanges,e)}adjustSelections(e){let n=!1,t=this._foldingModel.textModel,i=null,s=e=>(i&&isInside(e,i)||(i=findRange(this._hiddenRanges,e)),i?i.startLineNumber-1:null);for(let d=0,r=e.length;d<r;d++){let i=e[d],r=s(i.startLineNumber);r&&(i=i.setStartPosition(r,t.getLineMaxColumn(r)),n=!0);let a=s(i.endLineNumber);a&&(i=i.setEndPosition(a,t.getLineMaxColumn(a)),n=!0),e[d]=i}return n}dispose(){this.hiddenRanges.length>0&&(this._hiddenRanges=[],this._updateEventEmitter.fire(this._hiddenRanges)),this._foldingModelListener&&(this._foldingModelListener.dispose(),this._foldingModelListener=null)}}function isInside(e,n){return e>=n.startLineNumber&&e<=n.endLineNumber}function findRange(e,n){let t=findFirstInSorted(e,(e=>n<e.startLineNumber))-1;return t>=0&&e[t].endLineNumber>=n?e[t]:null}