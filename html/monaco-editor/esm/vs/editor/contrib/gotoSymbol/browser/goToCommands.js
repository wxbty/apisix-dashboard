var _a,_b,_c,_d,_e,_f,_g,_h,__awaiter=this&&this.__awaiter||function(e,o,t,n){function i(e){return e instanceof t?e:new t((function(o){o(e)}))}return new(t||(t=Promise))((function(t,r){function s(e){try{l(n.next(e))}catch(o){r(o)}}function a(e){try{l(n["throw"](e))}catch(o){r(o)}}function l(e){e.done?t(e.value):i(e.value).then(s,a)}l((n=n.apply(e,o||[])).next())}))};import{isStandalone}from"../../../../base/browser/browser.js";import{alert}from"../../../../base/browser/ui/aria/aria.js";import{createCancelablePromise,raceCancellation}from"../../../../base/common/async.js";import{KeyChord}from"../../../../base/common/keyCodes.js";import{isWeb}from"../../../../base/common/platform.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{EditorStateCancellationTokenSource}from"../../editorState/browser/editorState.js";import{isCodeEditor}from"../../../browser/editorBrowser.js";import{EditorAction,registerInstantiatedEditorAction}from"../../../browser/editorExtensions.js";import{ICodeEditorService}from"../../../browser/services/codeEditorService.js";import{EmbeddedCodeEditorWidget}from"../../../browser/widget/embeddedCodeEditorWidget.js";import*as corePosition from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{isLocationLink}from"../../../common/languages.js";import{ReferencesController}from"./peek/referencesController.js";import{ReferencesModel}from"./referencesModel.js";import{ISymbolNavigationService}from"./symbolNavigation.js";import{MessageController}from"../../message/browser/messageController.js";import{PeekContext}from"../../peekView/browser/peekView.js";import*as nls from"../../../../nls.js";import{MenuId,MenuRegistry}from"../../../../platform/actions/common/actions.js";import{CommandsRegistry,ICommandService}from"../../../../platform/commands/common/commands.js";import{ContextKeyExpr}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{INotificationService}from"../../../../platform/notification/common/notification.js";import{IEditorProgressService}from"../../../../platform/progress/common/progress.js";import{getDeclarationsAtPosition,getDefinitionsAtPosition,getImplementationsAtPosition,getReferencesAtPosition,getTypeDefinitionsAtPosition}from"./goToSymbol.js";MenuRegistry.appendMenuItem(MenuId.EditorContext,{submenu:MenuId.EditorContextPeek,title:nls.localize("peek.submenu","Peek"),group:"navigation",order:100});const _goToActionIds=new Set;function registerGoToAction(e){const o=new e;return registerInstantiatedEditorAction(o),_goToActionIds.add(o.id),o}export class SymbolNavigationAnchor{constructor(e,o){this.model=e,this.position=o}static is(e){return!(!e||"object"!==typeof e)&&(e instanceof SymbolNavigationAnchor||!(!corePosition.Position.isIPosition(e.position)||!e.model))}}export class SymbolNavigationAction extends EditorAction{constructor(e,o){super(o),this.configuration=e}run(e,o,t){if(!o.hasModel())return Promise.resolve(void 0);const n=e.get(INotificationService),i=e.get(ICodeEditorService),r=e.get(IEditorProgressService),s=e.get(ISymbolNavigationService),a=o.getModel(),l=o.getPosition(),c=SymbolNavigationAnchor.is(t)?t:new SymbolNavigationAnchor(a,l),d=new EditorStateCancellationTokenSource(o,5),m=raceCancellation(this._getLocationModel(c.model,c.position,d.token),d.token).then((e=>__awaiter(this,void 0,void 0,(function*(){var t;if(!e||d.token.isCancellationRequested)return;let n;if(alert(e.ariaMessage),e.referenceAt(a.uri,l)){const e=this._getAlternativeCommand(o);e!==this.id&&_goToActionIds.has(e)&&(n=o.getAction(e))}const r=e.references.length;if(0===r){if(!this.configuration.muteMessage){const e=a.getWordAtPosition(l);null===(t=MessageController.get(o))||void 0===t||t.showMessage(this._getNoResultFoundMessage(e),l)}}else{if(1!==r||!n)return this._onResult(i,s,o,e);n.run()}}))),(e=>{n.error(e)})).finally((()=>{d.dispose()}));return r.showWhile(m,250),m}_onResult(e,o,t,n){return __awaiter(this,void 0,void 0,(function*(){const i=this._getGoToPreference(t);if(t instanceof EmbeddedCodeEditorWidget||!(this.configuration.openInPeek||"peek"===i&&n.references.length>1)){const r=n.firstReference(),s=n.references.length>1&&"gotoAndPeek"===i,a=yield this._openReference(t,e,r,this.configuration.openToSide,!s);s&&a?this._openInPeek(a,n):n.dispose(),"goto"===i&&o.put(r)}else this._openInPeek(t,n)}))}_openReference(e,o,t,n,i){return __awaiter(this,void 0,void 0,(function*(){let r;if(isLocationLink(t)&&(r=t.targetSelectionRange),r||(r=t.range),!r)return;const s=yield o.openCodeEditor({resource:t.uri,options:{selection:Range.collapseToStart(r),selectionRevealType:3}},e,n);if(s){if(i){const e=s.getModel(),o=s.deltaDecorations([],[{range:r,options:{description:"symbol-navigate-action-highlight",className:"symbolHighlight"}}]);setTimeout((()=>{s.getModel()===e&&s.deltaDecorations(o,[])}),350)}return s}}))}_openInPeek(e,o){const t=ReferencesController.get(e);t&&e.hasModel()?t.toggleWidget(e.getSelection(),createCancelablePromise((e=>Promise.resolve(o))),this.configuration.openInPeek):o.dispose()}}export class DefinitionAction extends SymbolNavigationAction{_getLocationModel(e,o,t){return __awaiter(this,void 0,void 0,(function*(){return new ReferencesModel(yield getDefinitionsAtPosition(e,o,t),nls.localize("def.title","Definitions"))}))}_getNoResultFoundMessage(e){return e&&e.word?nls.localize("noResultWord","No definition found for '{0}'",e.word):nls.localize("generic.noResults","No definition found")}_getAlternativeCommand(e){return e.getOption(51).alternativeDefinitionCommand}_getGoToPreference(e){return e.getOption(51).multipleDefinitions}}const goToDefinitionKb=isWeb&&!isStandalone?2118:70;registerGoToAction((_a=class e extends DefinitionAction{constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:e.id,label:nls.localize("actions.goToDecl.label","Go to Definition"),alias:"Go to Definition",precondition:ContextKeyExpr.and(EditorContextKeys.hasDefinitionProvider,EditorContextKeys.isInWalkThroughSnippet.toNegated()),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:goToDefinitionKb,weight:100},contextMenuOpts:{group:"navigation",order:1.1}}),CommandsRegistry.registerCommandAlias("editor.action.goToDeclaration",e.id)}},_a.id="editor.action.revealDefinition",_a)),registerGoToAction((_b=class e extends DefinitionAction{constructor(){super({openToSide:!0,openInPeek:!1,muteMessage:!1},{id:e.id,label:nls.localize("actions.goToDeclToSide.label","Open Definition to the Side"),alias:"Open Definition to the Side",precondition:ContextKeyExpr.and(EditorContextKeys.hasDefinitionProvider,EditorContextKeys.isInWalkThroughSnippet.toNegated()),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:KeyChord(2089,goToDefinitionKb),weight:100}}),CommandsRegistry.registerCommandAlias("editor.action.openDeclarationToTheSide",e.id)}},_b.id="editor.action.revealDefinitionAside",_b)),registerGoToAction((_c=class e extends DefinitionAction{constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:e.id,label:nls.localize("actions.previewDecl.label","Peek Definition"),alias:"Peek Definition",precondition:ContextKeyExpr.and(EditorContextKeys.hasDefinitionProvider,PeekContext.notInPeekEditor,EditorContextKeys.isInWalkThroughSnippet.toNegated()),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:582,linux:{primary:3140},weight:100},contextMenuOpts:{menuId:MenuId.EditorContextPeek,group:"peek",order:2}}),CommandsRegistry.registerCommandAlias("editor.action.previewDeclaration",e.id)}},_c.id="editor.action.peekDefinition",_c));class DeclarationAction extends SymbolNavigationAction{_getLocationModel(e,o,t){return __awaiter(this,void 0,void 0,(function*(){return new ReferencesModel(yield getDeclarationsAtPosition(e,o,t),nls.localize("decl.title","Declarations"))}))}_getNoResultFoundMessage(e){return e&&e.word?nls.localize("decl.noResultWord","No declaration found for '{0}'",e.word):nls.localize("decl.generic.noResults","No declaration found")}_getAlternativeCommand(e){return e.getOption(51).alternativeDeclarationCommand}_getGoToPreference(e){return e.getOption(51).multipleDeclarations}}registerGoToAction((_d=class e extends DeclarationAction{constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:e.id,label:nls.localize("actions.goToDeclaration.label","Go to Declaration"),alias:"Go to Declaration",precondition:ContextKeyExpr.and(EditorContextKeys.hasDeclarationProvider,EditorContextKeys.isInWalkThroughSnippet.toNegated()),contextMenuOpts:{group:"navigation",order:1.3}})}_getNoResultFoundMessage(e){return e&&e.word?nls.localize("decl.noResultWord","No declaration found for '{0}'",e.word):nls.localize("decl.generic.noResults","No declaration found")}},_d.id="editor.action.revealDeclaration",_d)),registerGoToAction(class extends DeclarationAction{constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:"editor.action.peekDeclaration",label:nls.localize("actions.peekDecl.label","Peek Declaration"),alias:"Peek Declaration",precondition:ContextKeyExpr.and(EditorContextKeys.hasDeclarationProvider,PeekContext.notInPeekEditor,EditorContextKeys.isInWalkThroughSnippet.toNegated()),contextMenuOpts:{menuId:MenuId.EditorContextPeek,group:"peek",order:3}})}});class TypeDefinitionAction extends SymbolNavigationAction{_getLocationModel(e,o,t){return __awaiter(this,void 0,void 0,(function*(){return new ReferencesModel(yield getTypeDefinitionsAtPosition(e,o,t),nls.localize("typedef.title","Type Definitions"))}))}_getNoResultFoundMessage(e){return e&&e.word?nls.localize("goToTypeDefinition.noResultWord","No type definition found for '{0}'",e.word):nls.localize("goToTypeDefinition.generic.noResults","No type definition found")}_getAlternativeCommand(e){return e.getOption(51).alternativeTypeDefinitionCommand}_getGoToPreference(e){return e.getOption(51).multipleTypeDefinitions}}registerGoToAction((_e=class e extends TypeDefinitionAction{constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:e.ID,label:nls.localize("actions.goToTypeDefinition.label","Go to Type Definition"),alias:"Go to Type Definition",precondition:ContextKeyExpr.and(EditorContextKeys.hasTypeDefinitionProvider,EditorContextKeys.isInWalkThroughSnippet.toNegated()),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:0,weight:100},contextMenuOpts:{group:"navigation",order:1.4}})}},_e.ID="editor.action.goToTypeDefinition",_e)),registerGoToAction((_f=class e extends TypeDefinitionAction{constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:e.ID,label:nls.localize("actions.peekTypeDefinition.label","Peek Type Definition"),alias:"Peek Type Definition",precondition:ContextKeyExpr.and(EditorContextKeys.hasTypeDefinitionProvider,PeekContext.notInPeekEditor,EditorContextKeys.isInWalkThroughSnippet.toNegated()),contextMenuOpts:{menuId:MenuId.EditorContextPeek,group:"peek",order:4}})}},_f.ID="editor.action.peekTypeDefinition",_f));class ImplementationAction extends SymbolNavigationAction{_getLocationModel(e,o,t){return __awaiter(this,void 0,void 0,(function*(){return new ReferencesModel(yield getImplementationsAtPosition(e,o,t),nls.localize("impl.title","Implementations"))}))}_getNoResultFoundMessage(e){return e&&e.word?nls.localize("goToImplementation.noResultWord","No implementation found for '{0}'",e.word):nls.localize("goToImplementation.generic.noResults","No implementation found")}_getAlternativeCommand(e){return e.getOption(51).alternativeImplementationCommand}_getGoToPreference(e){return e.getOption(51).multipleImplementations}}registerGoToAction((_g=class e extends ImplementationAction{constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:e.ID,label:nls.localize("actions.goToImplementation.label","Go to Implementations"),alias:"Go to Implementations",precondition:ContextKeyExpr.and(EditorContextKeys.hasImplementationProvider,EditorContextKeys.isInWalkThroughSnippet.toNegated()),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:2118,weight:100},contextMenuOpts:{group:"navigation",order:1.45}})}},_g.ID="editor.action.goToImplementation",_g)),registerGoToAction((_h=class e extends ImplementationAction{constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:e.ID,label:nls.localize("actions.peekImplementation.label","Peek Implementations"),alias:"Peek Implementations",precondition:ContextKeyExpr.and(EditorContextKeys.hasImplementationProvider,PeekContext.notInPeekEditor,EditorContextKeys.isInWalkThroughSnippet.toNegated()),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:3142,weight:100},contextMenuOpts:{menuId:MenuId.EditorContextPeek,group:"peek",order:5}})}},_h.ID="editor.action.peekImplementation",_h));class ReferencesAction extends SymbolNavigationAction{_getNoResultFoundMessage(e){return e?nls.localize("references.no","No references found for '{0}'",e.word):nls.localize("references.noGeneric","No references found")}_getAlternativeCommand(e){return e.getOption(51).alternativeReferenceCommand}_getGoToPreference(e){return e.getOption(51).multipleReferences}}registerGoToAction(class extends ReferencesAction{constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:"editor.action.goToReferences",label:nls.localize("goToReferences.label","Go to References"),alias:"Go to References",precondition:ContextKeyExpr.and(EditorContextKeys.hasReferenceProvider,PeekContext.notInPeekEditor,EditorContextKeys.isInWalkThroughSnippet.toNegated()),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:1094,weight:100},contextMenuOpts:{group:"navigation",order:1.45}})}_getLocationModel(e,o,t){return __awaiter(this,void 0,void 0,(function*(){return new ReferencesModel(yield getReferencesAtPosition(e,o,!0,t),nls.localize("ref.title","References"))}))}}),registerGoToAction(class extends ReferencesAction{constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:"editor.action.referenceSearch.trigger",label:nls.localize("references.action.label","Peek References"),alias:"Peek References",precondition:ContextKeyExpr.and(EditorContextKeys.hasReferenceProvider,PeekContext.notInPeekEditor,EditorContextKeys.isInWalkThroughSnippet.toNegated()),contextMenuOpts:{menuId:MenuId.EditorContextPeek,group:"peek",order:6}})}_getLocationModel(e,o,t){return __awaiter(this,void 0,void 0,(function*(){return new ReferencesModel(yield getReferencesAtPosition(e,o,!1,t),nls.localize("ref.title","References"))}))}});class GenericGoToLocationAction extends SymbolNavigationAction{constructor(e,o,t){super(e,{id:"editor.action.goToLocation",label:nls.localize("label.generic","Go to Any Symbol"),alias:"Go to Any Symbol",precondition:ContextKeyExpr.and(PeekContext.notInPeekEditor,EditorContextKeys.isInWalkThroughSnippet.toNegated())}),this._references=o,this._gotoMultipleBehaviour=t}_getLocationModel(e,o,t){return __awaiter(this,void 0,void 0,(function*(){return new ReferencesModel(this._references,nls.localize("generic.title","Locations"))}))}_getNoResultFoundMessage(e){return e&&nls.localize("generic.noResult","No results for '{0}'",e.word)||""}_getGoToPreference(e){var o;return null!==(o=this._gotoMultipleBehaviour)&&void 0!==o?o:e.getOption(51).multipleReferences}_getAlternativeCommand(){return""}}CommandsRegistry.registerCommand({id:"editor.action.goToLocations",description:{description:"Go to locations from a position in a file",args:[{name:"uri",description:"The text document in which to start",constraint:URI},{name:"position",description:"The position at which to start",constraint:corePosition.Position.isIPosition},{name:"locations",description:"An array of locations.",constraint:Array},{name:"multiple",description:"Define what to do when having multiple results, either `peek`, `gotoAndPeek`, or `goto"},{name:"noResultsMessage",description:"Human readable message that shows when locations is empty."}]},handler:(e,o,t,n,i,r,s)=>__awaiter(void 0,void 0,void 0,(function*(){assertType(URI.isUri(o)),assertType(corePosition.Position.isIPosition(t)),assertType(Array.isArray(n)),assertType("undefined"===typeof i||"string"===typeof i),assertType("undefined"===typeof s||"boolean"===typeof s);const a=e.get(ICodeEditorService),l=yield a.openCodeEditor({resource:o},a.getFocusedCodeEditor());if(isCodeEditor(l))return l.setPosition(t),l.revealPositionInCenterIfOutsideViewport(t,0),l.invokeWithinContext((e=>{const o=new class extends GenericGoToLocationAction{_getNoResultFoundMessage(e){return r||super._getNoResultFoundMessage(e)}}({muteMessage:!Boolean(r),openInPeek:Boolean(s),openToSide:!1},n,i);e.get(IInstantiationService).invokeFunction(o.run.bind(o),l)}))}))}),CommandsRegistry.registerCommand({id:"editor.action.peekLocations",description:{description:"Peek locations from a position in a file",args:[{name:"uri",description:"The text document in which to start",constraint:URI},{name:"position",description:"The position at which to start",constraint:corePosition.Position.isIPosition},{name:"locations",description:"An array of locations.",constraint:Array},{name:"multiple",description:"Define what to do when having multiple results, either `peek`, `gotoAndPeek`, or `goto"}]},handler:(e,o,t,n,i)=>__awaiter(void 0,void 0,void 0,(function*(){e.get(ICommandService).executeCommand("editor.action.goToLocations",o,t,n,i,void 0,!0)}))}),CommandsRegistry.registerCommand({id:"editor.action.findReferences",handler:(e,o,t)=>{assertType(URI.isUri(o)),assertType(corePosition.Position.isIPosition(t));const n=e.get(ICodeEditorService);return n.openCodeEditor({resource:o},n.getFocusedCodeEditor()).then((e=>{if(!isCodeEditor(e)||!e.hasModel())return;const o=ReferencesController.get(e);if(!o)return;const n=createCancelablePromise((o=>getReferencesAtPosition(e.getModel(),corePosition.Position.lift(t),!1,o).then((e=>new ReferencesModel(e,nls.localize("ref.title","References")))))),i=new Range(t.lineNumber,t.column,t.lineNumber,t.column);return Promise.resolve(o.toggleWidget(i,n,!1))}))}}),CommandsRegistry.registerCommandAlias("editor.action.showReferences","editor.action.peekLocations"),MenuRegistry.appendMenuItems([{id:MenuId.MenubarGoMenu,item:{command:{id:"editor.action.revealDefinition",title:nls.localize({key:"miGotoDefinition",comment:["&& denotes a mnemonic"]},"Go to &&Definition")},group:"4_symbol_nav",order:2}},{id:MenuId.MenubarGoMenu,item:{command:{id:"editor.action.revealDeclaration",title:nls.localize({key:"miGotoDeclaration",comment:["&& denotes a mnemonic"]},"Go to &&Declaration")},group:"4_symbol_nav",order:3}},{id:MenuId.MenubarGoMenu,item:{command:{id:"editor.action.goToTypeDefinition",title:nls.localize({key:"miGotoTypeDefinition",comment:["&& denotes a mnemonic"]},"Go to &&Type Definition")},group:"4_symbol_nav",order:3}},{id:MenuId.MenubarGoMenu,item:{command:{id:"editor.action.goToImplementation",title:nls.localize({key:"miGotoImplementation",comment:["&& denotes a mnemonic"]},"Go to &&Implementations")},group:"4_symbol_nav",order:4}},{id:MenuId.MenubarGoMenu,item:{command:{id:"editor.action.goToReferences",title:nls.localize({key:"miGotoReference",comment:["&& denotes a mnemonic"]},"Go to &&References")},group:"4_symbol_nav",order:5}}]);