var __awaiter=this&&this.__awaiter||function(e,n,o,i){function t(e){return e instanceof o?e:new o((function(n){n(e)}))}return new(o||(o=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(n){r(n)}}function d(e){try{a(i["throw"](e))}catch(n){r(n)}}function a(e){e.done?o(e.value):t(e.value).then(s,d)}a((i=i.apply(e,n||[])).next())}))};import{CancellationToken}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError}from"../../../../base/common/errors.js";import{registerModelAndPositionCommand}from"../../../browser/editorExtensions.js";import{DeclarationProviderRegistry,DefinitionProviderRegistry,ImplementationProviderRegistry,ReferenceProviderRegistry,TypeDefinitionProviderRegistry}from"../../../common/languages.js";import{ReferencesModel}from"./referencesModel.js";function getLocationLinks(e,n,o,i){const t=o.ordered(e),r=t.map((o=>Promise.resolve(i(o,e,n)).then(void 0,(e=>{onUnexpectedExternalError(e)}))));return Promise.all(r).then((e=>{const n=[];for(let o of e)Array.isArray(o)?n.push(...o):o&&n.push(o);return n}))}export function getDefinitionsAtPosition(e,n,o){return getLocationLinks(e,n,DefinitionProviderRegistry,((e,n,i)=>e.provideDefinition(n,i,o)))}export function getDeclarationsAtPosition(e,n,o){return getLocationLinks(e,n,DeclarationProviderRegistry,((e,n,i)=>e.provideDeclaration(n,i,o)))}export function getImplementationsAtPosition(e,n,o){return getLocationLinks(e,n,ImplementationProviderRegistry,((e,n,i)=>e.provideImplementation(n,i,o)))}export function getTypeDefinitionsAtPosition(e,n,o){return getLocationLinks(e,n,TypeDefinitionProviderRegistry,((e,n,i)=>e.provideTypeDefinition(n,i,o)))}export function getReferencesAtPosition(e,n,o,i){return getLocationLinks(e,n,ReferenceProviderRegistry,((e,n,t)=>__awaiter(this,void 0,void 0,(function*(){const r=yield e.provideReferences(n,t,{includeDeclaration:!0},i);if(!o||!r||2!==r.length)return r;const s=yield e.provideReferences(n,t,{includeDeclaration:!1},i);return s&&1===s.length?s:r}))))}function _sortedAndDeduped(e){return __awaiter(this,void 0,void 0,(function*(){const n=yield e(),o=new ReferencesModel(n,""),i=o.references.map((e=>e.link));return o.dispose(),i}))}registerModelAndPositionCommand("_executeDefinitionProvider",((e,n)=>_sortedAndDeduped((()=>getDefinitionsAtPosition(e,n,CancellationToken.None))))),registerModelAndPositionCommand("_executeDeclarationProvider",((e,n)=>_sortedAndDeduped((()=>getDeclarationsAtPosition(e,n,CancellationToken.None))))),registerModelAndPositionCommand("_executeImplementationProvider",((e,n)=>_sortedAndDeduped((()=>getImplementationsAtPosition(e,n,CancellationToken.None))))),registerModelAndPositionCommand("_executeTypeDefinitionProvider",((e,n)=>_sortedAndDeduped((()=>getTypeDefinitionsAtPosition(e,n,CancellationToken.None))))),registerModelAndPositionCommand("_executeReferenceProvider",((e,n)=>_sortedAndDeduped((()=>getReferencesAtPosition(e,n,!1,CancellationToken.None)))));