var __awaiter=this&&this.__awaiter||function(e,r,t,n){function i(e){return e instanceof t?e:new t((function(r){r(e)}))}return new(t||(t=Promise))((function(t,s){function o(e){try{l(n.next(e))}catch(r){s(r)}}function a(e){try{l(n["throw"](e))}catch(r){s(r)}}function l(e){e.done?t(e.value):i(e.value).then(o,a)}l((n=n.apply(e,r||[])).next())}))};import{onUnexpectedError}from"../../../../base/common/errors.js";import{Emitter}from"../../../../base/common/event.js";import{defaultGenerator}from"../../../../base/common/idGenerator.js";import{dispose}from"../../../../base/common/lifecycle.js";import{ResourceMap}from"../../../../base/common/map.js";import{basename,extUri}from"../../../../base/common/resources.js";import*as strings from"../../../../base/common/strings.js";import{Range}from"../../../common/core/range.js";import{localize}from"../../../../nls.js";export class OneReference{constructor(e,r,t,n){this.isProviderFirst=e,this.parent=r,this.link=t,this._rangeCallback=n,this.id=defaultGenerator.nextId()}get uri(){return this.link.uri}get range(){var e,r;return null!==(r=null!==(e=this._range)&&void 0!==e?e:this.link.targetSelectionRange)&&void 0!==r?r:this.link.range}set range(e){this._range=e,this._rangeCallback(this)}get ariaMessage(){var e;const r=null===(e=this.parent.getPreview(this))||void 0===e?void 0:e.preview(this.range);return r?localize({key:"aria.oneReference.preview",comment:["Placeholders are: 0: filename, 1:line number, 2: column number, 3: preview snippet of source code"]},"symbol in {0} on line {1} at column {2}, {3}",basename(this.uri),this.range.startLineNumber,this.range.startColumn,r.value):localize("aria.oneReference","symbol in {0} on line {1} at column {2}",basename(this.uri),this.range.startLineNumber,this.range.startColumn)}}export class FilePreview{constructor(e){this._modelReference=e}dispose(){this._modelReference.dispose()}preview(e,r=8){const t=this._modelReference.object.textEditorModel;if(!t)return;const{startLineNumber:n,startColumn:i,endLineNumber:s,endColumn:o}=e,a=t.getWordUntilPosition({lineNumber:n,column:i-r}),l=new Range(n,a.startColumn,n,i),c=new Range(s,o,s,1073741824),h=t.getValueInRange(l).replace(/^\s+/,""),u=t.getValueInRange(e),f=t.getValueInRange(c).replace(/\s+$/,"");return{value:h+u+f,highlight:{start:h.length,end:h.length+u.length}}}}export class FileReferences{constructor(e,r){this.parent=e,this.uri=r,this.children=[],this._previews=new ResourceMap}dispose(){dispose(this._previews.values()),this._previews.clear()}getPreview(e){return this._previews.get(e.uri)}get ariaMessage(){const e=this.children.length;return 1===e?localize("aria.fileReferences.1","1 symbol in {0}, full path {1}",basename(this.uri),this.uri.fsPath):localize("aria.fileReferences.N","{0} symbols in {1}, full path {2}",e,basename(this.uri),this.uri.fsPath)}resolve(e){return __awaiter(this,void 0,void 0,(function*(){if(0!==this._previews.size)return this;for(let t of this.children)if(!this._previews.has(t.uri))try{const r=yield e.createModelReference(t.uri);this._previews.set(t.uri,new FilePreview(r))}catch(r){onUnexpectedError(r)}return this}))}}export class ReferencesModel{constructor(e,r){this.groups=[],this.references=[],this._onDidChangeReferenceRange=new Emitter,this.onDidChangeReferenceRange=this._onDidChangeReferenceRange.event,this._links=e,this._title=r;const[t]=e;let n;e.sort(ReferencesModel._compareReferences);for(let i of e)if(n&&extUri.isEqual(n.uri,i.uri,!0)||(n=new FileReferences(this,i.uri),this.groups.push(n)),0===n.children.length||0!==ReferencesModel._compareReferences(i,n.children[n.children.length-1])){const e=new OneReference(t===i,n,i,(e=>this._onDidChangeReferenceRange.fire(e)));this.references.push(e),n.children.push(e)}}dispose(){dispose(this.groups),this._onDidChangeReferenceRange.dispose(),this.groups.length=0}clone(){return new ReferencesModel(this._links,this._title)}get title(){return this._title}get isEmpty(){return 0===this.groups.length}get ariaMessage(){return this.isEmpty?localize("aria.result.0","No results found"):1===this.references.length?localize("aria.result.1","Found 1 symbol in {0}",this.references[0].uri.fsPath):1===this.groups.length?localize("aria.result.n1","Found {0} symbols in {1}",this.references.length,this.groups[0].uri.fsPath):localize("aria.result.nm","Found {0} symbols in {1} files",this.references.length,this.groups.length)}nextOrPreviousReference(e,r){let{parent:t}=e,n=t.children.indexOf(e),i=t.children.length,s=t.parent.groups.length;return 1===s||r&&n+1<i||!r&&n>0?(n=r?(n+1)%i:(n+i-1)%i,t.children[n]):(n=t.parent.groups.indexOf(t),r?(n=(n+1)%s,t.parent.groups[n].children[0]):(n=(n+s-1)%s,t.parent.groups[n].children[t.parent.groups[n].children.length-1]))}nearestReference(e,r){const t=this.references.map(((t,n)=>({idx:n,prefixLen:strings.commonPrefixLength(t.uri.toString(),e.toString()),offsetDist:100*Math.abs(t.range.startLineNumber-r.lineNumber)+Math.abs(t.range.startColumn-r.column)}))).sort(((e,r)=>e.prefixLen>r.prefixLen?-1:e.prefixLen<r.prefixLen?1:e.offsetDist<r.offsetDist?-1:e.offsetDist>r.offsetDist?1:0))[0];if(t)return this.references[t.idx]}referenceAt(e,r){for(const t of this.references)if(t.uri.toString()===e.toString()&&Range.containsPosition(t.range,r))return t}firstReference(){for(const e of this.references)if(e.isProviderFirst)return e;return this.references[0]}static _compareReferences(e,r){return extUri.compare(e.uri,r.uri)||Range.compareRangesUsingStarts(e.range,r.range)}}