var __decorate=this&&this.__decorate||function(e,t,i,o){var r,n=arguments.length,s=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,i,o);else for(var c=e.length-1;c>=0;c--)(r=e[c])&&(s=(n<3?r(s):n>3?r(t,i,s):r(t,i))||s);return n>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}},__awaiter=this&&this.__awaiter||function(e,t,i,o){function r(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,n){function s(e){try{d(o.next(e))}catch(t){n(t)}}function c(e){try{d(o["throw"](e))}catch(t){n(t)}}function d(e){e.done?i(e.value):r(e.value).then(s,c)}d((o=o.apply(e,t||[])).next())}))};import{createCancelablePromise}from"../../../../../base/common/async.js";import{onUnexpectedError}from"../../../../../base/common/errors.js";import{KeyChord}from"../../../../../base/common/keyCodes.js";import{DisposableStore}from"../../../../../base/common/lifecycle.js";import{ICodeEditorService}from"../../../../browser/services/codeEditorService.js";import{Position}from"../../../../common/core/position.js";import{Range}from"../../../../common/core/range.js";import{getOuterEditor,PeekContext}from"../../../peekView/browser/peekView.js";import*as nls from"../../../../../nls.js";import{CommandsRegistry}from"../../../../../platform/commands/common/commands.js";import{IConfigurationService}from"../../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr,IContextKeyService,RawContextKey}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../../platform/instantiation/common/instantiation.js";import{KeybindingsRegistry}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{IListService,WorkbenchListFocusContextKey,WorkbenchTreeElementCanCollapse,WorkbenchTreeElementCanExpand}from"../../../../../platform/list/browser/listService.js";import{INotificationService}from"../../../../../platform/notification/common/notification.js";import{IStorageService}from"../../../../../platform/storage/common/storage.js";import{OneReference}from"../referencesModel.js";import{LayoutData,ReferenceWidget}from"./referencesWidget.js";export const ctxReferenceSearchVisible=new RawContextKey("referenceSearchVisible",!1,nls.localize("referenceSearchVisible","Whether reference peek is visible, like 'Peek References' or 'Peek Definition'"));let ReferencesController=class e{constructor(e,t,i,o,r,n,s,c){this._defaultTreeKeyboardSupport=e,this._editor=t,this._editorService=o,this._notificationService=r,this._instantiationService=n,this._storageService=s,this._configurationService=c,this._disposables=new DisposableStore,this._requestIdPool=0,this._ignoreModelChangeEvent=!1,this._referenceSearchVisible=ctxReferenceSearchVisible.bindTo(i)}static get(t){return t.getContribution(e.ID)}dispose(){var e,t;this._referenceSearchVisible.reset(),this._disposables.dispose(),null===(e=this._widget)||void 0===e||e.dispose(),null===(t=this._model)||void 0===t||t.dispose(),this._widget=void 0,this._model=void 0}toggleWidget(e,t,i){let o;if(this._widget&&(o=this._widget.position),this.closeWidget(),o&&e.containsPosition(o))return;this._peekMode=i,this._referenceSearchVisible.set(!0),this._disposables.add(this._editor.onDidChangeModelLanguage((()=>{this.closeWidget()}))),this._disposables.add(this._editor.onDidChangeModel((()=>{this._ignoreModelChangeEvent||this.closeWidget()})));const r="peekViewLayout",n=LayoutData.fromJSON(this._storageService.get(r,0,"{}"));this._widget=this._instantiationService.createInstance(ReferenceWidget,this._editor,this._defaultTreeKeyboardSupport,n),this._widget.setTitle(nls.localize("labelLoading","Loading...")),this._widget.show(e),this._disposables.add(this._widget.onDidClose((()=>{t.cancel(),this._widget&&(this._storageService.store(r,JSON.stringify(this._widget.layoutData),0,1),this._widget=void 0),this.closeWidget()}))),this._disposables.add(this._widget.onDidSelectReference((e=>{let{element:t,kind:o}=e;if(t)switch(o){case"open":"editor"===e.source&&this._configurationService.getValue("editor.stablePeek")||this.openReference(t,!1,!1);break;case"side":this.openReference(t,!0,!1);break;case"goto":i?this._gotoReference(t):this.openReference(t,!1,!0);break}})));const s=++this._requestIdPool;t.then((t=>{var i;if(s===this._requestIdPool&&this._widget)return null===(i=this._model)||void 0===i||i.dispose(),this._model=t,this._widget.setModel(this._model).then((()=>{if(this._widget&&this._model&&this._editor.hasModel()){this._model.isEmpty?this._widget.setMetaTitle(""):this._widget.setMetaTitle(nls.localize("metaTitle.N","{0} ({1})",this._model.title,this._model.references.length));let t=this._editor.getModel().uri,i=new Position(e.startLineNumber,e.startColumn),o=this._model.nearestReference(t,i);if(o)return this._widget.setSelection(o).then((()=>{this._widget&&"editor"===this._editor.getOption(77)&&this._widget.focusOnPreviewEditor()}))}}));t.dispose()}),(e=>{this._notificationService.error(e)}))}changeFocusBetweenPreviewAndReferences(){this._widget&&(this._widget.isPreviewEditorFocused()?this._widget.focusOnReferenceTree():this._widget.focusOnPreviewEditor())}goToNextOrPreviousReference(e){return __awaiter(this,void 0,void 0,(function*(){if(!this._editor.hasModel()||!this._model||!this._widget)return;const t=this._widget.position;if(!t)return;const i=this._model.nearestReference(this._editor.getModel().uri,t);if(!i)return;const o=this._model.nextOrPreviousReference(i,e),r=this._editor.hasTextFocus(),n=this._widget.isPreviewEditorFocused();yield this._widget.setSelection(o),yield this._gotoReference(o),r?this._editor.focus():this._widget&&n&&this._widget.focusOnPreviewEditor()}))}revealReference(e){return __awaiter(this,void 0,void 0,(function*(){this._editor.hasModel()&&this._model&&this._widget&&(yield this._widget.revealReference(e))}))}closeWidget(e=!0){var t,i;null===(t=this._widget)||void 0===t||t.dispose(),null===(i=this._model)||void 0===i||i.dispose(),this._referenceSearchVisible.reset(),this._disposables.clear(),this._widget=void 0,this._model=void 0,e&&this._editor.focus(),this._requestIdPool+=1}_gotoReference(t){this._widget&&this._widget.hide(),this._ignoreModelChangeEvent=!0;const i=Range.lift(t.range).collapseToStart();return this._editorService.openCodeEditor({resource:t.uri,options:{selection:i}},this._editor).then((t=>{var o;if(this._ignoreModelChangeEvent=!1,t&&this._widget)if(this._editor===t)this._widget.show(i),this._widget.focusOnReferenceTree();else{const r=e.get(t),n=this._model.clone();this.closeWidget(),t.focus(),null===r||void 0===r||r.toggleWidget(i,createCancelablePromise((e=>Promise.resolve(n))),null!==(o=this._peekMode)&&void 0!==o&&o)}else this.closeWidget()}),(e=>{this._ignoreModelChangeEvent=!1,onUnexpectedError(e)}))}openReference(e,t,i){t||this.closeWidget();const{uri:o,range:r}=e;this._editorService.openCodeEditor({resource:o,options:{selection:r,pinned:i}},this._editor,t)}};ReferencesController.ID="editor.contrib.referencesController",ReferencesController=__decorate([__param(2,IContextKeyService),__param(3,ICodeEditorService),__param(4,INotificationService),__param(5,IInstantiationService),__param(6,IStorageService),__param(7,IConfigurationService)],ReferencesController);export{ReferencesController};function withController(e,t){const i=getOuterEditor(e);if(!i)return;const o=ReferencesController.get(i);o&&t(o)}KeybindingsRegistry.registerCommandAndKeybindingRule({id:"togglePeekWidgetFocus",weight:100,primary:KeyChord(2089,60),when:ContextKeyExpr.or(ctxReferenceSearchVisible,PeekContext.inPeekEditor),handler(e){withController(e,(e=>{e.changeFocusBetweenPreviewAndReferences()}))}}),KeybindingsRegistry.registerCommandAndKeybindingRule({id:"goToNextReference",weight:90,primary:62,secondary:[70],when:ContextKeyExpr.or(ctxReferenceSearchVisible,PeekContext.inPeekEditor),handler(e){withController(e,(e=>{e.goToNextOrPreviousReference(!0)}))}}),KeybindingsRegistry.registerCommandAndKeybindingRule({id:"goToPreviousReference",weight:90,primary:1086,secondary:[1094],when:ContextKeyExpr.or(ctxReferenceSearchVisible,PeekContext.inPeekEditor),handler(e){withController(e,(e=>{e.goToNextOrPreviousReference(!1)}))}}),CommandsRegistry.registerCommandAlias("goToNextReferenceFromEmbeddedEditor","goToNextReference"),CommandsRegistry.registerCommandAlias("goToPreviousReferenceFromEmbeddedEditor","goToPreviousReference"),CommandsRegistry.registerCommandAlias("closeReferenceSearchEditor","closeReferenceSearch"),CommandsRegistry.registerCommand("closeReferenceSearch",(e=>withController(e,(e=>e.closeWidget())))),KeybindingsRegistry.registerKeybindingRule({id:"closeReferenceSearch",weight:-1,primary:9,secondary:[1033],when:ContextKeyExpr.and(PeekContext.inPeekEditor,ContextKeyExpr.not("config.editor.stablePeek"))}),KeybindingsRegistry.registerKeybindingRule({id:"closeReferenceSearch",weight:250,primary:9,secondary:[1033],when:ContextKeyExpr.and(ctxReferenceSearchVisible,ContextKeyExpr.not("config.editor.stablePeek"))}),KeybindingsRegistry.registerCommandAndKeybindingRule({id:"revealReference",weight:200,primary:3,mac:{primary:3,secondary:[2066]},when:ContextKeyExpr.and(ctxReferenceSearchVisible,WorkbenchListFocusContextKey,WorkbenchTreeElementCanCollapse.negate(),WorkbenchTreeElementCanExpand.negate()),handler(e){var t;const i=e.get(IListService),o=null===(t=i.lastFocusedList)||void 0===t?void 0:t.getFocus();Array.isArray(o)&&o[0]instanceof OneReference&&withController(e,(e=>e.revealReference(o[0])))}}),KeybindingsRegistry.registerCommandAndKeybindingRule({id:"openReferenceToSide",weight:100,primary:2051,mac:{primary:259},when:ContextKeyExpr.and(ctxReferenceSearchVisible,WorkbenchListFocusContextKey,WorkbenchTreeElementCanCollapse.negate(),WorkbenchTreeElementCanExpand.negate()),handler(e){var t;const i=e.get(IListService),o=null===(t=i.lastFocusedList)||void 0===t?void 0:t.getFocus();Array.isArray(o)&&o[0]instanceof OneReference&&withController(e,(e=>e.openReference(o[0],!0,!0)))}}),CommandsRegistry.registerCommand("openReference",(e=>{var t;const i=e.get(IListService),o=null===(t=i.lastFocusedList)||void 0===t?void 0:t.getFocus();Array.isArray(o)&&o[0]instanceof OneReference&&withController(e,(e=>e.openReference(o[0],!1,!0)))}));