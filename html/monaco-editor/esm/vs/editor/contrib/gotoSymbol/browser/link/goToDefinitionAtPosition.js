var __decorate=this&&this.__decorate||function(e,t,o,i){var n,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,o,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(r<3?n(s):r>3?n(t,o,s):n(t,o))||s);return r>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}};import{createCancelablePromise}from"../../../../../base/common/async.js";import{onUnexpectedError}from"../../../../../base/common/errors.js";import{MarkdownString}from"../../../../../base/common/htmlContent.js";import{DisposableStore}from"../../../../../base/common/lifecycle.js";import{withNullAsUndefined}from"../../../../../base/common/types.js";import"./goToDefinitionAtPosition.css";import{EditorState}from"../../../editorState/browser/editorState.js";import{registerEditorContribution}from"../../../../browser/editorExtensions.js";import{Position}from"../../../../common/core/position.js";import{Range}from"../../../../common/core/range.js";import{DefinitionProviderRegistry}from"../../../../common/languages.js";import{ILanguageService}from"../../../../common/services/language.js";import{ITextModelService}from"../../../../common/services/resolverService.js";import{ClickLinkGesture}from"./clickLinkGesture.js";import{PeekContext}from"../../../peekView/browser/peekView.js";import*as nls from"../../../../../nls.js";import{IContextKeyService}from"../../../../../platform/contextkey/common/contextkey.js";import{editorActiveLinkForeground}from"../../../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant}from"../../../../../platform/theme/common/themeService.js";import{DefinitionAction}from"../goToCommands.js";import{getDefinitionsAtPosition}from"../goToSymbol.js";let GotoDefinitionAtPositionEditorContribution=class e{constructor(e,t,o){this.textModelResolverService=t,this.languageService=o,this.toUnhook=new DisposableStore,this.toUnhookForKeyboard=new DisposableStore,this.linkDecorations=[],this.currentWordAtPosition=null,this.previousPromise=null,this.editor=e;let i=new ClickLinkGesture(e);this.toUnhook.add(i),this.toUnhook.add(i.onMouseMoveOrRelevantKeyDown((([e,t])=>{this.startFindDefinitionFromMouse(e,withNullAsUndefined(t))}))),this.toUnhook.add(i.onExecute((e=>{this.isEnabled(e)&&this.gotoDefinition(e.target.position,e.hasSideBySideModifier).then((()=>{this.removeLinkDecorations()}),(e=>{this.removeLinkDecorations(),onUnexpectedError(e)}))}))),this.toUnhook.add(i.onCancel((()=>{this.removeLinkDecorations(),this.currentWordAtPosition=null})))}static get(t){return t.getContribution(e.ID)}startFindDefinitionFromCursor(e){return this.startFindDefinition(e).then((()=>{this.toUnhookForKeyboard.add(this.editor.onDidChangeCursorPosition((()=>{this.currentWordAtPosition=null,this.removeLinkDecorations(),this.toUnhookForKeyboard.clear()}))),this.toUnhookForKeyboard.add(this.editor.onKeyDown((e=>{e&&(this.currentWordAtPosition=null,this.removeLinkDecorations(),this.toUnhookForKeyboard.clear())})))}))}startFindDefinitionFromMouse(e,t){if(9===e.target.type&&this.linkDecorations.length>0)return;if(!this.editor.hasModel()||!this.isEnabled(e,t))return this.currentWordAtPosition=null,void this.removeLinkDecorations();const o=e.target.position;this.startFindDefinition(o)}startFindDefinition(e){var t;this.toUnhookForKeyboard.clear();const o=e?null===(t=this.editor.getModel())||void 0===t?void 0:t.getWordAtPosition(e):null;if(!o)return this.currentWordAtPosition=null,this.removeLinkDecorations(),Promise.resolve(0);if(this.currentWordAtPosition&&this.currentWordAtPosition.startColumn===o.startColumn&&this.currentWordAtPosition.endColumn===o.endColumn&&this.currentWordAtPosition.word===o.word)return Promise.resolve(0);this.currentWordAtPosition=o;let i=new EditorState(this.editor,15);return this.previousPromise&&(this.previousPromise.cancel(),this.previousPromise=null),this.previousPromise=createCancelablePromise((t=>this.findDefinition(e,t))),this.previousPromise.then((t=>{if(t&&t.length&&i.validate(this.editor))if(t.length>1)this.addDecoration(new Range(e.lineNumber,o.startColumn,e.lineNumber,o.endColumn),(new MarkdownString).appendText(nls.localize("multipleResults","Click to show {0} definitions.",t.length)));else{let i=t[0];if(!i.uri)return;this.textModelResolverService.createModelReference(i.uri).then((t=>{if(!t.object||!t.object.textEditorModel)return void t.dispose();const{object:{textEditorModel:n}}=t,{startLineNumber:r}=i.range;if(r<1||r>n.getLineCount())return void t.dispose();const s=this.getPreviewValue(n,r,i);let a;a=i.originSelectionRange?Range.lift(i.originSelectionRange):new Range(e.lineNumber,o.startColumn,e.lineNumber,o.endColumn);const d=this.languageService.guessLanguageIdByFilepathOrFirstLine(n.uri);this.addDecoration(a,(new MarkdownString).appendCodeblock(d||"",s)),t.dispose()}))}else this.removeLinkDecorations()})).then(void 0,onUnexpectedError)}getPreviewValue(t,o,i){let n=i.targetSelectionRange?i.range:this.getPreviewRangeBasedOnBrackets(t,o);const r=n.endLineNumber-n.startLineNumber;r>=e.MAX_SOURCE_PREVIEW_LINES&&(n=this.getPreviewRangeBasedOnIndentation(t,o));const s=this.stripIndentationFromPreviewRange(t,o,n);return s}stripIndentationFromPreviewRange(e,t,o){const i=e.getLineFirstNonWhitespaceColumn(t);let n=i;for(let s=t+1;s<o.endLineNumber;s++){const t=e.getLineFirstNonWhitespaceColumn(s);n=Math.min(n,t)}const r=e.getValueInRange(o).replace(new RegExp(`^\\s{${n-1}}`,"gm"),"").trim();return r}getPreviewRangeBasedOnIndentation(t,o){const i=t.getLineFirstNonWhitespaceColumn(o),n=Math.min(t.getLineCount(),o+e.MAX_SOURCE_PREVIEW_LINES);let r=o+1;for(;r<n;r++){let e=t.getLineFirstNonWhitespaceColumn(r);if(i===e)break}return new Range(o,1,r+1,1)}getPreviewRangeBasedOnBrackets(t,o){const i=Math.min(t.getLineCount(),o+e.MAX_SOURCE_PREVIEW_LINES),n=[];let r=!0,s=t.bracketPairs.findNextBracket(new Position(o,1));while(null!==s){if(0===n.length)n.push(s);else{const e=n[n.length-1];if(e.open[0]===s.open[0]&&e.isOpen&&!s.isOpen?n.pop():n.push(s),0===n.length){if(!r)return new Range(o,1,s.range.endLineNumber+1,1);r=!1}}const e=t.getLineMaxColumn(o);let a=s.range.endLineNumber,d=s.range.endColumn;if(e===s.range.endColumn&&(a++,d=1),a>i)return new Range(o,1,i+1,1);s=t.bracketPairs.findNextBracket(new Position(a,d))}return new Range(o,1,i+1,1)}addDecoration(e,t){const o={range:e,options:{description:"goto-definition-link",inlineClassName:"goto-definition-link",hoverMessage:t}};this.linkDecorations=this.editor.deltaDecorations(this.linkDecorations,[o])}removeLinkDecorations(){this.linkDecorations.length>0&&(this.linkDecorations=this.editor.deltaDecorations(this.linkDecorations,[]))}isEnabled(e,t){return this.editor.hasModel()&&e.isNoneOrSingleMouseDown&&6===e.target.type&&(e.hasTriggerModifier||!!t&&t.keyCodeIsTriggerKey)&&DefinitionProviderRegistry.has(this.editor.getModel())}findDefinition(e,t){const o=this.editor.getModel();return o?getDefinitionsAtPosition(o,e,t):Promise.resolve(null)}gotoDefinition(e,t){return this.editor.setPosition(e),this.editor.invokeWithinContext((e=>{const o=!t&&this.editor.getOption(78)&&!this.isInPeekEditor(e),i=new DefinitionAction({openToSide:t,openInPeek:o,muteMessage:!0},{alias:"",label:"",id:"",precondition:void 0});return i.run(e,this.editor)}))}isInPeekEditor(e){const t=e.get(IContextKeyService);return PeekContext.inPeekEditor.getValue(t)}dispose(){this.toUnhook.dispose()}};GotoDefinitionAtPositionEditorContribution.ID="editor.contrib.gotodefinitionatposition",GotoDefinitionAtPositionEditorContribution.MAX_SOURCE_PREVIEW_LINES=8,GotoDefinitionAtPositionEditorContribution=__decorate([__param(1,ITextModelService),__param(2,ILanguageService)],GotoDefinitionAtPositionEditorContribution);export{GotoDefinitionAtPositionEditorContribution};registerEditorContribution(GotoDefinitionAtPositionEditorContribution.ID,GotoDefinitionAtPositionEditorContribution),registerThemingParticipant(((e,t)=>{const o=e.getColor(editorActiveLinkForeground);o&&t.addRule(`.monaco-editor .goto-definition-link { color: ${o} !important; }`)}));