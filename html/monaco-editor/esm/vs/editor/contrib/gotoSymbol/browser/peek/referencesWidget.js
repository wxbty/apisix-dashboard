var __decorate=this&&this.__decorate||function(e,i,t,o){var r,s=arguments.length,n=s<3?i:null===o?o=Object.getOwnPropertyDescriptor(i,t):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)n=Reflect.decorate(e,i,t,o);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(n=(s<3?r(n):s>3?r(i,t,n):r(i,t))||n);return s>3&&n&&Object.defineProperty(i,t,n),n},__param=this&&this.__param||function(e,i){return function(t,o){i(t,o,e)}},__awaiter=this&&this.__awaiter||function(e,i,t,o){function r(e){return e instanceof t?e:new t((function(i){i(e)}))}return new(t||(t=Promise))((function(t,s){function n(e){try{d(o.next(e))}catch(i){s(i)}}function a(e){try{d(o["throw"](e))}catch(i){s(i)}}function d(e){e.done?t(e.value):r(e.value).then(n,a)}d((o=o.apply(e,i||[])).next())}))};import*as dom from"../../../../../base/browser/dom.js";import{Sizing,SplitView}from"../../../../../base/browser/ui/splitview/splitview.js";import{Color}from"../../../../../base/common/color.js";import{Emitter,Event}from"../../../../../base/common/event.js";import{DisposableStore,dispose}from"../../../../../base/common/lifecycle.js";import{Schemas}from"../../../../../base/common/network.js";import{basenameOrAuthority,dirname}from"../../../../../base/common/resources.js";import"./referencesWidget.css";import{EmbeddedCodeEditorWidget}from"../../../../browser/widget/embeddedCodeEditorWidget.js";import{Range}from"../../../../common/core/range.js";import{ModelDecorationOptions,TextModel}from"../../../../common/model/textModel.js";import{ILanguageConfigurationService}from"../../../../common/languages/languageConfigurationRegistry.js";import{PLAINTEXT_LANGUAGE_ID}from"../../../../common/languages/modesRegistry.js";import{ILanguageService}from"../../../../common/services/language.js";import{ITextModelService}from"../../../../common/services/resolverService.js";import{AccessibilityProvider,DataSource,Delegate,FileReferencesRenderer,IdentityProvider,OneReferenceRenderer,StringRepresentationProvider}from"./referencesTree.js";import*as peekView from"../../../peekView/browser/peekView.js";import*as nls from"../../../../../nls.js";import{IInstantiationService}from"../../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService}from"../../../../../platform/keybinding/common/keybinding.js";import{ILabelService}from"../../../../../platform/label/common/label.js";import{WorkbenchAsyncDataTree}from"../../../../../platform/list/browser/listService.js";import{IThemeService}from"../../../../../platform/theme/common/themeService.js";import{IUndoRedoService}from"../../../../../platform/undoRedo/common/undoRedo.js";import{FileReferences,OneReference}from"../referencesModel.js";class DecorationsManager{constructor(e,i){this._editor=e,this._model=i,this._decorations=new Map,this._decorationIgnoreSet=new Set,this._callOnDispose=new DisposableStore,this._callOnModelChange=new DisposableStore,this._callOnDispose.add(this._editor.onDidChangeModel((()=>this._onModelChanged()))),this._onModelChanged()}dispose(){this._callOnModelChange.dispose(),this._callOnDispose.dispose(),this.removeDecorations()}_onModelChanged(){this._callOnModelChange.clear();const e=this._editor.getModel();if(e)for(let i of this._model.references)if(i.uri.toString()===e.uri.toString())return void this._addDecorations(i.parent)}_addDecorations(e){if(!this._editor.hasModel())return;this._callOnModelChange.add(this._editor.getModel().onDidChangeDecorations((()=>this._onDecorationChanged())));const i=[],t=[];for(let r=0,s=e.children.length;r<s;r++){let o=e.children[r];this._decorationIgnoreSet.has(o.id)||o.uri.toString()===this._editor.getModel().uri.toString()&&(i.push({range:o.range,options:DecorationsManager.DecorationOptions}),t.push(r))}const o=this._editor.deltaDecorations([],i);for(let r=0;r<o.length;r++)this._decorations.set(o[r],e.children[t[r]])}_onDecorationChanged(){const e=[],i=this._editor.getModel();if(i){for(let[t,o]of this._decorations){const r=i.getDecorationRange(t);if(!r)continue;let s=!1;if(!Range.equalsRange(r,o.range)){if(Range.spansMultipleLines(r))s=!0;else{const e=o.range.endColumn-o.range.startColumn,i=r.endColumn-r.startColumn;e!==i&&(s=!0)}s?(this._decorationIgnoreSet.add(o.id),e.push(t)):o.range=r}}for(let i=0,t=e.length;i<t;i++)this._decorations.delete(e[i]);this._editor.deltaDecorations(e,[])}}removeDecorations(){this._editor.deltaDecorations([...this._decorations.keys()],[]),this._decorations.clear()}}DecorationsManager.DecorationOptions=ModelDecorationOptions.register({description:"reference-decoration",stickiness:1,className:"reference-decoration"});export class LayoutData{constructor(){this.ratio=.7,this.heightInLines=18}static fromJSON(e){let i,t;try{const o=JSON.parse(e);i=o.ratio,t=o.heightInLines}catch(o){}return{ratio:i||.7,heightInLines:t||18}}}class ReferencesTree extends WorkbenchAsyncDataTree{}let ReferenceWidget=class extends peekView.PeekViewWidget{constructor(e,i,t,o,r,s,n,a,d,l,c,h){super(e,{showFrame:!1,showArrow:!0,isResizeable:!0,isAccessible:!0,supportOnTitleClick:!0},s),this._defaultTreeKeyboardSupport=i,this.layoutData=t,this._textModelResolverService=r,this._instantiationService=s,this._peekViewService=n,this._uriLabel=a,this._undoRedoService=d,this._keybindingService=l,this._languageService=c,this._languageConfigurationService=h,this._disposeOnNewModel=new DisposableStore,this._callOnDispose=new DisposableStore,this._onDidSelectReference=new Emitter,this.onDidSelectReference=this._onDidSelectReference.event,this._dim=new dom.Dimension(0,0),this._applyTheme(o.getColorTheme()),this._callOnDispose.add(o.onDidColorThemeChange(this._applyTheme.bind(this))),this._peekViewService.addExclusiveWidget(e,this),this.create()}dispose(){this.setModel(void 0),this._callOnDispose.dispose(),this._disposeOnNewModel.dispose(),dispose(this._preview),dispose(this._previewNotAvailableMessage),dispose(this._tree),dispose(this._previewModelReference),this._splitView.dispose(),super.dispose()}_applyTheme(e){const i=e.getColor(peekView.peekViewBorder)||Color.transparent;this.style({arrowColor:i,frameColor:i,headerBackgroundColor:e.getColor(peekView.peekViewTitleBackground)||Color.transparent,primaryHeadingColor:e.getColor(peekView.peekViewTitleForeground),secondaryHeadingColor:e.getColor(peekView.peekViewTitleInfoForeground)})}show(e){this.editor.revealRangeInCenterIfOutsideViewport(e,0),super.show(e,this.layoutData.heightInLines||18)}focusOnReferenceTree(){this._tree.domFocus()}focusOnPreviewEditor(){this._preview.focus()}isPreviewEditorFocused(){return this._preview.hasTextFocus()}_onTitleClick(e){this._preview&&this._preview.getModel()&&this._onDidSelectReference.fire({element:this._getFocusedReference(),kind:e.ctrlKey||e.metaKey||e.altKey?"side":"open",source:"title"})}_fillBody(e){this.setCssClass("reference-zone-widget"),this._messageContainer=dom.append(e,dom.$("div.messages")),dom.hide(this._messageContainer),this._splitView=new SplitView(e,{orientation:1}),this._previewContainer=dom.append(e,dom.$("div.preview.inline"));let i={scrollBeyondLastLine:!1,scrollbar:{verticalScrollbarSize:14,horizontal:"auto",useShadows:!0,verticalHasArrows:!1,horizontalHasArrows:!1,alwaysConsumeMouseWheel:!1},overviewRulerLanes:2,fixedOverflowWidgets:!0,minimap:{enabled:!1}};this._preview=this._instantiationService.createInstance(EmbeddedCodeEditorWidget,this._previewContainer,i,this.editor),dom.hide(this._previewContainer),this._previewNotAvailableMessage=new TextModel(nls.localize("missingPreviewMessage","no preview available"),PLAINTEXT_LANGUAGE_ID,TextModel.DEFAULT_CREATION_OPTIONS,null,this._undoRedoService,this._languageService,this._languageConfigurationService),this._treeContainer=dom.append(e,dom.$("div.ref-tree.inline"));const t={keyboardSupport:this._defaultTreeKeyboardSupport,accessibilityProvider:new AccessibilityProvider,keyboardNavigationLabelProvider:this._instantiationService.createInstance(StringRepresentationProvider),identityProvider:new IdentityProvider,openOnSingleClick:!0,selectionNavigation:!0,overrideStyles:{listBackground:peekView.peekViewResultsBackground}};this._defaultTreeKeyboardSupport&&this._callOnDispose.add(dom.addStandardDisposableListener(this._treeContainer,"keydown",(e=>{e.equals(9)&&(this._keybindingService.dispatchEvent(e,e.target),e.stopPropagation())}),!0)),this._tree=this._instantiationService.createInstance(ReferencesTree,"ReferencesWidget",this._treeContainer,new Delegate,[this._instantiationService.createInstance(FileReferencesRenderer),this._instantiationService.createInstance(OneReferenceRenderer)],this._instantiationService.createInstance(DataSource),t),this._splitView.addView({onDidChange:Event.None,element:this._previewContainer,minimumSize:200,maximumSize:Number.MAX_VALUE,layout:e=>{this._preview.layout({height:this._dim.height,width:e})}},Sizing.Distribute),this._splitView.addView({onDidChange:Event.None,element:this._treeContainer,minimumSize:100,maximumSize:Number.MAX_VALUE,layout:e=>{this._treeContainer.style.height=`${this._dim.height}px`,this._treeContainer.style.width=`${e}px`,this._tree.layout(this._dim.height,e)}},Sizing.Distribute),this._disposables.add(this._splitView.onDidSashChange((()=>{this._dim.width&&(this.layoutData.ratio=this._splitView.getViewSize(0)/this._dim.width)}),void 0));let o=(e,i)=>{e instanceof OneReference&&("show"===i&&this._revealReference(e,!1),this._onDidSelectReference.fire({element:e,kind:i,source:"tree"}))};this._tree.onDidOpen((e=>{e.sideBySide?o(e.element,"side"):e.editorOptions.pinned?o(e.element,"goto"):o(e.element,"show")})),dom.hide(this._treeContainer)}_onWidth(e){this._dim&&this._doLayoutBody(this._dim.height,e)}_doLayoutBody(e,i){super._doLayoutBody(e,i),this._dim=new dom.Dimension(i,e),this.layoutData.heightInLines=this._viewZone?this._viewZone.heightInLines:this.layoutData.heightInLines,this._splitView.layout(i),this._splitView.resizeView(0,i*this.layoutData.ratio)}setSelection(e){return this._revealReference(e,!0).then((()=>{this._model&&(this._tree.setSelection([e]),this._tree.setFocus([e]))}))}setModel(e){return this._disposeOnNewModel.clear(),this._model=e,this._model?this._onNewModel():Promise.resolve()}_onNewModel(){return this._model?this._model.isEmpty?(this.setTitle(""),this._messageContainer.innerText=nls.localize("noResults","No results"),dom.show(this._messageContainer),Promise.resolve(void 0)):(dom.hide(this._messageContainer),this._decorationsManager=new DecorationsManager(this._preview,this._model),this._disposeOnNewModel.add(this._decorationsManager),this._disposeOnNewModel.add(this._model.onDidChangeReferenceRange((e=>this._tree.rerender(e)))),this._disposeOnNewModel.add(this._preview.onMouseDown((e=>{const{event:i,target:t}=e;if(2!==i.detail)return;const o=this._getFocusedReference();o&&this._onDidSelectReference.fire({element:{uri:o.uri,range:t.range},kind:i.ctrlKey||i.metaKey||i.altKey?"side":"open",source:"editor"})}))),this.container.classList.add("results-loaded"),dom.show(this._treeContainer),dom.show(this._previewContainer),this._splitView.layout(this._dim.width),this.focusOnReferenceTree(),this._tree.setInput(1===this._model.groups.length?this._model.groups[0]:this._model)):Promise.resolve(void 0)}_getFocusedReference(){const[e]=this._tree.getFocus();return e instanceof OneReference?e:e instanceof FileReferences&&e.children.length>0?e.children[0]:void 0}revealReference(e){return __awaiter(this,void 0,void 0,(function*(){yield this._revealReference(e,!1),this._onDidSelectReference.fire({element:e,kind:"goto",source:"tree"})}))}_revealReference(e,i){return __awaiter(this,void 0,void 0,(function*(){if(this._revealedReference===e)return;this._revealedReference=e,e.uri.scheme!==Schemas.inMemory?this.setTitle(basenameOrAuthority(e.uri),this._uriLabel.getUriLabel(dirname(e.uri))):this.setTitle(nls.localize("peekView.alternateTitle","References"));const t=this._textModelResolverService.createModelReference(e.uri);this._tree.getInput()===e.parent||(i&&this._tree.reveal(e.parent),yield this._tree.expand(e.parent)),this._tree.reveal(e);const o=yield t;if(!this._model)return void o.dispose();dispose(this._previewModelReference);const r=o.object;if(r){const i=this._preview.getModel()===r.textEditorModel?0:1,t=Range.lift(e.range).collapseToStart();this._previewModelReference=o,this._preview.setModel(r.textEditorModel),this._preview.setSelection(t),this._preview.revealRangeInCenter(t,i)}else this._preview.setModel(this._previewNotAvailableMessage),o.dispose()}))}};ReferenceWidget=__decorate([__param(3,IThemeService),__param(4,ITextModelService),__param(5,IInstantiationService),__param(6,peekView.IPeekViewService),__param(7,ILabelService),__param(8,IUndoRedoService),__param(9,IKeybindingService),__param(10,ILanguageService),__param(11,ILanguageConfigurationService)],ReferenceWidget);export{ReferenceWidget};