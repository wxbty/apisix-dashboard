import{Emitter}from"../../base/common/event.js";import{toDisposable}from"../../base/common/lifecycle.js";import{shouldSynchronizeModel}from"./model.js";import{score}from"./languageSelector.js";function isExclusive(e){return"string"!==typeof e&&(Array.isArray(e)?e.every(isExclusive):!!e.exclusive)}export class LanguageFeatureRegistry{constructor(){this._clock=0,this._entries=[],this._onDidChange=new Emitter}get onDidChange(){return this._onDidChange.event}register(e,r){let t={selector:e,provider:r,_score:-1,_time:this._clock++};return this._entries.push(t),this._lastCandidate=void 0,this._onDidChange.fire(this._entries.length),toDisposable((()=>{if(t){const e=this._entries.indexOf(t);e>=0&&(this._entries.splice(e,1),this._lastCandidate=void 0,this._onDidChange.fire(this._entries.length),t=void 0)}}))}has(e){return this.all(e).length>0}all(e){if(!e)return[];this._updateScores(e);const r=[];for(let t of this._entries)t._score>0&&r.push(t.provider);return r}ordered(e){const r=[];return this._orderedForEach(e,(e=>r.push(e.provider))),r}orderedGroups(e){const r=[];let t,s;return this._orderedForEach(e,(e=>{t&&s===e._score?t.push(e.provider):(s=e._score,t=[e.provider],r.push(t))})),r}_orderedForEach(e,r){if(e){this._updateScores(e);for(const e of this._entries)e._score>0&&r(e)}}_updateScores(e){const r={uri:e.uri.toString(),language:e.getLanguageId()};if(!this._lastCandidate||this._lastCandidate.language!==r.language||this._lastCandidate.uri!==r.uri){this._lastCandidate=r;for(let r of this._entries)if(r._score=score(r.selector,e.uri,e.getLanguageId(),shouldSynchronizeModel(e)),isExclusive(r.selector)&&r._score>0){for(let e of this._entries)e._score=0;r._score=1e3;break}this._entries.sort(LanguageFeatureRegistry._compareByScoreAndTime)}}static _compareByScoreAndTime(e,r){return e._score<r._score?1:e._score>r._score?-1:e._time<r._time?1:e._time>r._time?-1:0}}