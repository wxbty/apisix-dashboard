var __awaiter=this&&this.__awaiter||function(e,n,t,o){function r(e){return e instanceof t?e:new t((function(n){n(e)}))}return new(t||(t=Promise))((function(t,i){function s(e){try{a(o.next(e))}catch(n){i(n)}}function c(e){try{a(o["throw"](e))}catch(n){i(n)}}function a(e){e.done?t(e.value):r(e.value).then(s,c)}a((o=o.apply(e,n||[])).next())}))};import{CancellationToken}from"../../../base/common/cancellation.js";import{onUnexpectedExternalError}from"../../../base/common/errors.js";import{URI}from"../../../base/common/uri.js";import{DocumentSemanticTokensProviderRegistry,DocumentRangeSemanticTokensProviderRegistry}from"../languages.js";import{IModelService}from"./model.js";import{CommandsRegistry,ICommandService}from"../../../platform/commands/common/commands.js";import{assertType}from"../../../base/common/types.js";import{encodeSemanticTokensDto}from"./semanticTokensDto.js";import{Range}from"../core/range.js";export function isSemanticTokens(e){return e&&!!e.data}export function isSemanticTokensEdits(e){return e&&Array.isArray(e.edits)}export class DocumentSemanticTokensResult{constructor(e,n,t){this.provider=e,this.tokens=n,this.error=t}}export function hasDocumentSemanticTokensProvider(e){return DocumentSemanticTokensProviderRegistry.has(e)}function getDocumentSemanticTokensProviders(e){const n=DocumentSemanticTokensProviderRegistry.orderedGroups(e);return n.length>0?n[0]:[]}export function getDocumentSemanticTokens(e,n,t,o){return __awaiter(this,void 0,void 0,(function*(){const r=getDocumentSemanticTokensProviders(e),i=yield Promise.all(r.map((r=>__awaiter(this,void 0,void 0,(function*(){let i,s=null;try{i=yield r.provideDocumentSemanticTokens(e,r===n?t:null,o)}catch(c){s=c,i=null}return i&&(isSemanticTokens(i)||isSemanticTokensEdits(i))||(i=null),new DocumentSemanticTokensResult(r,i,s)})))));for(const e of i){if(e.error)throw e.error;if(e.tokens)return e}return i.length>0?i[0]:null}))}function _getDocumentSemanticTokensProviderHighestGroup(e){const n=DocumentSemanticTokensProviderRegistry.orderedGroups(e);return n.length>0?n[0]:null}class DocumentRangeSemanticTokensResult{constructor(e,n){this.provider=e,this.tokens=n}}export function hasDocumentRangeSemanticTokensProvider(e){return DocumentRangeSemanticTokensProviderRegistry.has(e)}function getDocumentRangeSemanticTokensProviders(e){const n=DocumentRangeSemanticTokensProviderRegistry.orderedGroups(e);return n.length>0?n[0]:[]}export function getDocumentRangeSemanticTokens(e,n,t){return __awaiter(this,void 0,void 0,(function*(){const o=getDocumentRangeSemanticTokensProviders(e),r=yield Promise.all(o.map((o=>__awaiter(this,void 0,void 0,(function*(){let r;try{r=yield o.provideDocumentRangeSemanticTokens(e,n,t)}catch(i){onUnexpectedExternalError(i),r=null}return r&&isSemanticTokens(r)||(r=null),new DocumentRangeSemanticTokensResult(o,r)})))));for(const e of r)if(e.tokens)return e;return r.length>0?r[0]:null}))}CommandsRegistry.registerCommand("_provideDocumentSemanticTokensLegend",((e,...n)=>__awaiter(void 0,void 0,void 0,(function*(){const[t]=n;assertType(t instanceof URI);const o=e.get(IModelService).getModel(t);if(!o)return;const r=_getDocumentSemanticTokensProviderHighestGroup(o);return r?r[0].getLegend():e.get(ICommandService).executeCommand("_provideDocumentRangeSemanticTokensLegend",t)})))),CommandsRegistry.registerCommand("_provideDocumentSemanticTokens",((e,...n)=>__awaiter(void 0,void 0,void 0,(function*(){const[t]=n;assertType(t instanceof URI);const o=e.get(IModelService).getModel(t);if(!o)return;if(!hasDocumentSemanticTokensProvider(o))return e.get(ICommandService).executeCommand("_provideDocumentRangeSemanticTokens",t,o.getFullModelRange());const r=yield getDocumentSemanticTokens(o,null,null,CancellationToken.None);if(!r)return;const{provider:i,tokens:s}=r;if(!s||!isSemanticTokens(s))return;const c=encodeSemanticTokensDto({id:0,type:"full",data:s.data});return s.resultId&&i.releaseDocumentSemanticTokens(s.resultId),c})))),CommandsRegistry.registerCommand("_provideDocumentRangeSemanticTokensLegend",((e,...n)=>__awaiter(void 0,void 0,void 0,(function*(){const[t,o]=n;assertType(t instanceof URI);const r=e.get(IModelService).getModel(t);if(!r)return;const i=getDocumentRangeSemanticTokensProviders(r);if(0===i.length)return;if(1===i.length)return i[0].getLegend();if(!o||!Range.isIRange(o))return console.warn("provideDocumentRangeSemanticTokensLegend might be out-of-sync with provideDocumentRangeSemanticTokens unless a range argument is passed in"),i[0].getLegend();const s=yield getDocumentRangeSemanticTokens(r,Range.lift(o),CancellationToken.None);return s?s.provider.getLegend():void 0})))),CommandsRegistry.registerCommand("_provideDocumentRangeSemanticTokens",((e,...n)=>__awaiter(void 0,void 0,void 0,(function*(){const[t,o]=n;assertType(t instanceof URI),assertType(Range.isIRange(o));const r=e.get(IModelService).getModel(t);if(!r)return;const i=yield getDocumentRangeSemanticTokens(r,Range.lift(o),CancellationToken.None);return i&&i.tokens?encodeSemanticTokensDto({id:0,type:"full",data:i.tokens.data}):void 0}))));