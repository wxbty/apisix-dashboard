var __decorate=this&&this.__decorate||function(e,t,o,i){var n,s=arguments.length,r=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)r=Reflect.decorate(e,t,o,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(r=(s<3?n(r):s>3?n(t,o,r):n(t,o))||r);return s>3&&r&&Object.defineProperty(t,o,r),r},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}};import{Emitter}from"../../../base/common/event.js";import{Disposable,DisposableStore,dispose}from"../../../base/common/lifecycle.js";import*as platform from"../../../base/common/platform.js";import*as errors from"../../../base/common/errors.js";import{TextModel}from"../model/textModel.js";import{EDITOR_MODEL_DEFAULTS}from"../core/textModelDefaults.js";import{DocumentSemanticTokensProviderRegistry}from"../languages.js";import{PLAINTEXT_LANGUAGE_ID}from"../languages/modesRegistry.js";import{ILanguageService}from"./language.js";import{IModelService}from"./model.js";import{ITextResourcePropertiesService}from"./textResourceConfiguration.js";import{IConfigurationService}from"../../../platform/configuration/common/configuration.js";import{RunOnceScheduler}from"../../../base/common/async.js";import{CancellationTokenSource}from"../../../base/common/cancellation.js";import{IThemeService}from"../../../platform/theme/common/themeService.js";import{ILogService}from"../../../platform/log/common/log.js";import{IUndoRedoService}from"../../../platform/undoRedo/common/undoRedo.js";import{StringSHA1}from"../../../base/common/hash.js";import{isEditStackElement}from"../model/editStack.js";import{Schemas}from"../../../base/common/network.js";import{SemanticTokensProviderStyling,toMultilineTokens2}from"./semanticTokensProviderStyling.js";import{getDocumentSemanticTokens,hasDocumentSemanticTokensProvider,isSemanticTokens,isSemanticTokensEdits}from"./getSemanticTokens.js";import{equals}from"../../../base/common/objects.js";import{ILanguageConfigurationService}from"../languages/languageConfigurationRegistry.js";import{ILanguageFeatureDebounceService}from"./languageFeatureDebounce.js";import{StopWatch}from"../../../base/common/stopwatch.js";function MODEL_ID(e){return e.toString()}function computeModelSha1(e){const t=new StringSHA1,o=e.createSnapshot();let i;while(i=o.read())t.update(i);return t.digest()}class ModelData{constructor(e,t,o){this._modelEventListeners=new DisposableStore,this.model=e,this._languageSelection=null,this._languageSelectionListener=null,this._modelEventListeners.add(e.onWillDispose((()=>t(e)))),this._modelEventListeners.add(e.onDidChangeLanguage((t=>o(e,t))))}_disposeLanguageSelection(){this._languageSelectionListener&&(this._languageSelectionListener.dispose(),this._languageSelectionListener=null)}dispose(){this._modelEventListeners.dispose(),this._disposeLanguageSelection()}setLanguage(e){this._disposeLanguageSelection(),this._languageSelection=e,this._languageSelectionListener=this._languageSelection.onDidChange((()=>this.model.setMode(e.languageId))),this.model.setMode(e.languageId)}}const DEFAULT_EOL=platform.isLinux||platform.isMacintosh?1:2;class DisposedModelInfo{constructor(e,t,o,i,n,s,r,a){this.uri=e,this.initialUndoRedoSnapshot=t,this.time=o,this.sharesUndoRedoStack=i,this.heapSize=n,this.sha1=s,this.versionId=r,this.alternativeVersionId=a}}let ModelService=class e extends Disposable{constructor(e,t,o,i,n,s,r,a){super(),this._configurationService=e,this._resourcePropertiesService=t,this._themeService=o,this._logService=i,this._undoRedoService=n,this._languageService=s,this._languageConfigurationService=r,this._languageFeatureDebounceService=a,this._onModelAdded=this._register(new Emitter),this.onModelAdded=this._onModelAdded.event,this._onModelRemoved=this._register(new Emitter),this.onModelRemoved=this._onModelRemoved.event,this._onModelModeChanged=this._register(new Emitter),this.onModelLanguageChanged=this._onModelModeChanged.event,this._modelCreationOptionsByLanguageAndResource=Object.create(null),this._models={},this._disposedModels=new Map,this._disposedModelsHeapSize=0,this._semanticStyling=this._register(new SemanticStyling(this._themeService,this._languageService,this._logService)),this._register(this._configurationService.onDidChangeConfiguration((()=>this._updateModelOptions()))),this._updateModelOptions(),this._register(new SemanticColoringFeature(this._semanticStyling,this,this._themeService,this._configurationService,this._languageFeatureDebounceService))}static _readModelOptions(e,t){var o;let i=EDITOR_MODEL_DEFAULTS.tabSize;if(e.editor&&"undefined"!==typeof e.editor.tabSize){const t=parseInt(e.editor.tabSize,10);isNaN(t)||(i=t),i<1&&(i=1)}let n=i;if(e.editor&&"undefined"!==typeof e.editor.indentSize&&"tabSize"!==e.editor.indentSize){const t=parseInt(e.editor.indentSize,10);isNaN(t)||(n=t),n<1&&(n=1)}let s=EDITOR_MODEL_DEFAULTS.insertSpaces;e.editor&&"undefined"!==typeof e.editor.insertSpaces&&(s="false"!==e.editor.insertSpaces&&Boolean(e.editor.insertSpaces));let r=DEFAULT_EOL;const a=e.eol;"\r\n"===a?r=2:"\n"===a&&(r=1);let c=EDITOR_MODEL_DEFAULTS.trimAutoWhitespace;e.editor&&"undefined"!==typeof e.editor.trimAutoWhitespace&&(c="false"!==e.editor.trimAutoWhitespace&&Boolean(e.editor.trimAutoWhitespace));let l=EDITOR_MODEL_DEFAULTS.detectIndentation;e.editor&&"undefined"!==typeof e.editor.detectIndentation&&(l="false"!==e.editor.detectIndentation&&Boolean(e.editor.detectIndentation));let d=EDITOR_MODEL_DEFAULTS.largeFileOptimizations;e.editor&&"undefined"!==typeof e.editor.largeFileOptimizations&&(d="false"!==e.editor.largeFileOptimizations&&Boolean(e.editor.largeFileOptimizations));let u=EDITOR_MODEL_DEFAULTS.bracketPairColorizationOptions;return(null===(o=e.editor)||void 0===o?void 0:o.bracketPairColorization)&&"object"===typeof e.editor.bracketPairColorization&&(u={enabled:!!e.editor.bracketPairColorization.enabled}),{isForSimpleWidget:t,tabSize:i,indentSize:n,insertSpaces:s,detectIndentation:l,defaultEOL:r,trimAutoWhitespace:c,largeFileOptimizations:d,bracketPairColorizationOptions:u}}_getEOL(e,t){if(e)return this._resourcePropertiesService.getEOL(e,t);const o=this._configurationService.getValue("files.eol",{overrideIdentifier:t});return o&&"string"===typeof o&&"auto"!==o?o:3===platform.OS||2===platform.OS?"\n":"\r\n"}_shouldRestoreUndoStack(){const e=this._configurationService.getValue("files.restoreUndoStack");return"boolean"!==typeof e||e}getCreationOptions(t,o,i){let n=this._modelCreationOptionsByLanguageAndResource[t+o];if(!n){const s=this._configurationService.getValue("editor",{overrideIdentifier:t,resource:o}),r=this._getEOL(o,t);n=e._readModelOptions({editor:s,eol:r},i),this._modelCreationOptionsByLanguageAndResource[t+o]=n}return n}_updateModelOptions(){const t=this._modelCreationOptionsByLanguageAndResource;this._modelCreationOptionsByLanguageAndResource=Object.create(null);const o=Object.keys(this._models);for(let i=0,n=o.length;i<n;i++){const n=o[i],s=this._models[n],r=s.model.getLanguageId(),a=s.model.uri,c=t[r+a],l=this.getCreationOptions(r,a,s.model.isForSimpleWidget);e._setModelOptionsForModel(s.model,l,c)}}static _setModelOptionsForModel(e,t,o){o&&o.defaultEOL!==t.defaultEOL&&1===e.getLineCount()&&e.setEOL(1===t.defaultEOL?0:1),o&&o.detectIndentation===t.detectIndentation&&o.insertSpaces===t.insertSpaces&&o.tabSize===t.tabSize&&o.indentSize===t.indentSize&&o.trimAutoWhitespace===t.trimAutoWhitespace&&equals(o.bracketPairColorizationOptions,t.bracketPairColorizationOptions)||(t.detectIndentation?(e.detectIndentation(t.insertSpaces,t.tabSize),e.updateOptions({trimAutoWhitespace:t.trimAutoWhitespace,bracketColorizationOptions:t.bracketPairColorizationOptions})):e.updateOptions({insertSpaces:t.insertSpaces,tabSize:t.tabSize,indentSize:t.indentSize,trimAutoWhitespace:t.trimAutoWhitespace,bracketColorizationOptions:t.bracketPairColorizationOptions}))}_insertDisposedModel(e){this._disposedModels.set(MODEL_ID(e.uri),e),this._disposedModelsHeapSize+=e.heapSize}_removeDisposedModel(e){const t=this._disposedModels.get(MODEL_ID(e));return t&&(this._disposedModelsHeapSize-=t.heapSize),this._disposedModels.delete(MODEL_ID(e)),t}_ensureDisposedModelsHeapSize(e){if(this._disposedModelsHeapSize>e){const t=[];this._disposedModels.forEach((e=>{e.sharesUndoRedoStack||t.push(e)})),t.sort(((e,t)=>e.time-t.time));while(t.length>0&&this._disposedModelsHeapSize>e){const e=t.shift();this._removeDisposedModel(e.uri),null!==e.initialUndoRedoSnapshot&&this._undoRedoService.restoreSnapshot(e.initialUndoRedoSnapshot)}}}_createModelData(e,t,o,i){const n=this.getCreationOptions(t,o,i),s=new TextModel(e,t,n,o,this._undoRedoService,this._languageService,this._languageConfigurationService);if(o&&this._disposedModels.has(MODEL_ID(o))){const e=this._removeDisposedModel(o),t=this._undoRedoService.getElements(o),i=computeModelSha1(s)===e.sha1;if(i||e.sharesUndoRedoStack){for(const e of t.past)isEditStackElement(e)&&e.matchesResource(o)&&e.setModel(s);for(const e of t.future)isEditStackElement(e)&&e.matchesResource(o)&&e.setModel(s);this._undoRedoService.setElementsValidFlag(o,!0,(e=>isEditStackElement(e)&&e.matchesResource(o))),i&&(s._overwriteVersionId(e.versionId),s._overwriteAlternativeVersionId(e.alternativeVersionId),s._overwriteInitialUndoRedoSnapshot(e.initialUndoRedoSnapshot))}else null!==e.initialUndoRedoSnapshot&&this._undoRedoService.restoreSnapshot(e.initialUndoRedoSnapshot)}const r=MODEL_ID(s.uri);if(this._models[r])throw new Error("ModelService: Cannot add model because it already exists!");const a=new ModelData(s,(e=>this._onWillDispose(e)),((e,t)=>this._onDidChangeLanguage(e,t)));return this._models[r]=a,a}createModel(e,t,o,i=!1){let n;return t?(n=this._createModelData(e,t.languageId,o,i),this.setMode(n.model,t)):n=this._createModelData(e,PLAINTEXT_LANGUAGE_ID,o,i),this._onModelAdded.fire(n.model),n.model}setMode(e,t){if(!t)return;const o=this._models[MODEL_ID(e.uri)];o&&o.setLanguage(t)}getModels(){const e=[],t=Object.keys(this._models);for(let o=0,i=t.length;o<i;o++){const i=t[o];e.push(this._models[i].model)}return e}getModel(e){const t=MODEL_ID(e),o=this._models[t];return o?o.model:null}getSemanticTokensProviderStyling(e){return this._semanticStyling.get(e)}_schemaShouldMaintainUndoRedoElements(e){return e.scheme===Schemas.file||e.scheme===Schemas.vscodeRemote||e.scheme===Schemas.userData||e.scheme===Schemas.vscodeNotebookCell||"fake-fs"===e.scheme}_onWillDispose(t){const o=MODEL_ID(t.uri),i=this._models[o],n=this._undoRedoService.getUriComparisonKey(t.uri)!==t.uri.toString();let s=!1,r=0;if(n||this._shouldRestoreUndoStack()&&this._schemaShouldMaintainUndoRedoElements(t.uri)){const e=this._undoRedoService.getElements(t.uri);if(e.past.length>0||e.future.length>0){for(const o of e.past)isEditStackElement(o)&&o.matchesResource(t.uri)&&(s=!0,r+=o.heapSize(t.uri),o.setModel(t.uri));for(const o of e.future)isEditStackElement(o)&&o.matchesResource(t.uri)&&(s=!0,r+=o.heapSize(t.uri),o.setModel(t.uri))}}const a=e.MAX_MEMORY_FOR_CLOSED_FILES_UNDO_STACK;if(s)if(!n&&r>a){const e=i.model.getInitialUndoRedoSnapshot();null!==e&&this._undoRedoService.restoreSnapshot(e)}else this._ensureDisposedModelsHeapSize(a-r),this._undoRedoService.setElementsValidFlag(t.uri,!1,(e=>isEditStackElement(e)&&e.matchesResource(t.uri))),this._insertDisposedModel(new DisposedModelInfo(t.uri,i.model.getInitialUndoRedoSnapshot(),Date.now(),n,r,computeModelSha1(t),t.getVersionId(),t.getAlternativeVersionId()));else if(!n){const e=i.model.getInitialUndoRedoSnapshot();null!==e&&this._undoRedoService.restoreSnapshot(e)}delete this._models[o],i.dispose(),delete this._modelCreationOptionsByLanguageAndResource[t.getLanguageId()+t.uri],this._onModelRemoved.fire(t)}_onDidChangeLanguage(t,o){const i=o.oldLanguage,n=t.getLanguageId(),s=this.getCreationOptions(i,t.uri,t.isForSimpleWidget),r=this.getCreationOptions(n,t.uri,t.isForSimpleWidget);e._setModelOptionsForModel(t,r,s),this._onModelModeChanged.fire({model:t,oldLanguageId:i})}};ModelService.MAX_MEMORY_FOR_CLOSED_FILES_UNDO_STACK=20971520,ModelService=__decorate([__param(0,IConfigurationService),__param(1,ITextResourcePropertiesService),__param(2,IThemeService),__param(3,ILogService),__param(4,IUndoRedoService),__param(5,ILanguageService),__param(6,ILanguageConfigurationService),__param(7,ILanguageFeatureDebounceService)],ModelService);export{ModelService};export const SEMANTIC_HIGHLIGHTING_SETTING_ID="editor.semanticHighlighting";export function isSemanticColoringEnabled(e,t,o){var i;const n=null===(i=o.getValue(SEMANTIC_HIGHLIGHTING_SETTING_ID,{overrideIdentifier:e.getLanguageId(),resource:e.uri}))||void 0===i?void 0:i.enabled;return"boolean"===typeof n?n:t.getColorTheme().semanticHighlighting}let SemanticColoringFeature=class extends Disposable{constructor(e,t,o,i,n){super(),this._watchers=Object.create(null),this._semanticStyling=e;const s=e=>{this._watchers[e.uri.toString()]=new ModelSemanticColoring(e,this._semanticStyling,o,n)},r=(e,t)=>{t.dispose(),delete this._watchers[e.uri.toString()]},a=()=>{for(let e of t.getModels()){const t=this._watchers[e.uri.toString()];isSemanticColoringEnabled(e,o,i)?t||s(e):t&&r(e,t)}};this._register(t.onModelAdded((e=>{isSemanticColoringEnabled(e,o,i)&&s(e)}))),this._register(t.onModelRemoved((e=>{const t=this._watchers[e.uri.toString()];t&&r(e,t)}))),this._register(i.onDidChangeConfiguration((e=>{e.affectsConfiguration(SEMANTIC_HIGHLIGHTING_SETTING_ID)&&a()}))),this._register(o.onDidColorThemeChange(a))}};SemanticColoringFeature=__decorate([__param(1,IModelService),__param(2,IThemeService),__param(3,IConfigurationService),__param(4,ILanguageFeatureDebounceService)],SemanticColoringFeature);class SemanticStyling extends Disposable{constructor(e,t,o){super(),this._themeService=e,this._languageService=t,this._logService=o,this._caches=new WeakMap,this._register(this._themeService.onDidColorThemeChange((()=>{this._caches=new WeakMap})))}get(e){return this._caches.has(e)||this._caches.set(e,new SemanticTokensProviderStyling(e.getLegend(),this._themeService,this._languageService,this._logService)),this._caches.get(e)}}class SemanticTokensResponse{constructor(e,t,o){this.provider=e,this.resultId=t,this.data=o}dispose(){this.provider.releaseDocumentSemanticTokens(this.resultId)}}let ModelSemanticColoring=class e extends Disposable{constructor(t,o,i,n){super(),this._isDisposed=!1,this._model=t,this._semanticStyling=o,this._debounceInformation=n.for(DocumentSemanticTokensProviderRegistry,"DocumentSemanticTokens",{min:e.REQUEST_MIN_DELAY,max:e.REQUEST_MAX_DELAY}),this._fetchDocumentSemanticTokens=this._register(new RunOnceScheduler((()=>this._fetchDocumentSemanticTokensNow()),e.REQUEST_MIN_DELAY)),this._currentDocumentResponse=null,this._currentDocumentRequestCancellationTokenSource=null,this._documentProvidersChangeListeners=[],this._register(this._model.onDidChangeContent((()=>{this._fetchDocumentSemanticTokens.isScheduled()||this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model))}))),this._register(this._model.onDidChangeLanguage((()=>{this._currentDocumentResponse&&(this._currentDocumentResponse.dispose(),this._currentDocumentResponse=null),this._currentDocumentRequestCancellationTokenSource&&(this._currentDocumentRequestCancellationTokenSource.cancel(),this._currentDocumentRequestCancellationTokenSource=null),this._setDocumentSemanticTokens(null,null,null,[]),this._fetchDocumentSemanticTokens.schedule(0)})));const s=()=>{dispose(this._documentProvidersChangeListeners),this._documentProvidersChangeListeners=[];for(const e of DocumentSemanticTokensProviderRegistry.all(t))"function"===typeof e.onDidChange&&this._documentProvidersChangeListeners.push(e.onDidChange((()=>this._fetchDocumentSemanticTokens.schedule(0))))};s(),this._register(DocumentSemanticTokensProviderRegistry.onDidChange((()=>{s(),this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model))}))),this._register(i.onDidColorThemeChange((e=>{this._setDocumentSemanticTokens(null,null,null,[]),this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model))}))),this._fetchDocumentSemanticTokens.schedule(0)}dispose(){this._currentDocumentResponse&&(this._currentDocumentResponse.dispose(),this._currentDocumentResponse=null),this._currentDocumentRequestCancellationTokenSource&&(this._currentDocumentRequestCancellationTokenSource.cancel(),this._currentDocumentRequestCancellationTokenSource=null),this._setDocumentSemanticTokens(null,null,null,[]),this._isDisposed=!0,super.dispose()}_fetchDocumentSemanticTokensNow(){if(this._currentDocumentRequestCancellationTokenSource)return;if(!hasDocumentSemanticTokensProvider(this._model))return void(this._currentDocumentResponse&&this._model.setSemanticTokens(null,!1));const e=new CancellationTokenSource,t=this._currentDocumentResponse?this._currentDocumentResponse.provider:null,o=this._currentDocumentResponse&&this._currentDocumentResponse.resultId||null,i=getDocumentSemanticTokens(this._model,t,o,e.token);this._currentDocumentRequestCancellationTokenSource=e;const n=[],s=this._model.onDidChangeContent((e=>{n.push(e)})),r=new StopWatch(!1);i.then((e=>{if(this._debounceInformation.update(this._model,r.elapsed()),this._currentDocumentRequestCancellationTokenSource=null,s.dispose(),e){const{provider:t,tokens:o}=e,i=this._semanticStyling.get(t);this._setDocumentSemanticTokens(t,o||null,i,n)}else this._setDocumentSemanticTokens(null,null,null,n)}),(e=>{const t=e&&(errors.isCancellationError(e)||"string"===typeof e.message&&-1!==e.message.indexOf("busy"));t||errors.onUnexpectedError(e),this._currentDocumentRequestCancellationTokenSource=null,s.dispose(),n.length>0&&(this._fetchDocumentSemanticTokens.isScheduled()||this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model)))}))}static _copy(e,t,o,i,n){for(let s=0;s<n;s++)o[i+s]=e[t+s]}_setDocumentSemanticTokens(t,o,i,n){const s=this._currentDocumentResponse,r=()=>{n.length>0&&!this._fetchDocumentSemanticTokens.isScheduled()&&this._fetchDocumentSemanticTokens.schedule(this._debounceInformation.get(this._model))};if(this._currentDocumentResponse&&(this._currentDocumentResponse.dispose(),this._currentDocumentResponse=null),this._isDisposed)t&&o&&t.releaseDocumentSemanticTokens(o.resultId);else if(t&&i){if(!o)return this._model.setSemanticTokens(null,!0),void r();if(isSemanticTokensEdits(o)){if(!s)return void this._model.setSemanticTokens(null,!0);if(0===o.edits.length)o={resultId:o.resultId,data:s.data};else{let t=0;for(const e of o.edits)t+=(e.data?e.data.length:0)-e.deleteCount;const i=s.data,n=new Uint32Array(i.length+t);let r=i.length,a=n.length;for(let s=o.edits.length-1;s>=0;s--){const t=o.edits[s],c=r-(t.start+t.deleteCount);c>0&&(e._copy(i,r-c,n,a-c,c),a-=c),t.data&&(e._copy(t.data,0,n,a-t.data.length,t.data.length),a-=t.data.length),r=t.start}r>0&&e._copy(i,0,n,0,r),o={resultId:o.resultId,data:n}}}if(isSemanticTokens(o)){this._currentDocumentResponse=new SemanticTokensResponse(t,o.resultId,o.data);const e=toMultilineTokens2(o,i,this._model.getLanguageId());if(n.length>0)for(const t of n)for(const o of e)for(const e of t.changes)o.applyEdit(e.range,e.text);this._model.setSemanticTokens(e,!0)}else this._model.setSemanticTokens(null,!0);r()}else this._model.setSemanticTokens(null,!1)}};ModelSemanticColoring.REQUEST_MIN_DELAY=300,ModelSemanticColoring.REQUEST_MAX_DELAY=2e3,ModelSemanticColoring=__decorate([__param(2,IThemeService),__param(3,ILanguageFeatureDebounceService)],ModelSemanticColoring);export{ModelSemanticColoring};