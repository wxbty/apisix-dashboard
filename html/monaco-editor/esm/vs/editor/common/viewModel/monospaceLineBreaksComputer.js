import*as strings from"../../../base/common/strings.js";import{CharacterClassifier}from"../core/characterClassifier.js";import{LineInjectedText}from"../textModelEvents.js";import{ModelLineProjectionData}from"./modelLineProjectionData.js";export class MonospaceLineBreaksComputerFactory{constructor(e,t){this.classifier=new WrappingCharacterClassifier(e,t)}static create(e){return new MonospaceLineBreaksComputerFactory(e.get(120),e.get(119))}createLineBreaksComputer(e,t,r,a){const n=[],i=[],o=[];return{addRequest:(e,t,r)=>{n.push(e),i.push(t),o.push(r)},finalize:()=>{const s=e.typicalFullwidthCharacterWidth/e.typicalHalfwidthCharacterWidth,l=[];for(let e=0,c=n.length;e<c;e++){const c=i[e],h=o[e];!h||h.injectionOptions||c?l[e]=createLineBreaks(this.classifier,n[e],c,t,r,s,a):l[e]=createLineBreaksFromPreviousLineBreaks(this.classifier,h,n[e],t,r,s,a)}return arrPool1.length=0,arrPool2.length=0,l}}}}class WrappingCharacterClassifier extends CharacterClassifier{constructor(e,t){super(0);for(let r=0;r<e.length;r++)this.set(e.charCodeAt(r),1);for(let r=0;r<t.length;r++)this.set(t.charCodeAt(r),2)}get(e){return e>=0&&e<256?this._asciiMap[e]:e>=12352&&e<=12543||e>=13312&&e<=19903||e>=19968&&e<=40959?3:this._map.get(e)||this._defaultValue}}let arrPool1=[],arrPool2=[];function createLineBreaksFromPreviousLineBreaks(e,t,r,a,n,i,o){if(-1===n)return null;const s=r.length;if(s<=1)return null;const l=t.breakOffsets,c=t.breakOffsetsVisibleColumn,h=computeWrappedTextIndentLength(r,a,n,i,o),u=n-h,f=arrPool1,g=arrPool2;let d=0,p=0,C=0,m=n;const k=l.length;let b=0;if(b>=0){let e=Math.abs(c[b]-m);while(b+1<k){const t=Math.abs(c[b+1]-m);if(t>=e)break;e=t,b++}}while(b<k){let t=b<0?0:l[b],n=b<0?0:c[b];p>t&&(t=p,n=C);let o=0,h=0,L=0,W=0;if(n<=m){let C=n,k=0===t?0:r.charCodeAt(t-1),b=0===t?0:e.get(k),P=!0;for(let n=t;n<s;n++){const t=n,s=r.charCodeAt(n);let l,c;if(strings.isHighSurrogate(s)?(n++,l=0,c=2):(l=e.get(s),c=computeCharWidth(s,C,a,i)),t>p&&canBreak(k,b,s,l)&&(o=t,h=C),C+=c,C>m){t>p?(L=t,W=C-c):(L=n+1,W=C),C-h>u&&(o=0),P=!1;break}k=s,b=l}if(P){d>0&&(f[d]=l[l.length-1],g[d]=c[l.length-1],d++);break}}if(0===o){let s=n,l=r.charCodeAt(t),c=e.get(l),f=!1;for(let a=t-1;a>=p;a--){const t=a+1,n=r.charCodeAt(a);if(9===n){f=!0;break}let g,d;if(strings.isLowSurrogate(n)?(a--,g=0,d=2):(g=e.get(n),d=strings.isFullWidthCharacter(n)?i:1),s<=m){if(0===L&&(L=t,W=s),s<=m-u)break;if(canBreak(n,g,l,c)){o=t,h=s;break}}s-=d,l=n,c=g}if(0!==o){const e=u-(W-h);if(e<=a){const t=r.charCodeAt(L);let n;n=strings.isHighSurrogate(t)?2:computeCharWidth(t,W,a,i),e-n<0&&(o=0)}}if(f){b--;continue}}if(0===o&&(o=L,h=W),o<=p){const e=r.charCodeAt(p);strings.isHighSurrogate(e)?(o=p+2,h=C+2):(o=p+1,h=C+computeCharWidth(e,C,a,i))}p=o,f[d]=o,C=h,g[d]=h,d++,m=h+u;while(b<0||b<k&&c[b]<h)b++;let P=Math.abs(c[b]-m);while(b+1<k){const e=Math.abs(c[b+1]-m);if(e>=P)break;P=e,b++}}return 0===d?null:(f.length=d,g.length=d,arrPool1=t.breakOffsets,arrPool2=t.breakOffsetsVisibleColumn,t.breakOffsets=f,t.breakOffsetsVisibleColumn=g,t.wrappedTextIndentLength=h,t)}function createLineBreaks(e,t,r,a,n,i,o){const s=LineInjectedText.applyInjectedText(t,r);let l,c;if(r&&r.length>0?(l=r.map((e=>e.options)),c=r.map((e=>e.column-1))):(l=null,c=null),-1===n)return l?new ModelLineProjectionData(c,l,[s.length],[],0):null;const h=s.length;if(h<=1)return l?new ModelLineProjectionData(c,l,[s.length],[],0):null;const u=computeWrappedTextIndentLength(s,a,n,i,o),f=n-u,g=[],d=[];let p=0,C=0,m=0,k=n,b=s.charCodeAt(0),L=e.get(b),W=computeCharWidth(b,0,a,i),P=1;strings.isHighSurrogate(b)&&(W+=1,b=s.charCodeAt(1),L=e.get(b),P++);for(let j=P;j<h;j++){const t=j,r=s.charCodeAt(j);let n,o;strings.isHighSurrogate(r)?(j++,n=0,o=2):(n=e.get(r),o=computeCharWidth(r,W,a,i)),canBreak(b,L,r,n)&&(C=t,m=W),W+=o,W>k&&((0===C||W-m>f)&&(C=t,m=W-o),g[p]=C,d[p]=m,p++,k=m+f,C=0),b=r,L=n}return 0!==p||r&&0!==r.length?(g[p]=h,d[p]=W,new ModelLineProjectionData(c,l,g,d,u)):null}function computeCharWidth(e,t,r,a){return 9===e?r-t%r:strings.isFullWidthCharacter(e)||e<32?a:1}function tabCharacterWidth(e,t){return t-e%t}function canBreak(e,t,r,a){return 32!==r&&(2===t||3===t&&2!==a||1===a||3===a&&1!==t)}function computeWrappedTextIndentLength(e,t,r,a,n){let i=0;if(0!==n){const o=strings.firstNonWhitespaceIndex(e);if(-1!==o){for(let r=0;r<o;r++){const a=9===e.charCodeAt(r)?tabCharacterWidth(i,t):1;i+=a}const s=3===n?2:2===n?1:0;for(let e=0;e<s;e++){const e=tabCharacterWidth(i,t);i+=e}i+a>r&&(i=0)}}return i}