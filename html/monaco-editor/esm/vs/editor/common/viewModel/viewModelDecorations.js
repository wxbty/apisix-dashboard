import{Position}from"../core/position.js";import{Range}from"../core/range.js";import{InlineDecoration,ViewModelDecoration}from"./viewModel.js";import{filterValidationDecorations}from"../config/editorOptions.js";export class ViewModelDecorations{constructor(e,o,n,t,i){this.editorId=e,this.model=o,this.configuration=n,this._linesCollection=t,this._coordinatesConverter=i,this._decorationsCache=Object.create(null),this._cachedModelDecorationsResolver=null,this._cachedModelDecorationsResolverViewRange=null}_clearCachedModelDecorationsResolver(){this._cachedModelDecorationsResolver=null,this._cachedModelDecorationsResolverViewRange=null}dispose(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}reset(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}onModelDecorationsChanged(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}onLineMappingChanged(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}_getOrCreateViewModelDecoration(e){const o=e.id;let n=this._decorationsCache[o];if(!n){const t=e.range,i=e.options;let r;if(i.isWholeLine){const e=this._coordinatesConverter.convertModelPositionToViewPosition(new Position(t.startLineNumber,1),0),o=this._coordinatesConverter.convertModelPositionToViewPosition(new Position(t.endLineNumber,this.model.getLineMaxColumn(t.endLineNumber)),1);r=new Range(e.lineNumber,e.column,o.lineNumber,o.column)}else r=this._coordinatesConverter.convertModelRangeToViewRange(t,1);n=new ViewModelDecoration(r,i),this._decorationsCache[o]=n}return n}getDecorationsViewportData(e){let o=null!==this._cachedModelDecorationsResolver;return o=o&&e.equalsRange(this._cachedModelDecorationsResolverViewRange),o||(this._cachedModelDecorationsResolver=this._getDecorationsViewportData(e),this._cachedModelDecorationsResolverViewRange=e),this._cachedModelDecorationsResolver}_getDecorationsViewportData(e){const o=this._linesCollection.getDecorationsInRange(e,this.editorId,filterValidationDecorations(this.configuration.options)),n=e.startLineNumber,t=e.endLineNumber,i=[];let r=0;const s=[];for(let a=n;a<=t;a++)s[a-n]=[];for(let a=0,c=o.length;a<c;a++){const e=o[a],c=e.options;if(!isModelDecorationVisible(this.model,e))continue;const l=this._getOrCreateViewModelDecoration(e),d=l.range;if(i[r++]=l,c.inlineClassName){const e=new InlineDecoration(d,c.inlineClassName,c.inlineClassNameAffectsLetterSpacing?3:0),o=Math.max(n,d.startLineNumber),i=Math.min(t,d.endLineNumber);for(let t=o;t<=i;t++)s[t-n].push(e)}if(c.beforeContentClassName&&n<=d.startLineNumber&&d.startLineNumber<=t){const e=new InlineDecoration(new Range(d.startLineNumber,d.startColumn,d.startLineNumber,d.startColumn),c.beforeContentClassName,1);s[d.startLineNumber-n].push(e)}if(c.afterContentClassName&&n<=d.endLineNumber&&d.endLineNumber<=t){const e=new InlineDecoration(new Range(d.endLineNumber,d.endColumn,d.endLineNumber,d.endColumn),c.afterContentClassName,2);s[d.endLineNumber-n].push(e)}}return{decorations:i,inlineDecorations:s}}}export function isModelDecorationVisible(e,o){return(!o.options.hideInCommentTokens||!isModelDecorationInComment(e,o))&&(!o.options.hideInStringTokens||!isModelDecorationInString(e,o))}export function isModelDecorationInComment(e,o){return testTokensInRange(e,o.range,(e=>1===e))}export function isModelDecorationInString(e,o){return testTokensInRange(e,o.range,(e=>2===e))}function testTokensInRange(e,o,n){for(let t=o.startLineNumber;t<=o.endLineNumber;t++){const i=e.getLineTokens(t),r=t===o.startLineNumber,s=t===o.endLineNumber;let a=r?i.findTokenIndexAtOffset(o.startColumn-1):0;while(a<i.getCount()){if(s){const e=i.getStartOffset(a);if(e>o.endColumn-1)break}const e=n(i.getStandardTokenType(a));if(!e)return!1;a++}}return!0}