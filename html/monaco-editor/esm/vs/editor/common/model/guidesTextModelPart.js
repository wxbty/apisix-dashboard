import{ArrayQueue,findLast}from"../../../base/common/arrays.js";import*as strings from"../../../base/common/strings.js";import{CursorColumns}from"../core/cursorColumns.js";import{Range}from"../core/range.js";import{TextModelPart}from"./textModelPart.js";import{computeIndentLevel}from"./utils.js";import{HorizontalGuidesState,IndentGuide,IndentGuideHorizontalLine}from"../textModelGuides.js";export class GuidesTextModelPart extends TextModelPart{constructor(e,t){super(),this.textModel=e,this.languageConfigurationService=t}getLanguageConfiguration(e){return this.languageConfigurationService.getLanguageConfiguration(e)}_computeIndentLevel(e){return computeIndentLevel(this.textModel.getLineContent(e+1),this.textModel.getOptions().tabSize)}getActiveIndentGuide(e,t,n){this.assertNotDisposed();const i=this.textModel.getLineCount();if(e<1||e>i)throw new Error("Illegal value for lineNumber");const o=this.getLanguageConfiguration(this.textModel.getLanguageId()).foldingRules,s=Boolean(o&&o.offSide);let r=-2,l=-1,a=-2,u=-1;const d=e=>{if(-1!==r&&(-2===r||r>e-1)){r=-1,l=-1;for(let t=e-2;t>=0;t--){const e=this._computeIndentLevel(t);if(e>=0){r=t,l=e;break}}}if(-2===a){a=-1,u=-1;for(let t=e;t<i;t++){const e=this._computeIndentLevel(t);if(e>=0){a=t,u=e;break}}}};let g=-2,c=-1,m=-2,h=-1;const f=e=>{if(-2===g){g=-1,c=-1;for(let t=e-2;t>=0;t--){const e=this._computeIndentLevel(t);if(e>=0){g=t,c=e;break}}}if(-1!==m&&(-2===m||m<e-1)){m=-1,h=-1;for(let t=e;t<i;t++){const e=this._computeIndentLevel(t);if(e>=0){m=t,h=e;break}}}};let L=0,b=!0,v=0,C=!0,p=0,I=0;for(let N=0;b||C;N++){const o=e-N,r=e+N;N>1&&(o<1||o<t)&&(b=!1),N>1&&(r>i||r>n)&&(C=!1),N>5e4&&(b=!1,C=!1);let m=-1;if(b&&o>=1){const e=this._computeIndentLevel(o-1);e>=0?(a=o-1,u=e,m=Math.ceil(e/this.textModel.getOptions().indentSize)):(d(o),m=this._getIndentLevelForWhitespaceLine(s,l,u))}let M=-1;if(C&&r<=i){const e=this._computeIndentLevel(r-1);e>=0?(g=r-1,c=e,M=Math.ceil(e/this.textModel.getOptions().indentSize)):(f(r),M=this._getIndentLevelForWhitespaceLine(s,c,h))}if(0!==N){if(1===N){if(r<=i&&M>=0&&I+1===M){b=!1,L=r,v=r,p=M;continue}if(o>=1&&m>=0&&m-1===I){C=!1,L=o,v=o,p=m;continue}if(L=e,v=e,p=I,0===p)return{startLineNumber:L,endLineNumber:v,indent:p}}b&&(m>=p?L=o:b=!1),C&&(M>=p?v=r:C=!1)}else I=m}return{startLineNumber:L,endLineNumber:v,indent:p}}getLinesBracketGuides(e,t,n,i){var o,s,r,l,a;const u=[],d=this.textModel.bracketPairs.getBracketPairsInRangeWithMinIndentation(new Range(e,1,t,this.textModel.getLineMaxColumn(t)));let g;if(n&&d.length>0){const i=e<=n.lineNumber&&n.lineNumber<=t?d.filter((e=>Range.strictContainsPosition(e.range,n))):this.textModel.bracketPairs.getBracketPairsInRange(Range.fromPositions(n));g=null===(o=findLast(i,(e=>e.range.startLineNumber!==e.range.endLineNumber)))||void 0===o?void 0:o.range}const c=new ArrayQueue(d),m=new Array,h=new Array,f=new BracketPairGuidesClassNames;for(let L=e;L<=t;L++){let e=new Array;h.length>0&&(e=e.concat(h),h.length=0),u.push(e);for(const n of c.takeWhile((e=>e.openingBracketRange.startLineNumber<=L))||[]){if(n.range.startLineNumber===n.range.endLineNumber)continue;const e=Math.min(this.getVisibleColumnFromPosition(n.openingBracketRange.getStartPosition()),this.getVisibleColumnFromPosition(null!==(r=null===(s=n.closingBracketRange)||void 0===s?void 0:s.getStartPosition())&&void 0!==r?r:n.range.getEndPosition()),n.minVisibleColumnIndentation+1);let t=!1;if(n.closingBracketRange){const e=strings.firstNonWhitespaceIndex(this.textModel.getLineContent(n.closingBracketRange.startLineNumber));e<n.closingBracketRange.startColumn-1&&(t=!0)}const i=n.openingBracketRange.getStartPosition(),o=null!==(a=null===(l=n.closingBracketRange)||void 0===l?void 0:l.getStartPosition())&&void 0!==a?a:n.range.getEndPosition();void 0===n.closingBracketRange?m[n.nestingLevel]=null:m[n.nestingLevel]={nestingLevel:n.nestingLevel,guideVisibleColumn:e,start:i,visibleStartColumn:this.getVisibleColumnFromPosition(i),end:o,visibleEndColumn:this.getVisibleColumnFromPosition(o),bracketPair:n,renderHorizontalEndLineAtTheBottom:t}}for(const n of m){if(!n)continue;const t=g&&n.bracketPair.range.equalsRange(g),o=f.getInlineClassNameOfLevel(n.nestingLevel)+(i.highlightActive&&t?" "+f.activeClassName:"");(t&&i.horizontalGuides!==HorizontalGuidesState.Disabled||i.includeInactive&&i.horizontalGuides===HorizontalGuidesState.Enabled)&&(n.start.lineNumber===L&&n.guideVisibleColumn<n.visibleStartColumn&&e.push(new IndentGuide(n.guideVisibleColumn,o,new IndentGuideHorizontalLine(!1,n.start.column))),n.end.lineNumber===L+1&&n.guideVisibleColumn<n.visibleEndColumn&&h.push(new IndentGuide(n.guideVisibleColumn,o,new IndentGuideHorizontalLine(!n.renderHorizontalEndLineAtTheBottom,n.end.column))))}let t=Number.MAX_SAFE_INTEGER;for(let n=m.length-1;n>=0;n--){const o=m[n];if(!o)continue;const s=i.highlightActive&&g&&o.bracketPair.range.equalsRange(g),r=f.getInlineClassNameOfLevel(o.nestingLevel)+(s?" "+f.activeClassName:"");(s||i.includeInactive)&&o.renderHorizontalEndLineAtTheBottom&&o.end.lineNumber===L+1&&h.push(new IndentGuide(o.guideVisibleColumn,r,null)),o.end.lineNumber<=L||o.start.lineNumber>=L||(o.guideVisibleColumn>=t&&!s||(t=o.guideVisibleColumn,(s||i.includeInactive)&&e.push(new IndentGuide(o.guideVisibleColumn,r,null))))}e.sort(((e,t)=>e.visibleColumn-t.visibleColumn))}return u}getVisibleColumnFromPosition(e){return CursorColumns.visibleColumnFromColumn(this.textModel.getLineContent(e.lineNumber),e.column,this.textModel.getOptions().tabSize)+1}getLinesIndentGuides(e,t){this.assertNotDisposed();const n=this.textModel.getLineCount();if(e<1||e>n)throw new Error("Illegal value for startLineNumber");if(t<1||t>n)throw new Error("Illegal value for endLineNumber");const i=this.textModel.getOptions(),o=this.getLanguageConfiguration(this.textModel.getLanguageId()).foldingRules,s=Boolean(o&&o.offSide),r=new Array(t-e+1);let l=-2,a=-1,u=-2,d=-1;for(let g=e;g<=t;g++){const t=g-e,o=this._computeIndentLevel(g-1);if(o>=0)l=g-1,a=o,r[t]=Math.ceil(o/i.indentSize);else{if(-2===l){l=-1,a=-1;for(let e=g-2;e>=0;e--){const t=this._computeIndentLevel(e);if(t>=0){l=e,a=t;break}}}if(-1!==u&&(-2===u||u<g-1)){u=-1,d=-1;for(let e=g;e<n;e++){const t=this._computeIndentLevel(e);if(t>=0){u=e,d=t;break}}}r[t]=this._getIndentLevelForWhitespaceLine(s,a,d)}}return r}_getIndentLevelForWhitespaceLine(e,t,n){const i=this.textModel.getOptions();return-1===t||-1===n?0:t<n?1+Math.floor(t/i.indentSize):t===n||e?Math.ceil(n/i.indentSize):1+Math.floor(n/i.indentSize)}}export class BracketPairGuidesClassNames{constructor(){this.activeClassName="indent-active"}getInlineClassNameOfLevel(e){return"bracket-indent-guide lvl-"+e%30}}