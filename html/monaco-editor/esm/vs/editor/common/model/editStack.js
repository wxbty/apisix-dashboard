import*as nls from"../../../nls.js";import{onUnexpectedError}from"../../../base/common/errors.js";import{Selection}from"../core/selection.js";import{URI}from"../../../base/common/uri.js";import{TextChange,compressConsecutiveTextChanges}from"../core/textChange.js";import*as buffer from"../../../base/common/buffer.js";import{basename}from"../../../base/common/resources.js";function uriGetComparisonKey(t){return t.toString()}export class SingleModelEditStackData{constructor(t,e,i,s,n,r,a){this.beforeVersionId=t,this.afterVersionId=e,this.beforeEOL=i,this.afterEOL=s,this.beforeCursorState=n,this.afterCursorState=r,this.changes=a}static create(t,e){const i=t.getAlternativeVersionId(),s=getModelEOL(t);return new SingleModelEditStackData(i,i,s,s,e,e,[])}append(t,e,i,s,n){e.length>0&&(this.changes=compressConsecutiveTextChanges(this.changes,e)),this.afterEOL=i,this.afterVersionId=s,this.afterCursorState=n}static _writeSelectionsSize(t){return 4+16*(t?t.length:0)}static _writeSelections(t,e,i){if(buffer.writeUInt32BE(t,e?e.length:0,i),i+=4,e)for(const s of e)buffer.writeUInt32BE(t,s.selectionStartLineNumber,i),i+=4,buffer.writeUInt32BE(t,s.selectionStartColumn,i),i+=4,buffer.writeUInt32BE(t,s.positionLineNumber,i),i+=4,buffer.writeUInt32BE(t,s.positionColumn,i),i+=4;return i}static _readSelections(t,e,i){const s=buffer.readUInt32BE(t,e);e+=4;for(let n=0;n<s;n++){const s=buffer.readUInt32BE(t,e);e+=4;const n=buffer.readUInt32BE(t,e);e+=4;const r=buffer.readUInt32BE(t,e);e+=4;const a=buffer.readUInt32BE(t,e);e+=4,i.push(new Selection(s,n,r,a))}return e}serialize(){let t=10+SingleModelEditStackData._writeSelectionsSize(this.beforeCursorState)+SingleModelEditStackData._writeSelectionsSize(this.afterCursorState)+4;for(const s of this.changes)t+=s.writeSize();const e=new Uint8Array(t);let i=0;buffer.writeUInt32BE(e,this.beforeVersionId,i),i+=4,buffer.writeUInt32BE(e,this.afterVersionId,i),i+=4,buffer.writeUInt8(e,this.beforeEOL,i),i+=1,buffer.writeUInt8(e,this.afterEOL,i),i+=1,i=SingleModelEditStackData._writeSelections(e,this.beforeCursorState,i),i=SingleModelEditStackData._writeSelections(e,this.afterCursorState,i),buffer.writeUInt32BE(e,this.changes.length,i),i+=4;for(const s of this.changes)i=s.write(e,i);return e.buffer}static deserialize(t){const e=new Uint8Array(t);let i=0;const s=buffer.readUInt32BE(e,i);i+=4;const n=buffer.readUInt32BE(e,i);i+=4;const r=buffer.readUInt8(e,i);i+=1;const a=buffer.readUInt8(e,i);i+=1;const o=[];i=SingleModelEditStackData._readSelections(e,i,o);const d=[];i=SingleModelEditStackData._readSelections(e,i,d);const l=buffer.readUInt32BE(e,i);i+=4;const c=[];for(let h=0;h<l;h++)i=TextChange.read(e,i,c);return new SingleModelEditStackData(s,n,r,a,o,d,c)}}export class SingleModelEditStackElement{constructor(t,e){this.model=t,this._data=SingleModelEditStackData.create(t,e)}get type(){return 0}get resource(){return URI.isUri(this.model)?this.model:this.model.uri}get label(){return nls.localize("edit","Typing")}toString(){const t=this._data instanceof SingleModelEditStackData?this._data:SingleModelEditStackData.deserialize(this._data);return t.changes.map((t=>t.toString())).join(", ")}matchesResource(t){const e=URI.isUri(this.model)?this.model:this.model.uri;return e.toString()===t.toString()}setModel(t){this.model=t}canAppend(t){return this.model===t&&this._data instanceof SingleModelEditStackData}append(t,e,i,s,n){this._data instanceof SingleModelEditStackData&&this._data.append(t,e,i,s,n)}close(){this._data instanceof SingleModelEditStackData&&(this._data=this._data.serialize())}open(){this._data instanceof SingleModelEditStackData||(this._data=SingleModelEditStackData.deserialize(this._data))}undo(){if(URI.isUri(this.model))throw new Error("Invalid SingleModelEditStackElement");this._data instanceof SingleModelEditStackData&&(this._data=this._data.serialize());const t=SingleModelEditStackData.deserialize(this._data);this.model._applyUndo(t.changes,t.beforeEOL,t.beforeVersionId,t.beforeCursorState)}redo(){if(URI.isUri(this.model))throw new Error("Invalid SingleModelEditStackElement");this._data instanceof SingleModelEditStackData&&(this._data=this._data.serialize());const t=SingleModelEditStackData.deserialize(this._data);this.model._applyRedo(t.changes,t.afterEOL,t.afterVersionId,t.afterCursorState)}heapSize(){return this._data instanceof SingleModelEditStackData&&(this._data=this._data.serialize()),this._data.byteLength+168}}export class MultiModelEditStackElement{constructor(t,e){this.type=1,this.label=t,this._isOpen=!0,this._editStackElementsArr=e.slice(0),this._editStackElementsMap=new Map;for(const i of this._editStackElementsArr){const t=uriGetComparisonKey(i.resource);this._editStackElementsMap.set(t,i)}this._delegate=null}get resources(){return this._editStackElementsArr.map((t=>t.resource))}prepareUndoRedo(){if(this._delegate)return this._delegate.prepareUndoRedo(this)}matchesResource(t){const e=uriGetComparisonKey(t);return this._editStackElementsMap.has(e)}setModel(t){const e=uriGetComparisonKey(URI.isUri(t)?t:t.uri);this._editStackElementsMap.has(e)&&this._editStackElementsMap.get(e).setModel(t)}canAppend(t){if(!this._isOpen)return!1;const e=uriGetComparisonKey(t.uri);if(this._editStackElementsMap.has(e)){const i=this._editStackElementsMap.get(e);return i.canAppend(t)}return!1}append(t,e,i,s,n){const r=uriGetComparisonKey(t.uri),a=this._editStackElementsMap.get(r);a.append(t,e,i,s,n)}close(){this._isOpen=!1}open(){}undo(){this._isOpen=!1;for(const t of this._editStackElementsArr)t.undo()}redo(){for(const t of this._editStackElementsArr)t.redo()}heapSize(t){const e=uriGetComparisonKey(t);if(this._editStackElementsMap.has(e)){const t=this._editStackElementsMap.get(e);return t.heapSize()}return 0}split(){return this._editStackElementsArr}toString(){let t=[];for(const e of this._editStackElementsArr)t.push(`${basename(e.resource)}: ${e}`);return`{${t.join(", ")}}`}}function getModelEOL(t){const e=t.getEOL();return"\n"===e?0:1}export function isEditStackElement(t){return!!t&&(t instanceof SingleModelEditStackElement||t instanceof MultiModelEditStackElement)}export class EditStack{constructor(t,e){this._model=t,this._undoRedoService=e}pushStackElement(){const t=this._undoRedoService.getLastElement(this._model.uri);isEditStackElement(t)&&t.close()}popStackElement(){const t=this._undoRedoService.getLastElement(this._model.uri);isEditStackElement(t)&&t.open()}clear(){this._undoRedoService.removeElements(this._model.uri)}_getOrCreateEditStackElement(t){const e=this._undoRedoService.getLastElement(this._model.uri);if(isEditStackElement(e)&&e.canAppend(this._model))return e;const i=new SingleModelEditStackElement(this._model,t);return this._undoRedoService.pushElement(i),i}pushEOL(t){const e=this._getOrCreateEditStackElement(null);this._model.setEOL(t),e.append(this._model,[],getModelEOL(this._model),this._model.getAlternativeVersionId(),null)}pushEditOperation(t,e,i){const s=this._getOrCreateEditStackElement(t),n=this._model.applyEdits(e,!0),r=EditStack._computeCursorState(i,n),a=n.map(((t,e)=>({index:e,textChange:t.textChange})));return a.sort(((t,e)=>t.textChange.oldPosition===e.textChange.oldPosition?t.index-e.index:t.textChange.oldPosition-e.textChange.oldPosition)),s.append(this._model,a.map((t=>t.textChange)),getModelEOL(this._model),this._model.getAlternativeVersionId(),r),r}static _computeCursorState(t,e){try{return t?t(e):null}catch(i){return onUnexpectedError(i),null}}}