import{lengthAdd,lengthDiffNonNegative,lengthLessThanEqual,lengthToObj,toLength}from"./length.js";export class TextEditInfo{constructor(t,e,n){this.startOffset=t,this.endOffset=e,this.newLength=n}}export class BeforeEditPositionMapper{constructor(t,e){this.documentLength=e,this.nextEditIdx=0,this.deltaOldToNewLineCount=0,this.deltaOldToNewColumnCount=0,this.deltaLineIdxInOld=-1,this.edits=t.map((t=>TextEditInfoCache.from(t)))}getOffsetBeforeChange(t){return this.adjustNextEdit(t),this.translateCurToOld(t)}getDistanceToNextChange(t){this.adjustNextEdit(t);const e=this.edits[this.nextEditIdx],n=e?this.translateOldToCur(e.offsetObj):this.documentLength;return lengthDiffNonNegative(t,n)}translateOldToCur(t){return t.lineCount===this.deltaLineIdxInOld?toLength(t.lineCount+this.deltaOldToNewLineCount,t.columnCount+this.deltaOldToNewColumnCount):toLength(t.lineCount+this.deltaOldToNewLineCount,t.columnCount)}translateCurToOld(t){const e=lengthToObj(t);return e.lineCount-this.deltaOldToNewLineCount===this.deltaLineIdxInOld?toLength(e.lineCount-this.deltaOldToNewLineCount,e.columnCount-this.deltaOldToNewColumnCount):toLength(e.lineCount-this.deltaOldToNewLineCount,e.columnCount)}adjustNextEdit(t){while(this.nextEditIdx<this.edits.length){const e=this.edits[this.nextEditIdx],n=this.translateOldToCur(e.endOffsetAfterObj);if(!lengthLessThanEqual(n,t))break;{this.nextEditIdx++;const t=lengthToObj(n),o=lengthToObj(this.translateOldToCur(e.endOffsetBeforeObj)),i=t.lineCount-o.lineCount;this.deltaOldToNewLineCount+=i;const s=this.deltaLineIdxInOld===e.endOffsetBeforeObj.lineCount?this.deltaOldToNewColumnCount:0,l=t.columnCount-o.columnCount;this.deltaOldToNewColumnCount=s+l,this.deltaLineIdxInOld=e.endOffsetBeforeObj.lineCount}}}}class TextEditInfoCache{constructor(t,e,n){this.endOffsetBeforeObj=lengthToObj(e),this.endOffsetAfterObj=lengthToObj(lengthAdd(t,n)),this.offsetObj=lengthToObj(t)}static from(t){return new TextEditInfoCache(t.startOffset,t.endOffset,t.newLength)}}