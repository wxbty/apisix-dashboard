import{Emitter}from"../../../../base/common/event.js";import{Disposable,DisposableStore,MutableDisposable}from"../../../../base/common/lifecycle.js";import{BracketPairsTree}from"./bracketPairsTree/bracketPairsTree.js";import{ignoreBracketsInToken}from"../../languages/supports.js";import{BracketsUtils}from"../../languages/supports/richEditBrackets.js";export class BracketPairsTextModelPart extends Disposable{constructor(e,t){super(),this.textModel=e,this.languageConfigurationService=t,this.bracketPairsTree=this._register(new MutableDisposable),this.onDidChangeEmitter=new Emitter,this.onDidChange=this.onDidChangeEmitter.event,this.bracketsRequested=!1,this._register(e.onDidChangeOptions((e=>{this.bracketPairsTree.clear(),this.updateBracketPairsTree()}))),this._register(e.onDidChangeLanguage((e=>{this.bracketPairsTree.clear(),this.updateBracketPairsTree()}))),this._register(this.languageConfigurationService.onDidChange((e=>{var t;e.languageId&&!(null===(t=this.bracketPairsTree.value)||void 0===t?void 0:t.object.didLanguageChange(e.languageId))||(this.bracketPairsTree.clear(),this.updateBracketPairsTree())})))}get isDocumentSupported(){const e=5e6;return this.textModel.getValueLength()<=e}updateBracketPairsTree(){if(this.bracketsRequested&&this.isDocumentSupported){if(!this.bracketPairsTree.value){const e=new DisposableStore;this.bracketPairsTree.value=createDisposableRef(e.add(new BracketPairsTree(this.textModel,(e=>this.languageConfigurationService.getLanguageConfiguration(e)))),e),e.add(this.bracketPairsTree.value.object.onDidChange((e=>this.onDidChangeEmitter.fire(e)))),this.onDidChangeEmitter.fire()}}else this.bracketPairsTree.value&&(this.bracketPairsTree.clear(),this.onDidChangeEmitter.fire())}handleContentChanged(e){var t;null===(t=this.bracketPairsTree.value)||void 0===t||t.object.handleContentChanged(e)}getBracketPairsInRange(e){var t;return this.bracketsRequested=!0,this.updateBracketPairsTree(),(null===(t=this.bracketPairsTree.value)||void 0===t?void 0:t.object.getBracketPairsInRange(e,!1))||[]}getBracketPairsInRangeWithMinIndentation(e){var t;return this.bracketsRequested=!0,this.updateBracketPairsTree(),(null===(t=this.bracketPairsTree.value)||void 0===t?void 0:t.object.getBracketPairsInRange(e,!0))||[]}getBracketsInRange(e){var t;return this.bracketsRequested=!0,this.updateBracketPairsTree(),(null===(t=this.bracketPairsTree.value)||void 0===t?void 0:t.object.getBracketsInRange(e))||[]}findMatchingBracketUp(e,t){const n=e.toLowerCase(),r=this.textModel.validatePosition(t),a=this.textModel.getLanguageIdAtPosition(r.lineNumber,r.column),i=this.languageConfigurationService.getLanguageConfiguration(a).brackets;if(!i)return null;const s=i.textIsBracket[n];return s?stripBracketSearchCanceled(this._findMatchingBracketUp(s,r,null)):null}matchBracket(e){return this._matchBracket(this.textModel.validatePosition(e))}_establishBracketSearchOffsets(e,t,n,r){const a=t.getCount(),i=t.getLanguageId(r);let s=Math.max(0,e.column-1-n.maxBracketLength);for(let c=r-1;c>=0;c--){const e=t.getEndOffset(c);if(e<=s)break;if(ignoreBracketsInToken(t.getStandardTokenType(c))||t.getLanguageId(c)!==i){s=e;break}}let o=Math.min(t.getLineContent().length,e.column-1+n.maxBracketLength);for(let c=r+1;c<a;c++){const e=t.getStartOffset(c);if(e>=o)break;if(ignoreBracketsInToken(t.getStandardTokenType(c))||t.getLanguageId(c)!==i){o=e;break}}return{searchStartOffset:s,searchEndOffset:o}}_matchBracket(e){const t=e.lineNumber,n=this.textModel.getLineTokens(t),r=this.textModel.getLineContent(t),a=n.findTokenIndexAtOffset(e.column-1);if(a<0)return null;const i=this.languageConfigurationService.getLanguageConfiguration(n.getLanguageId(a)).brackets;if(i&&!ignoreBracketsInToken(n.getStandardTokenType(a))){let{searchStartOffset:s,searchEndOffset:o}=this._establishBracketSearchOffsets(e,n,i,a),c=null;while(1){const n=BracketsUtils.findNextBracketInRange(i.forwardRegex,t,r,s,o);if(!n)break;if(n.startColumn<=e.column&&e.column<=n.endColumn){const e=r.substring(n.startColumn-1,n.endColumn-1).toLowerCase(),t=this._matchFoundBracket(n,i.textIsBracket[e],i.textIsOpenBracket[e],null);if(t){if(t instanceof BracketSearchCanceled)return null;c=t}}s=n.endColumn-1}if(c)return c}if(a>0&&n.getStartOffset(a)===e.column-1){const i=a-1,s=this.languageConfigurationService.getLanguageConfiguration(n.getLanguageId(i)).brackets;if(s&&!ignoreBracketsInToken(n.getStandardTokenType(i))){const{searchStartOffset:a,searchEndOffset:o}=this._establishBracketSearchOffsets(e,n,s,i),c=BracketsUtils.findPrevBracketInRange(s.reversedRegex,t,r,a,o);if(c&&c.startColumn<=e.column&&e.column<=c.endColumn){const e=r.substring(c.startColumn-1,c.endColumn-1).toLowerCase(),t=this._matchFoundBracket(c,s.textIsBracket[e],s.textIsOpenBracket[e],null);if(t)return t instanceof BracketSearchCanceled?null:t}}}return null}_matchFoundBracket(e,t,n,r){if(!t)return null;const a=n?this._findMatchingBracketDown(t,e.getEndPosition(),r):this._findMatchingBracketUp(t,e.getStartPosition(),r);return a?a instanceof BracketSearchCanceled?a:[e,a]:null}_findMatchingBracketUp(e,t,n){const r=e.languageId,a=e.reversedRegex;let i=-1,s=0;const o=(t,r,o,c)=>{while(1){if(n&&++s%100===0&&!n())return BracketSearchCanceled.INSTANCE;const l=BracketsUtils.findPrevBracketInRange(a,t,r,o,c);if(!l)break;const g=r.substring(l.startColumn-1,l.endColumn-1).toLowerCase();if(e.isOpen(g)?i++:e.isClose(g)&&i--,0===i)return l;c=l.startColumn-1}return null};for(let c=t.lineNumber;c>=1;c--){const e=this.textModel.getLineTokens(c),n=e.getCount(),a=this.textModel.getLineContent(c);let i=n-1,s=a.length,l=a.length;c===t.lineNumber&&(i=e.findTokenIndexAtOffset(t.column-1),s=t.column-1,l=t.column-1);let g=!0;for(;i>=0;i--){const t=e.getLanguageId(i)===r&&!ignoreBracketsInToken(e.getStandardTokenType(i));if(t)g?s=e.getStartOffset(i):(s=e.getStartOffset(i),l=e.getEndOffset(i));else if(g&&s!==l){const e=o(c,a,s,l);if(e)return e}g=t}if(g&&s!==l){const e=o(c,a,s,l);if(e)return e}}return null}_findMatchingBracketDown(e,t,n){const r=e.languageId,a=e.forwardRegex;let i=1,s=0;const o=(t,r,o,c)=>{while(1){if(n&&++s%100===0&&!n())return BracketSearchCanceled.INSTANCE;const l=BracketsUtils.findNextBracketInRange(a,t,r,o,c);if(!l)break;const g=r.substring(l.startColumn-1,l.endColumn-1).toLowerCase();if(e.isOpen(g)?i++:e.isClose(g)&&i--,0===i)return l;o=l.endColumn-1}return null},c=this.textModel.getLineCount();for(let l=t.lineNumber;l<=c;l++){const e=this.textModel.getLineTokens(l),n=e.getCount(),a=this.textModel.getLineContent(l);let i=0,s=0,c=0;l===t.lineNumber&&(i=e.findTokenIndexAtOffset(t.column-1),s=t.column-1,c=t.column-1);let g=!0;for(;i<n;i++){const t=e.getLanguageId(i)===r&&!ignoreBracketsInToken(e.getStandardTokenType(i));if(t)g||(s=e.getStartOffset(i)),c=e.getEndOffset(i);else if(g&&s!==c){const e=o(l,a,s,c);if(e)return e}g=t}if(g&&s!==c){const e=o(l,a,s,c);if(e)return e}}return null}findPrevBracket(e){const t=this.textModel.validatePosition(e);let n=null,r=null;for(let a=t.lineNumber;a>=1;a--){const e=this.textModel.getLineTokens(a),i=e.getCount(),s=this.textModel.getLineContent(a);let o=i-1,c=s.length,l=s.length;if(a===t.lineNumber){o=e.findTokenIndexAtOffset(t.column-1),c=t.column-1,l=t.column-1;const a=e.getLanguageId(o);n!==a&&(n=a,r=this.languageConfigurationService.getLanguageConfiguration(n).brackets)}let g=!0;for(;o>=0;o--){const t=e.getLanguageId(o);if(n!==t){if(r&&g&&c!==l){const e=BracketsUtils.findPrevBracketInRange(r.reversedRegex,a,s,c,l);if(e)return this._toFoundBracket(r,e);g=!1}n=t,r=this.languageConfigurationService.getLanguageConfiguration(n).brackets}const i=!!r&&!ignoreBracketsInToken(e.getStandardTokenType(o));if(i)g?c=e.getStartOffset(o):(c=e.getStartOffset(o),l=e.getEndOffset(o));else if(r&&g&&c!==l){const e=BracketsUtils.findPrevBracketInRange(r.reversedRegex,a,s,c,l);if(e)return this._toFoundBracket(r,e)}g=i}if(r&&g&&c!==l){const e=BracketsUtils.findPrevBracketInRange(r.reversedRegex,a,s,c,l);if(e)return this._toFoundBracket(r,e)}}return null}findNextBracket(e){const t=this.textModel.validatePosition(e),n=this.textModel.getLineCount();let r=null,a=null;for(let i=t.lineNumber;i<=n;i++){const e=this.textModel.getLineTokens(i),n=e.getCount(),s=this.textModel.getLineContent(i);let o=0,c=0,l=0;if(i===t.lineNumber){o=e.findTokenIndexAtOffset(t.column-1),c=t.column-1,l=t.column-1;const n=e.getLanguageId(o);r!==n&&(r=n,a=this.languageConfigurationService.getLanguageConfiguration(r).brackets)}let g=!0;for(;o<n;o++){const t=e.getLanguageId(o);if(r!==t){if(a&&g&&c!==l){const e=BracketsUtils.findNextBracketInRange(a.forwardRegex,i,s,c,l);if(e)return this._toFoundBracket(a,e);g=!1}r=t,a=this.languageConfigurationService.getLanguageConfiguration(r).brackets}const n=!!a&&!ignoreBracketsInToken(e.getStandardTokenType(o));if(n)g||(c=e.getStartOffset(o)),l=e.getEndOffset(o);else if(a&&g&&c!==l){const e=BracketsUtils.findNextBracketInRange(a.forwardRegex,i,s,c,l);if(e)return this._toFoundBracket(a,e)}g=n}if(a&&g&&c!==l){const e=BracketsUtils.findNextBracketInRange(a.forwardRegex,i,s,c,l);if(e)return this._toFoundBracket(a,e)}}return null}findEnclosingBrackets(e,t){let n;if("undefined"===typeof t)n=null;else{const e=Date.now();n=()=>Date.now()-e<=t}const r=this.textModel.validatePosition(e),a=this.textModel.getLineCount(),i=new Map;let s=[];const o=(e,t)=>{if(!i.has(e)){const n=[];for(let e=0,r=t?t.brackets.length:0;e<r;e++)n[e]=0;i.set(e,n)}s=i.get(e)};let c=0;const l=(e,t,r,a,i)=>{while(1){if(n&&++c%100===0&&!n())return BracketSearchCanceled.INSTANCE;const o=BracketsUtils.findNextBracketInRange(e.forwardRegex,t,r,a,i);if(!o)break;const l=r.substring(o.startColumn-1,o.endColumn-1).toLowerCase(),g=e.textIsBracket[l];if(g&&(g.isOpen(l)?s[g.index]++:g.isClose(l)&&s[g.index]--,-1===s[g.index]))return this._matchFoundBracket(o,g,!1,n);a=o.endColumn-1}return null};let g=null,u=null;for(let d=r.lineNumber;d<=a;d++){const e=this.textModel.getLineTokens(d),t=e.getCount(),n=this.textModel.getLineContent(d);let a=0,i=0,s=0;if(d===r.lineNumber){a=e.findTokenIndexAtOffset(r.column-1),i=r.column-1,s=r.column-1;const t=e.getLanguageId(a);g!==t&&(g=t,u=this.languageConfigurationService.getLanguageConfiguration(g).brackets,o(g,u))}let c=!0;for(;a<t;a++){const t=e.getLanguageId(a);if(g!==t){if(u&&c&&i!==s){const e=l(u,d,n,i,s);if(e)return stripBracketSearchCanceled(e);c=!1}g=t,u=this.languageConfigurationService.getLanguageConfiguration(g).brackets,o(g,u)}const r=!!u&&!ignoreBracketsInToken(e.getStandardTokenType(a));if(r)c||(i=e.getStartOffset(a)),s=e.getEndOffset(a);else if(u&&c&&i!==s){const e=l(u,d,n,i,s);if(e)return stripBracketSearchCanceled(e)}c=r}if(u&&c&&i!==s){const e=l(u,d,n,i,s);if(e)return stripBracketSearchCanceled(e)}}return null}_toFoundBracket(e,t){if(!t)return null;let n=this.textModel.getValueInRange(t);n=n.toLowerCase();const r=e.textIsBracket[n];return r?{range:t,open:r.open,close:r.close,isOpen:e.textIsOpenBracket[n]}:null}}function createDisposableRef(e,t){return{object:e,dispose:()=>null===t||void 0===t?void 0:t.dispose()}}class BracketSearchCanceled{constructor(){this._searchCanceledBrand=void 0}}function stripBracketSearchCanceled(e){return e instanceof BracketSearchCanceled?null:e}BracketSearchCanceled.INSTANCE=new BracketSearchCanceled;