import{createFastDomNode}from"../../../../base/browser/fastDomNode.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{ViewPart}from"../../view/viewPart.js";import{Position}from"../../../common/core/position.js";const invalidFunc=()=>{throw new Error("Invalid change accessor")};export class ViewZones extends ViewPart{constructor(e){super(e);const t=this._context.configuration.options,o=t.get(131);this._lineHeight=t.get(59),this._contentWidth=o.contentWidth,this._contentLeft=o.contentLeft,this.domNode=createFastDomNode(document.createElement("div")),this.domNode.setClassName("view-zones"),this.domNode.setPosition("absolute"),this.domNode.setAttribute("role","presentation"),this.domNode.setAttribute("aria-hidden","true"),this.marginDomNode=createFastDomNode(document.createElement("div")),this.marginDomNode.setClassName("margin-view-zones"),this.marginDomNode.setPosition("absolute"),this.marginDomNode.setAttribute("role","presentation"),this.marginDomNode.setAttribute("aria-hidden","true"),this._zones={}}dispose(){super.dispose(),this._zones={}}_recomputeWhitespacesProps(){const e=this._context.viewLayout.getWhitespaces(),t=new Map;for(const i of e)t.set(i.id,i);let o=!1;return this._context.model.changeWhitespace((e=>{const i=Object.keys(this._zones);for(let n=0,s=i.length;n<s;n++){const s=i[n],r=this._zones[s],d=this._computeWhitespaceProps(r.delegate);r.isInHiddenArea=d.isInHiddenArea;const a=t.get(s);!a||a.afterLineNumber===d.afterViewLineNumber&&a.height===d.heightInPx||(e.changeOneWhitespace(s,d.afterViewLineNumber,d.heightInPx),this._safeCallOnComputedHeight(r.delegate,d.heightInPx),o=!0)}})),o}onConfigurationChanged(e){const t=this._context.configuration.options,o=t.get(131);return this._lineHeight=t.get(59),this._contentWidth=o.contentWidth,this._contentLeft=o.contentLeft,e.hasChanged(59)&&this._recomputeWhitespacesProps(),!0}onLineMappingChanged(e){return this._recomputeWhitespacesProps()}onLinesDeleted(e){return!0}onScrollChanged(e){return e.scrollTopChanged||e.scrollWidthChanged}onZonesChanged(e){return!0}onLinesInserted(e){return!0}_getZoneOrdinal(e){return"undefined"!==typeof e.afterColumn?e.afterColumn:1e4}_computeWhitespaceProps(e){if(0===e.afterLineNumber)return{isInHiddenArea:!1,afterViewLineNumber:0,heightInPx:this._heightInPixels(e),minWidthInPx:this._minWidthInPixels(e)};let t,o;if("undefined"!==typeof e.afterColumn)t=this._context.model.validateModelPosition({lineNumber:e.afterLineNumber,column:e.afterColumn});else{const o=this._context.model.validateModelPosition({lineNumber:e.afterLineNumber,column:1}).lineNumber;t=new Position(o,this._context.model.getModelLineMaxColumn(o))}o=t.column===this._context.model.getModelLineMaxColumn(t.lineNumber)?this._context.model.validateModelPosition({lineNumber:t.lineNumber+1,column:1}):this._context.model.validateModelPosition({lineNumber:t.lineNumber,column:t.column+1});const i=this._context.model.coordinatesConverter.convertModelPositionToViewPosition(t,e.afterColumnAffinity),n=this._context.model.coordinatesConverter.modelPositionIsVisible(o);return{isInHiddenArea:!n,afterViewLineNumber:i.lineNumber,heightInPx:n?this._heightInPixels(e):0,minWidthInPx:this._minWidthInPixels(e)}}changeViewZones(e){let t=!1;return this._context.model.changeWhitespace((o=>{const i={addZone:e=>(t=!0,this._addZone(o,e)),removeZone:e=>{e&&(t=this._removeZone(o,e)||t)},layoutZone:e=>{e&&(t=this._layoutZone(o,e)||t)}};safeInvoke1Arg(e,i),i.addZone=invalidFunc,i.removeZone=invalidFunc,i.layoutZone=invalidFunc})),t}_addZone(e,t){const o=this._computeWhitespaceProps(t),i=e.insertWhitespace(o.afterViewLineNumber,this._getZoneOrdinal(t),o.heightInPx,o.minWidthInPx),n={whitespaceId:i,delegate:t,isInHiddenArea:o.isInHiddenArea,isVisible:!1,domNode:createFastDomNode(t.domNode),marginDomNode:t.marginDomNode?createFastDomNode(t.marginDomNode):null};return this._safeCallOnComputedHeight(n.delegate,o.heightInPx),n.domNode.setPosition("absolute"),n.domNode.domNode.style.width="100%",n.domNode.setDisplay("none"),n.domNode.setAttribute("monaco-view-zone",n.whitespaceId),this.domNode.appendChild(n.domNode),n.marginDomNode&&(n.marginDomNode.setPosition("absolute"),n.marginDomNode.domNode.style.width="100%",n.marginDomNode.setDisplay("none"),n.marginDomNode.setAttribute("monaco-view-zone",n.whitespaceId),this.marginDomNode.appendChild(n.marginDomNode)),this._zones[n.whitespaceId]=n,this.setShouldRender(),n.whitespaceId}_removeZone(e,t){if(this._zones.hasOwnProperty(t)){const o=this._zones[t];return delete this._zones[t],e.removeWhitespace(o.whitespaceId),o.domNode.removeAttribute("monaco-visible-view-zone"),o.domNode.removeAttribute("monaco-view-zone"),o.domNode.domNode.parentNode.removeChild(o.domNode.domNode),o.marginDomNode&&(o.marginDomNode.removeAttribute("monaco-visible-view-zone"),o.marginDomNode.removeAttribute("monaco-view-zone"),o.marginDomNode.domNode.parentNode.removeChild(o.marginDomNode.domNode)),this.setShouldRender(),!0}return!1}_layoutZone(e,t){if(this._zones.hasOwnProperty(t)){const o=this._zones[t],i=this._computeWhitespaceProps(o.delegate);return o.isInHiddenArea=i.isInHiddenArea,e.changeOneWhitespace(o.whitespaceId,i.afterViewLineNumber,i.heightInPx),this._safeCallOnComputedHeight(o.delegate,i.heightInPx),this.setShouldRender(),!0}return!1}shouldSuppressMouseDownOnViewZone(e){if(this._zones.hasOwnProperty(e)){const t=this._zones[e];return Boolean(t.delegate.suppressMouseDown)}return!1}_heightInPixels(e){return"number"===typeof e.heightInPx?e.heightInPx:"number"===typeof e.heightInLines?this._lineHeight*e.heightInLines:this._lineHeight}_minWidthInPixels(e){return"number"===typeof e.minWidthInPx?e.minWidthInPx:0}_safeCallOnComputedHeight(e,t){if("function"===typeof e.onComputedHeight)try{e.onComputedHeight(t)}catch(o){onUnexpectedError(o)}}_safeCallOnDomNodeTop(e,t){if("function"===typeof e.onDomNodeTop)try{e.onDomNodeTop(t)}catch(o){onUnexpectedError(o)}}prepareRender(e){}render(e){const t=e.viewportData.whitespaceViewportData,o={};let i=!1;for(const s of t)this._zones[s.id].isInHiddenArea||(o[s.id]=s,i=!0);const n=Object.keys(this._zones);for(let s=0,r=n.length;s<r;s++){const t=n[s],i=this._zones[t];let r=0,d=0,a="none";o.hasOwnProperty(t)?(r=o[t].verticalOffset-e.bigNumbersDelta,d=o[t].height,a="block",i.isVisible||(i.domNode.setAttribute("monaco-visible-view-zone","true"),i.isVisible=!0),this._safeCallOnDomNodeTop(i.delegate,e.getScrolledTopFromAbsoluteTop(o[t].verticalOffset))):(i.isVisible&&(i.domNode.removeAttribute("monaco-visible-view-zone"),i.isVisible=!1),this._safeCallOnDomNodeTop(i.delegate,e.getScrolledTopFromAbsoluteTop(-1e6))),i.domNode.setTop(r),i.domNode.setHeight(d),i.domNode.setDisplay(a),i.marginDomNode&&(i.marginDomNode.setTop(r),i.marginDomNode.setHeight(d),i.marginDomNode.setDisplay(a))}i&&(this.domNode.setWidth(Math.max(e.scrollWidth,this._contentWidth)),this.marginDomNode.setWidth(this._contentLeft))}}function safeInvoke1Arg(e,t){try{return e(t)}catch(o){onUnexpectedError(o)}}