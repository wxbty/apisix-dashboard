import"./lineNumbers.css";import*as platform from"../../../../base/common/platform.js";import{DynamicViewOverlay}from"../../view/dynamicViewOverlay.js";import{Position}from"../../../common/core/position.js";import{editorActiveLineNumber,editorLineNumbers}from"../../../common/core/editorColorRegistry.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";export class LineNumbersOverlay extends DynamicViewOverlay{constructor(e){super(),this._context=e,this._readConfig(),this._lastCursorModelPosition=new Position(1,1),this._renderResult=null,this._activeLineNumber=1,this._context.addEventHandler(this)}_readConfig(){const e=this._context.configuration.options;this._lineHeight=e.get(59);const i=e.get(60);this._renderLineNumbers=i.renderType,this._renderCustomLineNumbers=i.renderFn,this._renderFinalNewline=e.get(84);const t=e.get(131);this._lineNumbersLeft=t.lineNumbersLeft,this._lineNumbersWidth=t.lineNumbersWidth}dispose(){this._context.removeEventHandler(this),this._renderResult=null,super.dispose()}onConfigurationChanged(e){return this._readConfig(),!0}onCursorStateChanged(e){const i=e.selections[0].getPosition();this._lastCursorModelPosition=this._context.model.coordinatesConverter.convertViewPositionToModelPosition(i);let t=!1;return this._activeLineNumber!==i.lineNumber&&(this._activeLineNumber=i.lineNumber,t=!0),2!==this._renderLineNumbers&&3!==this._renderLineNumbers||(t=!0),t}onFlushed(e){return!0}onLinesChanged(e){return!0}onLinesDeleted(e){return!0}onLinesInserted(e){return!0}onScrollChanged(e){return e.scrollTopChanged}onZonesChanged(e){return!0}_getLineRenderLineNumber(e){const i=this._context.model.coordinatesConverter.convertViewPositionToModelPosition(new Position(e,1));if(1!==i.column)return"";const t=i.lineNumber;if(this._renderCustomLineNumbers)return this._renderCustomLineNumbers(t);if(2===this._renderLineNumbers){const e=Math.abs(this._lastCursorModelPosition.lineNumber-t);return 0===e?'<span class="relative-current-line-number">'+t+"</span>":String(e)}return 3===this._renderLineNumbers?this._lastCursorModelPosition.lineNumber===t||t%10===0?String(t):"":String(t)}prepareRender(e){if(0===this._renderLineNumbers)return void(this._renderResult=null);const i=platform.isLinux?this._lineHeight%2===0?" lh-even":" lh-odd":"",t=e.visibleRange.startLineNumber,n=e.visibleRange.endLineNumber,r='<div class="'+LineNumbersOverlay.CLASS_NAME+i+'" style="left:'+this._lineNumbersLeft+"px;width:"+this._lineNumbersWidth+'px;">',s=this._context.model.getLineCount(),o=[];for(let l=t;l<=n;l++){const e=l-t;if(!this._renderFinalNewline&&l===s&&0===this._context.model.getLineLength(l)){o[e]="";continue}const n=this._getLineRenderLineNumber(l);n?l===this._activeLineNumber?o[e]='<div class="active-line-number '+LineNumbersOverlay.CLASS_NAME+i+'" style="left:'+this._lineNumbersLeft+"px;width:"+this._lineNumbersWidth+'px;">'+n+"</div>":o[e]=r+n+"</div>":o[e]=""}this._renderResult=o}render(e,i){if(!this._renderResult)return"";const t=i-e;return t<0||t>=this._renderResult.length?"":this._renderResult[t]}}LineNumbersOverlay.CLASS_NAME="line-numbers",registerThemingParticipant(((e,i)=>{const t=e.getColor(editorLineNumbers);t&&i.addRule(`.monaco-editor .line-numbers { color: ${t}; }`);const n=e.getColor(editorActiveLineNumber);n&&i.addRule(`.monaco-editor .line-numbers.active-line-number { color: ${n}; }`)}));