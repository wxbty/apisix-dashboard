import*as dom from"../../../../base/browser/dom.js";import{createFastDomNode}from"../../../../base/browser/fastDomNode.js";import*as strings from"../../../../base/common/strings.js";import{applyFontInfo}from"../../config/domFontInfo.js";import{TextEditorCursorStyle}from"../../../common/config/editorOptions.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{MOUSE_CURSOR_TEXT_CSS_CLASS_NAME}from"../../../../base/browser/ui/mouseCursor/mouseCursor.js";class ViewCursorRenderData{constructor(t,e,i,o,s,r){this.top=t,this.left=e,this.width=i,this.height=o,this.textContent=s,this.textContentClassName=r}}export class ViewCursor{constructor(t){this._context=t;const e=this._context.configuration.options,i=e.get(44);this._cursorStyle=e.get(24),this._lineHeight=e.get(59),this._typicalHalfwidthCharacterWidth=i.typicalHalfwidthCharacterWidth,this._lineCursorWidth=Math.min(e.get(27),this._typicalHalfwidthCharacterWidth),this._isVisible=!0,this._domNode=createFastDomNode(document.createElement("div")),this._domNode.setClassName(`cursor ${MOUSE_CURSOR_TEXT_CSS_CLASS_NAME}`),this._domNode.setHeight(this._lineHeight),this._domNode.setTop(0),this._domNode.setLeft(0),applyFontInfo(this._domNode,i),this._domNode.setDisplay("none"),this._position=new Position(1,1),this._lastRenderedContent="",this._renderData=null}getDomNode(){return this._domNode}getPosition(){return this._position}show(){this._isVisible||(this._domNode.setVisibility("inherit"),this._isVisible=!0)}hide(){this._isVisible&&(this._domNode.setVisibility("hidden"),this._isVisible=!1)}onConfigurationChanged(t){const e=this._context.configuration.options,i=e.get(44);return this._cursorStyle=e.get(24),this._lineHeight=e.get(59),this._typicalHalfwidthCharacterWidth=i.typicalHalfwidthCharacterWidth,this._lineCursorWidth=Math.min(e.get(27),this._typicalHalfwidthCharacterWidth),applyFontInfo(this._domNode,i),!0}onCursorPositionChanged(t){return this._position=t,!0}_getGraphemeAwarePosition(){const{lineNumber:t,column:e}=this._position,i=this._context.model.getLineContent(t),[o,s]=strings.getCharContainingOffset(i,e-1);return[new Position(t,o+1),i.substring(o,s)]}_prepareRender(t){let e="";const[i,o]=this._getGraphemeAwarePosition();if(this._cursorStyle===TextEditorCursorStyle.Line||this._cursorStyle===TextEditorCursorStyle.LineThin){const s=t.visibleRangeForPosition(i);if(!s||s.outsideRenderedLine)return null;let r;this._cursorStyle===TextEditorCursorStyle.Line?(r=dom.computeScreenAwareSize(this._lineCursorWidth>0?this._lineCursorWidth:2),r>2&&(e=o)):r=dom.computeScreenAwareSize(1);let n=s.left;r>=2&&n>=1&&(n-=1);const h=t.getVerticalOffsetForLineNumber(i.lineNumber)-t.bigNumbersDelta;return new ViewCursorRenderData(h,n,r,this._lineHeight,e,"")}const s=t.linesVisibleRangesForRange(new Range(i.lineNumber,i.column,i.lineNumber,i.column+o.length),!1);if(!s||0===s.length)return null;const r=s[0];if(r.outsideRenderedLine||0===r.ranges.length)return null;const n=r.ranges[0],h=n.width<1?this._typicalHalfwidthCharacterWidth:n.width;let d="";if(this._cursorStyle===TextEditorCursorStyle.Block){const t=this._context.model.getViewLineData(i.lineNumber);e=o;const s=t.tokens.findTokenIndexAtOffset(i.column-1);d=t.tokens.getClassName(s)}let a=t.getVerticalOffsetForLineNumber(i.lineNumber)-t.bigNumbersDelta,l=this._lineHeight;return this._cursorStyle!==TextEditorCursorStyle.Underline&&this._cursorStyle!==TextEditorCursorStyle.UnderlineThin||(a+=this._lineHeight-2,l=2),new ViewCursorRenderData(a,n.left,h,l,e,d)}prepareRender(t){this._renderData=this._prepareRender(t)}render(t){return this._renderData?(this._lastRenderedContent!==this._renderData.textContent&&(this._lastRenderedContent=this._renderData.textContent,this._domNode.domNode.textContent=this._lastRenderedContent),this._domNode.setClassName(`cursor ${MOUSE_CURSOR_TEXT_CSS_CLASS_NAME} ${this._renderData.textContentClassName}`),this._domNode.setDisplay("block"),this._domNode.setTop(this._renderData.top),this._domNode.setLeft(this._renderData.left),this._domNode.setWidth(this._renderData.width),this._domNode.setLineHeight(this._renderData.height),this._domNode.setHeight(this._renderData.height),{domNode:this._domNode.domNode,position:this._position,contentLeft:this._renderData.left,height:this._renderData.height,width:2}):(this._domNode.setDisplay("none"),null)}}