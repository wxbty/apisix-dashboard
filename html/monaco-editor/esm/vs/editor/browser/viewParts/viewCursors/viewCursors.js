import"./viewCursors.css";import{createFastDomNode}from"../../../../base/browser/fastDomNode.js";import{IntervalTimer,TimeoutTimer}from"../../../../base/common/async.js";import{ViewPart}from"../../view/viewPart.js";import{ViewCursor}from"./viewCursor.js";import{TextEditorCursorStyle}from"../../../common/config/editorOptions.js";import{editorCursorBackground,editorCursorForeground}from"../../../common/core/editorColorRegistry.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";export class ViewCursors extends ViewPart{constructor(r){super(r);const s=this._context.configuration.options;this._readOnly=s.get(81),this._cursorBlinking=s.get(22),this._cursorStyle=s.get(24),this._cursorSmoothCaretAnimation=s.get(23),this._selectionIsEmpty=!0,this._isComposingInput=!1,this._isVisible=!1,this._primaryCursor=new ViewCursor(this._context),this._secondaryCursors=[],this._renderData=[],this._domNode=createFastDomNode(document.createElement("div")),this._domNode.setAttribute("role","presentation"),this._domNode.setAttribute("aria-hidden","true"),this._updateDomClassName(),this._domNode.appendChild(this._primaryCursor.getDomNode()),this._startCursorBlinkAnimation=new TimeoutTimer,this._cursorFlatBlinkInterval=new IntervalTimer,this._blinkingEnabled=!1,this._editorHasFocus=!1,this._updateBlinking()}dispose(){super.dispose(),this._startCursorBlinkAnimation.dispose(),this._cursorFlatBlinkInterval.dispose()}getDomNode(){return this._domNode}onCompositionStart(r){return this._isComposingInput=!0,this._updateBlinking(),!0}onCompositionEnd(r){return this._isComposingInput=!1,this._updateBlinking(),!0}onConfigurationChanged(r){const s=this._context.configuration.options;this._readOnly=s.get(81),this._cursorBlinking=s.get(22),this._cursorStyle=s.get(24),this._cursorSmoothCaretAnimation=s.get(23),this._updateBlinking(),this._updateDomClassName(),this._primaryCursor.onConfigurationChanged(r);for(let e=0,t=this._secondaryCursors.length;e<t;e++)this._secondaryCursors[e].onConfigurationChanged(r);return!0}_onCursorPositionChanged(r,s){if(this._primaryCursor.onCursorPositionChanged(r),this._updateBlinking(),this._secondaryCursors.length<s.length){const r=s.length-this._secondaryCursors.length;for(let s=0;s<r;s++){const r=new ViewCursor(this._context);this._domNode.domNode.insertBefore(r.getDomNode().domNode,this._primaryCursor.getDomNode().domNode.nextSibling),this._secondaryCursors.push(r)}}else if(this._secondaryCursors.length>s.length){const r=this._secondaryCursors.length-s.length;for(let s=0;s<r;s++)this._domNode.removeChild(this._secondaryCursors[0].getDomNode()),this._secondaryCursors.splice(0,1)}for(let e=0;e<s.length;e++)this._secondaryCursors[e].onCursorPositionChanged(s[e])}onCursorStateChanged(r){const s=[];for(let t=0,o=r.selections.length;t<o;t++)s[t]=r.selections[t].getPosition();this._onCursorPositionChanged(s[0],s.slice(1));const e=r.selections[0].isEmpty();return this._selectionIsEmpty!==e&&(this._selectionIsEmpty=e,this._updateDomClassName()),!0}onDecorationsChanged(r){return!0}onFlushed(r){return!0}onFocusChanged(r){return this._editorHasFocus=r.isFocused,this._updateBlinking(),!1}onLinesChanged(r){return!0}onLinesDeleted(r){return!0}onLinesInserted(r){return!0}onScrollChanged(r){return!0}onTokensChanged(r){const s=s=>{for(let e=0,t=r.ranges.length;e<t;e++)if(r.ranges[e].fromLineNumber<=s.lineNumber&&s.lineNumber<=r.ranges[e].toLineNumber)return!0;return!1};if(s(this._primaryCursor.getPosition()))return!0;for(const e of this._secondaryCursors)if(s(e.getPosition()))return!0;return!1}onZonesChanged(r){return!0}_getCursorBlinking(){return this._isComposingInput?0:this._editorHasFocus?this._readOnly?5:this._cursorBlinking:0}_updateBlinking(){this._startCursorBlinkAnimation.cancel(),this._cursorFlatBlinkInterval.cancel();const r=this._getCursorBlinking(),s=0===r,e=5===r;s?this._hide():this._show(),this._blinkingEnabled=!1,this._updateDomClassName(),s||e||(1===r?this._cursorFlatBlinkInterval.cancelAndSet((()=>{this._isVisible?this._hide():this._show()}),ViewCursors.BLINK_INTERVAL):this._startCursorBlinkAnimation.setIfNotSet((()=>{this._blinkingEnabled=!0,this._updateDomClassName()}),ViewCursors.BLINK_INTERVAL))}_updateDomClassName(){this._domNode.setClassName(this._getClassName())}_getClassName(){let r="cursors-layer";switch(this._selectionIsEmpty||(r+=" has-selection"),this._cursorStyle){case TextEditorCursorStyle.Line:r+=" cursor-line-style";break;case TextEditorCursorStyle.Block:r+=" cursor-block-style";break;case TextEditorCursorStyle.Underline:r+=" cursor-underline-style";break;case TextEditorCursorStyle.LineThin:r+=" cursor-line-thin-style";break;case TextEditorCursorStyle.BlockOutline:r+=" cursor-block-outline-style";break;case TextEditorCursorStyle.UnderlineThin:r+=" cursor-underline-thin-style";break;default:r+=" cursor-line-style"}if(this._blinkingEnabled)switch(this._getCursorBlinking()){case 1:r+=" cursor-blink";break;case 2:r+=" cursor-smooth";break;case 3:r+=" cursor-phase";break;case 4:r+=" cursor-expand";break;case 5:r+=" cursor-solid";break;default:r+=" cursor-solid"}else r+=" cursor-solid";return this._cursorSmoothCaretAnimation&&(r+=" cursor-smooth-caret-animation"),r}_show(){this._primaryCursor.show();for(let r=0,s=this._secondaryCursors.length;r<s;r++)this._secondaryCursors[r].show();this._isVisible=!0}_hide(){this._primaryCursor.hide();for(let r=0,s=this._secondaryCursors.length;r<s;r++)this._secondaryCursors[r].hide();this._isVisible=!1}prepareRender(r){this._primaryCursor.prepareRender(r);for(let s=0,e=this._secondaryCursors.length;s<e;s++)this._secondaryCursors[s].prepareRender(r)}render(r){const s=[];let e=0;const t=this._primaryCursor.render(r);t&&(s[e++]=t);for(let o=0,i=this._secondaryCursors.length;o<i;o++){const t=this._secondaryCursors[o].render(r);t&&(s[e++]=t)}this._renderData=s}getLastRenderData(){return this._renderData}}ViewCursors.BLINK_INTERVAL=500,registerThemingParticipant(((r,s)=>{const e=r.getColor(editorCursorForeground);if(e){let t=r.getColor(editorCursorBackground);t||(t=e.opposite()),s.addRule(`.monaco-editor .cursors-layer .cursor { background-color: ${e}; border-color: ${e}; color: ${t}; }`),"hc"===r.type&&s.addRule(`.monaco-editor .cursors-layer.has-selection .cursor { border-left: 1px solid ${t}; border-right: 1px solid ${t}; }`)}}));