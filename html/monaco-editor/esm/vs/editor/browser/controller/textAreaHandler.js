import"./textAreaHandler.css";import*as nls from"../../../nls.js";import*as browser from"../../../base/browser/browser.js";import{createFastDomNode}from"../../../base/browser/fastDomNode.js";import*as platform from"../../../base/common/platform.js";import*as strings from"../../../base/common/strings.js";import{applyFontInfo}from"../config/domFontInfo.js";import{CopyOptions,TextAreaInput,TextAreaWrapper}from"./textAreaInput.js";import{PagedScreenReaderStrategy,TextAreaState,_debugComposition}from"./textAreaState.js";import{PartFingerprints,ViewPart}from"../view/viewPart.js";import{LineNumbersOverlay}from"../viewParts/lineNumbers/lineNumbers.js";import{Margin}from"../viewParts/margin/margin.js";import{EditorOptions}from"../../common/config/editorOptions.js";import{getMapForWordSeparators}from"../../common/core/wordCharacterClassifier.js";import{Position}from"../../common/core/position.js";import{Range}from"../../common/core/range.js";import{Selection}from"../../common/core/selection.js";import{MOUSE_CURSOR_TEXT_CSS_CLASS_NAME}from"../../../base/browser/ui/mouseCursor/mouseCursor.js";import{TokenizationRegistry}from"../../common/languages.js";import{Color}from"../../../base/common/color.js";class VisibleTextAreaData{constructor(t,e,i,o,s){this._context=t,this.modelLineNumber=e,this.distanceToModelLineStart=i,this.widthOfHiddenLineTextBefore=o,this.distanceToModelLineEnd=s,this._visibleTextAreaBrand=void 0,this.startPosition=null,this.endPosition=null,this.visibleTextareaStart=null,this.visibleTextareaEnd=null}prepareRender(t){const e=new Position(this.modelLineNumber,this.distanceToModelLineStart+1),i=new Position(this.modelLineNumber,this._context.model.getModelLineMaxColumn(this.modelLineNumber)-this.distanceToModelLineEnd);this.startPosition=this._context.model.coordinatesConverter.convertModelPositionToViewPosition(e),this.endPosition=this._context.model.coordinatesConverter.convertModelPositionToViewPosition(i),this.startPosition.lineNumber===this.endPosition.lineNumber?(this.visibleTextareaStart=t.visibleRangeForPosition(this.startPosition),this.visibleTextareaEnd=t.visibleRangeForPosition(this.endPosition)):(this.visibleTextareaStart=null,this.visibleTextareaEnd=null)}}const canUseZeroSizeTextarea=browser.isFirefox;export class TextAreaHandler extends ViewPart{constructor(t,e,i){super(t),this._primaryCursorPosition=new Position(1,1),this._primaryCursorVisibleRange=null,this._viewController=e,this._visibleRangeProvider=i,this._scrollLeft=0,this._scrollTop=0;const o=this._context.configuration.options,s=o.get(131);this._setAccessibilityOptions(o),this._contentLeft=s.contentLeft,this._contentWidth=s.contentWidth,this._contentHeight=s.height,this._fontInfo=o.get(44),this._lineHeight=o.get(59),this._emptySelectionClipboard=o.get(32),this._copyWithSyntaxHighlighting=o.get(21),this._visibleTextArea=null,this._selections=[new Selection(1,1,1,1)],this._modelSelections=[new Selection(1,1,1,1)],this._lastRenderPosition=null,this.textArea=createFastDomNode(document.createElement("textarea")),PartFingerprints.write(this.textArea,6),this.textArea.setClassName(`inputarea ${MOUSE_CURSOR_TEXT_CSS_CLASS_NAME}`),this.textArea.setAttribute("wrap","off"),this.textArea.setAttribute("autocorrect","off"),this.textArea.setAttribute("autocapitalize","off"),this.textArea.setAttribute("autocomplete","off"),this.textArea.setAttribute("spellcheck","false"),this.textArea.setAttribute("aria-label",this._getAriaLabel(o)),this.textArea.setAttribute("tabindex",String(o.get(112))),this.textArea.setAttribute("role","textbox"),this.textArea.setAttribute("aria-roledescription",nls.localize("editor","editor")),this.textArea.setAttribute("aria-multiline","true"),this.textArea.setAttribute("aria-haspopup","false"),this.textArea.setAttribute("aria-autocomplete","both"),o.get(30)&&o.get(81)&&this.textArea.setAttribute("readonly","true"),this.textAreaCover=createFastDomNode(document.createElement("div")),this.textAreaCover.setPosition("absolute");const r={getLineCount:()=>this._context.model.getLineCount(),getLineMaxColumn:t=>this._context.model.getLineMaxColumn(t),getValueInRange:(t,e)=>this._context.model.getValueInRange(t,e)},n={getDataToCopy:()=>{const t=this._context.model.getPlainTextToCopy(this._modelSelections,this._emptySelectionClipboard,platform.isWindows),e=this._context.model.getEOL(),i=this._emptySelectionClipboard&&1===this._modelSelections.length&&this._modelSelections[0].isEmpty(),o=Array.isArray(t)?t:null,s=Array.isArray(t)?t.join(e):t;let r,n=null;if(CopyOptions.forceCopyWithSyntaxHighlighting||this._copyWithSyntaxHighlighting&&s.length<65536){const t=this._context.model.getRichTextToCopy(this._modelSelections,this._emptySelectionClipboard);t&&(r=t.html,n=t.mode)}return{isFromEmptySelection:i,multicursorText:o,text:s,html:r,mode:n}},getScreenReaderContent:t=>{if(1===this._accessibilitySupport){if(platform.isMacintosh){const t=this._selections[0];if(t.isEmpty()){const e=t.getStartPosition();let i=this._getWordBeforePosition(e);if(0===i.length&&(i=this._getCharacterBeforePosition(e)),i.length>0)return new TextAreaState(i,i.length,i.length,e,e)}}return TextAreaState.EMPTY}if(browser.isAndroid){const t=this._selections[0];if(t.isEmpty()){const e=t.getStartPosition(),[i,o]=this._getAndroidWordAtPosition(e);if(i.length>0)return new TextAreaState(i,o,o,e,e)}return TextAreaState.EMPTY}return PagedScreenReaderStrategy.fromEditorSelection(t,r,this._selections[0],this._accessibilityPageSize,0===this._accessibilitySupport)},deduceModelPosition:(t,e,i)=>this._context.model.deduceModelPositionRelativeToViewPosition(t,e,i)},a=this._register(new TextAreaWrapper(this.textArea.domNode));this._textAreaInput=this._register(new TextAreaInput(n,a,platform.OS,browser)),this._register(this._textAreaInput.onKeyDown((t=>{this._viewController.emitKeyDown(t)}))),this._register(this._textAreaInput.onKeyUp((t=>{this._viewController.emitKeyUp(t)}))),this._register(this._textAreaInput.onPaste((t=>{let e=!1,i=null,o=null;t.metadata&&(e=this._emptySelectionClipboard&&!!t.metadata.isFromEmptySelection,i="undefined"!==typeof t.metadata.multicursorText?t.metadata.multicursorText:null,o=t.metadata.mode),this._viewController.paste(t.text,e,i,o)}))),this._register(this._textAreaInput.onCut((()=>{this._viewController.cut()}))),this._register(this._textAreaInput.onType((t=>{t.replacePrevCharCnt||t.replaceNextCharCnt||t.positionDelta?(_debugComposition&&console.log(` => compositionType: <<${t.text}>>, ${t.replacePrevCharCnt}, ${t.replaceNextCharCnt}, ${t.positionDelta}`),this._viewController.compositionType(t.text,t.replacePrevCharCnt,t.replaceNextCharCnt,t.positionDelta)):(_debugComposition&&console.log(` => type: <<${t.text}>>`),this._viewController.type(t.text))}))),this._register(this._textAreaInput.onSelectionChangeRequest((t=>{this._viewController.setSelection(t)}))),this._register(this._textAreaInput.onCompositionStart((t=>{const e=this.textArea.domNode,i=this._modelSelections[0],{distanceToModelLineStart:o,widthOfHiddenTextBefore:s}=(()=>{const t=e.value.substring(0,Math.min(e.selectionStart,e.selectionEnd)),o=t.lastIndexOf("\n"),s=t.substring(o+1),r=s.lastIndexOf("\t"),n=s.length-r-1,a=i.getStartPosition(),l=Math.min(a.column-1,n),h=a.column-1-l,c=s.substring(0,s.length-l),d=measureText(c,this._fontInfo);return{distanceToModelLineStart:h,widthOfHiddenTextBefore:d}})(),{distanceToModelLineEnd:r}=(()=>{const t=e.value.substring(Math.max(e.selectionStart,e.selectionEnd)),o=t.indexOf("\n"),s=-1===o?t:t.substring(0,o),r=s.indexOf("\t"),n=-1===r?s.length:s.length-r-1,a=i.getEndPosition(),l=Math.min(this._context.model.getModelLineMaxColumn(a.lineNumber)-a.column,n),h=this._context.model.getModelLineMaxColumn(a.lineNumber)-a.column-l;return{distanceToModelLineEnd:h}})();this._context.model.revealRange("keyboard",!0,Range.fromPositions(this._selections[0].getStartPosition()),0,1),this._visibleTextArea=new VisibleTextAreaData(this._context,i.startLineNumber,o,s,r),this._visibleTextArea.prepareRender(this._visibleRangeProvider),this._render(),this.textArea.setClassName(`inputarea ${MOUSE_CURSOR_TEXT_CSS_CLASS_NAME} ime-input`),this._viewController.compositionStart(),this._context.model.onCompositionStart()}))),this._register(this._textAreaInput.onCompositionUpdate((t=>{this._visibleTextArea&&(this._visibleTextArea.prepareRender(this._visibleRangeProvider),this._render())}))),this._register(this._textAreaInput.onCompositionEnd((()=>{this._visibleTextArea=null,this._render(),this.textArea.setClassName(`inputarea ${MOUSE_CURSOR_TEXT_CSS_CLASS_NAME}`),this._viewController.compositionEnd(),this._context.model.onCompositionEnd()}))),this._register(this._textAreaInput.onFocus((()=>{this._context.model.setHasFocus(!0)}))),this._register(this._textAreaInput.onBlur((()=>{this._context.model.setHasFocus(!1)})))}dispose(){super.dispose()}_getAndroidWordAtPosition(t){const e='`~!@#$%^&*()-=+[{]}\\|;:",.<>/?',i=this._context.model.getLineContent(t.lineNumber),o=getMapForWordSeparators(e);let s=!0,r=t.column,n=!0,a=t.column,l=0;while(l<50&&(s||n)){if(s&&r<=1&&(s=!1),s){const t=i.charCodeAt(r-2),e=o.get(t);0!==e?s=!1:r--}if(n&&a>i.length&&(n=!1),n){const t=i.charCodeAt(a-1),e=o.get(t);0!==e?n=!1:a++}l++}return[i.substring(r-1,a-1),t.column-r]}_getWordBeforePosition(t){const e=this._context.model.getLineContent(t.lineNumber),i=getMapForWordSeparators(this._context.configuration.options.get(117));let o=t.column,s=0;while(o>1){const r=e.charCodeAt(o-2),n=i.get(r);if(0!==n||s>50)return e.substring(o-1,t.column-1);s++,o--}return e.substring(0,t.column-1)}_getCharacterBeforePosition(t){if(t.column>1){const e=this._context.model.getLineContent(t.lineNumber),i=e.charAt(t.column-2);if(!strings.isHighSurrogate(i.charCodeAt(0)))return i}return""}_getAriaLabel(t){const e=t.get(2);return 1===e?nls.localize("accessibilityOffAriaLabel","The editor is not accessible at this time. Press {0} for options.",platform.isLinux?"Shift+Alt+F1":"Alt+F1"):t.get(4)}_setAccessibilityOptions(t){this._accessibilitySupport=t.get(2);const e=t.get(3);2===this._accessibilitySupport&&e===EditorOptions.accessibilityPageSize.defaultValue?this._accessibilityPageSize=500:this._accessibilityPageSize=e}onConfigurationChanged(t){const e=this._context.configuration.options,i=e.get(131);return this._setAccessibilityOptions(e),this._contentLeft=i.contentLeft,this._contentWidth=i.contentWidth,this._contentHeight=i.height,this._fontInfo=e.get(44),this._lineHeight=e.get(59),this._emptySelectionClipboard=e.get(32),this._copyWithSyntaxHighlighting=e.get(21),this.textArea.setAttribute("aria-label",this._getAriaLabel(e)),this.textArea.setAttribute("tabindex",String(e.get(112))),(t.hasChanged(30)||t.hasChanged(81))&&(e.get(30)&&e.get(81)?this.textArea.setAttribute("readonly","true"):this.textArea.removeAttribute("readonly")),t.hasChanged(2)&&this._textAreaInput.writeScreenReaderContent("strategy changed"),!0}onCursorStateChanged(t){return this._selections=t.selections.slice(0),this._modelSelections=t.modelSelections.slice(0),this._textAreaInput.writeScreenReaderContent("selection changed"),!0}onDecorationsChanged(t){return!0}onFlushed(t){return!0}onLinesChanged(t){return!0}onLinesDeleted(t){return!0}onLinesInserted(t){return!0}onScrollChanged(t){return this._scrollLeft=t.scrollLeft,this._scrollTop=t.scrollTop,!0}onZonesChanged(t){return!0}isFocused(){return this._textAreaInput.isFocused()}focusTextArea(){this._textAreaInput.focusTextArea()}getLastRenderData(){return this._lastRenderPosition}setAriaOptions(t){t.activeDescendant?(this.textArea.setAttribute("aria-haspopup","true"),this.textArea.setAttribute("aria-autocomplete","list"),this.textArea.setAttribute("aria-activedescendant",t.activeDescendant)):(this.textArea.setAttribute("aria-haspopup","false"),this.textArea.setAttribute("aria-autocomplete","both"),this.textArea.removeAttribute("aria-activedescendant")),t.role&&this.textArea.setAttribute("role",t.role)}prepareRender(t){this._primaryCursorPosition=new Position(this._selections[0].positionLineNumber,this._selections[0].positionColumn),this._primaryCursorVisibleRange=t.visibleRangeForPosition(this._primaryCursorPosition),this._visibleTextArea&&this._visibleTextArea.prepareRender(t)}render(t){this._textAreaInput.writeScreenReaderContent("render"),this._render()}_render(){if(this._visibleTextArea){const t=this._visibleTextArea.visibleTextareaStart,e=this._visibleTextArea.visibleTextareaEnd,i=this._visibleTextArea.startPosition,o=this._visibleTextArea.endPosition;if(i&&o&&t&&e&&e.left>=this._scrollLeft&&t.left<=this._scrollLeft+this._contentWidth){const s=this._context.viewLayout.getVerticalOffsetForLineNumber(this._primaryCursorPosition.lineNumber)-this._scrollTop,r=this._newlinecount(this.textArea.domNode.value.substr(0,this.textArea.domNode.selectionStart));this.textArea.domNode.scrollTop=r*this._lineHeight;let n=this._visibleTextArea.widthOfHiddenLineTextBefore,a=this._contentLeft+t.left-this._scrollLeft,l=e.left-t.left;if(a<this._contentLeft){const t=this._contentLeft-a;a+=t,n+=t,l-=t}l>this._contentWidth&&(l=this._contentWidth),this.textArea.domNode.scrollLeft=n,this._renderInsideEditor(null,s,a,l,this._lineHeight);const h=this._context.model.getViewLineData(i.lineNumber),c=h.tokens.findTokenIndexAtOffset(i.column-1),d=h.tokens.findTokenIndexAtOffset(o.column-1);let u;u=c===d?h.tokens.getPresentation(c):{foreground:1,italic:!1,bold:!1,underline:!1,strikethrough:!1};const m=(TokenizationRegistry.getColorMap()||[])[u.foreground];this.textArea.domNode.style.color=m?Color.Format.CSS.formatHex(m):"inherit",this.textArea.domNode.style.fontStyle=u.italic?"italic":"inherit",u.bold&&(this.textArea.domNode.style.fontWeight="bold"),this.textArea.domNode.style.textDecoration=`${u.underline?" underline":""}${u.strikethrough?" line-through":""}`}return}if(!this._primaryCursorVisibleRange)return void this._renderAtTopLeft();const t=this._contentLeft+this._primaryCursorVisibleRange.left-this._scrollLeft;if(t<this._contentLeft||t>this._contentLeft+this._contentWidth)return void this._renderAtTopLeft();const e=this._context.viewLayout.getVerticalOffsetForLineNumber(this._selections[0].positionLineNumber)-this._scrollTop;if(e<0||e>this._contentHeight)this._renderAtTopLeft();else if(platform.isMacintosh){this._renderInsideEditor(this._primaryCursorPosition,e,t,canUseZeroSizeTextarea?0:1,this._lineHeight),this.textArea.domNode.scrollLeft=this._primaryCursorVisibleRange.left;const i=this._newlinecount(this.textArea.domNode.value.substr(0,this.textArea.domNode.selectionStart));this.textArea.domNode.scrollTop=i*this._lineHeight}else this._renderInsideEditor(this._primaryCursorPosition,e,t,canUseZeroSizeTextarea?0:1,canUseZeroSizeTextarea?0:1)}_newlinecount(t){let e=0,i=-1;do{if(i=t.indexOf("\n",i+1),-1===i)break;e++}while(1);return e}_renderInsideEditor(t,e,i,o,s){this._lastRenderPosition=t;const r=this.textArea,n=this.textAreaCover;applyFontInfo(r,this._fontInfo),r.setTop(e),r.setLeft(i),r.setWidth(o),r.setHeight(s),n.setTop(0),n.setLeft(0),n.setWidth(0),n.setHeight(0)}_renderAtTopLeft(){this._lastRenderPosition=null;const t=this.textArea,e=this.textAreaCover;if(applyFontInfo(t,this._fontInfo),t.setTop(0),t.setLeft(0),e.setTop(0),e.setLeft(0),canUseZeroSizeTextarea)return t.setWidth(0),t.setHeight(0),e.setWidth(0),void e.setHeight(0);t.setWidth(1),t.setHeight(1),e.setWidth(1),e.setHeight(1);const i=this._context.configuration.options;i.get(50)?e.setClassName("monaco-editor-background textAreaCover "+Margin.OUTER_CLASS_NAME):0!==i.get(60).renderType?e.setClassName("monaco-editor-background textAreaCover "+LineNumbersOverlay.CLASS_NAME):e.setClassName("monaco-editor-background textAreaCover")}}function measureText(t,e){if(0===t.length)return 0;const i=document.createElement("div");i.style.position="absolute",i.style.top="-50000px",i.style.width="50000px";const o=document.createElement("span");applyFontInfo(o,e),o.style.whiteSpace="pre",o.append(t),i.appendChild(o),document.body.appendChild(i);const s=o.offsetWidth;return document.body.removeChild(i),s}