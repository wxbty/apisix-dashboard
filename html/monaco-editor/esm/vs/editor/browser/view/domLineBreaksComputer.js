var _a;import{createStringBuilder}from"../../common/core/stringBuilder.js";import*as strings from"../../../base/common/strings.js";import{applyFontInfo}from"../config/domFontInfo.js";import{LineInjectedText}from"../../common/textModelEvents.js";import{ModelLineProjectionData}from"../../common/viewModel/modelLineProjectionData.js";const ttPolicy=null===(_a=window.trustedTypes)||void 0===_a?void 0:_a.createPolicy("domLineBreaksComputer",{createHTML:e=>e});export class DOMLineBreaksComputerFactory{static create(){return new DOMLineBreaksComputerFactory}constructor(){}createLineBreaksComputer(e,t,n,r){const i=[],o=[];return{addRequest:(e,t,n)=>{i.push(e),o.push(t)},finalize:()=>createLineBreaks(i,e,t,n,r,o)}}}function createLineBreaks(e,t,n,r,i,o){var a;function c(t){const n=o[t];if(n){const r=LineInjectedText.applyInjectedText(e[t],n),i=n.map((e=>e.options)),o=n.map((e=>e.column-1));return new ModelLineProjectionData(o,i,[r.length],[],0)}return null}if(-1===r){const t=[];for(let n=0,r=e.length;n<r;n++)t[n]=c(n);return t}const l=Math.round(r*t.typicalHalfwidthCharacterWidth),s=3===i?2:2===i?1:0,d=Math.round(n*s),p=Math.ceil(t.spaceWidth*d),u=document.createElement("div");applyFontInfo(u,t);const h=createStringBuilder(1e4),g=[],I=[],f=[],S=[],m=[];for(let v=0;v<e.length;v++){const r=LineInjectedText.applyInjectedText(e[v],o[v]);let a=0,c=0,s=l;if(0!==i)if(a=strings.firstNonWhitespaceIndex(r),-1===a)a=0;else{for(let t=0;t<a;t++){const e=9===r.charCodeAt(t)?n-c%n:1;c+=e}const e=Math.ceil(t.spaceWidth*c);e+t.typicalFullwidthCharacterWidth>l?(a=0,c=0):s=l-e}const d=r.substr(a),u=renderLine(d,c,n,s,h,p);g[v]=a,I[v]=c,f[v]=d,S[v]=u[0],m[v]=u[1]}const C=h.build(),y=null!==(a=null===ttPolicy||void 0===ttPolicy?void 0:ttPolicy.createHTML(C))&&void 0!==a?a:C;u.innerHTML=y,u.style.position="absolute",u.style.top="10000",u.style.wordWrap="break-word",document.body.appendChild(u);const A=document.createRange(),k=Array.prototype.slice.call(u.children,0),L=[];for(let v=0;v<e.length;v++){const e=k[v],t=readLineBreaks(A,e,f[v],S[v]);if(null===t){L[v]=c(v);continue}const n=g[v],r=I[v]+d,i=m[v],a=[];for(let o=0,c=t.length;o<c;o++)a[o]=i[t[o]];if(0!==n)for(let o=0,c=t.length;o<c;o++)t[o]+=n;let l,s;const p=o[v];p?(l=p.map((e=>e.options)),s=p.map((e=>e.column-1))):(l=null,s=null),L[v]=new ModelLineProjectionData(s,l,t,a,r)}return document.body.removeChild(u),L}function renderLine(e,t,n,r,i,o){if(0!==o){const e=String(o);i.appendASCIIString('<div style="text-indent: -'),i.appendASCIIString(e),i.appendASCIIString("px; padding-left: "),i.appendASCIIString(e),i.appendASCIIString("px; box-sizing: border-box; width:")}else i.appendASCIIString('<div style="width:');i.appendASCIIString(String(r)),i.appendASCIIString('px;">');const a=e.length;let c=t,l=0;const s=[],d=[];let p=0<a?e.charCodeAt(0):0;i.appendASCIIString("<span>");for(let u=0;u<a;u++){0!==u&&u%16384===0&&i.appendASCIIString("</span><span>"),s[u]=l,d[u]=c;const t=p;p=u+1<a?e.charCodeAt(u+1):0;let r=1,o=1;switch(t){case 9:r=n-c%n,o=r;for(let e=1;e<=r;e++)e<r?i.write1(160):i.appendASCII(32);break;case 32:32===p?i.write1(160):i.appendASCII(32);break;case 60:i.appendASCIIString("&lt;");break;case 62:i.appendASCIIString("&gt;");break;case 38:i.appendASCIIString("&amp;");break;case 0:i.appendASCIIString("&#00;");break;case 65279:case 8232:case 8233:case 133:i.write1(65533);break;default:strings.isFullWidthCharacter(t)&&o++,t<32?i.write1(9216+t):i.write1(t)}l+=r,c+=o}return i.appendASCIIString("</span>"),s[e.length]=l,d[e.length]=c,i.appendASCIIString("</div>"),[s,d]}function readLineBreaks(e,t,n,r){if(n.length<=1)return null;const i=Array.prototype.slice.call(t.children,0),o=[];try{discoverBreaks(e,i,r,0,null,n.length-1,null,o)}catch(a){return console.log(a),null}return 0===o.length?null:(o.push(n.length),o)}function discoverBreaks(e,t,n,r,i,o,a,c){if(r===o)return;if(i=i||readClientRect(e,t,n[r],n[r+1]),a=a||readClientRect(e,t,n[o],n[o+1]),Math.abs(i[0].top-a[0].top)<=.1)return;if(r+1===o)return void c.push(o);const l=r+(o-r)/2|0,s=readClientRect(e,t,n[l],n[l+1]);discoverBreaks(e,t,n,r,i,l,s,c),discoverBreaks(e,t,n,l,s,o,a,c)}function readClientRect(e,t,n,r){return e.setStart(t[n/16384|0].firstChild,n%16384),e.setEnd(t[r/16384|0].firstChild,r%16384),e.getClientRects()}