var __awaiter=this&&this.__awaiter||function(e,i,t,n){function o(e){return e instanceof t?e:new t((function(i){i(e)}))}return new(t||(t=Promise))((function(t,s){function l(e){try{r(n.next(e))}catch(i){s(i)}}function d(e){try{r(n["throw"](e))}catch(i){s(i)}}function r(e){e.done?t(e.value):o(e.value).then(l,d)}r((n=n.apply(e,i||[])).next())}))};import*as nls from"../../../nls.js";import*as dom from"../../../base/browser/dom.js";import{Action}from"../../../base/common/actions.js";import{Disposable}from"../../../base/common/lifecycle.js";import{Range}from"../../common/core/range.js";import{Codicon}from"../../../base/common/codicons.js";export class InlineDiffMargin extends Disposable{constructor(e,i,t,n,o,s){super(),this._viewZoneId=e,this._marginDomNode=i,this.editor=t,this.diff=n,this._contextMenuService=o,this._clipboardService=s,this._visibility=!1,this._marginDomNode.style.zIndex="10",this._diffActions=document.createElement("div"),this._diffActions.className=Codicon.lightBulb.classNames+" lightbulb-glyph",this._diffActions.style.position="absolute";const l=t.getOption(59),d=t.getModel().getEOL();this._diffActions.style.right="0px",this._diffActions.style.visibility="hidden",this._diffActions.style.height=`${l}px`,this._diffActions.style.lineHeight=`${l}px`,this._marginDomNode.appendChild(this._diffActions);const r=[],a=0===n.modifiedEndLineNumber;r.push(new Action("diff.clipboard.copyDeletedContent",a?n.originalEndLineNumber>n.modifiedStartLineNumber?nls.localize("diff.clipboard.copyDeletedLinesContent.label","Copy deleted lines"):nls.localize("diff.clipboard.copyDeletedLinesContent.single.label","Copy deleted line"):n.originalEndLineNumber>n.modifiedStartLineNumber?nls.localize("diff.clipboard.copyChangedLinesContent.label","Copy changed lines"):nls.localize("diff.clipboard.copyChangedLinesContent.single.label","Copy changed line"),void 0,!0,(()=>__awaiter(this,void 0,void 0,(function*(){const e=new Range(n.originalStartLineNumber,1,n.originalEndLineNumber+1,1),i=n.originalModel.getValueInRange(e);yield this._clipboardService.writeText(i)})))));let c,f=0;n.originalEndLineNumber>n.modifiedStartLineNumber&&(c=new Action("diff.clipboard.copyDeletedLineContent",a?nls.localize("diff.clipboard.copyDeletedLineContent.label","Copy deleted line ({0})",n.originalStartLineNumber):nls.localize("diff.clipboard.copyChangedLineContent.label","Copy changed line ({0})",n.originalStartLineNumber),void 0,!0,(()=>__awaiter(this,void 0,void 0,(function*(){const e=n.originalModel.getLineContent(n.originalStartLineNumber+f);if(""===e){const e=n.originalModel.getEndOfLineSequence();yield this._clipboardService.writeText(0===e?"\n":"\r\n")}else yield this._clipboardService.writeText(e)})))),r.push(c));const g=t.getOption(81);g||r.push(new Action("diff.inline.revertChange",nls.localize("diff.inline.revertChange.label","Revert this change"),void 0,!0,(()=>__awaiter(this,void 0,void 0,(function*(){const e=new Range(n.originalStartLineNumber,1,n.originalEndLineNumber,n.originalModel.getLineMaxColumn(n.originalEndLineNumber)),i=n.originalModel.getValueInRange(e);if(0===n.modifiedEndLineNumber){const e=t.getModel().getLineMaxColumn(n.modifiedStartLineNumber);t.executeEdits("diffEditor",[{range:new Range(n.modifiedStartLineNumber,e,n.modifiedStartLineNumber,e),text:d+i}])}else{const e=t.getModel().getLineMaxColumn(n.modifiedEndLineNumber);t.executeEdits("diffEditor",[{range:new Range(n.modifiedStartLineNumber,1,n.modifiedEndLineNumber,e),text:i}])}})))));const h=(e,i)=>{this._contextMenuService.showContextMenu({getAnchor:()=>({x:e,y:i}),getActions:()=>(c&&(c.label=a?nls.localize("diff.clipboard.copyDeletedLineContent.label","Copy deleted line ({0})",n.originalStartLineNumber+f):nls.localize("diff.clipboard.copyChangedLineContent.label","Copy changed line ({0})",n.originalStartLineNumber+f)),r),autoSelectFirstItem:!0})};this._register(dom.addStandardDisposableListener(this._diffActions,"mousedown",(e=>{const{top:i,height:t}=dom.getDomNodePagePosition(this._diffActions),n=Math.floor(l/3);e.preventDefault(),h(e.posx,i+t+n)}))),this._register(t.onMouseMove((e=>{if(8===e.target.type||5===e.target.type){const i=e.target.detail.viewZoneId;i===this._viewZoneId?(this.visibility=!0,f=this._updateLightBulbPosition(this._marginDomNode,e.event.browserEvent.y,l)):this.visibility=!1}else this.visibility=!1}))),this._register(t.onMouseDown((e=>{if(e.event.rightButton&&(8===e.target.type||5===e.target.type)){const i=e.target.detail.viewZoneId;i===this._viewZoneId&&(e.event.preventDefault(),f=this._updateLightBulbPosition(this._marginDomNode,e.event.browserEvent.y,l),h(e.event.posx,e.event.posy+l))}})))}get visibility(){return this._visibility}set visibility(e){this._visibility!==e&&(this._visibility=e,this._diffActions.style.visibility=e?"visible":"hidden")}_updateLightBulbPosition(e,i,t){const{top:n}=dom.getDomNodePagePosition(e),o=i-n,s=Math.floor(o/t),l=s*t;if(this._diffActions.style.top=`${l}px`,this.diff.viewLineCounts){let e=0;for(let i=0;i<this.diff.viewLineCounts.length;i++)if(e+=this.diff.viewLineCounts[i],s<e)return i}return s}}