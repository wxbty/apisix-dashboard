var __decorate=this&&this.__decorate||function(e,t,o,i){var s,n=arguments.length,r=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)r=Reflect.decorate(e,t,o,i);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(r=(n<3?s(r):n>3?s(t,o,r):s(t,o))||r);return n>3&&r&&Object.defineProperty(t,o,r),r},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}};import"../services/markerDecorations.js";import"./media/editor.css";import*as nls from"../../../nls.js";import*as dom from"../../../base/browser/dom.js";import{onUnexpectedError}from"../../../base/common/errors.js";import{Emitter}from"../../../base/common/event.js";import{Disposable,dispose}from"../../../base/common/lifecycle.js";import{Schemas}from"../../../base/common/network.js";import{EditorConfiguration}from"../config/editorConfiguration.js";import{EditorExtensionsRegistry}from"../editorExtensions.js";import{ICodeEditorService}from"../services/codeEditorService.js";import{View}from"../view/view.js";import{ViewUserInputEvents}from"../view/viewUserInputEvents.js";import{filterValidationDecorations}from"../../common/config/editorOptions.js";import{CursorsController}from"../../common/cursor/cursor.js";import{CursorColumns}from"../../common/core/cursorColumns.js";import{Position}from"../../common/core/position.js";import{Range}from"../../common/core/range.js";import{Selection}from"../../common/core/selection.js";import{InternalEditorAction}from"../../common/editorAction.js";import*as editorCommon from"../../common/editorCommon.js";import{EditorContextKeys}from"../../common/editorContextKeys.js";import*as modes from"../../common/languages.js";import{editorUnnecessaryCodeBorder,editorUnnecessaryCodeOpacity}from"../../common/core/editorColorRegistry.js";import{editorErrorBorder,editorErrorForeground,editorHintBorder,editorHintForeground,editorInfoBorder,editorInfoForeground,editorWarningBorder,editorWarningForeground,editorForeground,editorErrorBackground,editorInfoBackground,editorWarningBackground}from"../../../platform/theme/common/colorRegistry.js";import{ViewModel}from"../../common/viewModel/viewModelImpl.js";import{ICommandService}from"../../../platform/commands/common/commands.js";import{IContextKeyService}from"../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../platform/instantiation/common/instantiation.js";import{ServiceCollection}from"../../../platform/instantiation/common/serviceCollection.js";import{INotificationService}from"../../../platform/notification/common/notification.js";import{IThemeService,registerThemingParticipant}from"../../../platform/theme/common/themeService.js";import{IAccessibilityService}from"../../../platform/accessibility/common/accessibility.js";import{withNullAsUndefined}from"../../../base/common/types.js";import{MonospaceLineBreaksComputerFactory}from"../../common/viewModel/monospaceLineBreaksComputer.js";import{DOMLineBreaksComputerFactory}from"../view/domLineBreaksComputer.js";import{WordOperations}from"../../common/cursor/cursorWordOperations.js";import{ILanguageConfigurationService}from"../../common/languages/languageConfigurationRegistry.js";import{applyFontInfo}from"../config/domFontInfo.js";let EDITOR_ID=0;class ModelData{constructor(e,t,o,i,s){this.model=e,this.viewModel=t,this.view=o,this.hasRealView=i,this.listenersToRemove=s}dispose(){dispose(this.listenersToRemove),this.model.onBeforeDetached(),this.hasRealView&&this.view.dispose(),this.viewModel.dispose()}}let CodeEditorWidget=class e extends Disposable{constructor(e,t,o,i,s,n,r,a,d,h,l){super(),this.languageConfigurationService=l,this._onDidDispose=this._register(new Emitter),this.onDidDispose=this._onDidDispose.event,this._onDidChangeModelContent=this._register(new Emitter),this.onDidChangeModelContent=this._onDidChangeModelContent.event,this._onDidChangeModelLanguage=this._register(new Emitter),this.onDidChangeModelLanguage=this._onDidChangeModelLanguage.event,this._onDidChangeModelLanguageConfiguration=this._register(new Emitter),this.onDidChangeModelLanguageConfiguration=this._onDidChangeModelLanguageConfiguration.event,this._onDidChangeModelOptions=this._register(new Emitter),this.onDidChangeModelOptions=this._onDidChangeModelOptions.event,this._onDidChangeModelDecorations=this._register(new Emitter),this.onDidChangeModelDecorations=this._onDidChangeModelDecorations.event,this._onDidChangeConfiguration=this._register(new Emitter),this.onDidChangeConfiguration=this._onDidChangeConfiguration.event,this._onDidChangeModel=this._register(new Emitter),this.onDidChangeModel=this._onDidChangeModel.event,this._onDidChangeCursorPosition=this._register(new Emitter),this.onDidChangeCursorPosition=this._onDidChangeCursorPosition.event,this._onDidChangeCursorSelection=this._register(new Emitter),this.onDidChangeCursorSelection=this._onDidChangeCursorSelection.event,this._onDidAttemptReadOnlyEdit=this._register(new Emitter),this.onDidAttemptReadOnlyEdit=this._onDidAttemptReadOnlyEdit.event,this._onDidLayoutChange=this._register(new Emitter),this.onDidLayoutChange=this._onDidLayoutChange.event,this._editorTextFocus=this._register(new BooleanEventEmitter),this.onDidFocusEditorText=this._editorTextFocus.onDidChangeToTrue,this.onDidBlurEditorText=this._editorTextFocus.onDidChangeToFalse,this._editorWidgetFocus=this._register(new BooleanEventEmitter),this.onDidFocusEditorWidget=this._editorWidgetFocus.onDidChangeToTrue,this.onDidBlurEditorWidget=this._editorWidgetFocus.onDidChangeToFalse,this._onWillType=this._register(new Emitter),this.onWillType=this._onWillType.event,this._onDidType=this._register(new Emitter),this.onDidType=this._onDidType.event,this._onDidCompositionStart=this._register(new Emitter),this.onDidCompositionStart=this._onDidCompositionStart.event,this._onDidCompositionEnd=this._register(new Emitter),this.onDidCompositionEnd=this._onDidCompositionEnd.event,this._onDidPaste=this._register(new Emitter),this.onDidPaste=this._onDidPaste.event,this._onMouseUp=this._register(new Emitter),this.onMouseUp=this._onMouseUp.event,this._onMouseDown=this._register(new Emitter),this.onMouseDown=this._onMouseDown.event,this._onMouseDrag=this._register(new Emitter),this.onMouseDrag=this._onMouseDrag.event,this._onMouseDrop=this._register(new Emitter),this.onMouseDrop=this._onMouseDrop.event,this._onMouseDropCanceled=this._register(new Emitter),this.onMouseDropCanceled=this._onMouseDropCanceled.event,this._onContextMenu=this._register(new Emitter),this.onContextMenu=this._onContextMenu.event,this._onMouseMove=this._register(new Emitter),this.onMouseMove=this._onMouseMove.event,this._onMouseLeave=this._register(new Emitter),this.onMouseLeave=this._onMouseLeave.event,this._onMouseWheel=this._register(new Emitter),this.onMouseWheel=this._onMouseWheel.event,this._onKeyUp=this._register(new Emitter),this.onKeyUp=this._onKeyUp.event,this._onKeyDown=this._register(new Emitter),this.onKeyDown=this._onKeyDown.event,this._onDidContentSizeChange=this._register(new Emitter),this.onDidContentSizeChange=this._onDidContentSizeChange.event,this._onDidScrollChange=this._register(new Emitter),this.onDidScrollChange=this._onDidScrollChange.event,this._onDidChangeViewZones=this._register(new Emitter),this.onDidChangeViewZones=this._onDidChangeViewZones.event,this._onDidChangeHiddenAreas=this._register(new Emitter),this.onDidChangeHiddenAreas=this._onDidChangeHiddenAreas.event,this._bannerDomNode=null;const m=Object.assign({},t);let c;this._domElement=e,this._overflowWidgetsDomNode=m.overflowWidgetsDomNode,delete m.overflowWidgetsDomNode,this._id=++EDITOR_ID,this._decorationTypeKeysToIds={},this._decorationTypeSubtypes={},this._telemetryData=o.telemetryData,this._configuration=this._register(this._createConfiguration(o.isSimpleWidget||!1,m,h)),this._register(this._configuration.onDidChange((e=>{this._onDidChangeConfiguration.fire(e);const t=this._configuration.options;if(e.hasChanged(131)){const e=t.get(131);this._onDidLayoutChange.fire(e)}}))),this._contextKeyService=this._register(r.createScoped(this._domElement)),this._notificationService=d,this._codeEditorService=s,this._commandService=n,this._themeService=a,this._register(new EditorContextKeysManager(this,this._contextKeyService)),this._register(new EditorModeContext(this,this._contextKeyService)),this._instantiationService=i.createChild(new ServiceCollection([IContextKeyService,this._contextKeyService])),this._modelData=null,this._contributions={},this._actions={},this._focusTracker=new CodeEditorWidgetFocusTracker(e),this._register(this._focusTracker.onChange((()=>{this._editorWidgetFocus.setValue(this._focusTracker.hasFocus())}))),this._contentWidgets={},this._overlayWidgets={},c=Array.isArray(o.contributions)?o.contributions:EditorExtensionsRegistry.getEditorContributions();for(const _ of c)if(this._contributions[_.id])onUnexpectedError(new Error(`Cannot have two contributions with the same id ${_.id}`));else try{const e=this._instantiationService.createInstance(_.ctor,this);this._contributions[_.id]=e}catch(g){onUnexpectedError(g)}EditorExtensionsRegistry.getEditorActions().forEach((e=>{if(this._actions[e.id])return void onUnexpectedError(new Error(`Cannot have two actions with the same id ${e.id}`));const t=new InternalEditorAction(e.id,e.label,e.alias,withNullAsUndefined(e.precondition),(()=>this._instantiationService.invokeFunction((t=>Promise.resolve(e.runEditorCommand(t,this,null))))),this._contextKeyService);this._actions[t.id]=t})),this._codeEditorService.addCodeEditor(this)}get isSimpleWidget(){return this._configuration.isSimpleWidget}_createConfiguration(e,t,o){return new EditorConfiguration(e,t,this._domElement,o)}getId(){return this.getEditorType()+":"+this._id}getEditorType(){return editorCommon.EditorType.ICodeEditor}dispose(){this._codeEditorService.removeCodeEditor(this),this._focusTracker.dispose();const e=Object.keys(this._contributions);for(let t=0,o=e.length;t<o;t++){const o=e[t];this._contributions[o].dispose()}this._contributions={},this._actions={},this._contentWidgets={},this._overlayWidgets={},this._removeDecorationTypes(),this._postDetachModelCleanup(this._detachModel()),this._onDidDispose.fire(),super.dispose()}invokeWithinContext(e){return this._instantiationService.invokeFunction(e)}updateOptions(e){this._configuration.updateOptions(e||{})}getOptions(){return this._configuration.options}getOption(e){return this._configuration.options.get(e)}getRawOptions(){return this._configuration.getRawOptions()}getOverflowWidgetsDomNode(){return this._overflowWidgetsDomNode}getConfiguredWordAtPosition(e){return this._modelData?WordOperations.getWordAtPosition(this._modelData.model,this._configuration.options.get(117),e):null}getValue(e=null){if(!this._modelData)return"";const t=!(!e||!e.preserveBOM);let o=0;return e&&e.lineEnding&&"\n"===e.lineEnding?o=1:e&&e.lineEnding&&"\r\n"===e.lineEnding&&(o=2),this._modelData.model.getValue(o,t)}setValue(e){this._modelData&&this._modelData.model.setValue(e)}getModel(){return this._modelData?this._modelData.model:null}setModel(e=null){const t=e;if(null===this._modelData&&null===t)return;if(this._modelData&&this._modelData.model===t)return;const o=this.hasTextFocus(),i=this._detachModel();this._attachModel(t),o&&this.hasModel()&&this.focus();const s={oldModelUrl:i?i.uri:null,newModelUrl:t?t.uri:null};this._removeDecorationTypes(),this._onDidChangeModel.fire(s),this._postDetachModelCleanup(i)}_removeDecorationTypes(){if(this._decorationTypeKeysToIds={},this._decorationTypeSubtypes){for(let e in this._decorationTypeSubtypes){const t=this._decorationTypeSubtypes[e];for(let o in t)this._removeDecorationType(e+"-"+o)}this._decorationTypeSubtypes={}}}getVisibleRanges(){return this._modelData?this._modelData.viewModel.getVisibleRanges():[]}getVisibleRangesPlusViewportAboveBelow(){return this._modelData?this._modelData.viewModel.getVisibleRangesPlusViewportAboveBelow():[]}getWhitespaces(){return this._modelData?this._modelData.viewModel.viewLayout.getWhitespaces():[]}static _getVerticalOffsetForPosition(e,t,o){const i=e.model.validatePosition({lineNumber:t,column:o}),s=e.viewModel.coordinatesConverter.convertModelPositionToViewPosition(i);return e.viewModel.viewLayout.getVerticalOffsetForLineNumber(s.lineNumber)}getTopForLineNumber(t){return this._modelData?e._getVerticalOffsetForPosition(this._modelData,t,1):-1}getTopForPosition(t,o){return this._modelData?e._getVerticalOffsetForPosition(this._modelData,t,o):-1}setHiddenAreas(e){this._modelData&&this._modelData.viewModel.setHiddenAreas(e.map((e=>Range.lift(e))))}getVisibleColumnFromPosition(e){if(!this._modelData)return e.column;const t=this._modelData.model.validatePosition(e),o=this._modelData.model.getOptions().tabSize;return CursorColumns.visibleColumnFromColumn(this._modelData.model.getLineContent(t.lineNumber),t.column,o)+1}getPosition(){return this._modelData?this._modelData.viewModel.getPosition():null}setPosition(e){if(this._modelData){if(!Position.isIPosition(e))throw new Error("Invalid arguments");this._modelData.viewModel.setSelections("api",[{selectionStartLineNumber:e.lineNumber,selectionStartColumn:e.column,positionLineNumber:e.lineNumber,positionColumn:e.column}])}}_sendRevealRange(e,t,o,i){if(!this._modelData)return;if(!Range.isIRange(e))throw new Error("Invalid arguments");const s=this._modelData.model.validateRange(e),n=this._modelData.viewModel.coordinatesConverter.convertModelRangeToViewRange(s);this._modelData.viewModel.revealRange("api",o,n,t,i)}revealLine(e,t=0){this._revealLine(e,0,t)}revealLineInCenter(e,t=0){this._revealLine(e,1,t)}revealLineInCenterIfOutsideViewport(e,t=0){this._revealLine(e,2,t)}revealLineNearTop(e,t=0){this._revealLine(e,5,t)}_revealLine(e,t,o){if("number"!==typeof e)throw new Error("Invalid arguments");this._sendRevealRange(new Range(e,1,e,1),t,!1,o)}revealPosition(e,t=0){this._revealPosition(e,0,!0,t)}revealPositionInCenter(e,t=0){this._revealPosition(e,1,!0,t)}revealPositionInCenterIfOutsideViewport(e,t=0){this._revealPosition(e,2,!0,t)}revealPositionNearTop(e,t=0){this._revealPosition(e,5,!0,t)}_revealPosition(e,t,o,i){if(!Position.isIPosition(e))throw new Error("Invalid arguments");this._sendRevealRange(new Range(e.lineNumber,e.column,e.lineNumber,e.column),t,o,i)}getSelection(){return this._modelData?this._modelData.viewModel.getSelection():null}getSelections(){return this._modelData?this._modelData.viewModel.getSelections():null}setSelection(e){const t=Selection.isISelection(e),o=Range.isIRange(e);if(!t&&!o)throw new Error("Invalid arguments");if(t)this._setSelectionImpl(e);else if(o){const t={selectionStartLineNumber:e.startLineNumber,selectionStartColumn:e.startColumn,positionLineNumber:e.endLineNumber,positionColumn:e.endColumn};this._setSelectionImpl(t)}}_setSelectionImpl(e){if(!this._modelData)return;const t=new Selection(e.selectionStartLineNumber,e.selectionStartColumn,e.positionLineNumber,e.positionColumn);this._modelData.viewModel.setSelections("api",[t])}revealLines(e,t,o=0){this._revealLines(e,t,0,o)}revealLinesInCenter(e,t,o=0){this._revealLines(e,t,1,o)}revealLinesInCenterIfOutsideViewport(e,t,o=0){this._revealLines(e,t,2,o)}revealLinesNearTop(e,t,o=0){this._revealLines(e,t,5,o)}_revealLines(e,t,o,i){if("number"!==typeof e||"number"!==typeof t)throw new Error("Invalid arguments");this._sendRevealRange(new Range(e,1,t,1),o,!1,i)}revealRange(e,t=0,o=!1,i=!0){this._revealRange(e,o?1:0,i,t)}revealRangeInCenter(e,t=0){this._revealRange(e,1,!0,t)}revealRangeInCenterIfOutsideViewport(e,t=0){this._revealRange(e,2,!0,t)}revealRangeNearTop(e,t=0){this._revealRange(e,5,!0,t)}revealRangeNearTopIfOutsideViewport(e,t=0){this._revealRange(e,6,!0,t)}revealRangeAtTop(e,t=0){this._revealRange(e,3,!0,t)}_revealRange(e,t,o,i){if(!Range.isIRange(e))throw new Error("Invalid arguments");this._sendRevealRange(Range.lift(e),t,o,i)}setSelections(e,t="api",o=0){if(this._modelData){if(!e||0===e.length)throw new Error("Invalid arguments");for(let t=0,o=e.length;t<o;t++)if(!Selection.isISelection(e[t]))throw new Error("Invalid arguments");this._modelData.viewModel.setSelections(t,e,o)}}getContentWidth(){return this._modelData?this._modelData.viewModel.viewLayout.getContentWidth():-1}getScrollWidth(){return this._modelData?this._modelData.viewModel.viewLayout.getScrollWidth():-1}getScrollLeft(){return this._modelData?this._modelData.viewModel.viewLayout.getCurrentScrollLeft():-1}getContentHeight(){return this._modelData?this._modelData.viewModel.viewLayout.getContentHeight():-1}getScrollHeight(){return this._modelData?this._modelData.viewModel.viewLayout.getScrollHeight():-1}getScrollTop(){return this._modelData?this._modelData.viewModel.viewLayout.getCurrentScrollTop():-1}setScrollLeft(e,t=1){if(this._modelData){if("number"!==typeof e)throw new Error("Invalid arguments");this._modelData.viewModel.setScrollPosition({scrollLeft:e},t)}}setScrollTop(e,t=1){if(this._modelData){if("number"!==typeof e)throw new Error("Invalid arguments");this._modelData.viewModel.setScrollPosition({scrollTop:e},t)}}setScrollPosition(e,t=1){this._modelData&&this._modelData.viewModel.setScrollPosition(e,t)}saveViewState(){if(!this._modelData)return null;const e={},t=Object.keys(this._contributions);for(const s of t){const t=this._contributions[s];"function"===typeof t.saveViewState&&(e[s]=t.saveViewState())}const o=this._modelData.viewModel.saveCursorState(),i=this._modelData.viewModel.saveState();return{cursorState:o,viewState:i,contributionsState:e}}restoreViewState(e){if(!this._modelData||!this._modelData.hasRealView)return;const t=e;if(t&&t.cursorState&&t.viewState){const e=t.cursorState;Array.isArray(e)?this._modelData.viewModel.restoreCursorState(e):this._modelData.viewModel.restoreCursorState([e]);const o=t.contributionsState||{},i=Object.keys(this._contributions);for(let t=0,n=i.length;t<n;t++){const e=i[t],s=this._contributions[e];"function"===typeof s.restoreViewState&&s.restoreViewState(o[e])}const s=this._modelData.viewModel.reduceRestoreState(t.viewState);this._modelData.view.restoreState(s)}}getContribution(e){return this._contributions[e]||null}getActions(){const e=[],t=Object.keys(this._actions);for(let o=0,i=t.length;o<i;o++){const i=t[o];e.push(this._actions[i])}return e}getSupportedActions(){let e=this.getActions();return e=e.filter((e=>e.isSupported())),e}getAction(e){return this._actions[e]||null}trigger(e,t,o){switch(o=o||{},t){case"compositionStart":return void this._startComposition();case"compositionEnd":return void this._endComposition(e);case"type":{const t=o;return void this._type(e,t.text||"")}case"replacePreviousChar":{const t=o;return void this._compositionType(e,t.text||"",t.replaceCharCnt||0,0,0)}case"compositionType":{const t=o;return void this._compositionType(e,t.text||"",t.replacePrevCharCnt||0,t.replaceNextCharCnt||0,t.positionDelta||0)}case"paste":{const t=o;return void this._paste(e,t.text||"",t.pasteOnNewLine||!1,t.multicursorText||null,t.mode||null)}case"cut":return void this._cut(e)}const i=this.getAction(t);i?Promise.resolve(i.run()).then(void 0,onUnexpectedError):this._modelData&&(this._triggerEditorCommand(e,t,o)||this._triggerCommand(t,o))}_triggerCommand(e,t){this._commandService.executeCommand(e,t)}_startComposition(){this._modelData&&(this._modelData.viewModel.startComposition(),this._onDidCompositionStart.fire())}_endComposition(e){this._modelData&&(this._modelData.viewModel.endComposition(e),this._onDidCompositionEnd.fire())}_type(e,t){this._modelData&&0!==t.length&&("keyboard"===e&&this._onWillType.fire(t),this._modelData.viewModel.type(t,e),"keyboard"===e&&this._onDidType.fire(t))}_compositionType(e,t,o,i,s){this._modelData&&this._modelData.viewModel.compositionType(t,o,i,s,e)}_paste(e,t,o,i,s){if(!this._modelData||0===t.length)return;const n=this._modelData.viewModel.getSelection().getStartPosition();this._modelData.viewModel.paste(t,o,i,e);const r=this._modelData.viewModel.getSelection().getStartPosition();"keyboard"===e&&this._onDidPaste.fire({range:new Range(n.lineNumber,n.column,r.lineNumber,r.column),languageId:s})}_cut(e){this._modelData&&this._modelData.viewModel.cut(e)}_triggerEditorCommand(e,t,o){const i=EditorExtensionsRegistry.getEditorCommand(t);return!!i&&(o=o||{},o.source=e,this._instantiationService.invokeFunction((e=>{Promise.resolve(i.runEditorCommand(e,this,o)).then(void 0,onUnexpectedError)})),!0)}_getViewModel(){return this._modelData?this._modelData.viewModel:null}pushUndoStop(){return!!this._modelData&&(!this._configuration.options.get(81)&&(this._modelData.model.pushStackElement(),!0))}popUndoStop(){return!!this._modelData&&(!this._configuration.options.get(81)&&(this._modelData.model.popStackElement(),!0))}executeEdits(e,t,o){if(!this._modelData)return!1;if(this._configuration.options.get(81))return!1;let i;return i=o?Array.isArray(o)?()=>o:o:()=>null,this._modelData.viewModel.executeEdits(e,t,i),!0}executeCommand(e,t){this._modelData&&this._modelData.viewModel.executeCommand(t,e)}executeCommands(e,t){this._modelData&&this._modelData.viewModel.executeCommands(t,e)}changeDecorations(e){return this._modelData?this._modelData.model.changeDecorations(e,this._id):null}getLineDecorations(e){return this._modelData?this._modelData.model.getLineDecorations(e,this._id,filterValidationDecorations(this._configuration.options)):null}getDecorationsInRange(e){return this._modelData?this._modelData.model.getDecorationsInRange(e,this._id,filterValidationDecorations(this._configuration.options)):null}deltaDecorations(e,t){return this._modelData?0===e.length&&0===t.length?e:this._modelData.model.deltaDecorations(e,t,this._id):[]}removeDecorations(e){const t=this._decorationTypeKeysToIds[e];t&&this.deltaDecorations(t,[]),this._decorationTypeKeysToIds.hasOwnProperty(e)&&delete this._decorationTypeKeysToIds[e],this._decorationTypeSubtypes.hasOwnProperty(e)&&delete this._decorationTypeSubtypes[e]}getLayoutInfo(){const e=this._configuration.options,t=e.get(131);return t}createOverviewRuler(e){return this._modelData&&this._modelData.hasRealView?this._modelData.view.createOverviewRuler(e):null}getContainerDomNode(){return this._domElement}getDomNode(){return this._modelData&&this._modelData.hasRealView?this._modelData.view.domNode.domNode:null}delegateVerticalScrollbarMouseDown(e){this._modelData&&this._modelData.hasRealView&&this._modelData.view.delegateVerticalScrollbarMouseDown(e)}layout(e){this._configuration.observeContainer(e),this.render()}focus(){this._modelData&&this._modelData.hasRealView&&this._modelData.view.focus()}hasTextFocus(){return!(!this._modelData||!this._modelData.hasRealView)&&this._modelData.view.isFocused()}hasWidgetFocus(){return this._focusTracker&&this._focusTracker.hasFocus()}addContentWidget(e){const t={widget:e,position:e.getPosition()};this._contentWidgets.hasOwnProperty(e.getId())&&console.warn("Overwriting a content widget with the same id."),this._contentWidgets[e.getId()]=t,this._modelData&&this._modelData.hasRealView&&this._modelData.view.addContentWidget(t)}layoutContentWidget(e){const t=e.getId();if(this._contentWidgets.hasOwnProperty(t)){const o=this._contentWidgets[t];o.position=e.getPosition(),this._modelData&&this._modelData.hasRealView&&this._modelData.view.layoutContentWidget(o)}}removeContentWidget(e){const t=e.getId();if(this._contentWidgets.hasOwnProperty(t)){const e=this._contentWidgets[t];delete this._contentWidgets[t],this._modelData&&this._modelData.hasRealView&&this._modelData.view.removeContentWidget(e)}}addOverlayWidget(e){const t={widget:e,position:e.getPosition()};this._overlayWidgets.hasOwnProperty(e.getId())&&console.warn("Overwriting an overlay widget with the same id."),this._overlayWidgets[e.getId()]=t,this._modelData&&this._modelData.hasRealView&&this._modelData.view.addOverlayWidget(t)}layoutOverlayWidget(e){const t=e.getId();if(this._overlayWidgets.hasOwnProperty(t)){const o=this._overlayWidgets[t];o.position=e.getPosition(),this._modelData&&this._modelData.hasRealView&&this._modelData.view.layoutOverlayWidget(o)}}removeOverlayWidget(e){const t=e.getId();if(this._overlayWidgets.hasOwnProperty(t)){const e=this._overlayWidgets[t];delete this._overlayWidgets[t],this._modelData&&this._modelData.hasRealView&&this._modelData.view.removeOverlayWidget(e)}}changeViewZones(e){this._modelData&&this._modelData.hasRealView&&this._modelData.view.change(e)}getTargetAtClientPoint(e,t){return this._modelData&&this._modelData.hasRealView?this._modelData.view.getTargetAtClientPoint(e,t):null}getScrolledVisiblePosition(t){if(!this._modelData||!this._modelData.hasRealView)return null;const o=this._modelData.model.validatePosition(t),i=this._configuration.options,s=i.get(131),n=e._getVerticalOffsetForPosition(this._modelData,o.lineNumber,o.column)-this.getScrollTop(),r=this._modelData.view.getOffsetForColumn(o.lineNumber,o.column)+s.glyphMarginWidth+s.lineNumbersWidth+s.decorationsWidth-this.getScrollLeft();return{top:n,left:r,height:i.get(59)}}getOffsetForColumn(e,t){return this._modelData&&this._modelData.hasRealView?this._modelData.view.getOffsetForColumn(e,t):-1}render(e=!1){this._modelData&&this._modelData.hasRealView&&this._modelData.view.render(!0,e)}setAriaOptions(e){this._modelData&&this._modelData.hasRealView&&this._modelData.view.setAriaOptions(e)}applyFontInfo(e){applyFontInfo(e,this._configuration.options.get(44))}setBanner(e,t){this._bannerDomNode&&this._domElement.contains(this._bannerDomNode)&&this._domElement.removeChild(this._bannerDomNode),this._bannerDomNode=e,this._configuration.setReservedHeight(e?t:0),this._bannerDomNode&&this._domElement.prepend(this._bannerDomNode)}_attachModel(e){if(!e)return void(this._modelData=null);const t=[];this._domElement.setAttribute("data-mode-id",e.getLanguageId()),this._configuration.setIsDominatedByLongLines(e.isDominatedByLongLines()),this._configuration.setModelLineCount(e.getLineCount()),e.onBeforeAttached();const o=new ViewModel(this._id,this._configuration,e,DOMLineBreaksComputerFactory.create(),MonospaceLineBreaksComputerFactory.create(this._configuration.options),(e=>dom.scheduleAtNextAnimationFrame(e)),this.languageConfigurationService);t.push(e.onDidChangeDecorations((e=>this._onDidChangeModelDecorations.fire(e)))),t.push(e.onDidChangeLanguage((t=>{this._domElement.setAttribute("data-mode-id",e.getLanguageId()),this._onDidChangeModelLanguage.fire(t)}))),t.push(e.onDidChangeLanguageConfiguration((e=>this._onDidChangeModelLanguageConfiguration.fire(e)))),t.push(e.onDidChangeContent((e=>this._onDidChangeModelContent.fire(e)))),t.push(e.onDidChangeOptions((e=>this._onDidChangeModelOptions.fire(e)))),t.push(e.onWillDispose((()=>this.setModel(null)))),t.push(o.onEvent((e=>{switch(e.kind){case 0:this._onDidContentSizeChange.fire(e);break;case 1:this._editorTextFocus.setValue(e.hasFocus);break;case 2:this._onDidScrollChange.fire(e);break;case 3:this._onDidChangeViewZones.fire();break;case 4:this._onDidChangeHiddenAreas.fire();break;case 5:this._onDidAttemptReadOnlyEdit.fire();break;case 6:{e.reachedMaxCursorCount&&this._notificationService.warn(nls.localize("cursors.maximum","The number of cursors has been limited to {0}.",CursorsController.MAX_CURSOR_COUNT));const t=[];for(let s=0,n=e.selections.length;s<n;s++)t[s]=e.selections[s].getPosition();const o={position:t[0],secondaryPositions:t.slice(1),reason:e.reason,source:e.source};this._onDidChangeCursorPosition.fire(o);const i={selection:e.selections[0],secondarySelections:e.selections.slice(1),modelVersionId:e.modelVersionId,oldSelections:e.oldSelections,oldModelVersionId:e.oldModelVersionId,source:e.source,reason:e.reason};this._onDidChangeCursorSelection.fire(i);break}}})));const[i,s]=this._createView(o);if(s){this._domElement.appendChild(i.domNode.domNode);let t=Object.keys(this._contentWidgets);for(let e=0,o=t.length;e<o;e++){const o=t[e];i.addContentWidget(this._contentWidgets[o])}t=Object.keys(this._overlayWidgets);for(let e=0,o=t.length;e<o;e++){const o=t[e];i.addOverlayWidget(this._overlayWidgets[o])}i.render(!1,!0),i.domNode.domNode.setAttribute("data-uri",e.uri.toString())}this._modelData=new ModelData(e,o,i,s,t)}_createView(e){let t;t=this.isSimpleWidget?{paste:(e,t,o,i)=>{this._paste("keyboard",e,t,o,i)},type:e=>{this._type("keyboard",e)},compositionType:(e,t,o,i)=>{this._compositionType("keyboard",e,t,o,i)},startComposition:()=>{this._startComposition()},endComposition:()=>{this._endComposition("keyboard")},cut:()=>{this._cut("keyboard")}}:{paste:(e,t,o,i)=>{const s={text:e,pasteOnNewLine:t,multicursorText:o,mode:i};this._commandService.executeCommand("paste",s)},type:e=>{const t={text:e};this._commandService.executeCommand("type",t)},compositionType:(e,t,o,i)=>{if(o||i){const s={text:e,replacePrevCharCnt:t,replaceNextCharCnt:o,positionDelta:i};this._commandService.executeCommand("compositionType",s)}else{const o={text:e,replaceCharCnt:t};this._commandService.executeCommand("replacePreviousChar",o)}},startComposition:()=>{this._commandService.executeCommand("compositionStart",{})},endComposition:()=>{this._commandService.executeCommand("compositionEnd",{})},cut:()=>{this._commandService.executeCommand("cut",{})}};const o=new ViewUserInputEvents(e.coordinatesConverter);o.onKeyDown=e=>this._onKeyDown.fire(e),o.onKeyUp=e=>this._onKeyUp.fire(e),o.onContextMenu=e=>this._onContextMenu.fire(e),o.onMouseMove=e=>this._onMouseMove.fire(e),o.onMouseLeave=e=>this._onMouseLeave.fire(e),o.onMouseDown=e=>this._onMouseDown.fire(e),o.onMouseUp=e=>this._onMouseUp.fire(e),o.onMouseDrag=e=>this._onMouseDrag.fire(e),o.onMouseDrop=e=>this._onMouseDrop.fire(e),o.onMouseDropCanceled=e=>this._onMouseDropCanceled.fire(e),o.onMouseWheel=e=>this._onMouseWheel.fire(e);const i=new View(t,this._configuration,this._themeService,e,o,this._overflowWidgetsDomNode);return[i,!0]}_postDetachModelCleanup(e){e&&e.removeAllDecorationsWithOwnerId(this._id)}_detachModel(){if(!this._modelData)return null;const e=this._modelData.model,t=this._modelData.hasRealView?this._modelData.view.domNode.domNode:null;return this._modelData.dispose(),this._modelData=null,this._domElement.removeAttribute("data-mode-id"),t&&this._domElement.contains(t)&&this._domElement.removeChild(t),this._bannerDomNode&&this._domElement.contains(this._bannerDomNode)&&this._domElement.removeChild(this._bannerDomNode),e}_removeDecorationType(e){this._codeEditorService.removeDecorationType(e)}hasModel(){return null!==this._modelData}};CodeEditorWidget=__decorate([__param(3,IInstantiationService),__param(4,ICodeEditorService),__param(5,ICommandService),__param(6,IContextKeyService),__param(7,IThemeService),__param(8,INotificationService),__param(9,IAccessibilityService),__param(10,ILanguageConfigurationService)],CodeEditorWidget);export{CodeEditorWidget};export class BooleanEventEmitter extends Disposable{constructor(){super(),this._onDidChangeToTrue=this._register(new Emitter),this.onDidChangeToTrue=this._onDidChangeToTrue.event,this._onDidChangeToFalse=this._register(new Emitter),this.onDidChangeToFalse=this._onDidChangeToFalse.event,this._value=0}setValue(e){const t=e?2:1;this._value!==t&&(this._value=t,2===this._value?this._onDidChangeToTrue.fire():1===this._value&&this._onDidChangeToFalse.fire())}}class EditorContextKeysManager extends Disposable{constructor(e,t){super(),this._editor=e,t.createKey("editorId",e.getId()),this._editorSimpleInput=EditorContextKeys.editorSimpleInput.bindTo(t),this._editorFocus=EditorContextKeys.focus.bindTo(t),this._textInputFocus=EditorContextKeys.textInputFocus.bindTo(t),this._editorTextFocus=EditorContextKeys.editorTextFocus.bindTo(t),this._editorTabMovesFocus=EditorContextKeys.tabMovesFocus.bindTo(t),this._editorReadonly=EditorContextKeys.readOnly.bindTo(t),this._inDiffEditor=EditorContextKeys.inDiffEditor.bindTo(t),this._editorColumnSelection=EditorContextKeys.columnSelection.bindTo(t),this._hasMultipleSelections=EditorContextKeys.hasMultipleSelections.bindTo(t),this._hasNonEmptySelection=EditorContextKeys.hasNonEmptySelection.bindTo(t),this._canUndo=EditorContextKeys.canUndo.bindTo(t),this._canRedo=EditorContextKeys.canRedo.bindTo(t),this._register(this._editor.onDidChangeConfiguration((()=>this._updateFromConfig()))),this._register(this._editor.onDidChangeCursorSelection((()=>this._updateFromSelection()))),this._register(this._editor.onDidFocusEditorWidget((()=>this._updateFromFocus()))),this._register(this._editor.onDidBlurEditorWidget((()=>this._updateFromFocus()))),this._register(this._editor.onDidFocusEditorText((()=>this._updateFromFocus()))),this._register(this._editor.onDidBlurEditorText((()=>this._updateFromFocus()))),this._register(this._editor.onDidChangeModel((()=>this._updateFromModel()))),this._register(this._editor.onDidChangeConfiguration((()=>this._updateFromModel()))),this._updateFromConfig(),this._updateFromSelection(),this._updateFromFocus(),this._updateFromModel(),this._editorSimpleInput.set(this._editor.isSimpleWidget)}_updateFromConfig(){const e=this._editor.getOptions();this._editorTabMovesFocus.set(e.get(130)),this._editorReadonly.set(e.get(81)),this._inDiffEditor.set(e.get(54)),this._editorColumnSelection.set(e.get(18))}_updateFromSelection(){const e=this._editor.getSelections();e?(this._hasMultipleSelections.set(e.length>1),this._hasNonEmptySelection.set(e.some((e=>!e.isEmpty())))):(this._hasMultipleSelections.reset(),this._hasNonEmptySelection.reset())}_updateFromFocus(){this._editorFocus.set(this._editor.hasWidgetFocus()&&!this._editor.isSimpleWidget),this._editorTextFocus.set(this._editor.hasTextFocus()&&!this._editor.isSimpleWidget),this._textInputFocus.set(this._editor.hasTextFocus())}_updateFromModel(){const e=this._editor.getModel();this._canUndo.set(Boolean(e&&e.canUndo())),this._canRedo.set(Boolean(e&&e.canRedo()))}}export class EditorModeContext extends Disposable{constructor(e,t){super(),this._editor=e,this._contextKeyService=t,this._langId=EditorContextKeys.languageId.bindTo(t),this._hasCompletionItemProvider=EditorContextKeys.hasCompletionItemProvider.bindTo(t),this._hasCodeActionsProvider=EditorContextKeys.hasCodeActionsProvider.bindTo(t),this._hasCodeLensProvider=EditorContextKeys.hasCodeLensProvider.bindTo(t),this._hasDefinitionProvider=EditorContextKeys.hasDefinitionProvider.bindTo(t),this._hasDeclarationProvider=EditorContextKeys.hasDeclarationProvider.bindTo(t),this._hasImplementationProvider=EditorContextKeys.hasImplementationProvider.bindTo(t),this._hasTypeDefinitionProvider=EditorContextKeys.hasTypeDefinitionProvider.bindTo(t),this._hasHoverProvider=EditorContextKeys.hasHoverProvider.bindTo(t),this._hasDocumentHighlightProvider=EditorContextKeys.hasDocumentHighlightProvider.bindTo(t),this._hasDocumentSymbolProvider=EditorContextKeys.hasDocumentSymbolProvider.bindTo(t),this._hasReferenceProvider=EditorContextKeys.hasReferenceProvider.bindTo(t),this._hasRenameProvider=EditorContextKeys.hasRenameProvider.bindTo(t),this._hasSignatureHelpProvider=EditorContextKeys.hasSignatureHelpProvider.bindTo(t),this._hasInlayHintsProvider=EditorContextKeys.hasInlayHintsProvider.bindTo(t),this._hasDocumentFormattingProvider=EditorContextKeys.hasDocumentFormattingProvider.bindTo(t),this._hasDocumentSelectionFormattingProvider=EditorContextKeys.hasDocumentSelectionFormattingProvider.bindTo(t),this._hasMultipleDocumentFormattingProvider=EditorContextKeys.hasMultipleDocumentFormattingProvider.bindTo(t),this._hasMultipleDocumentSelectionFormattingProvider=EditorContextKeys.hasMultipleDocumentSelectionFormattingProvider.bindTo(t),this._isInWalkThrough=EditorContextKeys.isInWalkThroughSnippet.bindTo(t);const o=()=>this._update();this._register(e.onDidChangeModel(o)),this._register(e.onDidChangeModelLanguage(o)),this._register(modes.CompletionProviderRegistry.onDidChange(o)),this._register(modes.CodeActionProviderRegistry.onDidChange(o)),this._register(modes.CodeLensProviderRegistry.onDidChange(o)),this._register(modes.DefinitionProviderRegistry.onDidChange(o)),this._register(modes.DeclarationProviderRegistry.onDidChange(o)),this._register(modes.ImplementationProviderRegistry.onDidChange(o)),this._register(modes.TypeDefinitionProviderRegistry.onDidChange(o)),this._register(modes.HoverProviderRegistry.onDidChange(o)),this._register(modes.DocumentHighlightProviderRegistry.onDidChange(o)),this._register(modes.DocumentSymbolProviderRegistry.onDidChange(o)),this._register(modes.ReferenceProviderRegistry.onDidChange(o)),this._register(modes.RenameProviderRegistry.onDidChange(o)),this._register(modes.DocumentFormattingEditProviderRegistry.onDidChange(o)),this._register(modes.DocumentRangeFormattingEditProviderRegistry.onDidChange(o)),this._register(modes.SignatureHelpProviderRegistry.onDidChange(o)),this._register(modes.InlayHintsProviderRegistry.onDidChange(o)),o()}dispose(){super.dispose()}reset(){this._contextKeyService.bufferChangeEvents((()=>{this._langId.reset(),this._hasCompletionItemProvider.reset(),this._hasCodeActionsProvider.reset(),this._hasCodeLensProvider.reset(),this._hasDefinitionProvider.reset(),this._hasDeclarationProvider.reset(),this._hasImplementationProvider.reset(),this._hasTypeDefinitionProvider.reset(),this._hasHoverProvider.reset(),this._hasDocumentHighlightProvider.reset(),this._hasDocumentSymbolProvider.reset(),this._hasReferenceProvider.reset(),this._hasRenameProvider.reset(),this._hasDocumentFormattingProvider.reset(),this._hasDocumentSelectionFormattingProvider.reset(),this._hasSignatureHelpProvider.reset(),this._isInWalkThrough.reset()}))}_update(){const e=this._editor.getModel();e?this._contextKeyService.bufferChangeEvents((()=>{this._langId.set(e.getLanguageId()),this._hasCompletionItemProvider.set(modes.CompletionProviderRegistry.has(e)),this._hasCodeActionsProvider.set(modes.CodeActionProviderRegistry.has(e)),this._hasCodeLensProvider.set(modes.CodeLensProviderRegistry.has(e)),this._hasDefinitionProvider.set(modes.DefinitionProviderRegistry.has(e)),this._hasDeclarationProvider.set(modes.DeclarationProviderRegistry.has(e)),this._hasImplementationProvider.set(modes.ImplementationProviderRegistry.has(e)),this._hasTypeDefinitionProvider.set(modes.TypeDefinitionProviderRegistry.has(e)),this._hasHoverProvider.set(modes.HoverProviderRegistry.has(e)),this._hasDocumentHighlightProvider.set(modes.DocumentHighlightProviderRegistry.has(e)),this._hasDocumentSymbolProvider.set(modes.DocumentSymbolProviderRegistry.has(e)),this._hasReferenceProvider.set(modes.ReferenceProviderRegistry.has(e)),this._hasRenameProvider.set(modes.RenameProviderRegistry.has(e)),this._hasSignatureHelpProvider.set(modes.SignatureHelpProviderRegistry.has(e)),this._hasInlayHintsProvider.set(modes.InlayHintsProviderRegistry.has(e)),this._hasDocumentFormattingProvider.set(modes.DocumentFormattingEditProviderRegistry.has(e)||modes.DocumentRangeFormattingEditProviderRegistry.has(e)),this._hasDocumentSelectionFormattingProvider.set(modes.DocumentRangeFormattingEditProviderRegistry.has(e)),this._hasMultipleDocumentFormattingProvider.set(modes.DocumentFormattingEditProviderRegistry.all(e).length+modes.DocumentRangeFormattingEditProviderRegistry.all(e).length>1),this._hasMultipleDocumentSelectionFormattingProvider.set(modes.DocumentRangeFormattingEditProviderRegistry.all(e).length>1),this._isInWalkThrough.set(e.uri.scheme===Schemas.walkThroughSnippet)})):this.reset()}}class CodeEditorWidgetFocusTracker extends Disposable{constructor(e){super(),this._onChange=this._register(new Emitter),this.onChange=this._onChange.event,this._hasFocus=!1,this._domFocusTracker=this._register(dom.trackFocus(e)),this._register(this._domFocusTracker.onDidFocus((()=>{this._hasFocus=!0,this._onChange.fire(void 0)}))),this._register(this._domFocusTracker.onDidBlur((()=>{this._hasFocus=!1,this._onChange.fire(void 0)})))}hasFocus(){return this._hasFocus}}const squigglyStart=encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 6 3' enable-background='new 0 0 6 3' height='3' width='6'><g fill='"),squigglyEnd=encodeURIComponent("'><polygon points='5.5,0 2.5,3 1.1,3 4.1,0'/><polygon points='4,0 6,2 6,0.6 5.4,0'/><polygon points='0,2 1,3 2.4,3 0,0.6'/></g></svg>");function getSquigglySVGData(e){return squigglyStart+encodeURIComponent(e.toString())+squigglyEnd}const dotdotdotStart=encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" height="3" width="12"><g fill="'),dotdotdotEnd=encodeURIComponent('"><circle cx="1" cy="1" r="1"/><circle cx="5" cy="1" r="1"/><circle cx="9" cy="1" r="1"/></g></svg>');function getDotDotDotSVGData(e){return dotdotdotStart+encodeURIComponent(e.toString())+dotdotdotEnd}registerThemingParticipant(((e,t)=>{const o=e.getColor(editorErrorBorder);o&&t.addRule(`.monaco-editor .squiggly-error { border-bottom: 4px double ${o}; }`);const i=e.getColor(editorErrorForeground);i&&t.addRule(`.monaco-editor .squiggly-error { background: url("data:image/svg+xml,${getSquigglySVGData(i)}") repeat-x bottom left; }`);const s=e.getColor(editorErrorBackground);s&&t.addRule(`.monaco-editor .squiggly-error::before { display: block; content: ''; width: 100%; height: 100%; background: ${s}; }`);const n=e.getColor(editorWarningBorder);n&&t.addRule(`.monaco-editor .squiggly-warning { border-bottom: 4px double ${n}; }`);const r=e.getColor(editorWarningForeground);r&&t.addRule(`.monaco-editor .squiggly-warning { background: url("data:image/svg+xml,${getSquigglySVGData(r)}") repeat-x bottom left; }`);const a=e.getColor(editorWarningBackground);a&&t.addRule(`.monaco-editor .squiggly-warning::before { display: block; content: ''; width: 100%; height: 100%; background: ${a}; }`);const d=e.getColor(editorInfoBorder);d&&t.addRule(`.monaco-editor .squiggly-info { border-bottom: 4px double ${d}; }`);const h=e.getColor(editorInfoForeground);h&&t.addRule(`.monaco-editor .squiggly-info { background: url("data:image/svg+xml,${getSquigglySVGData(h)}") repeat-x bottom left; }`);const l=e.getColor(editorInfoBackground);l&&t.addRule(`.monaco-editor .squiggly-info::before { display: block; content: ''; width: 100%; height: 100%; background: ${l}; }`);const m=e.getColor(editorHintBorder);m&&t.addRule(`.monaco-editor .squiggly-hint { border-bottom: 2px dotted ${m}; }`);const c=e.getColor(editorHintForeground);c&&t.addRule(`.monaco-editor .squiggly-hint { background: url("data:image/svg+xml,${getDotDotDotSVGData(c)}") no-repeat bottom left; }`);const g=e.getColor(editorUnnecessaryCodeOpacity);g&&t.addRule(`.monaco-editor.showUnused .squiggly-inline-unnecessary { opacity: ${g.rgba.a}; }`);const _=e.getColor(editorUnnecessaryCodeBorder);_&&t.addRule(`.monaco-editor.showUnused .squiggly-unnecessary { border-bottom: 2px dashed ${_}; }`);const u=e.getColor(editorForeground)||"inherit";t.addRule(`.monaco-editor.showDeprecated .squiggly-inline-deprecated { text-decoration: line-through; text-decoration-color: ${u}}`)}));