var __decorate=this&&this.__decorate||function(e,r,t,o){var i,s=arguments.length,n=s<3?r:null===o?o=Object.getOwnPropertyDescriptor(r,t):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)n=Reflect.decorate(e,r,t,o);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(n=(s<3?i(n):s>3?i(r,t,n):i(r,t))||n);return s>3&&n&&Object.defineProperty(r,t,n),n},__param=this&&this.__param||function(e,r){return function(t,o){r(t,o,e)}},__awaiter=this&&this.__awaiter||function(e,r,t,o){function i(e){return e instanceof t?e:new t((function(r){r(e)}))}return new(t||(t=Promise))((function(t,s){function n(e){try{a(o.next(e))}catch(r){s(r)}}function c(e){try{a(o["throw"](e))}catch(r){s(r)}}function a(e){e.done?t(e.value):i(e.value).then(n,c)}a((o=o.apply(e,r||[])).next())}))};import{IntervalTimer,timeout}from"../../../base/common/async.js";import{Disposable,dispose,toDisposable,DisposableStore}from"../../../base/common/lifecycle.js";import{SimpleWorkerClient,logOnceWebWorkerWarning}from"../../../base/common/worker/simpleWorker.js";import{DefaultWorkerFactory}from"../../../base/browser/defaultWorkerFactory.js";import{Range}from"../../common/core/range.js";import*as modes from"../../common/languages.js";import{ILanguageConfigurationService}from"../../common/languages/languageConfigurationRegistry.js";import{EditorSimpleWorker}from"../../common/services/editorSimpleWorker.js";import{IModelService}from"../../common/services/model.js";import{ITextResourceConfigurationService}from"../../common/services/textResourceConfiguration.js";import{regExpFlags}from"../../../base/common/strings.js";import{isNonEmptyArray}from"../../../base/common/arrays.js";import{ILogService}from"../../../platform/log/common/log.js";import{StopWatch}from"../../../base/common/stopwatch.js";import{canceled}from"../../../base/common/errors.js";const STOP_SYNC_MODEL_DELTA_TIME_MS=6e4,STOP_WORKER_DELTA_TIME_MS=3e5;function canSyncModel(e,r){const t=e.getModel(r);return!!t&&!t.isTooLargeForSyncing()}let EditorWorkerService=class extends Disposable{constructor(e,r,t,o){super(),this._modelService=e,this._workerManager=this._register(new WorkerManager(this._modelService,o)),this._logService=t,this._register(modes.LinkProviderRegistry.register({language:"*",hasAccessToAllModels:!0},{provideLinks:(e,r)=>canSyncModel(this._modelService,e.uri)?this._workerManager.withWorker().then((r=>r.computeLinks(e.uri))).then((e=>e&&{links:e})):Promise.resolve({links:[]})})),this._register(modes.CompletionProviderRegistry.register("*",new WordBasedCompletionItemProvider(this._workerManager,r,this._modelService,o)))}dispose(){super.dispose()}canComputeUnicodeHighlights(e){return canSyncModel(this._modelService,e)}computedUnicodeHighlights(e,r,t){return this._workerManager.withWorker().then((o=>o.computedUnicodeHighlights(e,r,t)))}computeDiff(e,r,t,o){return this._workerManager.withWorker().then((i=>i.computeDiff(e,r,t,o)))}computeMoreMinimalEdits(e,r){if(isNonEmptyArray(r)){if(!canSyncModel(this._modelService,e))return Promise.resolve(r);const t=StopWatch.create(!0),o=this._workerManager.withWorker().then((t=>t.computeMoreMinimalEdits(e,r)));return o.finally((()=>this._logService.trace("FORMAT#computeMoreMinimalEdits",e.toString(!0),t.elapsed()))),Promise.race([o,timeout(1e3).then((()=>r))])}return Promise.resolve(void 0)}canNavigateValueSet(e){return canSyncModel(this._modelService,e)}navigateValueSet(e,r,t){return this._workerManager.withWorker().then((o=>o.navigateValueSet(e,r,t)))}canComputeWordRanges(e){return canSyncModel(this._modelService,e)}computeWordRanges(e,r){return this._workerManager.withWorker().then((t=>t.computeWordRanges(e,r)))}};EditorWorkerService=__decorate([__param(0,IModelService),__param(1,ITextResourceConfigurationService),__param(2,ILogService),__param(3,ILanguageConfigurationService)],EditorWorkerService);export{EditorWorkerService};class WordBasedCompletionItemProvider{constructor(e,r,t,o){this.languageConfigurationService=o,this._debugDisplayName="wordbasedCompletions",this._workerManager=e,this._configurationService=r,this._modelService=t}provideCompletionItems(e,r){return __awaiter(this,void 0,void 0,(function*(){const t=this._configurationService.getValue(e.uri,r,"editor");if(!t.wordBasedSuggestions)return;const o=[];if("currentDocument"===t.wordBasedSuggestionsMode)canSyncModel(this._modelService,e.uri)&&o.push(e.uri);else for(const r of this._modelService.getModels())canSyncModel(this._modelService,r.uri)&&(r===e?o.unshift(r.uri):"allDocuments"!==t.wordBasedSuggestionsMode&&r.getLanguageId()!==e.getLanguageId()||o.push(r.uri));if(0===o.length)return;const i=this.languageConfigurationService.getLanguageConfiguration(e.getLanguageId()).getWordDefinition(),s=e.getWordAtPosition(r),n=s?new Range(r.lineNumber,s.startColumn,r.lineNumber,s.endColumn):Range.fromPositions(r),c=n.setEndPosition(r.lineNumber,r.column),a=yield this._workerManager.withWorker(),d=yield a.textualSuggest(o,null===s||void 0===s?void 0:s.word,i);return d?{duration:d.duration,suggestions:d.words.map((e=>({kind:18,label:e,insertText:e,range:{insert:c,replace:n}})))}:void 0}))}}class WorkerManager extends Disposable{constructor(e,r){super(),this.languageConfigurationService=r,this._modelService=e,this._editorWorkerClient=null,this._lastWorkerUsedTime=(new Date).getTime();const t=this._register(new IntervalTimer);t.cancelAndSet((()=>this._checkStopIdleWorker()),Math.round(STOP_WORKER_DELTA_TIME_MS/2)),this._register(this._modelService.onModelRemoved((e=>this._checkStopEmptyWorker())))}dispose(){this._editorWorkerClient&&(this._editorWorkerClient.dispose(),this._editorWorkerClient=null),super.dispose()}_checkStopEmptyWorker(){if(!this._editorWorkerClient)return;const e=this._modelService.getModels();0===e.length&&(this._editorWorkerClient.dispose(),this._editorWorkerClient=null)}_checkStopIdleWorker(){if(!this._editorWorkerClient)return;const e=(new Date).getTime()-this._lastWorkerUsedTime;e>STOP_WORKER_DELTA_TIME_MS&&(this._editorWorkerClient.dispose(),this._editorWorkerClient=null)}withWorker(){return this._lastWorkerUsedTime=(new Date).getTime(),this._editorWorkerClient||(this._editorWorkerClient=new EditorWorkerClient(this._modelService,!1,"editorWorkerService",this.languageConfigurationService)),Promise.resolve(this._editorWorkerClient)}}class EditorModelManager extends Disposable{constructor(e,r,t){if(super(),this._syncedModels=Object.create(null),this._syncedModelsLastUsedTime=Object.create(null),this._proxy=e,this._modelService=r,!t){const e=new IntervalTimer;e.cancelAndSet((()=>this._checkStopModelSync()),Math.round(STOP_SYNC_MODEL_DELTA_TIME_MS/2)),this._register(e)}}dispose(){for(let e in this._syncedModels)dispose(this._syncedModels[e]);this._syncedModels=Object.create(null),this._syncedModelsLastUsedTime=Object.create(null),super.dispose()}ensureSyncedResources(e,r){for(const t of e){const e=t.toString();this._syncedModels[e]||this._beginModelSync(t,r),this._syncedModels[e]&&(this._syncedModelsLastUsedTime[e]=(new Date).getTime())}}_checkStopModelSync(){const e=(new Date).getTime(),r=[];for(let t in this._syncedModelsLastUsedTime){const o=e-this._syncedModelsLastUsedTime[t];o>STOP_SYNC_MODEL_DELTA_TIME_MS&&r.push(t)}for(const t of r)this._stopModelSync(t)}_beginModelSync(e,r){const t=this._modelService.getModel(e);if(!t)return;if(!r&&t.isTooLargeForSyncing())return;const o=e.toString();this._proxy.acceptNewModel({url:t.uri.toString(),lines:t.getLinesContent(),EOL:t.getEOL(),versionId:t.getVersionId()});const i=new DisposableStore;i.add(t.onDidChangeContent((e=>{this._proxy.acceptModelChanged(o.toString(),e)}))),i.add(t.onWillDispose((()=>{this._stopModelSync(o)}))),i.add(toDisposable((()=>{this._proxy.acceptRemovedModel(o)}))),this._syncedModels[o]=i}_stopModelSync(e){const r=this._syncedModels[e];delete this._syncedModels[e],delete this._syncedModelsLastUsedTime[e],dispose(r)}}class SynchronousWorkerClient{constructor(e){this._instance=e,this._proxyObj=Promise.resolve(this._instance)}dispose(){this._instance.dispose()}getProxyObject(){return this._proxyObj}}export class EditorWorkerHost{constructor(e){this._workerClient=e}fhr(e,r){return this._workerClient.fhr(e,r)}}export class EditorWorkerClient extends Disposable{constructor(e,r,t,o){super(),this.languageConfigurationService=o,this._disposed=!1,this._modelService=e,this._keepIdleModels=r,this._workerFactory=new DefaultWorkerFactory(t),this._worker=null,this._modelManager=null}fhr(e,r){throw new Error("Not implemented!")}_getOrCreateWorker(){if(!this._worker)try{this._worker=this._register(new SimpleWorkerClient(this._workerFactory,"vs/editor/common/services/editorSimpleWorker",new EditorWorkerHost(this)))}catch(e){logOnceWebWorkerWarning(e),this._worker=new SynchronousWorkerClient(new EditorSimpleWorker(new EditorWorkerHost(this),null))}return this._worker}_getProxy(){return this._getOrCreateWorker().getProxyObject().then(void 0,(e=>(logOnceWebWorkerWarning(e),this._worker=new SynchronousWorkerClient(new EditorSimpleWorker(new EditorWorkerHost(this),null)),this._getOrCreateWorker().getProxyObject())))}_getOrCreateModelManager(e){return this._modelManager||(this._modelManager=this._register(new EditorModelManager(e,this._modelService,this._keepIdleModels))),this._modelManager}_withSyncedResources(e,r=!1){return __awaiter(this,void 0,void 0,(function*(){return this._disposed?Promise.reject(canceled()):this._getProxy().then((t=>(this._getOrCreateModelManager(t).ensureSyncedResources(e,r),t)))}))}computedUnicodeHighlights(e,r,t){return this._withSyncedResources([e]).then((o=>o.computeUnicodeHighlights(e.toString(),r,t)))}computeDiff(e,r,t,o){return this._withSyncedResources([e,r],!0).then((i=>i.computeDiff(e.toString(),r.toString(),t,o)))}computeMoreMinimalEdits(e,r){return this._withSyncedResources([e]).then((t=>t.computeMoreMinimalEdits(e.toString(),r)))}computeLinks(e){return this._withSyncedResources([e]).then((r=>r.computeLinks(e.toString())))}textualSuggest(e,r,t){return __awaiter(this,void 0,void 0,(function*(){const o=yield this._withSyncedResources(e),i=t.source,s=regExpFlags(t);return o.textualSuggest(e.map((e=>e.toString())),r,i,s)}))}computeWordRanges(e,r){return this._withSyncedResources([e]).then((t=>{const o=this._modelService.getModel(e);if(!o)return Promise.resolve(null);const i=this.languageConfigurationService.getLanguageConfiguration(o.getLanguageId()).getWordDefinition(),s=i.source,n=regExpFlags(i);return t.computeWordRanges(e.toString(),r,s,n)}))}navigateValueSet(e,r,t){return this._withSyncedResources([e]).then((o=>{const i=this._modelService.getModel(e);if(!i)return null;const s=this.languageConfigurationService.getLanguageConfiguration(i.getLanguageId()).getWordDefinition(),n=s.source,c=regExpFlags(s);return o.navigateValueSet(e.toString(),r,t,n,c)}))}dispose(){super.dispose(),this._disposed=!0}}