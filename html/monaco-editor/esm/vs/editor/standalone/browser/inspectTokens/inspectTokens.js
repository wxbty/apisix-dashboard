var __decorate=this&&this.__decorate||function(e,t,o,n){var i,r=arguments.length,s=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)s=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(r<3?i(s):r>3?i(t,o,s):i(t,o))||s);return r>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};import"./inspectTokens.css";import{$,append,reset}from"../../../../base/browser/dom.js";import{Color}from"../../../../base/common/color.js";import{Disposable}from"../../../../base/common/lifecycle.js";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{TokenMetadata,TokenizationRegistry}from"../../../common/languages.js";import{NullState,nullTokenize,nullTokenizeEncoded}from"../../../common/languages/nullMode.js";import{ILanguageService}from"../../../common/services/language.js";import{IStandaloneThemeService}from"../../common/standaloneTheme.js";import{editorHoverBackground,editorHoverBorder,editorHoverForeground}from"../../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";import{InspectTokensNLS}from"../../../common/standaloneStrings.js";import{ColorScheme}from"../../../../platform/theme/common/theme.js";let InspectTokensController=class e extends Disposable{constructor(e,t,o){super(),this._editor=e,this._languageService=o,this._widget=null,this._register(this._editor.onDidChangeModel((e=>this.stop()))),this._register(this._editor.onDidChangeModelLanguage((e=>this.stop()))),this._register(TokenizationRegistry.onDidChange((e=>this.stop()))),this._register(this._editor.onKeyUp((e=>9===e.keyCode&&this.stop())))}static get(t){return t.getContribution(e.ID)}dispose(){this.stop(),super.dispose()}launch(){this._widget||this._editor.hasModel()&&(this._widget=new InspectTokensWidget(this._editor,this._languageService))}stop(){this._widget&&(this._widget.dispose(),this._widget=null)}};InspectTokensController.ID="editor.contrib.inspectTokens",InspectTokensController=__decorate([__param(1,IStandaloneThemeService),__param(2,ILanguageService)],InspectTokensController);class InspectTokens extends EditorAction{constructor(){super({id:"editor.action.inspectTokens",label:InspectTokensNLS.inspectTokensAction,alias:"Developer: Inspect Tokens",precondition:void 0})}run(e,t){const o=InspectTokensController.get(t);o&&o.launch()}}function renderTokenText(e){let t="";for(let o=0,n=e.length;o<n;o++){const n=e.charCodeAt(o);switch(n){case 9:t+="\u2192";break;case 32:t+="\xb7";break;default:t+=String.fromCharCode(n)}}return t}function getSafeTokenizationSupport(e,t){const o=TokenizationRegistry.get(t);if(o)return o;const n=e.encodeLanguageId(t);return{getInitialState:()=>NullState,tokenize:(e,o,n)=>nullTokenize(t,n),tokenizeEncoded:(e,t,o)=>nullTokenizeEncoded(n,o)}}class InspectTokensWidget extends Disposable{constructor(e,t){super(),this.allowEditorOverflow=!0,this._editor=e,this._languageService=t,this._model=this._editor.getModel(),this._domNode=document.createElement("div"),this._domNode.className="tokens-inspect-widget",this._tokenizationSupport=getSafeTokenizationSupport(this._languageService.languageIdCodec,this._model.getLanguageId()),this._compute(this._editor.getPosition()),this._register(this._editor.onDidChangeCursorPosition((e=>this._compute(this._editor.getPosition())))),this._editor.addContentWidget(this)}dispose(){this._editor.removeContentWidget(this),super.dispose()}getId(){return InspectTokensWidget._ID}_compute(e){const t=this._getTokensAtLine(e.lineNumber);let o=0;for(let a=t.tokens1.length-1;a>=0;a--){const n=t.tokens1[a];if(e.column-1>=n.offset){o=a;break}}let n=0;for(let a=t.tokens2.length>>>1;a>=0;a--)if(e.column-1>=t.tokens2[a<<1]){n=a;break}const i=this._model.getLineContent(e.lineNumber);let r="";if(o<t.tokens1.length){const e=t.tokens1[o].offset,n=o+1<t.tokens1.length?t.tokens1[o+1].offset:i.length;r=i.substring(e,n)}reset(this._domNode,$("h2.tm-token",void 0,renderTokenText(r),$("span.tm-token-length",void 0,`${r.length} ${1===r.length?"char":"chars"}`))),append(this._domNode,$("hr.tokens-inspect-separator",{style:"clear:both"}));const s=1+(n<<1)<t.tokens2.length?this._decodeMetadata(t.tokens2[1+(n<<1)]):null;append(this._domNode,$("table.tm-metadata-table",void 0,$("tbody",void 0,$("tr",void 0,$("td.tm-metadata-key",void 0,"language"),$("td.tm-metadata-value",void 0,`${s?s.languageId:"-?-"}`)),$("tr",void 0,$("td.tm-metadata-key",void 0,"token type"),$("td.tm-metadata-value",void 0,`${s?this._tokenTypeToString(s.tokenType):"-?-"}`)),$("tr",void 0,$("td.tm-metadata-key",void 0,"font style"),$("td.tm-metadata-value",void 0,`${s?this._fontStyleToString(s.fontStyle):"-?-"}`)),$("tr",void 0,$("td.tm-metadata-key",void 0,"foreground"),$("td.tm-metadata-value",void 0,`${s?Color.Format.CSS.formatHex(s.foreground):"-?-"}`)),$("tr",void 0,$("td.tm-metadata-key",void 0,"background"),$("td.tm-metadata-value",void 0,`${s?Color.Format.CSS.formatHex(s.background):"-?-"}`))))),append(this._domNode,$("hr.tokens-inspect-separator")),o<t.tokens1.length&&append(this._domNode,$("span.tm-token-type",void 0,t.tokens1[o].type)),this._editor.layoutContentWidget(this)}_decodeMetadata(e){const t=TokenizationRegistry.getColorMap(),o=TokenMetadata.getLanguageId(e),n=TokenMetadata.getTokenType(e),i=TokenMetadata.getFontStyle(e),r=TokenMetadata.getForeground(e),s=TokenMetadata.getBackground(e);return{languageId:this._languageService.languageIdCodec.decodeLanguageId(o),tokenType:n,fontStyle:i,foreground:t[r],background:t[s]}}_tokenTypeToString(e){switch(e){case 0:return"Other";case 1:return"Comment";case 2:return"String";case 3:return"RegEx";default:return"??"}}_fontStyleToString(e){let t="";return 1&e&&(t+="italic "),2&e&&(t+="bold "),4&e&&(t+="underline "),8&e&&(t+="strikethrough "),0===t.length&&(t="---"),t}_getTokensAtLine(e){const t=this._getStateBeforeLine(e),o=this._tokenizationSupport.tokenize(this._model.getLineContent(e),!0,t),n=this._tokenizationSupport.tokenizeEncoded(this._model.getLineContent(e),!0,t);return{startState:t,tokens1:o.tokens,tokens2:n.tokens,endState:o.endState}}_getStateBeforeLine(e){let t=this._tokenizationSupport.getInitialState();for(let o=1;o<e;o++){const e=this._tokenizationSupport.tokenize(this._model.getLineContent(o),!0,t);t=e.endState}return t}getDomNode(){return this._domNode}getPosition(){return{position:this._editor.getPosition(),preference:[2,1]}}}InspectTokensWidget._ID="editor.contrib.inspectTokensWidget",registerEditorContribution(InspectTokensController.ID,InspectTokensController),registerEditorAction(InspectTokens),registerThemingParticipant(((e,t)=>{const o=e.getColor(editorHoverBorder);if(o){const n=e.type===ColorScheme.HIGH_CONTRAST?2:1;t.addRule(`.monaco-editor .tokens-inspect-widget { border: ${n}px solid ${o}; }`),t.addRule(`.monaco-editor .tokens-inspect-widget .tokens-inspect-separator { background-color: ${o}; }`)}const n=e.getColor(editorHoverBackground);n&&t.addRule(`.monaco-editor .tokens-inspect-widget { background-color: ${n}; }`);const i=e.getColor(editorHoverForeground);i&&t.addRule(`.monaco-editor .tokens-inspect-widget { color: ${i}; }`)}));