var __decorate=this&&this.__decorate||function(e,t,i,o){var s,r=arguments.length,n=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)n=Reflect.decorate(e,t,i,o);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(n=(r<3?s(n):r>3?s(t,i,n):s(t,i))||n);return r>3&&n&&Object.defineProperty(t,i,n),n},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}};import"./accessibilityHelp.css";import*as dom from"../../../../base/browser/dom.js";import{createFastDomNode}from"../../../../base/browser/fastDomNode.js";import{renderFormattedText}from"../../../../base/browser/formattedTextRenderer.js";import{alert}from"../../../../base/browser/ui/aria/aria.js";import{Widget}from"../../../../base/browser/ui/widget.js";import{Disposable}from"../../../../base/common/lifecycle.js";import*as platform from"../../../../base/common/platform.js";import*as strings from"../../../../base/common/strings.js";import{URI}from"../../../../base/common/uri.js";import{EditorAction,EditorCommand,registerEditorAction,registerEditorCommand,registerEditorContribution}from"../../../browser/editorExtensions.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{ToggleTabFocusModeAction}from"../../../contrib/toggleTabFocusMode/browser/toggleTabFocusMode.js";import{IContextKeyService,RawContextKey}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService}from"../../../../platform/keybinding/common/keybinding.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";import{contrastBorder,editorWidgetBackground,widgetShadow,editorWidgetForeground}from"../../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";import{AccessibilityHelpNLS}from"../../../common/standaloneStrings.js";const CONTEXT_ACCESSIBILITY_WIDGET_VISIBLE=new RawContextKey("accessibilityHelpWidgetVisible",!1);let AccessibilityHelpController=class e extends Disposable{constructor(e,t){super(),this._editor=e,this._widget=this._register(t.createInstance(AccessibilityHelpWidget,this._editor))}static get(t){return t.getContribution(e.ID)}show(){this._widget.show()}hide(){this._widget.hide()}};function getSelectionLabel(e,t){return e&&0!==e.length?1===e.length?t?strings.format(AccessibilityHelpNLS.singleSelectionRange,e[0].positionLineNumber,e[0].positionColumn,t):strings.format(AccessibilityHelpNLS.singleSelection,e[0].positionLineNumber,e[0].positionColumn):t?strings.format(AccessibilityHelpNLS.multiSelectionRange,e.length,t):e.length>0?strings.format(AccessibilityHelpNLS.multiSelection,e.length):"":AccessibilityHelpNLS.noSelection}AccessibilityHelpController.ID="editor.contrib.accessibilityHelpController",AccessibilityHelpController=__decorate([__param(1,IInstantiationService)],AccessibilityHelpController);let AccessibilityHelpWidget=class e extends Widget{constructor(e,t,i,o){super(),this._contextKeyService=t,this._keybindingService=i,this._openerService=o,this._editor=e,this._isVisibleKey=CONTEXT_ACCESSIBILITY_WIDGET_VISIBLE.bindTo(this._contextKeyService),this._domNode=createFastDomNode(document.createElement("div")),this._domNode.setClassName("accessibilityHelpWidget"),this._domNode.setDisplay("none"),this._domNode.setAttribute("role","dialog"),this._domNode.setAttribute("aria-hidden","true"),this._contentDomNode=createFastDomNode(document.createElement("div")),this._contentDomNode.setAttribute("role","document"),this._domNode.appendChild(this._contentDomNode),this._isVisible=!1,this._register(this._editor.onDidLayoutChange((()=>{this._isVisible&&this._layout()}))),this._register(dom.addStandardDisposableListener(this._contentDomNode.domNode,"keydown",(e=>{if(this._isVisible&&(e.equals(2083)&&(alert(AccessibilityHelpNLS.emergencyConfOn),this._editor.updateOptions({accessibilitySupport:"on"}),dom.clearNode(this._contentDomNode.domNode),this._buildContent(),this._contentDomNode.domNode.focus(),e.preventDefault(),e.stopPropagation()),e.equals(2086))){alert(AccessibilityHelpNLS.openingDocs);let t=this._editor.getRawOptions().accessibilityHelpUrl;"undefined"===typeof t&&(t="https://go.microsoft.com/fwlink/?linkid=852450"),this._openerService.open(URI.parse(t)),e.preventDefault(),e.stopPropagation()}}))),this.onblur(this._contentDomNode.domNode,(()=>{this.hide()})),this._editor.addOverlayWidget(this)}dispose(){this._editor.removeOverlayWidget(this),super.dispose()}getId(){return e.ID}getDomNode(){return this._domNode.domNode}getPosition(){return{preference:null}}show(){this._isVisible||(this._isVisible=!0,this._isVisibleKey.set(!0),this._layout(),this._domNode.setDisplay("block"),this._domNode.setAttribute("aria-hidden","false"),this._contentDomNode.domNode.tabIndex=0,this._buildContent(),this._contentDomNode.domNode.focus())}_descriptionForCommand(e,t,i){const o=this._keybindingService.lookupKeybinding(e);return o?strings.format(t,o.getAriaLabel()):strings.format(i,e)}_buildContent(){const e=this._editor.getOptions(),t=this._editor.getSelections();let i=0;if(t){const e=this._editor.getModel();e&&t.forEach((t=>{i+=e.getValueLengthInRange(t)}))}let o=getSelectionLabel(t,i);e.get(54)?e.get(81)?o+=AccessibilityHelpNLS.readonlyDiffEditor:o+=AccessibilityHelpNLS.editableDiffEditor:e.get(81)?o+=AccessibilityHelpNLS.readonlyEditor:o+=AccessibilityHelpNLS.editableEditor;const s=platform.isMacintosh?AccessibilityHelpNLS.changeConfigToOnMac:AccessibilityHelpNLS.changeConfigToOnWinLinux;switch(e.get(2)){case 0:o+="\n\n - "+s;break;case 2:o+="\n\n - "+AccessibilityHelpNLS.auto_on;break;case 1:o+="\n\n - "+AccessibilityHelpNLS.auto_off,o+=" "+s;break}e.get(130)?o+="\n\n - "+this._descriptionForCommand(ToggleTabFocusModeAction.ID,AccessibilityHelpNLS.tabFocusModeOnMsg,AccessibilityHelpNLS.tabFocusModeOnMsgNoKb):o+="\n\n - "+this._descriptionForCommand(ToggleTabFocusModeAction.ID,AccessibilityHelpNLS.tabFocusModeOffMsg,AccessibilityHelpNLS.tabFocusModeOffMsgNoKb);const r=platform.isMacintosh?AccessibilityHelpNLS.openDocMac:AccessibilityHelpNLS.openDocWinLinux;o+="\n\n - "+r,o+="\n\n"+AccessibilityHelpNLS.outroMsg,this._contentDomNode.domNode.appendChild(renderFormattedText(o)),this._contentDomNode.domNode.setAttribute("aria-label",o)}hide(){this._isVisible&&(this._isVisible=!1,this._isVisibleKey.reset(),this._domNode.setDisplay("none"),this._domNode.setAttribute("aria-hidden","true"),this._contentDomNode.domNode.tabIndex=-1,dom.clearNode(this._contentDomNode.domNode),this._editor.focus())}_layout(){const t=this._editor.getLayoutInfo(),i=Math.max(5,Math.min(e.WIDTH,t.width-40)),o=Math.max(5,Math.min(e.HEIGHT,t.height-40));this._domNode.setWidth(i),this._domNode.setHeight(o);const s=Math.round((t.height-o)/2);this._domNode.setTop(s);const r=Math.round((t.width-i)/2);this._domNode.setLeft(r)}};AccessibilityHelpWidget.ID="editor.contrib.accessibilityHelpWidget",AccessibilityHelpWidget.WIDTH=500,AccessibilityHelpWidget.HEIGHT=300,AccessibilityHelpWidget=__decorate([__param(1,IContextKeyService),__param(2,IKeybindingService),__param(3,IOpenerService)],AccessibilityHelpWidget);class ShowAccessibilityHelpAction extends EditorAction{constructor(){super({id:"editor.action.showAccessibilityHelp",label:AccessibilityHelpNLS.showAccessibilityHelpAction,alias:"Show Accessibility Help",precondition:void 0,kbOpts:{primary:571,weight:100,linux:{primary:1595,secondary:[571]}}})}run(e,t){const i=AccessibilityHelpController.get(t);i&&i.show()}}registerEditorContribution(AccessibilityHelpController.ID,AccessibilityHelpController),registerEditorAction(ShowAccessibilityHelpAction);const AccessibilityHelpCommand=EditorCommand.bindToContribution(AccessibilityHelpController.get);registerEditorCommand(new AccessibilityHelpCommand({id:"closeAccessibilityHelp",precondition:CONTEXT_ACCESSIBILITY_WIDGET_VISIBLE,handler:e=>e.hide(),kbOpts:{weight:200,kbExpr:EditorContextKeys.focus,primary:9,secondary:[1033]}})),registerThemingParticipant(((e,t)=>{const i=e.getColor(editorWidgetBackground);i&&t.addRule(`.monaco-editor .accessibilityHelpWidget { background-color: ${i}; }`);const o=e.getColor(editorWidgetForeground);o&&t.addRule(`.monaco-editor .accessibilityHelpWidget { color: ${o}; }`);const s=e.getColor(widgetShadow);s&&t.addRule(`.monaco-editor .accessibilityHelpWidget { box-shadow: 0 2px 8px ${s}; }`);const r=e.getColor(contrastBorder);r&&t.addRule(`.monaco-editor .accessibilityHelpWidget { border: 2px solid ${r}; }`)}));