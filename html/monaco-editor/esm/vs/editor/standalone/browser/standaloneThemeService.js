import*as dom from"../../../base/browser/dom.js";import{Color}from"../../../base/common/color.js";import{Emitter}from"../../../base/common/event.js";import{TokenizationRegistry,TokenMetadata}from"../../common/languages.js";import{TokenTheme,generateTokensCSSForColorMap}from"../../common/languages/supports/tokenization.js";import{hc_black,vs,vs_dark}from"../common/themes.js";import{Registry}from"../../../platform/registry/common/platform.js";import{asCssVariableName,Extensions}from"../../../platform/theme/common/colorRegistry.js";import{Extensions as ThemingExtensions}from"../../../platform/theme/common/themeService.js";import{Disposable}from"../../../base/common/lifecycle.js";import{ColorScheme}from"../../../platform/theme/common/theme.js";import{getIconsStyleSheet,UnthemedProductIconTheme}from"../../../platform/theme/browser/iconsStyleSheet.js";const VS_THEME_NAME="vs",VS_DARK_THEME_NAME="vs-dark",HC_BLACK_THEME_NAME="hc-black",colorRegistry=Registry.as(Extensions.ColorContribution),themingRegistry=Registry.as(ThemingExtensions.ThemingContribution);class StandaloneTheme{constructor(e,t){this.semanticHighlighting=!1,this.themeData=t;const o=t.base;e.length>0?(isBuiltinTheme(e)?this.id=e:this.id=o+" "+e,this.themeName=e):(this.id=o,this.themeName=o),this.colors=null,this.defaultColors=Object.create(null),this._tokenTheme=null}get base(){return this.themeData.base}notifyBaseUpdated(){this.themeData.inherit&&(this.colors=null,this._tokenTheme=null)}getColors(){if(!this.colors){const e=new Map;for(let t in this.themeData.colors)e.set(t,Color.fromHex(this.themeData.colors[t]));if(this.themeData.inherit){const t=getBuiltinRules(this.themeData.base);for(let o in t.colors)e.has(o)||e.set(o,Color.fromHex(t.colors[o]))}this.colors=e}return this.colors}getColor(e,t){const o=this.getColors().get(e);return o||(!1!==t?this.getDefault(e):void 0)}getDefault(e){let t=this.defaultColors[e];return t||(t=colorRegistry.resolveDefaultColor(e,this),this.defaultColors[e]=t,t)}defines(e){return Object.prototype.hasOwnProperty.call(this.getColors(),e)}get type(){switch(this.base){case VS_THEME_NAME:return ColorScheme.LIGHT;case HC_BLACK_THEME_NAME:return ColorScheme.HIGH_CONTRAST;default:return ColorScheme.DARK}}get tokenTheme(){if(!this._tokenTheme){let e=[],t=[];if(this.themeData.inherit){const o=getBuiltinRules(this.themeData.base);e=o.rules,o.encodedTokensColors&&(t=o.encodedTokensColors)}const o=this.themeData.colors["editor.foreground"],s=this.themeData.colors["editor.background"];if(o||s){const t={token:""};o&&(t.foreground=o),s&&(t.background=s),e.push(t)}e=e.concat(this.themeData.rules),this.themeData.encodedTokensColors&&(t=this.themeData.encodedTokensColors),this._tokenTheme=TokenTheme.createFromRawTokenTheme(e,t)}return this._tokenTheme}getTokenStyleMetadata(e,t,o){const s=this.tokenTheme._match([e].concat(t).join(".")),n=s.metadata,i=TokenMetadata.getForeground(n),h=TokenMetadata.getFontStyle(n);return{foreground:i,italic:Boolean(1&h),bold:Boolean(2&h),underline:Boolean(4&h),strikethrough:Boolean(8&h)}}}function isBuiltinTheme(e){return e===VS_THEME_NAME||e===VS_DARK_THEME_NAME||e===HC_BLACK_THEME_NAME}function getBuiltinRules(e){switch(e){case VS_THEME_NAME:return vs;case VS_DARK_THEME_NAME:return vs_dark;case HC_BLACK_THEME_NAME:return hc_black}}function newBuiltInTheme(e){const t=getBuiltinRules(e);return new StandaloneTheme(e,t)}export class StandaloneThemeService extends Disposable{constructor(){super(),this._onColorThemeChange=this._register(new Emitter),this.onDidColorThemeChange=this._onColorThemeChange.event,this._onProductIconThemeChange=this._register(new Emitter),this.onDidProductIconThemeChange=this._onProductIconThemeChange.event,this._environment=Object.create(null),this._builtInProductIconTheme=new UnthemedProductIconTheme,this._autoDetectHighContrast=!0,this._knownThemes=new Map,this._knownThemes.set(VS_THEME_NAME,newBuiltInTheme(VS_THEME_NAME)),this._knownThemes.set(VS_DARK_THEME_NAME,newBuiltInTheme(VS_DARK_THEME_NAME)),this._knownThemes.set(HC_BLACK_THEME_NAME,newBuiltInTheme(HC_BLACK_THEME_NAME));const e=getIconsStyleSheet(this);this._codiconCSS=e.getCSS(),this._themeCSS="",this._allCSS=`${this._codiconCSS}\n${this._themeCSS}`,this._globalStyleElement=null,this._styleElements=[],this._colorMapOverride=null,this.setTheme(VS_THEME_NAME),e.onDidChange((()=>{this._codiconCSS=e.getCSS(),this._updateCSS()})),dom.addMatchMediaChangeListener("(forced-colors: active)",(()=>{this._updateActualTheme()}))}registerEditorContainer(e){return dom.isInShadowDOM(e)?this._registerShadowDomContainer(e):this._registerRegularEditorContainer()}_registerRegularEditorContainer(){return this._globalStyleElement||(this._globalStyleElement=dom.createStyleSheet(),this._globalStyleElement.className="monaco-colors",this._globalStyleElement.textContent=this._allCSS,this._styleElements.push(this._globalStyleElement)),Disposable.None}_registerShadowDomContainer(e){const t=dom.createStyleSheet(e);return t.className="monaco-colors",t.textContent=this._allCSS,this._styleElements.push(t),{dispose:()=>{for(let e=0;e<this._styleElements.length;e++)if(this._styleElements[e]===t)return void this._styleElements.splice(e,1)}}}defineTheme(e,t){if(!/^[a-z0-9\-]+$/i.test(e))throw new Error("Illegal theme name!");if(!isBuiltinTheme(t.base)&&!isBuiltinTheme(e))throw new Error("Illegal theme base!");this._knownThemes.set(e,new StandaloneTheme(e,t)),isBuiltinTheme(e)&&this._knownThemes.forEach((t=>{t.base===e&&t.notifyBaseUpdated()})),this._theme.themeName===e&&this.setTheme(e)}getColorTheme(){return this._theme}setColorMapOverride(e){this._colorMapOverride=e,this._updateThemeOrColorMap()}setTheme(e){let t;t=this._knownThemes.has(e)?this._knownThemes.get(e):this._knownThemes.get(VS_THEME_NAME),this._desiredTheme=t,this._updateActualTheme()}_updateActualTheme(){const e=this._autoDetectHighContrast&&window.matchMedia("(forced-colors: active)").matches?this._knownThemes.get(HC_BLACK_THEME_NAME):this._desiredTheme;this._theme!==e&&(this._theme=e,this._updateThemeOrColorMap())}setAutoDetectHighContrast(e){this._autoDetectHighContrast=e,this._updateActualTheme()}_updateThemeOrColorMap(){const e=[],t={},o={addRule:o=>{t[o]||(e.push(o),t[o]=!0)}};themingRegistry.getThemingParticipants().forEach((e=>e(this._theme,o,this._environment)));const s=[];for(const i of colorRegistry.getColors()){const e=this._theme.getColor(i.id,!0);e&&s.push(`${asCssVariableName(i.id)}: ${e.toString()};`)}o.addRule(`.monaco-editor { ${s.join("\n")} }`);const n=this._colorMapOverride||this._theme.tokenTheme.getColorMap();o.addRule(generateTokensCSSForColorMap(n)),this._themeCSS=e.join("\n"),this._updateCSS(),TokenizationRegistry.setColorMap(n),this._onColorThemeChange.fire(this._theme)}_updateCSS(){this._allCSS=`${this._codiconCSS}\n${this._themeCSS}`,this._styleElements.forEach((e=>e.textContent=this._allCSS))}getFileIconTheme(){return{hasFileIcons:!1,hasFolderIcons:!1,hidesExplorerArrows:!1}}getProductIconTheme(){return this._builtInProductIconTheme}}