import{BrowserFeatures}from"../../canIUse.js";import*as DOM from"../../dom.js";import{Disposable,DisposableStore,toDisposable}from"../../../common/lifecycle.js";import*as platform from"../../../common/platform.js";import{Range}from"../../../common/range.js";import"./contextview.css";export var LayoutAnchorMode;(function(t){t[t["AVOID"]=0]="AVOID",t[t["ALIGN"]=1]="ALIGN"})(LayoutAnchorMode||(LayoutAnchorMode={}));export function layout(t,e,o){const s=o.mode===LayoutAnchorMode.ALIGN?o.offset:o.offset+o.size,i=o.mode===LayoutAnchorMode.ALIGN?o.offset+o.size:o.offset;return 0===o.position?e<=t-s?s:e<=i?i-e:Math.max(t-e,0):e<=i?i-e:e<=t-s?s:0}export class ContextView extends Disposable{constructor(t,e){super(),this.container=null,this.delegate=null,this.toDisposeOnClean=Disposable.None,this.toDisposeOnSetContainer=Disposable.None,this.shadowRoot=null,this.shadowRootHostElement=null,this.view=DOM.$(".context-view"),this.useFixedPosition=!1,this.useShadowDOM=!1,DOM.hide(this.view),this.setContainer(t,e),this._register(toDisposable((()=>this.setContainer(null,1))))}setContainer(t,e){var o;if(this.container&&(this.toDisposeOnSetContainer.dispose(),this.shadowRoot?(this.shadowRoot.removeChild(this.view),this.shadowRoot=null,null===(o=this.shadowRootHostElement)||void 0===o||o.remove(),this.shadowRootHostElement=null):this.container.removeChild(this.view),this.container=null),t){if(this.container=t,this.useFixedPosition=1!==e,this.useShadowDOM=3===e,this.useShadowDOM){this.shadowRootHostElement=DOM.$(".shadow-root-host"),this.container.appendChild(this.shadowRootHostElement),this.shadowRoot=this.shadowRootHostElement.attachShadow({mode:"open"});const t=document.createElement("style");t.textContent=SHADOW_ROOT_CSS,this.shadowRoot.appendChild(t),this.shadowRoot.appendChild(this.view),this.shadowRoot.appendChild(DOM.$("slot"))}else this.container.appendChild(this.view);const o=new DisposableStore;ContextView.BUBBLE_UP_EVENTS.forEach((t=>{o.add(DOM.addStandardDisposableListener(this.container,t,(t=>{this.onDOMEvent(t,!1)})))})),ContextView.BUBBLE_DOWN_EVENTS.forEach((t=>{o.add(DOM.addStandardDisposableListener(this.container,t,(t=>{this.onDOMEvent(t,!0)}),!0))})),this.toDisposeOnSetContainer=o}}show(t){this.isVisible()&&this.hide(),DOM.clearNode(this.view),this.view.className="context-view",this.view.style.top="0px",this.view.style.left="0px",this.view.style.zIndex="2500",this.view.style.position=this.useFixedPosition?"fixed":"absolute",DOM.show(this.view),this.toDisposeOnClean=t.render(this.view)||Disposable.None,this.delegate=t,this.doLayout(),this.delegate.focus&&this.delegate.focus()}getViewElement(){return this.view}layout(){this.isVisible()&&(!1!==this.delegate.canRelayout||platform.isIOS&&BrowserFeatures.pointerEvents?(this.delegate.layout&&this.delegate.layout(),this.doLayout()):this.hide())}doLayout(){if(!this.isVisible())return;let t,e=this.delegate.getAnchor();if(DOM.isHTMLElement(e)){let o=DOM.getDomNodePagePosition(e);t={top:o.top,left:o.left,width:o.width,height:o.height}}else t={top:e.y,left:e.x,width:e.width||1,height:e.height||2};const o=DOM.getTotalWidth(this.view),s=DOM.getTotalHeight(this.view),i=this.delegate.anchorPosition||0,n=this.delegate.anchorAlignment||0,a=this.delegate.anchorAxisAlignment||0;let h,l;if(0===a){const e={offset:t.top-window.pageYOffset,size:t.height,position:0===i?0:1},a={offset:t.left,size:t.width,position:0===n?0:1,mode:LayoutAnchorMode.ALIGN};h=layout(window.innerHeight,s,e)+window.pageYOffset,Range.intersects({start:h,end:h+s},{start:e.offset,end:e.offset+e.size})&&(a.mode=LayoutAnchorMode.AVOID),l=layout(window.innerWidth,o,a)}else{const e={offset:t.left,size:t.width,position:0===n?0:1},a={offset:t.top,size:t.height,position:0===i?0:1,mode:LayoutAnchorMode.ALIGN};l=layout(window.innerWidth,o,e),Range.intersects({start:l,end:l+o},{start:e.offset,end:e.offset+e.size})&&(a.mode=LayoutAnchorMode.AVOID),h=layout(window.innerHeight,s,a)+window.pageYOffset}this.view.classList.remove("top","bottom","left","right"),this.view.classList.add(0===i?"bottom":"top"),this.view.classList.add(0===n?"left":"right"),this.view.classList.toggle("fixed",this.useFixedPosition);const d=DOM.getDomNodePagePosition(this.container);this.view.style.top=h-(this.useFixedPosition?DOM.getDomNodePagePosition(this.view).top:d.top)+"px",this.view.style.left=l-(this.useFixedPosition?DOM.getDomNodePagePosition(this.view).left:d.left)+"px",this.view.style.width="initial"}hide(t){const e=this.delegate;this.delegate=null,(null===e||void 0===e?void 0:e.onHide)&&e.onHide(t),this.toDisposeOnClean.dispose(),DOM.hide(this.view)}isVisible(){return!!this.delegate}onDOMEvent(t,e){this.delegate&&(this.delegate.onDOMEvent?this.delegate.onDOMEvent(t,document.activeElement):e&&!DOM.isAncestor(t.target,this.container)&&this.hide())}dispose(){this.hide(),super.dispose()}}ContextView.BUBBLE_UP_EVENTS=["click","keydown","focus","blur"],ContextView.BUBBLE_DOWN_EVENTS=["click"];let SHADOW_ROOT_CSS='\n\t:host {\n\t\tall: initial; /* 1st rule so subsequent properties are reset. */\n\t}\n\n\t@font-face {\n\t\tfont-family: "codicon";\n\t\tfont-display: block;\n\t\tsrc: url("./codicon.ttf?5d4d76ab2ce5108968ad644d591a16a6") format("truetype");\n\t}\n\n\t.codicon[class*=\'codicon-\'] {\n\t\tfont: normal normal normal 16px/1 codicon;\n\t\tdisplay: inline-block;\n\t\ttext-decoration: none;\n\t\ttext-rendering: auto;\n\t\ttext-align: center;\n\t\t-webkit-font-smoothing: antialiased;\n\t\t-moz-osx-font-smoothing: grayscale;\n\t\tuser-select: none;\n\t\t-webkit-user-select: none;\n\t\t-ms-user-select: none;\n\t}\n\n\t:host {\n\t\tfont-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "HelveticaNeue-Light", system-ui, "Ubuntu", "Droid Sans", sans-serif;\n\t}\n\n\t:host-context(.mac) { font-family: -apple-system, BlinkMacSystemFont, sans-serif; }\n\t:host-context(.mac:lang(zh-Hans)) { font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", sans-serif; }\n\t:host-context(.mac:lang(zh-Hant)) { font-family: -apple-system, BlinkMacSystemFont, "PingFang TC", sans-serif; }\n\t:host-context(.mac:lang(ja)) { font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic Pro", sans-serif; }\n\t:host-context(.mac:lang(ko)) { font-family: -apple-system, BlinkMacSystemFont, "Nanum Gothic", "Apple SD Gothic Neo", "AppleGothic", sans-serif; }\n\n\t:host-context(.windows) { font-family: "Segoe WPC", "Segoe UI", sans-serif; }\n\t:host-context(.windows:lang(zh-Hans)) { font-family: "Segoe WPC", "Segoe UI", "Microsoft YaHei", sans-serif; }\n\t:host-context(.windows:lang(zh-Hant)) { font-family: "Segoe WPC", "Segoe UI", "Microsoft Jhenghei", sans-serif; }\n\t:host-context(.windows:lang(ja)) { font-family: "Segoe WPC", "Segoe UI", "Yu Gothic UI", "Meiryo UI", sans-serif; }\n\t:host-context(.windows:lang(ko)) { font-family: "Segoe WPC", "Segoe UI", "Malgun Gothic", "Dotom", sans-serif; }\n\n\t:host-context(.linux) { font-family: system-ui, "Ubuntu", "Droid Sans", sans-serif; }\n\t:host-context(.linux:lang(zh-Hans)) { font-family: system-ui, "Ubuntu", "Droid Sans", "Source Han Sans SC", "Source Han Sans CN", "Source Han Sans", sans-serif; }\n\t:host-context(.linux:lang(zh-Hant)) { font-family: system-ui, "Ubuntu", "Droid Sans", "Source Han Sans TC", "Source Han Sans TW", "Source Han Sans", sans-serif; }\n\t:host-context(.linux:lang(ja)) { font-family: system-ui, "Ubuntu", "Droid Sans", "Source Han Sans J", "Source Han Sans JP", "Source Han Sans", sans-serif; }\n\t:host-context(.linux:lang(ko)) { font-family: system-ui, "Ubuntu", "Droid Sans", "Source Han Sans K", "Source Han Sans JR", "Source Han Sans", "UnDotum", "FBaekmuk Gulim", sans-serif; }\n';