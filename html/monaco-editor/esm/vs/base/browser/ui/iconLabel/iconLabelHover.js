var __awaiter=this&&this.__awaiter||function(o,e,t,i){function n(o){return o instanceof t?o:new t((function(e){e(o)}))}return new(t||(t=Promise))((function(t,s){function a(o){try{d(i.next(o))}catch(e){s(e)}}function r(o){try{d(i["throw"](o))}catch(e){s(e)}}function d(o){o.done?t(o.value):n(o.value).then(a,r)}d((i=i.apply(o,e||[])).next())}))};import*as dom from"../../dom.js";import{TimeoutTimer}from"../../../common/async.js";import{CancellationTokenSource}from"../../../common/cancellation.js";import{isMarkdownString}from"../../../common/htmlContent.js";import{stripIcons}from"../../../common/iconLabels.js";import{DisposableStore}from"../../../common/lifecycle.js";import{isFunction,isString}from"../../../common/types.js";import{localize}from"../../../../nls.js";export function setupNativeHover(o,e){isString(e)?o.title=stripIcons(e):(null===e||void 0===e?void 0:e.markdownNotSupportedFallback)?o.title=e.markdownNotSupportedFallback:o.removeAttribute("title")}class UpdatableHoverWidget{constructor(o,e,t){this.hoverDelegate=o,this.target=e,this.fadeInAnimation=t}update(o,e){var t;return __awaiter(this,void 0,void 0,(function*(){if(this._cancellationTokenSource&&(this._cancellationTokenSource.dispose(!0),this._cancellationTokenSource=void 0),this.isDisposed)return;let i;if(void 0===o||isString(o)||o instanceof HTMLElement)i=o;else if(isFunction(o.markdown)){this._hoverWidget||this.show(localize("iconLabel.loading","Loading..."),e),this._cancellationTokenSource=new CancellationTokenSource;const t=this._cancellationTokenSource.token;if(i=yield o.markdown(t),this.isDisposed||t.isCancellationRequested)return}else i=null!==(t=o.markdown)&&void 0!==t?t:o.markdownNotSupportedFallback;this.show(i,e)}))}show(o,e){const t=this._hoverWidget;if(this.hasContent(o)){const i={content:o,target:this.target,showPointer:"element"===this.hoverDelegate.placement,hoverPosition:2,skipFadeInAnimation:!this.fadeInAnimation||!!t};this._hoverWidget=this.hoverDelegate.showHover(i,e)}null===t||void 0===t||t.dispose()}hasContent(o){return!!o&&(!isMarkdownString(o)||!!o.value)}get isDisposed(){var o;return null===(o=this._hoverWidget)||void 0===o?void 0:o.isDisposed}dispose(){var o,e;null===(o=this._hoverWidget)||void 0===o||o.dispose(),null===(e=this._cancellationTokenSource)||void 0===e||e.dispose(!0),this._cancellationTokenSource=void 0}}export function setupCustomHover(o,e,t){let i,n;const s=(e,t)=>{var s;e&&(null===n||void 0===n||n.dispose(),n=void 0),t&&(null===i||void 0===i||i.dispose(),i=void 0),null===(s=o.onDidHideHover)||void 0===s||s.call(o)},a=(i,s,a)=>new TimeoutTimer((()=>__awaiter(this,void 0,void 0,(function*(){n&&!n.isDisposed||(n=new UpdatableHoverWidget(o,a||e,i>0),yield n.update(t,s))}))),i),r=()=>{if(i)return;const t=new DisposableStore,n=o=>s(!1,o.fromElement===e);t.add(dom.addDisposableListener(e,dom.EventType.MOUSE_LEAVE,n,!0));const r=()=>s(!0,!0);t.add(dom.addDisposableListener(e,dom.EventType.MOUSE_DOWN,r,!0));const d={targetElements:[e],dispose:()=>{}};if(void 0===o.placement||"mouse"===o.placement){const o=o=>d.x=o.x+10;t.add(dom.addDisposableListener(e,dom.EventType.MOUSE_MOVE,o,!0))}t.add(a(o.delay,!1,d)),i=t},d=dom.addDisposableListener(e,dom.EventType.MOUSE_OVER,r,!0),l={show:o=>{s(!1,!0),a(0,o)},hide:()=>{s(!0,!0)},update:o=>__awaiter(this,void 0,void 0,(function*(){t=o,yield null===n||void 0===n?void 0:n.update(t)})),dispose:()=>{d.dispose(),s(!0,!0)}};return l}