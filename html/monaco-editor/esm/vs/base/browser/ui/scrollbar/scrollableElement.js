import{getZoomFactor}from"../../browser.js";import*as dom from"../../dom.js";import{createFastDomNode}from"../../fastDomNode.js";import{StandardWheelEvent}from"../../mouseEvent.js";import{HorizontalScrollbar}from"./horizontalScrollbar.js";import{VerticalScrollbar}from"./verticalScrollbar.js";import{Widget}from"../widget.js";import{TimeoutTimer}from"../../../common/async.js";import{Emitter}from"../../../common/event.js";import{dispose}from"../../../common/lifecycle.js";import*as platform from"../../../common/platform.js";import{Scrollable}from"../../../common/scrollable.js";import"./media/scrollbars.css";const HIDE_TIMEOUT=500,SCROLL_WHEEL_SENSITIVITY=50,SCROLL_WHEEL_SMOOTH_SCROLL_ENABLED=!0;class MouseWheelClassifierItem{constructor(e,o,t){this.timestamp=e,this.deltaX=o,this.deltaY=t,this.score=0}}export class MouseWheelClassifier{constructor(){this._capacity=5,this._memory=[],this._front=-1,this._rear=-1}isPhysicalMouseWheel(){if(-1===this._front&&-1===this._rear)return!1;let e=1,o=0,t=1,s=this._rear;do{const i=s===this._front?e:Math.pow(2,-t);if(e-=i,o+=this._memory[s].score*i,s===this._front)break;s=(this._capacity+s-1)%this._capacity,t++}while(1);return o<=.5}accept(e,o,t){const s=new MouseWheelClassifierItem(e,o,t);s.score=this._computeScore(s),-1===this._front&&-1===this._rear?(this._memory[0]=s,this._front=0,this._rear=0):(this._rear=(this._rear+1)%this._capacity,this._rear===this._front&&(this._front=(this._front+1)%this._capacity),this._memory[this._rear]=s)}_computeScore(e){if(Math.abs(e.deltaX)>0&&Math.abs(e.deltaY)>0)return 1;let o=.5;-1===this._front&&-1===this._rear||this._memory[this._rear];return this._isAlmostInt(e.deltaX)&&this._isAlmostInt(e.deltaY)||(o+=.25),Math.min(Math.max(o,0),1)}_isAlmostInt(e){const o=Math.abs(Math.round(e)-e);return o<.01}}MouseWheelClassifier.INSTANCE=new MouseWheelClassifier;export class AbstractScrollableElement extends Widget{constructor(e,o,t){super(),this._onScroll=this._register(new Emitter),this.onScroll=this._onScroll.event,this._onWillScroll=this._register(new Emitter),e.style.overflow="hidden",this._options=resolveOptions(o),this._scrollable=t,this._register(this._scrollable.onScroll((e=>{this._onWillScroll.fire(e),this._onDidScroll(e),this._onScroll.fire(e)})));const s={onMouseWheel:e=>this._onMouseWheel(e),onDragStart:()=>this._onDragStart(),onDragEnd:()=>this._onDragEnd()};this._verticalScrollbar=this._register(new VerticalScrollbar(this._scrollable,this._options,s)),this._horizontalScrollbar=this._register(new HorizontalScrollbar(this._scrollable,this._options,s)),this._domNode=document.createElement("div"),this._domNode.className="monaco-scrollable-element "+this._options.className,this._domNode.setAttribute("role","presentation"),this._domNode.style.position="relative",this._domNode.style.overflow="hidden",this._domNode.appendChild(e),this._domNode.appendChild(this._horizontalScrollbar.domNode.domNode),this._domNode.appendChild(this._verticalScrollbar.domNode.domNode),this._options.useShadows?(this._leftShadowDomNode=createFastDomNode(document.createElement("div")),this._leftShadowDomNode.setClassName("shadow"),this._domNode.appendChild(this._leftShadowDomNode.domNode),this._topShadowDomNode=createFastDomNode(document.createElement("div")),this._topShadowDomNode.setClassName("shadow"),this._domNode.appendChild(this._topShadowDomNode.domNode),this._topLeftShadowDomNode=createFastDomNode(document.createElement("div")),this._topLeftShadowDomNode.setClassName("shadow"),this._domNode.appendChild(this._topLeftShadowDomNode.domNode)):(this._leftShadowDomNode=null,this._topShadowDomNode=null,this._topLeftShadowDomNode=null),this._listenOnDomNode=this._options.listenOnDomNode||this._domNode,this._mouseWheelToDispose=[],this._setListeningToMouseWheel(this._options.handleMouseWheel),this.onmouseover(this._listenOnDomNode,(e=>this._onMouseOver(e))),this.onnonbubblingmouseout(this._listenOnDomNode,(e=>this._onMouseOut(e))),this._hideTimeout=this._register(new TimeoutTimer),this._isDragging=!1,this._mouseIsOver=!1,this._shouldRender=!0,this._revealOnScroll=!0}get options(){return this._options}dispose(){this._mouseWheelToDispose=dispose(this._mouseWheelToDispose),super.dispose()}getDomNode(){return this._domNode}getOverviewRulerLayoutInfo(){return{parent:this._domNode,insertBefore:this._verticalScrollbar.domNode.domNode}}delegateVerticalScrollbarMouseDown(e){this._verticalScrollbar.delegateMouseDown(e)}getScrollDimensions(){return this._scrollable.getScrollDimensions()}setScrollDimensions(e){this._scrollable.setScrollDimensions(e,!1)}updateClassName(e){this._options.className=e,platform.isMacintosh&&(this._options.className+=" mac"),this._domNode.className="monaco-scrollable-element "+this._options.className}updateOptions(e){"undefined"!==typeof e.handleMouseWheel&&(this._options.handleMouseWheel=e.handleMouseWheel,this._setListeningToMouseWheel(this._options.handleMouseWheel)),"undefined"!==typeof e.mouseWheelScrollSensitivity&&(this._options.mouseWheelScrollSensitivity=e.mouseWheelScrollSensitivity),"undefined"!==typeof e.fastScrollSensitivity&&(this._options.fastScrollSensitivity=e.fastScrollSensitivity),"undefined"!==typeof e.scrollPredominantAxis&&(this._options.scrollPredominantAxis=e.scrollPredominantAxis),"undefined"!==typeof e.horizontal&&(this._options.horizontal=e.horizontal),"undefined"!==typeof e.vertical&&(this._options.vertical=e.vertical),"undefined"!==typeof e.horizontalScrollbarSize&&(this._options.horizontalScrollbarSize=e.horizontalScrollbarSize),"undefined"!==typeof e.verticalScrollbarSize&&(this._options.verticalScrollbarSize=e.verticalScrollbarSize),"undefined"!==typeof e.scrollByPage&&(this._options.scrollByPage=e.scrollByPage),this._horizontalScrollbar.updateOptions(this._options),this._verticalScrollbar.updateOptions(this._options),this._options.lazyRender||this._render()}_setListeningToMouseWheel(e){const o=this._mouseWheelToDispose.length>0;if(o!==e&&(this._mouseWheelToDispose=dispose(this._mouseWheelToDispose),e)){const e=e=>{this._onMouseWheel(new StandardWheelEvent(e))};this._mouseWheelToDispose.push(dom.addDisposableListener(this._listenOnDomNode,dom.EventType.MOUSE_WHEEL,e,{passive:!1}))}}_onMouseWheel(e){const o=MouseWheelClassifier.INSTANCE;if(SCROLL_WHEEL_SMOOTH_SCROLL_ENABLED){const t=window.devicePixelRatio/getZoomFactor();platform.isWindows||platform.isLinux?o.accept(Date.now(),e.deltaX/t,e.deltaY/t):o.accept(Date.now(),e.deltaX,e.deltaY)}let t=!1;if(e.deltaY||e.deltaX){let s=e.deltaY*this._options.mouseWheelScrollSensitivity,i=e.deltaX*this._options.mouseWheelScrollSensitivity;this._options.scrollPredominantAxis&&(Math.abs(s)>=Math.abs(i)?i=0:s=0),this._options.flipAxes&&([s,i]=[i,s]);const l=!platform.isMacintosh&&e.browserEvent&&e.browserEvent.shiftKey;!this._options.scrollYToX&&!l||i||(i=s,s=0),e.browserEvent&&e.browserEvent.altKey&&(i*=this._options.fastScrollSensitivity,s*=this._options.fastScrollSensitivity);const r=this._scrollable.getFutureScrollPosition();let n={};if(s){const e=SCROLL_WHEEL_SENSITIVITY*s,o=r.scrollTop-(e<0?Math.floor(e):Math.ceil(e));this._verticalScrollbar.writeScrollPosition(n,o)}if(i){const e=SCROLL_WHEEL_SENSITIVITY*i,o=r.scrollLeft-(e<0?Math.floor(e):Math.ceil(e));this._horizontalScrollbar.writeScrollPosition(n,o)}if(n=this._scrollable.validateScrollPosition(n),r.scrollLeft!==n.scrollLeft||r.scrollTop!==n.scrollTop){const e=SCROLL_WHEEL_SMOOTH_SCROLL_ENABLED&&this._options.mouseWheelSmoothScroll&&o.isPhysicalMouseWheel();e?this._scrollable.setScrollPositionSmooth(n):this._scrollable.setScrollPositionNow(n),t=!0}}let s=t;!s&&this._options.alwaysConsumeMouseWheel&&(s=!0),!s&&this._options.consumeMouseWheelIfScrollbarIsNeeded&&(this._verticalScrollbar.isNeeded()||this._horizontalScrollbar.isNeeded())&&(s=!0),s&&(e.preventDefault(),e.stopPropagation())}_onDidScroll(e){this._shouldRender=this._horizontalScrollbar.onDidScroll(e)||this._shouldRender,this._shouldRender=this._verticalScrollbar.onDidScroll(e)||this._shouldRender,this._options.useShadows&&(this._shouldRender=!0),this._revealOnScroll&&this._reveal(),this._options.lazyRender||this._render()}renderNow(){if(!this._options.lazyRender)throw new Error("Please use `lazyRender` together with `renderNow`!");this._render()}_render(){if(this._shouldRender&&(this._shouldRender=!1,this._horizontalScrollbar.render(),this._verticalScrollbar.render(),this._options.useShadows)){const e=this._scrollable.getCurrentScrollPosition(),o=e.scrollTop>0,t=e.scrollLeft>0,s=t?" left":"",i=o?" top":"",l=t||o?" top-left-corner":"";this._leftShadowDomNode.setClassName(`shadow${s}`),this._topShadowDomNode.setClassName(`shadow${i}`),this._topLeftShadowDomNode.setClassName(`shadow${l}${i}${s}`)}}_onDragStart(){this._isDragging=!0,this._reveal()}_onDragEnd(){this._isDragging=!1,this._hide()}_onMouseOut(e){this._mouseIsOver=!1,this._hide()}_onMouseOver(e){this._mouseIsOver=!0,this._reveal()}_reveal(){this._verticalScrollbar.beginReveal(),this._horizontalScrollbar.beginReveal(),this._scheduleHide()}_hide(){this._mouseIsOver||this._isDragging||(this._verticalScrollbar.beginHide(),this._horizontalScrollbar.beginHide())}_scheduleHide(){this._mouseIsOver||this._isDragging||this._hideTimeout.cancelAndSet((()=>this._hide()),HIDE_TIMEOUT)}}export class ScrollableElement extends AbstractScrollableElement{constructor(e,o){o=o||{},o.mouseWheelSmoothScroll=!1;const t=new Scrollable({forceIntegerValues:!0,smoothScrollDuration:0,scheduleAtNextAnimationFrame:e=>dom.scheduleAtNextAnimationFrame(e)});super(e,o,t),this._register(t)}setScrollPosition(e){this._scrollable.setScrollPositionNow(e)}}export class SmoothScrollableElement extends AbstractScrollableElement{constructor(e,o,t){super(e,o,t)}setScrollPosition(e){e.reuseAnimation?this._scrollable.setScrollPositionSmooth(e,e.reuseAnimation):this._scrollable.setScrollPositionNow(e)}getScrollPosition(){return this._scrollable.getCurrentScrollPosition()}}export class DomScrollableElement extends AbstractScrollableElement{constructor(e,o){o=o||{},o.mouseWheelSmoothScroll=!1;const t=new Scrollable({forceIntegerValues:!1,smoothScrollDuration:0,scheduleAtNextAnimationFrame:e=>dom.scheduleAtNextAnimationFrame(e)});super(e,o,t),this._register(t),this._element=e,this.onScroll((e=>{e.scrollTopChanged&&(this._element.scrollTop=e.scrollTop),e.scrollLeftChanged&&(this._element.scrollLeft=e.scrollLeft)})),this.scanDomNode()}setScrollPosition(e){this._scrollable.setScrollPositionNow(e)}getScrollPosition(){return this._scrollable.getCurrentScrollPosition()}scanDomNode(){this.setScrollDimensions({width:this._element.clientWidth,scrollWidth:this._element.scrollWidth,height:this._element.clientHeight,scrollHeight:this._element.scrollHeight}),this.setScrollPosition({scrollLeft:this._element.scrollLeft,scrollTop:this._element.scrollTop})}}function resolveOptions(e){const o={lazyRender:"undefined"!==typeof e.lazyRender&&e.lazyRender,className:"undefined"!==typeof e.className?e.className:"",useShadows:"undefined"===typeof e.useShadows||e.useShadows,handleMouseWheel:"undefined"===typeof e.handleMouseWheel||e.handleMouseWheel,flipAxes:"undefined"!==typeof e.flipAxes&&e.flipAxes,consumeMouseWheelIfScrollbarIsNeeded:"undefined"!==typeof e.consumeMouseWheelIfScrollbarIsNeeded&&e.consumeMouseWheelIfScrollbarIsNeeded,alwaysConsumeMouseWheel:"undefined"!==typeof e.alwaysConsumeMouseWheel&&e.alwaysConsumeMouseWheel,scrollYToX:"undefined"!==typeof e.scrollYToX&&e.scrollYToX,mouseWheelScrollSensitivity:"undefined"!==typeof e.mouseWheelScrollSensitivity?e.mouseWheelScrollSensitivity:1,fastScrollSensitivity:"undefined"!==typeof e.fastScrollSensitivity?e.fastScrollSensitivity:5,scrollPredominantAxis:"undefined"===typeof e.scrollPredominantAxis||e.scrollPredominantAxis,mouseWheelSmoothScroll:"undefined"===typeof e.mouseWheelSmoothScroll||e.mouseWheelSmoothScroll,arrowSize:"undefined"!==typeof e.arrowSize?e.arrowSize:11,listenOnDomNode:"undefined"!==typeof e.listenOnDomNode?e.listenOnDomNode:null,horizontal:"undefined"!==typeof e.horizontal?e.horizontal:1,horizontalScrollbarSize:"undefined"!==typeof e.horizontalScrollbarSize?e.horizontalScrollbarSize:10,horizontalSliderSize:"undefined"!==typeof e.horizontalSliderSize?e.horizontalSliderSize:0,horizontalHasArrows:"undefined"!==typeof e.horizontalHasArrows&&e.horizontalHasArrows,vertical:"undefined"!==typeof e.vertical?e.vertical:1,verticalScrollbarSize:"undefined"!==typeof e.verticalScrollbarSize?e.verticalScrollbarSize:10,verticalHasArrows:"undefined"!==typeof e.verticalHasArrows&&e.verticalHasArrows,verticalSliderSize:"undefined"!==typeof e.verticalSliderSize?e.verticalSliderSize:0,scrollByPage:"undefined"!==typeof e.scrollByPage&&e.scrollByPage};return o.horizontalSliderSize="undefined"!==typeof e.horizontalSliderSize?e.horizontalSliderSize:o.horizontalScrollbarSize,o.verticalSliderSize="undefined"!==typeof e.verticalSliderSize?e.verticalSliderSize:o.verticalScrollbarSize,platform.isMacintosh&&(o.className+=" mac"),o}