import{$,addDisposableListener,append,scheduleAtNextAnimationFrame}from"../../dom.js";import{Sash}from"../sash/sash.js";import{SmoothScrollableElement}from"../scrollbar/scrollableElement.js";import{pushToEnd,pushToStart,range}from"../../../common/arrays.js";import{Color}from"../../../common/color.js";import{Emitter,Event}from"../../../common/event.js";import{combinedDisposable,Disposable,toDisposable}from"../../../common/lifecycle.js";import{clamp}from"../../../common/numbers.js";import{Scrollable}from"../../../common/scrollable.js";import*as types from"../../../common/types.js";import"./splitview.css";const defaultStyles={separatorBorder:Color.transparent};class ViewItem{constructor(e,i,t,s){this.container=e,this.view=i,this.disposable=s,this._cachedVisibleSize=void 0,"number"===typeof t?(this._size=t,this._cachedVisibleSize=void 0,e.classList.add("visible")):(this._size=0,this._cachedVisibleSize=t.cachedVisibleSize)}set size(e){this._size=e}get size(){return this._size}get visible(){return"undefined"===typeof this._cachedVisibleSize}setVisible(e,i){e!==this.visible&&(e?(this.size=clamp(this._cachedVisibleSize,this.viewMinimumSize,this.viewMaximumSize),this._cachedVisibleSize=void 0):(this._cachedVisibleSize="number"===typeof i?i:this.size,this.size=0),this.container.classList.toggle("visible",e),this.view.setVisible&&this.view.setVisible(e))}get minimumSize(){return this.visible?this.view.minimumSize:0}get viewMinimumSize(){return this.view.minimumSize}get maximumSize(){return this.visible?this.view.maximumSize:0}get viewMaximumSize(){return this.view.maximumSize}get priority(){return this.view.priority}get snap(){return!!this.view.snap}set enabled(e){this.container.style.pointerEvents=e?"":"none"}layout(e,i){this.layoutContainer(e),this.view.layout(this.size,e,i)}dispose(){return this.disposable.dispose(),this.view}}class VerticalViewItem extends ViewItem{layoutContainer(e){this.container.style.top=`${e}px`,this.container.style.height=`${this.size}px`}}class HorizontalViewItem extends ViewItem{layoutContainer(e){this.container.style.left=`${e}px`,this.container.style.width=`${this.size}px`}}var State;(function(e){e[e["Idle"]=0]="Idle",e[e["Busy"]=1]="Busy"})(State||(State={}));export var Sizing;(function(e){function i(e){return{type:"split",index:e}}function t(e){return{type:"invisible",cachedVisibleSize:e}}e.Distribute={type:"distribute"},e.Split=i,e.Invisible=t})(Sizing||(Sizing={}));export class SplitView extends Disposable{constructor(e,i={}){var t,s,n,o,a;super(),this.size=0,this.contentSize=0,this.proportions=void 0,this.viewItems=[],this.sashItems=[],this.state=State.Idle,this._onDidSashChange=this._register(new Emitter),this._onDidSashReset=this._register(new Emitter),this._startSnappingEnabled=!0,this._endSnappingEnabled=!0,this.onDidSashChange=this._onDidSashChange.event,this.onDidSashReset=this._onDidSashReset.event,this.orientation=null!==(t=i.orientation)&&void 0!==t?t:0,this.inverseAltBehavior=null!==(s=i.inverseAltBehavior)&&void 0!==s&&s,this.proportionalLayout=null===(n=i.proportionalLayout)||void 0===n||n,this.getSashOrthogonalSize=i.getSashOrthogonalSize,this.el=document.createElement("div"),this.el.classList.add("monaco-split-view2"),this.el.classList.add(0===this.orientation?"vertical":"horizontal"),e.appendChild(this.el),this.sashContainer=append(this.el,$(".sash-container")),this.viewContainer=$(".split-view-container"),this.scrollable=new Scrollable({forceIntegerValues:!0,smoothScrollDuration:125,scheduleAtNextAnimationFrame:scheduleAtNextAnimationFrame}),this.scrollableElement=this._register(new SmoothScrollableElement(this.viewContainer,{vertical:0===this.orientation?null!==(o=i.scrollbarVisibility)&&void 0!==o?o:1:2,horizontal:1===this.orientation?null!==(a=i.scrollbarVisibility)&&void 0!==a?a:1:2},this.scrollable)),this.onDidScroll=this.scrollableElement.onScroll,this._register(this.onDidScroll((e=>{this.viewContainer.scrollTop=e.scrollTop,this.viewContainer.scrollLeft=e.scrollLeft}))),append(this.el,this.scrollableElement.getDomNode()),this.style(i.styles||defaultStyles),i.descriptor&&(this.size=i.descriptor.size,i.descriptor.views.forEach(((e,i)=>{const t=types.isUndefined(e.visible)||e.visible?e.size:{type:"invisible",cachedVisibleSize:e.size},s=e.view;this.doAddView(s,t,i,!0)})),this.contentSize=this.viewItems.reduce(((e,i)=>e+i.size),0),this.saveProportions())}get orthogonalStartSash(){return this._orthogonalStartSash}get orthogonalEndSash(){return this._orthogonalEndSash}get startSnappingEnabled(){return this._startSnappingEnabled}get endSnappingEnabled(){return this._endSnappingEnabled}set orthogonalStartSash(e){for(const i of this.sashItems)i.sash.orthogonalStartSash=e;this._orthogonalStartSash=e}set orthogonalEndSash(e){for(const i of this.sashItems)i.sash.orthogonalEndSash=e;this._orthogonalEndSash=e}set startSnappingEnabled(e){this._startSnappingEnabled!==e&&(this._startSnappingEnabled=e,this.updateSashEnablement())}set endSnappingEnabled(e){this._endSnappingEnabled!==e&&(this._endSnappingEnabled=e,this.updateSashEnablement())}style(e){e.separatorBorder.isTransparent()?(this.el.classList.remove("separator-border"),this.el.style.removeProperty("--separator-border")):(this.el.classList.add("separator-border"),this.el.style.setProperty("--separator-border",e.separatorBorder.toString()))}addView(e,i,t=this.viewItems.length,s){this.doAddView(e,i,t,s)}layout(e,i){const t=Math.max(this.size,this.contentSize);if(this.size=e,this.layoutContext=i,this.proportions)for(let s=0;s<this.viewItems.length;s++){const i=this.viewItems[s];i.size=clamp(Math.round(this.proportions[s]*e),i.minimumSize,i.maximumSize)}else{const i=range(this.viewItems.length),s=i.filter((e=>1===this.viewItems[e].priority)),n=i.filter((e=>2===this.viewItems[e].priority));this.resize(this.viewItems.length-1,e-t,void 0,s,n)}this.distributeEmptySpace(),this.layoutViews()}saveProportions(){this.proportionalLayout&&this.contentSize>0&&(this.proportions=this.viewItems.map((e=>e.size/this.contentSize)))}onSashStart({sash:e,start:i,alt:t}){for(const a of this.viewItems)a.enabled=!1;const s=this.sashItems.findIndex((i=>i.sash===e)),n=combinedDisposable(addDisposableListener(document.body,"keydown",(e=>o(this.sashDragState.current,e.altKey))),addDisposableListener(document.body,"keyup",(()=>o(this.sashDragState.current,!1)))),o=(e,i)=>{const t=this.viewItems.map((e=>e.size));let o,a,h=Number.NEGATIVE_INFINITY,r=Number.POSITIVE_INFINITY;if(this.inverseAltBehavior&&(i=!i),i){const e=s===this.sashItems.length-1;if(e){const e=this.viewItems[s];h=(e.minimumSize-e.size)/2,r=(e.maximumSize-e.size)/2}else{const e=this.viewItems[s+1];h=(e.size-e.maximumSize)/2,r=(e.size-e.minimumSize)/2}}if(!i){const e=range(s,-1),i=range(s+1,this.viewItems.length),n=e.reduce(((e,i)=>e+(this.viewItems[i].minimumSize-t[i])),0),h=e.reduce(((e,i)=>e+(this.viewItems[i].viewMaximumSize-t[i])),0),r=0===i.length?Number.POSITIVE_INFINITY:i.reduce(((e,i)=>e+(t[i]-this.viewItems[i].minimumSize)),0),l=0===i.length?Number.NEGATIVE_INFINITY:i.reduce(((e,i)=>e+(t[i]-this.viewItems[i].viewMaximumSize)),0),m=Math.max(n,l),d=Math.min(r,h),p=this.findFirstSnapIndex(e),c=this.findFirstSnapIndex(i);if("number"===typeof p){const e=this.viewItems[p],i=Math.floor(e.viewMinimumSize/2);o={index:p,limitDelta:e.visible?m-i:m+i,size:e.size}}if("number"===typeof c){const e=this.viewItems[c],i=Math.floor(e.viewMinimumSize/2);a={index:c,limitDelta:e.visible?d+i:d-i,size:e.size}}}this.sashDragState={start:e,current:e,index:s,sizes:t,minDelta:h,maxDelta:r,alt:i,snapBefore:o,snapAfter:a,disposable:n}};o(i,t)}onSashChange({current:e}){const{index:i,start:t,sizes:s,alt:n,minDelta:o,maxDelta:a,snapBefore:h,snapAfter:r}=this.sashDragState;this.sashDragState.current=e;const l=e-t,m=this.resize(i,l,s,void 0,void 0,o,a,h,r);if(n){const e=i===this.sashItems.length-1,t=this.viewItems.map((e=>e.size)),s=e?i:i+1,n=this.viewItems[s],o=n.size-n.maximumSize,a=n.size-n.minimumSize,h=e?i-1:i+1;this.resize(h,-m,t,void 0,void 0,o,a)}this.distributeEmptySpace(),this.layoutViews()}onSashEnd(e){this._onDidSashChange.fire(e),this.sashDragState.disposable.dispose(),this.saveProportions();for(const i of this.viewItems)i.enabled=!0}onViewChange(e,i){const t=this.viewItems.indexOf(e);t<0||t>=this.viewItems.length||(i="number"===typeof i?i:e.size,i=clamp(i,e.minimumSize,e.maximumSize),this.inverseAltBehavior&&t>0?(this.resize(t-1,Math.floor((e.size-i)/2)),this.distributeEmptySpace(),this.layoutViews()):(e.size=i,this.relayout([t],void 0)))}resizeView(e,i){if(this.state!==State.Idle)throw new Error("Cant modify splitview");if(this.state=State.Busy,e<0||e>=this.viewItems.length)return;const t=range(this.viewItems.length).filter((i=>i!==e)),s=[...t.filter((e=>1===this.viewItems[e].priority)),e],n=t.filter((e=>2===this.viewItems[e].priority)),o=this.viewItems[e];i=Math.round(i),i=clamp(i,o.minimumSize,Math.min(o.maximumSize,this.size)),o.size=i,this.relayout(s,n),this.state=State.Idle}distributeViewSizes(){const e=[];let i=0;for(const a of this.viewItems)a.maximumSize-a.minimumSize>0&&(e.push(a),i+=a.size);const t=Math.floor(i/e.length);for(const a of e)a.size=clamp(t,a.minimumSize,a.maximumSize);const s=range(this.viewItems.length),n=s.filter((e=>1===this.viewItems[e].priority)),o=s.filter((e=>2===this.viewItems[e].priority));this.relayout(n,o)}getViewSize(e){return e<0||e>=this.viewItems.length?-1:this.viewItems[e].size}doAddView(e,i,t=this.viewItems.length,s){if(this.state!==State.Idle)throw new Error("Cant modify splitview");this.state=State.Busy;const n=$(".split-view-view");t===this.viewItems.length?this.viewContainer.appendChild(n):this.viewContainer.insertBefore(n,this.viewContainer.children.item(t));const o=e.onDidChange((e=>this.onViewChange(l,e))),a=toDisposable((()=>this.viewContainer.removeChild(n))),h=combinedDisposable(o,a);let r;r="number"===typeof i?i:"split"===i.type?this.getViewSize(i.index)/2:"invisible"===i.type?{cachedVisibleSize:i.cachedVisibleSize}:e.minimumSize;const l=0===this.orientation?new VerticalViewItem(n,e,r,h):new HorizontalViewItem(n,e,r,h);if(this.viewItems.splice(t,0,l),this.viewItems.length>1){let e={orthogonalStartSash:this.orthogonalStartSash,orthogonalEndSash:this.orthogonalEndSash};const i=0===this.orientation?new Sash(this.sashContainer,{getHorizontalSashTop:e=>this.getSashPosition(e),getHorizontalSashWidth:this.getSashOrthogonalSize},Object.assign(Object.assign({},e),{orientation:1})):new Sash(this.sashContainer,{getVerticalSashLeft:e=>this.getSashPosition(e),getVerticalSashHeight:this.getSashOrthogonalSize},Object.assign(Object.assign({},e),{orientation:0})),s=0===this.orientation?e=>({sash:i,start:e.startY,current:e.currentY,alt:e.altKey}):e=>({sash:i,start:e.startX,current:e.currentX,alt:e.altKey}),n=Event.map(i.onDidStart,s),o=n(this.onSashStart,this),a=Event.map(i.onDidChange,s),h=a(this.onSashChange,this),r=Event.map(i.onDidEnd,(()=>this.sashItems.findIndex((e=>e.sash===i)))),l=r(this.onSashEnd,this),m=i.onDidReset((()=>{const e=this.sashItems.findIndex((e=>e.sash===i)),t=range(e,-1),s=range(e+1,this.viewItems.length),n=this.findFirstSnapIndex(t),o=this.findFirstSnapIndex(s);("number"!==typeof n||this.viewItems[n].visible)&&("number"!==typeof o||this.viewItems[o].visible)&&this._onDidSashReset.fire(e)})),d=combinedDisposable(o,h,l,m,i),p={sash:i,disposable:d};this.sashItems.splice(t-1,0,p)}let m;n.appendChild(e.element),"number"!==typeof i&&"split"===i.type&&(m=[i.index]),s||this.relayout([t],m),this.state=State.Idle,s||"number"===typeof i||"distribute"!==i.type||this.distributeViewSizes()}relayout(e,i){const t=this.viewItems.reduce(((e,i)=>e+i.size),0);this.resize(this.viewItems.length-1,this.size-t,void 0,e,i),this.distributeEmptySpace(),this.layoutViews(),this.saveProportions()}resize(e,i,t=this.viewItems.map((e=>e.size)),s,n,o=Number.NEGATIVE_INFINITY,a=Number.POSITIVE_INFINITY,h,r){if(e<0||e>=this.viewItems.length)return 0;const l=range(e,-1),m=range(e+1,this.viewItems.length);if(n)for(const f of n)pushToStart(l,f),pushToStart(m,f);if(s)for(const f of s)pushToEnd(l,f),pushToEnd(m,f);const d=l.map((e=>this.viewItems[e])),p=l.map((e=>t[e])),c=m.map((e=>this.viewItems[e])),S=m.map((e=>t[e])),u=l.reduce(((e,i)=>e+(this.viewItems[i].minimumSize-t[i])),0),v=l.reduce(((e,i)=>e+(this.viewItems[i].maximumSize-t[i])),0),z=0===m.length?Number.POSITIVE_INFINITY:m.reduce(((e,i)=>e+(t[i]-this.viewItems[i].minimumSize)),0),I=0===m.length?Number.NEGATIVE_INFINITY:m.reduce(((e,i)=>e+(t[i]-this.viewItems[i].maximumSize)),0),w=Math.max(u,I,o),b=Math.min(z,v,a);let g=!1;if(h){const e=this.viewItems[h.index],t=i>=h.limitDelta;g=t!==e.visible,e.setVisible(t,h.size)}if(!g&&r){const e=this.viewItems[r.index],t=i<r.limitDelta;g=t!==e.visible,e.setVisible(t,r.size)}if(g)return this.resize(e,i,t,s,n,o,a);i=clamp(i,w,b);for(let f=0,y=i;f<d.length;f++){const e=d[f],i=clamp(p[f]+y,e.minimumSize,e.maximumSize),t=i-p[f];y-=t,e.size=i}for(let f=0,y=i;f<c.length;f++){const e=c[f],i=clamp(S[f]-y,e.minimumSize,e.maximumSize),t=i-S[f];y+=t,e.size=i}return i}distributeEmptySpace(e){const i=this.viewItems.reduce(((e,i)=>e+i.size),0);let t=this.size-i;const s=range(this.viewItems.length-1,-1),n=s.filter((e=>1===this.viewItems[e].priority)),o=s.filter((e=>2===this.viewItems[e].priority));for(const a of o)pushToStart(s,a);for(const a of n)pushToEnd(s,a);"number"===typeof e&&pushToEnd(s,e);for(let a=0;0!==t&&a<s.length;a++){const e=this.viewItems[s[a]],i=clamp(e.size+t,e.minimumSize,e.maximumSize),n=i-e.size;t-=n,e.size=i}}layoutViews(){this.contentSize=this.viewItems.reduce(((e,i)=>e+i.size),0);let e=0;for(const i of this.viewItems)i.layout(e,this.layoutContext),e+=i.size;this.sashItems.forEach((e=>e.sash.layout())),this.updateSashEnablement(),this.updateScrollableElement()}updateScrollableElement(){0===this.orientation?this.scrollableElement.setScrollDimensions({height:this.size,scrollHeight:this.contentSize}):this.scrollableElement.setScrollDimensions({width:this.size,scrollWidth:this.contentSize})}updateSashEnablement(){let e=!1;const i=this.viewItems.map((i=>e=i.size-i.minimumSize>0||e));e=!1;const t=this.viewItems.map((i=>e=i.maximumSize-i.size>0||e)),s=[...this.viewItems].reverse();e=!1;const n=s.map((i=>e=i.size-i.minimumSize>0||e)).reverse();e=!1;const o=s.map((i=>e=i.maximumSize-i.size>0||e)).reverse();let a=0;for(let h=0;h<this.sashItems.length;h++){const{sash:e}=this.sashItems[h],s=this.viewItems[h];a+=s.size;const r=!(i[h]&&o[h+1]),l=!(t[h]&&n[h+1]);if(r&&l){const t=range(h,-1),s=range(h+1,this.viewItems.length),o=this.findFirstSnapIndex(t),r=this.findFirstSnapIndex(s),l="number"===typeof o&&!this.viewItems[o].visible,m="number"===typeof r&&!this.viewItems[r].visible;l&&n[h]&&(a>0||this.startSnappingEnabled)?e.state=1:m&&i[h]&&(a<this.contentSize||this.endSnappingEnabled)?e.state=2:e.state=0}else e.state=r&&!l?1:!r&&l?2:3}}getSashPosition(e){let i=0;for(let t=0;t<this.sashItems.length;t++)if(i+=this.viewItems[t].size,this.sashItems[t].sash===e)return i;return 0}findFirstSnapIndex(e){for(const i of e){const e=this.viewItems[i];if(e.visible&&e.snap)return i}for(const i of e){const e=this.viewItems[i];if(e.visible&&e.maximumSize-e.minimumSize>0)return;if(!e.visible&&e.snap)return i}}dispose(){super.dispose(),this.viewItems.forEach((e=>e.dispose())),this.viewItems=[],this.sashItems.forEach((e=>e.disposable.dispose())),this.sashItems=[]}}