import{$,append,clearNode,createStyleSheet}from"../../dom.js";import{List}from"../list/listWidget.js";import{SplitView}from"../splitview/splitview.js";import{Emitter,Event}from"../../../common/event.js";import{DisposableStore}from"../../../common/lifecycle.js";import"./table.css";class TableListRenderer{constructor(e,t,i){this.columns=e,this.getColumnSize=i,this.templateId=TableListRenderer.TemplateId,this.renderedTemplates=new Set;const s=new Map(t.map((e=>[e.templateId,e])));this.renderers=[];for(const o of e){const e=s.get(o.templateId);if(!e)throw new Error(`Table cell renderer for template id ${o.templateId} not found.`);this.renderers.push(e)}}renderTemplate(e){const t=append(e,$(".monaco-table-tr")),i=[],s=[];for(let n=0;n<this.columns.length;n++){const e=this.renderers[n],o=append(t,$(".monaco-table-td",{"data-col-index":n}));o.style.width=`${this.getColumnSize(n)}px`,i.push(o),s.push(e.renderTemplate(o))}const o={container:e,cellContainers:i,cellTemplateData:s};return this.renderedTemplates.add(o),o}renderElement(e,t,i,s){for(let o=0;o<this.columns.length;o++){const n=this.columns[o],l=n.project(e),r=this.renderers[o];r.renderElement(l,t,i.cellTemplateData[o],s)}}disposeElement(e,t,i,s){for(let o=0;o<this.columns.length;o++){const n=this.renderers[o];if(n.disposeElement){const l=this.columns[o],r=l.project(e);n.disposeElement(r,t,i.cellTemplateData[o],s)}}}disposeTemplate(e){for(let t=0;t<this.columns.length;t++){const i=this.renderers[t];i.disposeTemplate(e.cellTemplateData[t])}clearNode(e.container),this.renderedTemplates.delete(e)}layoutColumn(e,t){for(const{cellContainers:i}of this.renderedTemplates)i[e].style.width=`${t}px`}}function asListVirtualDelegate(e){return{getHeight(t){return e.getHeight(t)},getTemplateId(){return TableListRenderer.TemplateId}}}TableListRenderer.TemplateId="row";class ColumnHeader{constructor(e,t){this.column=e,this.index=t,this._onDidLayout=new Emitter,this.onDidLayout=this._onDidLayout.event,this.element=$(".monaco-table-th",{"data-col-index":t,title:e.tooltip},e.label)}get minimumSize(){var e;return null!==(e=this.column.minimumWidth)&&void 0!==e?e:120}get maximumSize(){var e;return null!==(e=this.column.maximumWidth)&&void 0!==e?e:Number.POSITIVE_INFINITY}get onDidChange(){var e;return null!==(e=this.column.onDidChangeWidthConstraints)&&void 0!==e?e:Event.None}layout(e){this._onDidLayout.fire([this.index,e])}}export class Table{constructor(e,t,i,s,o,n){this.virtualDelegate=i,this.domId="table_id_"+ ++Table.InstanceCount,this.disposables=new DisposableStore,this.cachedWidth=0,this.cachedHeight=0,this.domNode=append(t,$(`.monaco-table.${this.domId}`));const l=s.map(((e,t)=>new ColumnHeader(e,t))),r={size:l.reduce(((e,t)=>e+t.column.weight),0),views:l.map((e=>({size:e.column.weight,view:e})))};this.splitview=this.disposables.add(new SplitView(this.domNode,{orientation:1,scrollbarVisibility:2,getSashOrthogonalSize:()=>this.cachedHeight,descriptor:r})),this.splitview.el.style.height=`${i.headerRowHeight}px`,this.splitview.el.style.lineHeight=`${i.headerRowHeight}px`;const a=new TableListRenderer(s,o,(e=>this.splitview.getViewSize(e)));this.list=this.disposables.add(new List(e,this.domNode,asListVirtualDelegate(i),[a],n)),Event.any(...l.map((e=>e.onDidLayout)))((([e,t])=>a.layoutColumn(e,t)),null,this.disposables),this.splitview.onDidSashReset((e=>{const t=s.reduce(((e,t)=>e+t.weight),0),i=s[e].weight/t*this.cachedWidth;this.splitview.resizeView(e,i)}),null,this.disposables),this.styleElement=createStyleSheet(this.domNode),this.style({})}get onDidChangeFocus(){return this.list.onDidChangeFocus}get onDidChangeSelection(){return this.list.onDidChangeSelection}get onMouseDblClick(){return this.list.onMouseDblClick}get onPointer(){return this.list.onPointer}get onDidFocus(){return this.list.onDidFocus}get onDidDispose(){return this.list.onDidDispose}updateOptions(e){this.list.updateOptions(e)}splice(e,t,i=[]){this.list.splice(e,t,i)}getHTMLElement(){return this.domNode}style(e){const t=[];t.push(`.monaco-table.${this.domId} > .monaco-split-view2 .monaco-sash.vertical::before {\n\t\t\ttop: ${this.virtualDelegate.headerRowHeight+1}px;\n\t\t\theight: calc(100% - ${this.virtualDelegate.headerRowHeight}px);\n\t\t}`),this.styleElement.textContent=t.join("\n"),this.list.style(e)}getSelectedElements(){return this.list.getSelectedElements()}getSelection(){return this.list.getSelection()}getFocus(){return this.list.getFocus()}dispose(){this.disposables.dispose()}}Table.InstanceCount=0;