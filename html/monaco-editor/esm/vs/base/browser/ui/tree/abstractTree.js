import{DragAndDropData,StaticDND}from"../../dnd.js";import{$,addDisposableListener,append,clearNode,createStyleSheet,getDomNodePagePosition,hasParentWithClass}from"../../dom.js";import{DomEmitter}from"../../event.js";import{StandardKeyboardEvent}from"../../keyboardEvent.js";import{ElementsDragAndDropData}from"../list/listView.js";import{DefaultKeyboardNavigationDelegate,isInputElement,isMonacoEditor,List,MouseController}from"../list/listWidget.js";import{getVisibleState,isFilterResult}from"./indexTreeModel.js";import{TreeMouseEventTarget}from"./tree.js";import{distinct,equals,range}from"../../../common/arrays.js";import{disposableTimeout}from"../../../common/async.js";import{Codicon}from"../../../common/codicons.js";import{SetMap}from"../../../common/collections.js";import{Emitter,Event,EventBufferer,Relay}from"../../../common/event.js";import{fuzzyScore,FuzzyScore}from"../../../common/filters.js";import{Disposable,DisposableStore,dispose,toDisposable}from"../../../common/lifecycle.js";import{clamp}from"../../../common/numbers.js";import{isMacintosh}from"../../../common/platform.js";import"./media/tree.css";import{localize}from"../../../../nls.js";class TreeElementsDragAndDropData extends ElementsDragAndDropData{constructor(e){super(e.elements.map((e=>e.element))),this.data=e}}function asTreeDragAndDropData(e){return e instanceof ElementsDragAndDropData?new TreeElementsDragAndDropData(e):e}class TreeNodeListDragAndDrop{constructor(e,t){this.modelProvider=e,this.dnd=t,this.autoExpandDisposable=Disposable.None}getDragURI(e){return this.dnd.getDragURI(e.element)}getDragLabel(e,t){if(this.dnd.getDragLabel)return this.dnd.getDragLabel(e.map((e=>e.element)),t)}onDragStart(e,t){this.dnd.onDragStart&&this.dnd.onDragStart(asTreeDragAndDropData(e),t)}onDragOver(e,t,i,s,n=!0){const o=this.dnd.onDragOver(asTreeDragAndDropData(e),t&&t.element,i,s),r=this.autoExpandNode!==t;if(r&&(this.autoExpandDisposable.dispose(),this.autoExpandNode=t),"undefined"===typeof t)return o;if(r&&"boolean"!==typeof o&&o.autoExpand&&(this.autoExpandDisposable=disposableTimeout((()=>{const e=this.modelProvider(),i=e.getNodeLocation(t);e.isCollapsed(i)&&e.setCollapsed(i,!1),this.autoExpandNode=void 0}),500)),"boolean"===typeof o||!o.accept||"undefined"===typeof o.bubble||o.feedback){if(!n){const e="boolean"===typeof o?o:o.accept,t="boolean"===typeof o?void 0:o.effect;return{accept:e,effect:t,feedback:[i]}}return o}if(1===o.bubble){const i=this.modelProvider(),n=i.getNodeLocation(t),o=i.getParentNodeLocation(n),r=i.getNode(o),a=o&&i.getListIndex(o);return this.onDragOver(e,r,a,s,!1)}const a=this.modelProvider(),d=a.getNodeLocation(t),l=a.getListIndex(d),h=a.getListRenderCount(d);return Object.assign(Object.assign({},o),{feedback:range(l,l+h)})}drop(e,t,i,s){this.autoExpandDisposable.dispose(),this.autoExpandNode=void 0,this.dnd.drop(asTreeDragAndDropData(e),t&&t.element,i,s)}onDragEnd(e){this.dnd.onDragEnd&&this.dnd.onDragEnd(e)}}function asListOptions(e,t){return t&&Object.assign(Object.assign({},t),{identityProvider:t.identityProvider&&{getId(e){return t.identityProvider.getId(e.element)}},dnd:t.dnd&&new TreeNodeListDragAndDrop(e,t.dnd),multipleSelectionController:t.multipleSelectionController&&{isSelectionSingleChangeEvent(e){return t.multipleSelectionController.isSelectionSingleChangeEvent(Object.assign(Object.assign({},e),{element:e.element}))},isSelectionRangeChangeEvent(e){return t.multipleSelectionController.isSelectionRangeChangeEvent(Object.assign(Object.assign({},e),{element:e.element}))}},accessibilityProvider:t.accessibilityProvider&&Object.assign(Object.assign({},t.accessibilityProvider),{getSetSize(t){const i=e(),s=i.getNodeLocation(t),n=i.getParentNodeLocation(s),o=i.getNode(n);return o.visibleChildrenCount},getPosInSet(e){return e.visibleChildIndex+1},isChecked:t.accessibilityProvider&&t.accessibilityProvider.isChecked?e=>t.accessibilityProvider.isChecked(e.element):void 0,getRole:t.accessibilityProvider&&t.accessibilityProvider.getRole?e=>t.accessibilityProvider.getRole(e.element):()=>"treeitem",getAriaLabel(e){return t.accessibilityProvider.getAriaLabel(e.element)},getWidgetAriaLabel(){return t.accessibilityProvider.getWidgetAriaLabel()},getWidgetRole:t.accessibilityProvider&&t.accessibilityProvider.getWidgetRole?()=>t.accessibilityProvider.getWidgetRole():()=>"tree",getAriaLevel:t.accessibilityProvider&&t.accessibilityProvider.getAriaLevel?e=>t.accessibilityProvider.getAriaLevel(e.element):e=>e.depth,getActiveDescendantId:t.accessibilityProvider.getActiveDescendantId&&(e=>t.accessibilityProvider.getActiveDescendantId(e.element))}),keyboardNavigationLabelProvider:t.keyboardNavigationLabelProvider&&Object.assign(Object.assign({},t.keyboardNavigationLabelProvider),{getKeyboardNavigationLabel(e){return t.keyboardNavigationLabelProvider.getKeyboardNavigationLabel(e.element)}}),enableKeyboardNavigation:t.simpleKeyboardNavigation})}export class ComposedTreeDelegate{constructor(e){this.delegate=e}getHeight(e){return this.delegate.getHeight(e.element)}getTemplateId(e){return this.delegate.getTemplateId(e.element)}hasDynamicHeight(e){return!!this.delegate.hasDynamicHeight&&this.delegate.hasDynamicHeight(e.element)}setDynamicHeight(e,t){this.delegate.setDynamicHeight&&this.delegate.setDynamicHeight(e.element,t)}}export var RenderIndentGuides;(function(e){e["None"]="none",e["OnHover"]="onHover",e["Always"]="always"})(RenderIndentGuides||(RenderIndentGuides={}));class EventCollection{constructor(e,t=[]){this._elements=t,this.onDidChange=Event.forEach(e,(e=>this._elements=e))}get elements(){return this._elements}}class TreeRenderer{constructor(e,t,i,s,n={}){this.renderer=e,this.modelProvider=t,this.activeNodes=s,this.renderedElements=new Map,this.renderedNodes=new Map,this.indent=TreeRenderer.DefaultIndent,this.hideTwistiesOfChildlessElements=!1,this.shouldRenderIndentGuides=!1,this.renderedIndentGuides=new SetMap,this.activeIndentNodes=new Set,this.indentGuidesDisposable=Disposable.None,this.disposables=new DisposableStore,this.templateId=e.templateId,this.updateOptions(n),Event.map(i,(e=>e.node))(this.onDidChangeNodeTwistieState,this,this.disposables),e.onDidChangeTwistieState&&e.onDidChangeTwistieState(this.onDidChangeTwistieState,this,this.disposables)}updateOptions(e={}){if("undefined"!==typeof e.indent&&(this.indent=clamp(e.indent,0,40)),"undefined"!==typeof e.renderIndentGuides){const t=e.renderIndentGuides!==RenderIndentGuides.None;if(t!==this.shouldRenderIndentGuides&&(this.shouldRenderIndentGuides=t,this.indentGuidesDisposable.dispose(),t)){const e=new DisposableStore;this.activeNodes.onDidChange(this._onDidChangeActiveNodes,this,e),this.indentGuidesDisposable=e,this._onDidChangeActiveNodes(this.activeNodes.elements)}}"undefined"!==typeof e.hideTwistiesOfChildlessElements&&(this.hideTwistiesOfChildlessElements=e.hideTwistiesOfChildlessElements)}renderTemplate(e){const t=append(e,$(".monaco-tl-row")),i=append(t,$(".monaco-tl-indent")),s=append(t,$(".monaco-tl-twistie")),n=append(t,$(".monaco-tl-contents")),o=this.renderer.renderTemplate(n);return{container:e,indent:i,twistie:s,indentGuidesDisposable:Disposable.None,templateData:o}}renderElement(e,t,i,s){"number"===typeof s&&(this.renderedNodes.set(e,{templateData:i,height:s}),this.renderedElements.set(e.element,e));const n=TreeRenderer.DefaultIndent+(e.depth-1)*this.indent;i.twistie.style.paddingLeft=`${n}px`,i.indent.style.width=n+this.indent-16+"px",this.renderTwistie(e,i),"number"===typeof s&&this.renderIndentGuides(e,i),this.renderer.renderElement(e,t,i.templateData,s)}disposeElement(e,t,i,s){i.indentGuidesDisposable.dispose(),this.renderer.disposeElement&&this.renderer.disposeElement(e,t,i.templateData,s),"number"===typeof s&&(this.renderedNodes.delete(e),this.renderedElements.delete(e.element))}disposeTemplate(e){this.renderer.disposeTemplate(e.templateData)}onDidChangeTwistieState(e){const t=this.renderedElements.get(e);t&&this.onDidChangeNodeTwistieState(t)}onDidChangeNodeTwistieState(e){const t=this.renderedNodes.get(e);t&&(this.renderTwistie(e,t.templateData),this._onDidChangeActiveNodes(this.activeNodes.elements),this.renderIndentGuides(e,t.templateData))}renderTwistie(e,t){t.twistie.classList.remove(...Codicon.treeItemExpanded.classNamesArray);let i=!1;this.renderer.renderTwistie&&(i=this.renderer.renderTwistie(e.element,t.twistie)),e.collapsible&&(!this.hideTwistiesOfChildlessElements||e.visibleChildrenCount>0)?(i||t.twistie.classList.add(...Codicon.treeItemExpanded.classNamesArray),t.twistie.classList.add("collapsible"),t.twistie.classList.toggle("collapsed",e.collapsed)):t.twistie.classList.remove("collapsible","collapsed"),e.collapsible?t.container.setAttribute("aria-expanded",String(!e.collapsed)):t.container.removeAttribute("aria-expanded")}renderIndentGuides(e,t){if(clearNode(t.indent),t.indentGuidesDisposable.dispose(),!this.shouldRenderIndentGuides)return;const i=new DisposableStore,s=this.modelProvider();let n=e;while(1){const e=s.getNodeLocation(n),o=s.getParentNodeLocation(e);if(!o)break;const r=s.getNode(o),a=$(".indent-guide",{style:`width: ${this.indent}px`});this.activeIndentNodes.has(r)&&a.classList.add("active"),0===t.indent.childElementCount?t.indent.appendChild(a):t.indent.insertBefore(a,t.indent.firstElementChild),this.renderedIndentGuides.add(r,a),i.add(toDisposable((()=>this.renderedIndentGuides.delete(r,a)))),n=r}t.indentGuidesDisposable=i}_onDidChangeActiveNodes(e){if(!this.shouldRenderIndentGuides)return;const t=new Set,i=this.modelProvider();e.forEach((e=>{const s=i.getNodeLocation(e);try{const n=i.getParentNodeLocation(s);e.collapsible&&e.children.length>0&&!e.collapsed?t.add(e):n&&t.add(i.getNode(n))}catch(n){}})),this.activeIndentNodes.forEach((e=>{t.has(e)||this.renderedIndentGuides.forEach(e,(e=>e.classList.remove("active")))})),t.forEach((e=>{this.activeIndentNodes.has(e)||this.renderedIndentGuides.forEach(e,(e=>e.classList.add("active")))})),this.activeIndentNodes=t}dispose(){this.renderedNodes.clear(),this.renderedElements.clear(),this.indentGuidesDisposable.dispose(),dispose(this.disposables)}}TreeRenderer.DefaultIndent=8;class TypeFilter{constructor(e,t,i){this.tree=e,this.keyboardNavigationLabelProvider=t,this._filter=i,this._totalCount=0,this._matchCount=0,this._pattern="",this._lowercasePattern="",this.disposables=new DisposableStore,e.onWillRefilter(this.reset,this,this.disposables)}get totalCount(){return this._totalCount}get matchCount(){return this._matchCount}set pattern(e){this._pattern=e,this._lowercasePattern=e.toLowerCase()}filter(e,t){if(this._filter){const i=this._filter.filter(e,t);if(this.tree.options.simpleKeyboardNavigation)return i;let s;if(s="boolean"===typeof i?i?1:0:isFilterResult(i)?getVisibleState(i.visibility):i,0===s)return!1}if(this._totalCount++,this.tree.options.simpleKeyboardNavigation||!this._pattern)return this._matchCount++,{data:FuzzyScore.Default,visibility:!0};const i=this.keyboardNavigationLabelProvider.getKeyboardNavigationLabel(e),s=Array.isArray(i)?i:[i];for(const n of s){const e=n&&n.toString();if("undefined"===typeof e)return{data:FuzzyScore.Default,visibility:!0};const t=fuzzyScore(this._pattern,this._lowercasePattern,0,e,e.toLowerCase(),0,!0);if(t)return this._matchCount++,1===s.length?{data:t,visibility:!0}:{data:{label:e,score:t},visibility:!0}}return this.tree.options.filterOnType?2:{data:FuzzyScore.Default,visibility:!0}}reset(){this._totalCount=0,this._matchCount=0}dispose(){dispose(this.disposables)}}class TypeFilterController{constructor(e,t,i,s,n){this.tree=e,this.view=i,this.filter=s,this.keyboardNavigationDelegate=n,this._enabled=!1,this._pattern="",this._empty=!1,this._onDidChangeEmptyState=new Emitter,this.positionClassName="ne",this.automaticKeyboardNavigation=!0,this.triggered=!1,this._onDidChangePattern=new Emitter,this.enabledDisposables=new DisposableStore,this.disposables=new DisposableStore,this.domNode=$(`.monaco-list-type-filter.${this.positionClassName}`),this.domNode.draggable=!0,this.disposables.add(addDisposableListener(this.domNode,"dragstart",(()=>this.onDragStart()))),this.messageDomNode=append(i.getHTMLElement(),$(".monaco-list-type-filter-message")),this.labelDomNode=append(this.domNode,$("span.label"));const o=append(this.domNode,$(".controls"));this._filterOnType=!!e.options.filterOnType,this.filterOnTypeDomNode=append(o,$("input.filter")),this.filterOnTypeDomNode.type="checkbox",this.filterOnTypeDomNode.checked=this._filterOnType,this.filterOnTypeDomNode.tabIndex=-1,this.updateFilterOnTypeTitleAndIcon(),this.disposables.add(addDisposableListener(this.filterOnTypeDomNode,"input",(()=>this.onDidChangeFilterOnType()))),this.clearDomNode=append(o,$("button.clear"+Codicon.treeFilterClear.cssSelector)),this.clearDomNode.tabIndex=-1,this.clearDomNode.title=localize("clear","Clear"),this.keyboardNavigationEventFilter=e.options.keyboardNavigationEventFilter,t.onDidSplice(this.onDidSpliceModel,this,this.disposables),this.updateOptions(e.options)}get enabled(){return this._enabled}get pattern(){return this._pattern}get filterOnType(){return this._filterOnType}updateOptions(e){e.simpleKeyboardNavigation?this.disable():this.enable(),"undefined"!==typeof e.filterOnType&&(this._filterOnType=!!e.filterOnType,this.filterOnTypeDomNode.checked=this._filterOnType,this.updateFilterOnTypeTitleAndIcon()),"undefined"!==typeof e.automaticKeyboardNavigation&&(this.automaticKeyboardNavigation=e.automaticKeyboardNavigation),this.tree.refilter(),this.render(),this.automaticKeyboardNavigation||this.onEventOrInput("")}enable(){if(this._enabled)return;const e=this.enabledDisposables.add(new DomEmitter(this.view.getHTMLElement(),"keydown")),t=Event.chain(e.event).filter((e=>!isInputElement(e.target)||e.target===this.filterOnTypeDomNode)).filter((e=>"Dead"!==e.key&&!/^Media/.test(e.key))).map((e=>new StandardKeyboardEvent(e))).filter(this.keyboardNavigationEventFilter||(()=>!0)).filter((()=>this.automaticKeyboardNavigation||this.triggered)).filter((e=>this.keyboardNavigationDelegate.mightProducePrintableCharacter(e)&&!(18===e.keyCode||16===e.keyCode||15===e.keyCode||17===e.keyCode)||(this.pattern.length>0||this.triggered)&&(9===e.keyCode||1===e.keyCode)&&!e.altKey&&!e.ctrlKey&&!e.metaKey||1===e.keyCode&&(isMacintosh?e.altKey&&!e.metaKey:e.ctrlKey)&&!e.shiftKey)).forEach((e=>{e.stopPropagation(),e.preventDefault()})).event,i=this.enabledDisposables.add(new DomEmitter(this.clearDomNode,"click"));Event.chain(Event.any(t,i.event)).event(this.onEventOrInput,this,this.enabledDisposables),this.filter.pattern="",this.tree.refilter(),this.render(),this._enabled=!0,this.triggered=!1}disable(){this._enabled&&(this.domNode.remove(),this.enabledDisposables.clear(),this.tree.refilter(),this.render(),this._enabled=!1,this.triggered=!1)}onEventOrInput(e){"string"===typeof e?this.onInput(e):e instanceof MouseEvent||9===e.keyCode||1===e.keyCode&&(isMacintosh?e.altKey:e.ctrlKey)?this.onInput(""):1===e.keyCode?this.onInput(0===this.pattern.length?"":this.pattern.substr(0,this.pattern.length-1)):this.onInput(this.pattern+e.browserEvent.key)}onInput(e){const t=this.view.getHTMLElement();e&&!this.domNode.parentElement?t.append(this.domNode):!e&&this.domNode.parentElement&&(this.domNode.remove(),this.tree.domFocus()),this._pattern=e,this._onDidChangePattern.fire(e),this.filter.pattern=e,this.tree.refilter(),e&&this.tree.focusNext(0,!0,void 0,(e=>!FuzzyScore.isDefault(e.filterData)));const i=this.tree.getFocus();if(i.length>0){const e=i[0];null===this.tree.getRelativeTop(e)&&this.tree.reveal(e,.5)}this.render(),e||(this.triggered=!1)}onDragStart(){const e=this.view.getHTMLElement(),{left:t}=getDomNodePagePosition(e),i=e.clientWidth,s=i/2,n=this.domNode.clientWidth,o=new DisposableStore;let r=this.positionClassName;const a=()=>{switch(r){case"nw":this.domNode.style.top="4px",this.domNode.style.left="4px";break;case"ne":this.domNode.style.top="4px",this.domNode.style.left=i-n-6+"px";break}},d=e=>{e.preventDefault();const i=e.clientX-t;e.dataTransfer&&(e.dataTransfer.dropEffect="none"),r=i<s?"nw":"ne",a()},l=()=>{this.positionClassName=r,this.domNode.className=`monaco-list-type-filter ${this.positionClassName}`,this.domNode.style.top="",this.domNode.style.left="",dispose(o)};a(),this.domNode.classList.remove(r),this.domNode.classList.add("dragging"),o.add(toDisposable((()=>this.domNode.classList.remove("dragging")))),o.add(addDisposableListener(document,"dragover",(e=>d(e)))),o.add(addDisposableListener(this.domNode,"dragend",(()=>l()))),StaticDND.CurrentDragAndDropData=new DragAndDropData("vscode-ui"),o.add(toDisposable((()=>StaticDND.CurrentDragAndDropData=void 0)))}onDidSpliceModel(){this._enabled&&0!==this.pattern.length&&(this.tree.refilter(),this.render())}onDidChangeFilterOnType(){this.tree.updateOptions({filterOnType:this.filterOnTypeDomNode.checked}),this.tree.refilter(),this.tree.domFocus(),this.render(),this.updateFilterOnTypeTitleAndIcon()}updateFilterOnTypeTitleAndIcon(){this.filterOnType?(this.filterOnTypeDomNode.classList.remove(...Codicon.treeFilterOnTypeOff.classNamesArray),this.filterOnTypeDomNode.classList.add(...Codicon.treeFilterOnTypeOn.classNamesArray),this.filterOnTypeDomNode.title=localize("disable filter on type","Disable Filter on Type")):(this.filterOnTypeDomNode.classList.remove(...Codicon.treeFilterOnTypeOn.classNamesArray),this.filterOnTypeDomNode.classList.add(...Codicon.treeFilterOnTypeOff.classNamesArray),this.filterOnTypeDomNode.title=localize("enable filter on type","Enable Filter on Type"))}render(){const e=this.filter.totalCount>0&&0===this.filter.matchCount;this.pattern&&this.tree.options.filterOnType&&e?(this.messageDomNode.textContent=localize("empty","No elements found"),this._empty=!0):(this.messageDomNode.innerText="",this._empty=!1),this.domNode.classList.toggle("no-matches",e),this.domNode.title=localize("found","Matched {0} out of {1} elements",this.filter.matchCount,this.filter.totalCount),this.labelDomNode.textContent=this.pattern.length>16?"\u2026"+this.pattern.substr(this.pattern.length-16):this.pattern,this._onDidChangeEmptyState.fire(this._empty)}shouldAllowFocus(e){return!(this.enabled&&this.pattern&&!this.filterOnType)||(this.filter.totalCount>0&&this.filter.matchCount<=1||!FuzzyScore.isDefault(e.filterData))}dispose(){this._enabled&&(this.domNode.remove(),this.enabledDisposables.dispose(),this._enabled=!1,this.triggered=!1),this._onDidChangePattern.dispose(),dispose(this.disposables)}}function asTreeMouseEvent(e){let t=TreeMouseEventTarget.Unknown;return hasParentWithClass(e.browserEvent.target,"monaco-tl-twistie","monaco-tl-row")?t=TreeMouseEventTarget.Twistie:hasParentWithClass(e.browserEvent.target,"monaco-tl-contents","monaco-tl-row")&&(t=TreeMouseEventTarget.Element),{browserEvent:e.browserEvent,element:e.element?e.element.element:null,target:t}}function dfs(e,t){t(e),e.children.forEach((e=>dfs(e,t)))}class Trait{constructor(e,t){this.getFirstViewElementWithTrait=e,this.identityProvider=t,this.nodes=[],this._onDidChange=new Emitter,this.onDidChange=this._onDidChange.event}get nodeSet(){return this._nodeSet||(this._nodeSet=this.createNodeSet()),this._nodeSet}set(e,t){!(null===t||void 0===t?void 0:t.__forceEvent)&&equals(this.nodes,e)||this._set(e,!1,t)}_set(e,t,i){if(this.nodes=[...e],this.elements=void 0,this._nodeSet=void 0,!t){const e=this;this._onDidChange.fire({get elements(){return e.get()},browserEvent:i})}}get(){return this.elements||(this.elements=this.nodes.map((e=>e.element))),[...this.elements]}getNodes(){return this.nodes}has(e){return this.nodeSet.has(e)}onDidModelSplice({insertedNodes:e,deletedNodes:t}){if(!this.identityProvider){const e=this.createNodeSet(),i=t=>e.delete(t);return t.forEach((e=>dfs(e,i))),void this.set([...e.values()])}const i=new Set,s=e=>i.add(this.identityProvider.getId(e.element).toString());t.forEach((e=>dfs(e,s)));const n=new Map,o=e=>n.set(this.identityProvider.getId(e.element).toString(),e);e.forEach((e=>dfs(e,o)));const r=[];for(const a of this.nodes){const e=this.identityProvider.getId(a.element).toString(),t=i.has(e);if(t){const t=n.get(e);t&&r.push(t)}else r.push(a)}if(this.nodes.length>0&&0===r.length){const e=this.getFirstViewElementWithTrait();e&&r.push(e)}this._set(r,!0)}createNodeSet(){const e=new Set;for(const t of this.nodes)e.add(t);return e}}class TreeNodeListMouseController extends MouseController{constructor(e,t){super(e),this.tree=t}onViewPointer(e){if(isInputElement(e.browserEvent.target)||isMonacoEditor(e.browserEvent.target))return;const t=e.element;if(!t)return super.onViewPointer(e);if(this.isSelectionRangeChangeEvent(e)||this.isSelectionSingleChangeEvent(e))return super.onViewPointer(e);const i=e.browserEvent.target,s=i.classList.contains("monaco-tl-twistie")||i.classList.contains("monaco-icon-label")&&i.classList.contains("folder-icon")&&e.browserEvent.offsetX<16;let n=!1;if(n="function"===typeof this.tree.expandOnlyOnTwistieClick?this.tree.expandOnlyOnTwistieClick(t.element):!!this.tree.expandOnlyOnTwistieClick,n&&!s&&2!==e.browserEvent.detail)return super.onViewPointer(e);if(!this.tree.expandOnDoubleClick&&2===e.browserEvent.detail)return super.onViewPointer(e);if(t.collapsible){const i=this.tree.model,o=i.getNodeLocation(t),r=e.browserEvent.altKey;if(this.tree.setFocus([o]),i.setCollapsed(o,void 0,r),n&&s)return}super.onViewPointer(e)}onDoubleClick(e){const t=e.browserEvent.target.classList.contains("monaco-tl-twistie");!t&&this.tree.expandOnDoubleClick&&super.onDoubleClick(e)}}class TreeNodeList extends List{constructor(e,t,i,s,n,o,r,a){super(e,t,i,s,a),this.focusTrait=n,this.selectionTrait=o,this.anchorTrait=r}createMouseController(e){return new TreeNodeListMouseController(this,e.tree)}splice(e,t,i=[]){if(super.splice(e,t,i),0===i.length)return;const s=[],n=[];let o;i.forEach(((t,i)=>{this.focusTrait.has(t)&&s.push(e+i),this.selectionTrait.has(t)&&n.push(e+i),this.anchorTrait.has(t)&&(o=e+i)})),s.length>0&&super.setFocus(distinct([...super.getFocus(),...s])),n.length>0&&super.setSelection(distinct([...super.getSelection(),...n])),"number"===typeof o&&super.setAnchor(o)}setFocus(e,t,i=!1){super.setFocus(e,t),i||this.focusTrait.set(e.map((e=>this.element(e))),t)}setSelection(e,t,i=!1){super.setSelection(e,t),i||this.selectionTrait.set(e.map((e=>this.element(e))),t)}setAnchor(e,t=!1){super.setAnchor(e),t||("undefined"===typeof e?this.anchorTrait.set([]):this.anchorTrait.set([this.element(e)]))}}export class AbstractTree{constructor(e,t,i,s,n={}){this._user=e,this._options=n,this.eventBufferer=new EventBufferer,this.disposables=new DisposableStore,this._onWillRefilter=new Emitter,this.onWillRefilter=this._onWillRefilter.event,this._onDidUpdateOptions=new Emitter;const o=new ComposedTreeDelegate(i),r=new Relay,a=new Relay,d=new EventCollection(a.event);this.renderers=s.map((e=>new TreeRenderer(e,(()=>this.model),r.event,d,n)));for(let c of this.renderers)this.disposables.add(c);let l;n.keyboardNavigationLabelProvider&&(l=new TypeFilter(this,n.keyboardNavigationLabelProvider,n.filter),n=Object.assign(Object.assign({},n),{filter:l}),this.disposables.add(l)),this.focus=new Trait((()=>this.view.getFocusedElements()[0]),n.identityProvider),this.selection=new Trait((()=>this.view.getSelectedElements()[0]),n.identityProvider),this.anchor=new Trait((()=>this.view.getAnchorElement()),n.identityProvider),this.view=new TreeNodeList(e,t,o,this.renderers,this.focus,this.selection,this.anchor,Object.assign(Object.assign({},asListOptions((()=>this.model),n)),{tree:this})),this.model=this.createModel(e,this.view,n),r.input=this.model.onDidChangeCollapseState;const h=Event.forEach(this.model.onDidSplice,(e=>{this.eventBufferer.bufferEvents((()=>{this.focus.onDidModelSplice(e),this.selection.onDidModelSplice(e)}))}));if(h((()=>null),null,this.disposables),a.input=Event.chain(Event.any(h,this.focus.onDidChange,this.selection.onDidChange)).debounce((()=>null),0).map((()=>{const e=new Set;for(const t of this.focus.getNodes())e.add(t);for(const t of this.selection.getNodes())e.add(t);return[...e.values()]})).event,!1!==n.keyboardSupport){const e=Event.chain(this.view.onKeyDown).filter((e=>!isInputElement(e.target))).map((e=>new StandardKeyboardEvent(e)));e.filter((e=>15===e.keyCode)).on(this.onLeftArrow,this,this.disposables),e.filter((e=>17===e.keyCode)).on(this.onRightArrow,this,this.disposables),e.filter((e=>10===e.keyCode)).on(this.onSpace,this,this.disposables)}if(n.keyboardNavigationLabelProvider){const e=n.keyboardNavigationDelegate||DefaultKeyboardNavigationDelegate;this.typeFilterController=new TypeFilterController(this,this.model,this.view,l,e),this.focusNavigationFilter=e=>this.typeFilterController.shouldAllowFocus(e),this.disposables.add(this.typeFilterController)}this.styleElement=createStyleSheet(this.view.getHTMLElement()),this.getHTMLElement().classList.toggle("always",this._options.renderIndentGuides===RenderIndentGuides.Always)}get onDidChangeFocus(){return this.eventBufferer.wrapEvent(this.focus.onDidChange)}get onDidChangeSelection(){return this.eventBufferer.wrapEvent(this.selection.onDidChange)}get onMouseDblClick(){return Event.map(this.view.onMouseDblClick,asTreeMouseEvent)}get onPointer(){return Event.map(this.view.onPointer,asTreeMouseEvent)}get onDidFocus(){return this.view.onDidFocus}get onDidChangeModel(){return Event.signal(this.model.onDidSplice)}get onDidChangeCollapseState(){return this.model.onDidChangeCollapseState}get expandOnDoubleClick(){return"undefined"===typeof this._options.expandOnDoubleClick||this._options.expandOnDoubleClick}get expandOnlyOnTwistieClick(){return"undefined"===typeof this._options.expandOnlyOnTwistieClick||this._options.expandOnlyOnTwistieClick}get onDidDispose(){return this.view.onDidDispose}updateOptions(e={}){this._options=Object.assign(Object.assign({},this._options),e);for(const t of this.renderers)t.updateOptions(e);this.view.updateOptions(Object.assign(Object.assign({},this._options),{enableKeyboardNavigation:this._options.simpleKeyboardNavigation})),this.typeFilterController&&this.typeFilterController.updateOptions(this._options),this._onDidUpdateOptions.fire(this._options),this.getHTMLElement().classList.toggle("always",this._options.renderIndentGuides===RenderIndentGuides.Always)}get options(){return this._options}getHTMLElement(){return this.view.getHTMLElement()}get scrollTop(){return this.view.scrollTop}set scrollTop(e){this.view.scrollTop=e}domFocus(){this.view.domFocus()}layout(e,t){this.view.layout(e,t)}style(e){const t=`.${this.view.domId}`,i=[];e.treeIndentGuidesStroke&&(i.push(`.monaco-list${t}:hover .monaco-tl-indent > .indent-guide, .monaco-list${t}.always .monaco-tl-indent > .indent-guide  { border-color: ${e.treeIndentGuidesStroke.transparent(.4)}; }`),i.push(`.monaco-list${t} .monaco-tl-indent > .indent-guide.active { border-color: ${e.treeIndentGuidesStroke}; }`)),this.styleElement.textContent=i.join("\n"),this.view.style(e)}getParentElement(e){const t=this.model.getParentNodeLocation(e),i=this.model.getNode(t);return i.element}getFirstElementChild(e){return this.model.getFirstElementChild(e)}getNode(e){return this.model.getNode(e)}collapse(e,t=!1){return this.model.setCollapsed(e,!0,t)}expand(e,t=!1){return this.model.setCollapsed(e,!1,t)}isCollapsible(e){return this.model.isCollapsible(e)}setCollapsible(e,t){return this.model.setCollapsible(e,t)}isCollapsed(e){return this.model.isCollapsed(e)}refilter(){this._onWillRefilter.fire(void 0),this.model.refilter()}setSelection(e,t){const i=e.map((e=>this.model.getNode(e)));this.selection.set(i,t);const s=e.map((e=>this.model.getListIndex(e))).filter((e=>e>-1));this.view.setSelection(s,t,!0)}getSelection(){return this.selection.get()}setFocus(e,t){const i=e.map((e=>this.model.getNode(e)));this.focus.set(i,t);const s=e.map((e=>this.model.getListIndex(e))).filter((e=>e>-1));this.view.setFocus(s,t,!0)}focusNext(e=1,t=!1,i,s=this.focusNavigationFilter){this.view.focusNext(e,t,i,s)}getFocus(){return this.focus.get()}reveal(e,t){this.model.expandTo(e);const i=this.model.getListIndex(e);-1!==i&&this.view.reveal(i,t)}getRelativeTop(e){const t=this.model.getListIndex(e);return-1===t?null:this.view.getRelativeTop(t)}onLeftArrow(e){e.preventDefault(),e.stopPropagation();const t=this.view.getFocusedElements();if(0===t.length)return;const i=t[0],s=this.model.getNodeLocation(i),n=this.model.setCollapsed(s,!0);if(!n){const e=this.model.getParentNodeLocation(s);if(!e)return;const t=this.model.getListIndex(e);this.view.reveal(t),this.view.setFocus([t])}}onRightArrow(e){e.preventDefault(),e.stopPropagation();const t=this.view.getFocusedElements();if(0===t.length)return;const i=t[0],s=this.model.getNodeLocation(i),n=this.model.setCollapsed(s,!1);if(!n){if(!i.children.some((e=>e.visible)))return;const[e]=this.view.getFocus(),t=e+1;this.view.reveal(t),this.view.setFocus([t])}}onSpace(e){e.preventDefault(),e.stopPropagation();const t=this.view.getFocusedElements();if(0===t.length)return;const i=t[0],s=this.model.getNodeLocation(i),n=e.browserEvent.altKey;this.model.setCollapsed(s,void 0,n)}dispose(){dispose(this.disposables),this.view.dispose()}}