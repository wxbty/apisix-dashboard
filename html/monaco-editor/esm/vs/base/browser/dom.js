import*as browser from"./browser.js";import{BrowserFeatures}from"./canIUse.js";import{StandardKeyboardEvent}from"./keyboardEvent.js";import{StandardMouseEvent}from"./mouseEvent.js";import{TimeoutTimer}from"../common/async.js";import{onUnexpectedError}from"../common/errors.js";import{Emitter}from"../common/event.js";import{Disposable,DisposableStore,toDisposable}from"../common/lifecycle.js";import{FileAccess,RemoteAuthorities}from"../common/network.js";import*as platform from"../common/platform.js";export function clearNode(e){while(e.firstChild)e.firstChild.remove()}export function isInDOM(e){var t;return null!==(t=null===e||void 0===e?void 0:e.isConnected)&&void 0!==t&&t}class DomListener{constructor(e,t,i,n){this._node=e,this._type=t,this._handler=i,this._options=n||!1,this._node.addEventListener(this._type,this._handler,this._options)}dispose(){this._handler&&(this._node.removeEventListener(this._type,this._handler,this._options),this._node=null,this._handler=null)}}export function addDisposableListener(e,t,i,n){return new DomListener(e,t,i,n)}function _wrapAsStandardMouseEvent(e){return function(t){return e(new StandardMouseEvent(t))}}function _wrapAsStandardKeyboardEvent(e){return function(t){return e(new StandardKeyboardEvent(t))}}export let addStandardDisposableListener=function(e,t,i,n){let r=i;return"click"===t||"mousedown"===t?r=_wrapAsStandardMouseEvent(i):"keydown"!==t&&"keypress"!==t&&"keyup"!==t||(r=_wrapAsStandardKeyboardEvent(i)),addDisposableListener(e,t,r,n)};export let addStandardDisposableGenericMouseDownListner=function(e,t,i){let n=_wrapAsStandardMouseEvent(t);return addDisposableGenericMouseDownListner(e,n,i)};export let addStandardDisposableGenericMouseUpListner=function(e,t,i){let n=_wrapAsStandardMouseEvent(t);return addDisposableGenericMouseUpListner(e,n,i)};export function addDisposableGenericMouseDownListner(e,t,i){return addDisposableListener(e,platform.isIOS&&BrowserFeatures.pointerEvents?EventType.POINTER_DOWN:EventType.MOUSE_DOWN,t,i)}export function addDisposableGenericMouseUpListner(e,t,i){return addDisposableListener(e,platform.isIOS&&BrowserFeatures.pointerEvents?EventType.POINTER_UP:EventType.MOUSE_UP,t,i)}export function addDisposableNonBubblingMouseOutListener(e,t){return addDisposableListener(e,"mouseout",(i=>{let n=i.relatedTarget;while(n&&n!==e)n=n.parentNode;n!==e&&t(i)}))}export function addDisposableNonBubblingPointerOutListener(e,t){return addDisposableListener(e,"pointerout",(i=>{let n=i.relatedTarget;while(n&&n!==e)n=n.parentNode;n!==e&&t(i)}))}export function createEventEmitter(e,t,i){let n=null;const r=e=>a.fire(e),o=()=>{n||(n=new DomListener(e,t,r,i))},s=()=>{n&&(n.dispose(),n=null)},a=new Emitter({onFirstListenerAdd:o,onLastListenerRemove:s});return a}let _animationFrame=null;function doRequestAnimationFrame(e){if(!_animationFrame){const e=e=>setTimeout((()=>e((new Date).getTime())),0);_animationFrame=self.requestAnimationFrame||self.msRequestAnimationFrame||self.webkitRequestAnimationFrame||self.mozRequestAnimationFrame||self.oRequestAnimationFrame||e}return _animationFrame.call(self,e)}export let runAtThisOrScheduleAtNextAnimationFrame;export let scheduleAtNextAnimationFrame;class AnimationFrameQueueItem{constructor(e,t=0){this._runner=e,this.priority=t,this._canceled=!1}dispose(){this._canceled=!0}execute(){if(!this._canceled)try{this._runner()}catch(e){onUnexpectedError(e)}}static sort(e,t){return t.priority-e.priority}}(function(){let e=[],t=null,i=!1,n=!1,r=()=>{i=!1,t=e,e=[],n=!0;while(t.length>0){t.sort(AnimationFrameQueueItem.sort);let e=t.shift();e.execute()}n=!1};scheduleAtNextAnimationFrame=(t,n=0)=>{let o=new AnimationFrameQueueItem(t,n);return e.push(o),i||(i=!0,doRequestAnimationFrame(r)),o},runAtThisOrScheduleAtNextAnimationFrame=(e,i)=>{if(n){let n=new AnimationFrameQueueItem(e,i);return t.push(n),n}return scheduleAtNextAnimationFrame(e,i)}})();const MINIMUM_TIME_MS=8,DEFAULT_EVENT_MERGER=function(e,t){return t};class TimeoutThrottledDomListener extends Disposable{constructor(e,t,i,n=DEFAULT_EVENT_MERGER,r=MINIMUM_TIME_MS){super();let o=null,s=0,a=this._register(new TimeoutTimer),d=()=>{s=(new Date).getTime(),i(o),o=null};this._register(addDisposableListener(e,t,(e=>{o=n(o,e);let t=(new Date).getTime()-s;t>=r?(a.cancel(),d()):a.setIfNotSet(d,r-t)})))}}export function addDisposableThrottledListener(e,t,i,n,r){return new TimeoutThrottledDomListener(e,t,i,n,r)}export function getComputedStyle(e){return document.defaultView.getComputedStyle(e,null)}export function getClientArea(e){if(e!==document.body)return new Dimension(e.clientWidth,e.clientHeight);if(platform.isIOS&&window.visualViewport)return new Dimension(window.visualViewport.width,window.visualViewport.height);if(window.innerWidth&&window.innerHeight)return new Dimension(window.innerWidth,window.innerHeight);if(document.body&&document.body.clientWidth&&document.body.clientHeight)return new Dimension(document.body.clientWidth,document.body.clientHeight);if(document.documentElement&&document.documentElement.clientWidth&&document.documentElement.clientHeight)return new Dimension(document.documentElement.clientWidth,document.documentElement.clientHeight);throw new Error("Unable to figure out browser width and height")}class SizeUtils{static convertToPixels(e,t){return parseFloat(t)||0}static getDimension(e,t,i){let n=getComputedStyle(e),r="0";return n&&(r=n.getPropertyValue?n.getPropertyValue(t):n.getAttribute(i)),SizeUtils.convertToPixels(e,r)}static getBorderLeftWidth(e){return SizeUtils.getDimension(e,"border-left-width","borderLeftWidth")}static getBorderRightWidth(e){return SizeUtils.getDimension(e,"border-right-width","borderRightWidth")}static getBorderTopWidth(e){return SizeUtils.getDimension(e,"border-top-width","borderTopWidth")}static getBorderBottomWidth(e){return SizeUtils.getDimension(e,"border-bottom-width","borderBottomWidth")}static getPaddingLeft(e){return SizeUtils.getDimension(e,"padding-left","paddingLeft")}static getPaddingRight(e){return SizeUtils.getDimension(e,"padding-right","paddingRight")}static getPaddingTop(e){return SizeUtils.getDimension(e,"padding-top","paddingTop")}static getPaddingBottom(e){return SizeUtils.getDimension(e,"padding-bottom","paddingBottom")}static getMarginLeft(e){return SizeUtils.getDimension(e,"margin-left","marginLeft")}static getMarginTop(e){return SizeUtils.getDimension(e,"margin-top","marginTop")}static getMarginRight(e){return SizeUtils.getDimension(e,"margin-right","marginRight")}static getMarginBottom(e){return SizeUtils.getDimension(e,"margin-bottom","marginBottom")}}export class Dimension{constructor(e,t){this.width=e,this.height=t}with(e=this.width,t=this.height){return e!==this.width||t!==this.height?new Dimension(e,t):this}static is(e){return"object"===typeof e&&"number"===typeof e.height&&"number"===typeof e.width}static lift(e){return e instanceof Dimension?e:new Dimension(e.width,e.height)}static equals(e,t){return e===t||!(!e||!t)&&(e.width===t.width&&e.height===t.height)}}Dimension.None=new Dimension(0,0);export function getTopLeftOffset(e){let t=e.offsetParent,i=e.offsetTop,n=e.offsetLeft;while(null!==(e=e.parentNode)&&e!==document.body&&e!==document.documentElement){i-=e.scrollTop;const r=isShadowRoot(e)?null:getComputedStyle(e);r&&(n-="rtl"!==r.direction?e.scrollLeft:-e.scrollLeft),e===t&&(n+=SizeUtils.getBorderLeftWidth(e),i+=SizeUtils.getBorderTopWidth(e),i+=e.offsetTop,n+=e.offsetLeft,t=e.offsetParent)}return{left:n,top:i}}export function size(e,t,i){"number"===typeof t&&(e.style.width=`${t}px`),"number"===typeof i&&(e.style.height=`${i}px`)}export function getDomNodePagePosition(e){let t=e.getBoundingClientRect();return{left:t.left+StandardWindow.scrollX,top:t.top+StandardWindow.scrollY,width:t.width,height:t.height}}export const StandardWindow=new class{get scrollX(){return"number"===typeof window.scrollX?window.scrollX:document.body.scrollLeft+document.documentElement.scrollLeft}get scrollY(){return"number"===typeof window.scrollY?window.scrollY:document.body.scrollTop+document.documentElement.scrollTop}};export function getTotalWidth(e){let t=SizeUtils.getMarginLeft(e)+SizeUtils.getMarginRight(e);return e.offsetWidth+t}export function getContentWidth(e){let t=SizeUtils.getBorderLeftWidth(e)+SizeUtils.getBorderRightWidth(e),i=SizeUtils.getPaddingLeft(e)+SizeUtils.getPaddingRight(e);return e.offsetWidth-t-i}export function getContentHeight(e){let t=SizeUtils.getBorderTopWidth(e)+SizeUtils.getBorderBottomWidth(e),i=SizeUtils.getPaddingTop(e)+SizeUtils.getPaddingBottom(e);return e.offsetHeight-t-i}export function getTotalHeight(e){let t=SizeUtils.getMarginTop(e)+SizeUtils.getMarginBottom(e);return e.offsetHeight+t}export function isAncestor(e,t){while(e){if(e===t)return!0;e=e.parentNode}return!1}export function findParentWithClass(e,t,i){while(e&&e.nodeType===e.ELEMENT_NODE){if(e.classList.contains(t))return e;if(i)if("string"===typeof i){if(e.classList.contains(i))return null}else if(e===i)return null;e=e.parentNode}return null}export function hasParentWithClass(e,t,i){return!!findParentWithClass(e,t,i)}export function isShadowRoot(e){return e&&!!e.host&&!!e.mode}export function isInShadowDOM(e){return!!getShadowRoot(e)}export function getShadowRoot(e){while(e.parentNode){if(e===document.body)return null;e=e.parentNode}return isShadowRoot(e)?e:null}export function getActiveElement(){let e=document.activeElement;while(null===e||void 0===e?void 0:e.shadowRoot)e=e.shadowRoot.activeElement;return e}export function createStyleSheet(e=document.getElementsByTagName("head")[0]){let t=document.createElement("style");return t.type="text/css",t.media="screen",e.appendChild(t),t}let _sharedStyleSheet=null;function getSharedStyleSheet(){return _sharedStyleSheet||(_sharedStyleSheet=createStyleSheet()),_sharedStyleSheet}function getDynamicStyleSheetRules(e){var t,i;return(null===(t=null===e||void 0===e?void 0:e.sheet)||void 0===t?void 0:t.rules)?e.sheet.rules:(null===(i=null===e||void 0===e?void 0:e.sheet)||void 0===i?void 0:i.cssRules)?e.sheet.cssRules:[]}export function createCSSRule(e,t,i=getSharedStyleSheet()){i&&t&&i.sheet.insertRule(e+"{"+t+"}",0)}export function removeCSSRulesContainingSelector(e,t=getSharedStyleSheet()){if(!t)return;let i=getDynamicStyleSheetRules(t),n=[];for(let r=0;r<i.length;r++){let t=i[r];-1!==t.selectorText.indexOf(e)&&n.push(r)}for(let r=n.length-1;r>=0;r--)t.sheet.deleteRule(n[r])}export function isHTMLElement(e){return"object"===typeof HTMLElement?e instanceof HTMLElement:e&&"object"===typeof e&&1===e.nodeType&&"string"===typeof e.nodeName}export const EventType={CLICK:"click",AUXCLICK:"auxclick",DBLCLICK:"dblclick",MOUSE_UP:"mouseup",MOUSE_DOWN:"mousedown",MOUSE_OVER:"mouseover",MOUSE_MOVE:"mousemove",MOUSE_OUT:"mouseout",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",MOUSE_WHEEL:"wheel",POINTER_UP:"pointerup",POINTER_DOWN:"pointerdown",POINTER_MOVE:"pointermove",CONTEXT_MENU:"contextmenu",WHEEL:"wheel",KEY_DOWN:"keydown",KEY_PRESS:"keypress",KEY_UP:"keyup",LOAD:"load",BEFORE_UNLOAD:"beforeunload",UNLOAD:"unload",PAGE_SHOW:"pageshow",PAGE_HIDE:"pagehide",ABORT:"abort",ERROR:"error",RESIZE:"resize",SCROLL:"scroll",FULLSCREEN_CHANGE:"fullscreenchange",WK_FULLSCREEN_CHANGE:"webkitfullscreenchange",SELECT:"select",CHANGE:"change",SUBMIT:"submit",RESET:"reset",FOCUS:"focus",FOCUS_IN:"focusin",FOCUS_OUT:"focusout",BLUR:"blur",INPUT:"input",STORAGE:"storage",DRAG_START:"dragstart",DRAG:"drag",DRAG_ENTER:"dragenter",DRAG_LEAVE:"dragleave",DRAG_OVER:"dragover",DROP:"drop",DRAG_END:"dragend",ANIMATION_START:browser.isWebKit?"webkitAnimationStart":"animationstart",ANIMATION_END:browser.isWebKit?"webkitAnimationEnd":"animationend",ANIMATION_ITERATION:browser.isWebKit?"webkitAnimationIteration":"animationiteration"};export const EventHelper={stop:function(e,t){e.preventDefault?e.preventDefault():e.returnValue=!1,t&&(e.stopPropagation?e.stopPropagation():e.cancelBubble=!0)}};export function saveParentsScrollTop(e){let t=[];for(let i=0;e&&e.nodeType===e.ELEMENT_NODE;i++)t[i]=e.scrollTop,e=e.parentNode;return t}export function restoreParentsScrollTop(e,t){for(let i=0;e&&e.nodeType===e.ELEMENT_NODE;i++)e.scrollTop!==t[i]&&(e.scrollTop=t[i]),e=e.parentNode}class FocusTracker extends Disposable{constructor(e){super(),this._onDidFocus=this._register(new Emitter),this.onDidFocus=this._onDidFocus.event,this._onDidBlur=this._register(new Emitter),this.onDidBlur=this._onDidBlur.event;let t=FocusTracker.hasFocusWithin(e),i=!1;const n=()=>{i=!1,t||(t=!0,this._onDidFocus.fire())},r=()=>{t&&(i=!0,window.setTimeout((()=>{i&&(i=!1,t=!1,this._onDidBlur.fire())}),0))};this._refreshStateHandler=()=>{let i=FocusTracker.hasFocusWithin(e);i!==t&&(t?r():n())},this._register(addDisposableListener(e,EventType.FOCUS,n,!0)),this._register(addDisposableListener(e,EventType.BLUR,r,!0)),this._register(addDisposableListener(e,EventType.FOCUS_IN,(()=>this._refreshStateHandler()))),this._register(addDisposableListener(e,EventType.FOCUS_OUT,(()=>this._refreshStateHandler())))}static hasFocusWithin(e){const t=getShadowRoot(e),i=t?t.activeElement:document.activeElement;return isAncestor(i,e)}}export function trackFocus(e){return new FocusTracker(e)}export function append(e,...t){if(e.append(...t),1===t.length&&"string"!==typeof t[0])return t[0]}export function prepend(e,t){return e.insertBefore(t,e.firstChild),t}export function reset(e,...t){e.innerText="",append(e,...t)}const SELECTOR_REGEX=/([\w\-]+)?(#([\w\-]+))?((\.([\w\-]+))*)/;export var Namespace;function _$(e,t,i,...n){let r=SELECTOR_REGEX.exec(t);if(!r)throw new Error("Bad use of emmet");i=Object.assign({},i||{});let o,s=r[1]||"div";return o=e!==Namespace.HTML?document.createElementNS(e,s):document.createElement(s),r[3]&&(o.id=r[3]),r[4]&&(o.className=r[4].replace(/\./g," ").trim()),Object.keys(i).forEach((e=>{const t=i[e];"undefined"!==typeof t&&(/^on\w+$/.test(e)?o[e]=t:"selected"===e?t&&o.setAttribute(e,"true"):o.setAttribute(e,t))})),o.append(...n),o}(function(e){e["HTML"]="http://www.w3.org/1999/xhtml",e["SVG"]="http://www.w3.org/2000/svg"})(Namespace||(Namespace={}));export function $(e,t,...i){return _$(Namespace.HTML,e,t,...i)}$.SVG=function(e,t,...i){return _$(Namespace.SVG,e,t,...i)};export function show(...e){for(let t of e)t.style.display="",t.removeAttribute("aria-hidden")}export function hide(...e){for(let t of e)t.style.display="none",t.setAttribute("aria-hidden","true")}export function getElementsByTagName(e){return Array.prototype.slice.call(document.getElementsByTagName(e),0)}export function computeScreenAwareSize(e){const t=window.devicePixelRatio*e;return Math.max(1,Math.floor(t))/window.devicePixelRatio}export function windowOpenNoOpener(e){window.open(e,"_blank","noopener")}export function animate(e){const t=()=>{e(),i=scheduleAtNextAnimationFrame(t)};let i=scheduleAtNextAnimationFrame(t);return toDisposable((()=>i.dispose()))}RemoteAuthorities.setPreferredWebSchema(/^https:/.test(window.location.href)?"https":"http");export function asCSSUrl(e){return e?`url('${FileAccess.asBrowserUri(e).toString(!0).replace(/'/g,"%27")}')`:"url('')"}export function asCSSPropertyValue(e){return`'${e.replace(/'/g,"%27")}'`}export class ModifierKeyEmitter extends Emitter{constructor(){super(),this._subscriptions=new DisposableStore,this._keyStatus={altKey:!1,shiftKey:!1,ctrlKey:!1,metaKey:!1},this._subscriptions.add(addDisposableListener(window,"keydown",(e=>{if(e.defaultPrevented)return;const t=new StandardKeyboardEvent(e);if(6!==t.keyCode||!e.repeat){if(e.altKey&&!this._keyStatus.altKey)this._keyStatus.lastKeyPressed="alt";else if(e.ctrlKey&&!this._keyStatus.ctrlKey)this._keyStatus.lastKeyPressed="ctrl";else if(e.metaKey&&!this._keyStatus.metaKey)this._keyStatus.lastKeyPressed="meta";else if(e.shiftKey&&!this._keyStatus.shiftKey)this._keyStatus.lastKeyPressed="shift";else{if(6===t.keyCode)return;this._keyStatus.lastKeyPressed=void 0}this._keyStatus.altKey=e.altKey,this._keyStatus.ctrlKey=e.ctrlKey,this._keyStatus.metaKey=e.metaKey,this._keyStatus.shiftKey=e.shiftKey,this._keyStatus.lastKeyPressed&&(this._keyStatus.event=e,this.fire(this._keyStatus))}}),!0)),this._subscriptions.add(addDisposableListener(window,"keyup",(e=>{e.defaultPrevented||(!e.altKey&&this._keyStatus.altKey?this._keyStatus.lastKeyReleased="alt":!e.ctrlKey&&this._keyStatus.ctrlKey?this._keyStatus.lastKeyReleased="ctrl":!e.metaKey&&this._keyStatus.metaKey?this._keyStatus.lastKeyReleased="meta":!e.shiftKey&&this._keyStatus.shiftKey?this._keyStatus.lastKeyReleased="shift":this._keyStatus.lastKeyReleased=void 0,this._keyStatus.lastKeyPressed!==this._keyStatus.lastKeyReleased&&(this._keyStatus.lastKeyPressed=void 0),this._keyStatus.altKey=e.altKey,this._keyStatus.ctrlKey=e.ctrlKey,this._keyStatus.metaKey=e.metaKey,this._keyStatus.shiftKey=e.shiftKey,this._keyStatus.lastKeyReleased&&(this._keyStatus.event=e,this.fire(this._keyStatus)))}),!0)),this._subscriptions.add(addDisposableListener(document.body,"mousedown",(()=>{this._keyStatus.lastKeyPressed=void 0}),!0)),this._subscriptions.add(addDisposableListener(document.body,"mouseup",(()=>{this._keyStatus.lastKeyPressed=void 0}),!0)),this._subscriptions.add(addDisposableListener(document.body,"mousemove",(e=>{e.buttons&&(this._keyStatus.lastKeyPressed=void 0)}),!0)),this._subscriptions.add(addDisposableListener(window,"blur",(()=>{this.resetKeyStatus()})))}get keyStatus(){return this._keyStatus}resetKeyStatus(){this.doResetKeyStatus(),this.fire(this._keyStatus)}doResetKeyStatus(){this._keyStatus={altKey:!1,shiftKey:!1,ctrlKey:!1,metaKey:!1}}static getInstance(){return ModifierKeyEmitter.instance||(ModifierKeyEmitter.instance=new ModifierKeyEmitter),ModifierKeyEmitter.instance}dispose(){super.dispose(),this._subscriptions.dispose()}}export function addMatchMediaChangeListener(e,t){const i=window.matchMedia(e);i.addEventListener("change",t)}