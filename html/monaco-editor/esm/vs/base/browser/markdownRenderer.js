import*as DOM from"./dom.js";import*as dompurify from"./dompurify/dompurify.js";import{DomEmitter}from"./event.js";import{createElement}from"./formattedTextRenderer.js";import{StandardMouseEvent}from"./mouseEvent.js";import{renderLabelWithIcons}from"./ui/iconLabel/iconLabels.js";import{raceCancellation}from"../common/async.js";import{CancellationTokenSource}from"../common/cancellation.js";import{onUnexpectedError}from"../common/errors.js";import{Event}from"../common/event.js";import{parseHrefAndDimensions,removeMarkdownEscapes}from"../common/htmlContent.js";import{markdownEscapeEscapedIcons}from"../common/iconLabels.js";import{defaultGenerator}from"../common/idGenerator.js";import{DisposableStore}from"../common/lifecycle.js";import{marked}from"../common/marked/marked.js";import{parse}from"../common/marshalling.js";import{FileAccess,Schemas}from"../common/network.js";import{cloneAndChange}from"../common/objects.js";import{resolvePath}from"../common/resources.js";import{escape}from"../common/strings.js";import{URI}from"../common/uri.js";export function renderMarkdown(e,t={},r={}){var o;const a=new DisposableStore;let n=!1;const s=a.add(new CancellationTokenSource),i=createElement(t),c=function(t){let r;try{r=parse(decodeURIComponent(t))}catch(o){}return r?(r=cloneAndChange(r,(t=>e.uris&&e.uris[t]?URI.revive(e.uris[t]):void 0)),encodeURIComponent(JSON.stringify(r))):t},m=function(t,r){const o=e.uris&&e.uris[t];let a=URI.revive(o);return r?t.startsWith(Schemas.data+":")?t:(a||(a=URI.parse(t)),FileAccess.asBrowserUri(a).toString(!0)):a?URI.parse(t).toString()===a.toString()?t:(a.query&&(a=a.with({query:c(a.query)})),a.toString()):t};let d;const l=new Promise((e=>d=e)),p=new marked.Renderer;if(p.image=(e,t,r)=>{let o=[],a=[];return e&&(({href:e,dimensions:o}=parseHrefAndDimensions(e)),a.push(`src="${e}"`)),r&&a.push(`alt="${r}"`),t&&a.push(`title="${t}"`),o.length&&(a=a.concat(o)),"<img "+a.join(" ")+">"},p.link=(r,o,a)=>{if("string"!==typeof r)return"";if(r===a&&(a=removeMarkdownEscapes(a)),r=m(r,!1),t.baseUrl){const e=/^\w[\w\d+.-]*:/.test(r);e||(r=resolvePath(t.baseUrl,r).toString())}return o="string"===typeof o?removeMarkdownEscapes(o):"",r=removeMarkdownEscapes(r),!r||r.match(/^data:|javascript:/i)||r.match(/^command:/i)&&!e.isTrusted||r.match(/^command:(\/\/\/)?_workbench\.downloadResource/i)?a:(r=r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),`<a data-href="${r}" title="${o||r}">${a}</a>`)},p.paragraph=e=>`<p>${e}</p>`,t.codeBlockRenderer&&(p.code=(e,r)=>{if("string"!==typeof r)return"";const o=t.codeBlockRenderer(r,e),a=defaultGenerator.nextId();return raceCancellation(Promise.all([o,l]),s.token).then((e=>{var r;if(!n&&e){const o=i.querySelector(`div[data-code="${a}"]`);o&&DOM.reset(o,e[0]),null===(r=t.asyncRenderCallback)||void 0===r||r.call(t)}})).catch((()=>{})),`<div class="code" data-code="${a}">${escape(e)}</div>`}),t.actionHandler){const e=t.actionHandler.disposables.add(new DomEmitter(i,"click")),r=t.actionHandler.disposables.add(new DomEmitter(i,"auxclick"));t.actionHandler.disposables.add(Event.any(e.event,r.event)((e=>{const r=new StandardMouseEvent(e);if(!r.leftButton&&!r.middleButton)return;let o=r.target;if("A"===o.tagName||(o=o.parentElement,o&&"A"===o.tagName))try{const e=o.dataset["href"];e&&t.actionHandler.callback(e,r)}catch(a){onUnexpectedError(a)}finally{r.preventDefault()}})))}e.supportHtml||(r.sanitizer=t=>{const r=e.isTrusted?t.match(/^(<span[^>]+>)|(<\/\s*span>)$/):void 0;return r?t:""},r.sanitize=!0,r.silent=!0),r.renderer=p;let u=null!==(o=e.value)&&void 0!==o?o:"";u.length>1e5&&(u=`${u.substr(0,1e5)}\u2026`),e.supportThemeIcons&&(u=markdownEscapeEscapedIcons(u));let f=marked.parse(u,r);if(e.supportThemeIcons){const e=renderLabelWithIcons(f);f=e.map((e=>"string"===typeof e?e:e.outerHTML)).join("")}const h=new DOMParser,g=h.parseFromString(sanitizeRenderedMarkdown(e,f),"text/html");if(g.body.querySelectorAll("img").forEach((e=>{if(e.src){let o=m(e.src,!0);try{const e=URI.parse(o);t.baseUrl&&e.scheme===Schemas.file&&(o=resolvePath(t.baseUrl,o).toString())}catch(r){}e.src=o}})),i.innerHTML=sanitizeRenderedMarkdown(e,g.body.innerHTML),d(),t.asyncRenderCallback)for(const v of i.getElementsByTagName("img")){const e=a.add(DOM.addDisposableListener(v,"load",(()=>{e.dispose(),t.asyncRenderCallback()})))}return{element:i,dispose:()=>{n=!0,s.cancel(),a.dispose()}}}function sanitizeRenderedMarkdown(e,t){const{config:r,allowedSchemes:o}=getSanitizerOptions(e);dompurify.addHook("uponSanitizeAttribute",((e,t)=>{if("style"!==t.attrName&&"class"!==t.attrName);else{if("SPAN"===e.tagName){if("style"===t.attrName)return void(t.keepAttr=/^(color\:#[0-9a-fA-F]+;)?(background-color\:#[0-9a-fA-F]+;)?$/.test(t.attrValue));if("class"===t.attrName)return void(t.keepAttr=/^codicon codicon-[a-z\-]+( codicon-modifier-[a-z\-]+)?$/.test(t.attrValue))}t.keepAttr=!1}}));const a=document.createElement("a");dompurify.addHook("afterSanitizeAttributes",(e=>{for(const t of["href","src"])e.hasAttribute(t)&&(a.href=e.getAttribute(t),o.includes(a.protocol.replace(/:$/,""))||e.removeAttribute(t))}));try{return dompurify.sanitize(t,Object.assign(Object.assign({},r),{RETURN_TRUSTED_TYPE:!0}))}finally{dompurify.removeHook("uponSanitizeAttribute"),dompurify.removeHook("afterSanitizeAttributes")}}function getSanitizerOptions(e){const t=[Schemas.http,Schemas.https,Schemas.mailto,Schemas.data,Schemas.file,Schemas.vscodeFileResource,Schemas.vscodeRemote,Schemas.vscodeRemoteResource];return e.isTrusted&&t.push(Schemas.command),{config:{ALLOWED_TAGS:["ul","li","p","b","i","code","blockquote","ol","h1","h2","h3","h4","h5","h6","hr","em","pre","table","thead","tbody","tr","th","td","div","del","a","strong","br","img","span"],ALLOWED_ATTR:["href","data-href","target","title","src","alt","class","style","data-code","width","height","align"],ALLOW_UNKNOWN_PROTOCOLS:!0},allowedSchemes:t}}