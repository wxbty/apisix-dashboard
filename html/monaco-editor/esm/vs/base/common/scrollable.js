import{Emitter}from"./event.js";import{Disposable}from"./lifecycle.js";export class ScrollState{constructor(t,o,i,s,l,r,e){this._forceIntegerValues=t,this._scrollStateBrand=void 0,this._forceIntegerValues&&(o|=0,i|=0,s|=0,l|=0,r|=0,e|=0),this.rawScrollLeft=s,this.rawScrollTop=e,o<0&&(o=0),s+o>i&&(s=i-o),s<0&&(s=0),l<0&&(l=0),e+l>r&&(e=r-l),e<0&&(e=0),this.width=o,this.scrollWidth=i,this.scrollLeft=s,this.height=l,this.scrollHeight=r,this.scrollTop=e}equals(t){return this.rawScrollLeft===t.rawScrollLeft&&this.rawScrollTop===t.rawScrollTop&&this.width===t.width&&this.scrollWidth===t.scrollWidth&&this.scrollLeft===t.scrollLeft&&this.height===t.height&&this.scrollHeight===t.scrollHeight&&this.scrollTop===t.scrollTop}withScrollDimensions(t,o){return new ScrollState(this._forceIntegerValues,"undefined"!==typeof t.width?t.width:this.width,"undefined"!==typeof t.scrollWidth?t.scrollWidth:this.scrollWidth,o?this.rawScrollLeft:this.scrollLeft,"undefined"!==typeof t.height?t.height:this.height,"undefined"!==typeof t.scrollHeight?t.scrollHeight:this.scrollHeight,o?this.rawScrollTop:this.scrollTop)}withScrollPosition(t){return new ScrollState(this._forceIntegerValues,this.width,this.scrollWidth,"undefined"!==typeof t.scrollLeft?t.scrollLeft:this.rawScrollLeft,this.height,this.scrollHeight,"undefined"!==typeof t.scrollTop?t.scrollTop:this.rawScrollTop)}createScrollEvent(t,o){const i=this.width!==t.width,s=this.scrollWidth!==t.scrollWidth,l=this.scrollLeft!==t.scrollLeft,r=this.height!==t.height,e=this.scrollHeight!==t.scrollHeight,h=this.scrollTop!==t.scrollTop;return{inSmoothScrolling:o,oldWidth:t.width,oldScrollWidth:t.scrollWidth,oldScrollLeft:t.scrollLeft,width:this.width,scrollWidth:this.scrollWidth,scrollLeft:this.scrollLeft,oldHeight:t.height,oldScrollHeight:t.scrollHeight,oldScrollTop:t.scrollTop,height:this.height,scrollHeight:this.scrollHeight,scrollTop:this.scrollTop,widthChanged:i,scrollWidthChanged:s,scrollLeftChanged:l,heightChanged:r,scrollHeightChanged:e,scrollTopChanged:h}}}export class Scrollable extends Disposable{constructor(t){super(),this._scrollableBrand=void 0,this._onScroll=this._register(new Emitter),this.onScroll=this._onScroll.event,this._smoothScrollDuration=t.smoothScrollDuration,this._scheduleAtNextAnimationFrame=t.scheduleAtNextAnimationFrame,this._state=new ScrollState(t.forceIntegerValues,0,0,0,0,0,0),this._smoothScrolling=null}dispose(){this._smoothScrolling&&(this._smoothScrolling.dispose(),this._smoothScrolling=null),super.dispose()}setSmoothScrollDuration(t){this._smoothScrollDuration=t}validateScrollPosition(t){return this._state.withScrollPosition(t)}getScrollDimensions(){return this._state}setScrollDimensions(t,o){const i=this._state.withScrollDimensions(t,o);this._setState(i,Boolean(this._smoothScrolling)),this._smoothScrolling&&this._smoothScrolling.acceptScrollDimensions(this._state)}getFutureScrollPosition(){return this._smoothScrolling?this._smoothScrolling.to:this._state}getCurrentScrollPosition(){return this._state}setScrollPositionNow(t){const o=this._state.withScrollPosition(t);this._smoothScrolling&&(this._smoothScrolling.dispose(),this._smoothScrolling=null),this._setState(o,!1)}setScrollPositionSmooth(t,o){if(0===this._smoothScrollDuration)return this.setScrollPositionNow(t);if(this._smoothScrolling){t={scrollLeft:"undefined"===typeof t.scrollLeft?this._smoothScrolling.to.scrollLeft:t.scrollLeft,scrollTop:"undefined"===typeof t.scrollTop?this._smoothScrolling.to.scrollTop:t.scrollTop};const i=this._state.withScrollPosition(t);if(this._smoothScrolling.to.scrollLeft===i.scrollLeft&&this._smoothScrolling.to.scrollTop===i.scrollTop)return;let s;s=o?new SmoothScrollingOperation(this._smoothScrolling.from,i,this._smoothScrolling.startTime,this._smoothScrolling.duration):this._smoothScrolling.combine(this._state,i,this._smoothScrollDuration),this._smoothScrolling.dispose(),this._smoothScrolling=s}else{const o=this._state.withScrollPosition(t);this._smoothScrolling=SmoothScrollingOperation.start(this._state,o,this._smoothScrollDuration)}this._smoothScrolling.animationFrameDisposable=this._scheduleAtNextAnimationFrame((()=>{this._smoothScrolling&&(this._smoothScrolling.animationFrameDisposable=null,this._performSmoothScrolling())}))}_performSmoothScrolling(){if(!this._smoothScrolling)return;const t=this._smoothScrolling.tick(),o=this._state.withScrollPosition(t);return this._setState(o,!0),this._smoothScrolling?t.isDone?(this._smoothScrolling.dispose(),void(this._smoothScrolling=null)):void(this._smoothScrolling.animationFrameDisposable=this._scheduleAtNextAnimationFrame((()=>{this._smoothScrolling&&(this._smoothScrolling.animationFrameDisposable=null,this._performSmoothScrolling())}))):void 0}_setState(t,o){const i=this._state;i.equals(t)||(this._state=t,this._onScroll.fire(this._state.createScrollEvent(i,o)))}}export class SmoothScrollingUpdate{constructor(t,o,i){this.scrollLeft=t,this.scrollTop=o,this.isDone=i}}function createEaseOutCubic(t,o){const i=o-t;return function(o){return t+i*easeOutCubic(o)}}function createComposed(t,o,i){return function(s){return s<i?t(s/i):o((s-i)/(1-i))}}export class SmoothScrollingOperation{constructor(t,o,i,s){this.from=t,this.to=o,this.duration=s,this.startTime=i,this.animationFrameDisposable=null,this._initAnimations()}_initAnimations(){this.scrollLeft=this._initAnimation(this.from.scrollLeft,this.to.scrollLeft,this.to.width),this.scrollTop=this._initAnimation(this.from.scrollTop,this.to.scrollTop,this.to.height)}_initAnimation(t,o,i){const s=Math.abs(t-o);if(s>2.5*i){let s,l;return t<o?(s=t+.75*i,l=o-.75*i):(s=t-.75*i,l=o+.75*i),createComposed(createEaseOutCubic(t,s),createEaseOutCubic(l,o),.33)}return createEaseOutCubic(t,o)}dispose(){null!==this.animationFrameDisposable&&(this.animationFrameDisposable.dispose(),this.animationFrameDisposable=null)}acceptScrollDimensions(t){this.to=t.withScrollPosition(this.to),this._initAnimations()}tick(){return this._tick(Date.now())}_tick(t){const o=(t-this.startTime)/this.duration;if(o<1){const t=this.scrollLeft(o),i=this.scrollTop(o);return new SmoothScrollingUpdate(t,i,!1)}return new SmoothScrollingUpdate(this.to.scrollLeft,this.to.scrollTop,!0)}combine(t,o,i){return SmoothScrollingOperation.start(t,o,i)}static start(t,o,i){i+=10;const s=Date.now()-10;return new SmoothScrollingOperation(t,o,s,i)}}function easeInCubic(t){return Math.pow(t,3)}function easeOutCubic(t){return 1-easeInCubic(1-t)}