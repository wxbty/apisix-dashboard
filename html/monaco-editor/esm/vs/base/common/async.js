var __awaiter=this&&this.__awaiter||function(e,t,i,r){function n(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,s){function o(e){try{a(r.next(e))}catch(t){s(t)}}function l(e){try{a(r["throw"](e))}catch(t){s(t)}}function a(e){e.done?i(e.value):n(e.value).then(o,l)}a((r=r.apply(e,t||[])).next())}))},__asyncValues=this&&this.__asyncValues||function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,i=e[Symbol.asyncIterator];return i?i.call(e):(e="function"===typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(i){t[i]=e[i]&&function(t){return new Promise((function(r,s){t=e[i](t),n(r,s,t.done,t.value)}))}}function n(e,t,i,r){Promise.resolve(r).then((function(t){e({value:t,done:i})}),t)}};import{CancellationTokenSource}from"./cancellation.js";import{CancellationError}from"./errors.js";import{Emitter,Event}from"./event.js";import{toDisposable}from"./lifecycle.js";import{setTimeout0}from"./platform.js";export function isThenable(e){return!!e&&"function"===typeof e.then}export function createCancelablePromise(e){const t=new CancellationTokenSource,i=e(t.token),r=new Promise(((e,r)=>{const n=t.token.onCancellationRequested((()=>{n.dispose(),t.dispose(),r(new CancellationError)}));Promise.resolve(i).then((i=>{n.dispose(),t.dispose(),e(i)}),(e=>{n.dispose(),t.dispose(),r(e)}))}));return new class{cancel(){t.cancel()}then(e,t){return r.then(e,t)}catch(e){return this.then(void 0,e)}finally(e){return r.finally(e)}}}export function raceCancellation(e,t,i){return new Promise(((r,n)=>{const s=t.onCancellationRequested((()=>{s.dispose(),r(i)}));e.then(r,n).finally((()=>s.dispose()))}))}export class Throttler{constructor(){this.activePromise=null,this.queuedPromise=null,this.queuedPromiseFactory=null}queue(e){if(this.activePromise){if(this.queuedPromiseFactory=e,!this.queuedPromise){const e=()=>{this.queuedPromise=null;const e=this.queue(this.queuedPromiseFactory);return this.queuedPromiseFactory=null,e};this.queuedPromise=new Promise((t=>{this.activePromise.then(e,e).then(t)}))}return new Promise(((e,t)=>{this.queuedPromise.then(e,t)}))}return this.activePromise=e(),new Promise(((e,t)=>{this.activePromise.then((t=>{this.activePromise=null,e(t)}),(e=>{this.activePromise=null,t(e)}))}))}}const timeoutDeferred=(e,t)=>{let i=!0;const r=setTimeout((()=>{i=!1,t()}),e);return{isTriggered:()=>i,dispose:()=>{clearTimeout(r),i=!1}}},microtaskDeferred=e=>{let t=!0;return queueMicrotask((()=>{t&&(t=!1,e())})),{isTriggered:()=>t,dispose:()=>{t=!1}}};export const MicrotaskDelay=Symbol("MicrotaskDelay");export class Delayer{constructor(e){this.defaultDelay=e,this.deferred=null,this.completionPromise=null,this.doResolve=null,this.doReject=null,this.task=null}trigger(e,t=this.defaultDelay){this.task=e,this.cancelTimeout(),this.completionPromise||(this.completionPromise=new Promise(((e,t)=>{this.doResolve=e,this.doReject=t})).then((()=>{if(this.completionPromise=null,this.doResolve=null,this.task){const e=this.task;return this.task=null,e()}})));const i=()=>{var e;this.deferred=null,null===(e=this.doResolve)||void 0===e||e.call(this,null)};return this.deferred=t===MicrotaskDelay?microtaskDeferred(i):timeoutDeferred(t,i),this.completionPromise}isTriggered(){var e;return!!(null===(e=this.deferred)||void 0===e?void 0:e.isTriggered())}cancel(){this.cancelTimeout(),this.completionPromise&&(this.doReject&&this.doReject(new CancellationError),this.completionPromise=null)}cancelTimeout(){var e;null===(e=this.deferred)||void 0===e||e.dispose(),this.deferred=null}dispose(){this.cancel()}}export class ThrottledDelayer{constructor(e){this.delayer=new Delayer(e),this.throttler=new Throttler}trigger(e,t){return this.delayer.trigger((()=>this.throttler.queue(e)),t)}dispose(){this.delayer.dispose()}}export function timeout(e,t){return t?new Promise(((i,r)=>{const n=setTimeout((()=>{s.dispose(),i()}),e),s=t.onCancellationRequested((()=>{clearTimeout(n),s.dispose(),r(new CancellationError)}))})):createCancelablePromise((t=>timeout(e,t)))}export function disposableTimeout(e,t=0){const i=setTimeout(e,t);return toDisposable((()=>clearTimeout(i)))}export function first(e,t=(e=>!!e),i=null){let r=0;const n=e.length,s=()=>{if(r>=n)return Promise.resolve(i);const o=e[r++],l=Promise.resolve(o());return l.then((e=>t(e)?Promise.resolve(e):s()))};return s()}export class TimeoutTimer{constructor(e,t){this._token=-1,"function"===typeof e&&"number"===typeof t&&this.setIfNotSet(e,t)}dispose(){this.cancel()}cancel(){-1!==this._token&&(clearTimeout(this._token),this._token=-1)}cancelAndSet(e,t){this.cancel(),this._token=setTimeout((()=>{this._token=-1,e()}),t)}setIfNotSet(e,t){-1===this._token&&(this._token=setTimeout((()=>{this._token=-1,e()}),t))}}export class IntervalTimer{constructor(){this._token=-1}dispose(){this.cancel()}cancel(){-1!==this._token&&(clearInterval(this._token),this._token=-1)}cancelAndSet(e,t){this.cancel(),this._token=setInterval((()=>{e()}),t)}}export class RunOnceScheduler{constructor(e,t){this.timeoutToken=-1,this.runner=e,this.timeout=t,this.timeoutHandler=this.onTimeout.bind(this)}dispose(){this.cancel(),this.runner=null}cancel(){this.isScheduled()&&(clearTimeout(this.timeoutToken),this.timeoutToken=-1)}schedule(e=this.timeout){this.cancel(),this.timeoutToken=setTimeout(this.timeoutHandler,e)}get delay(){return this.timeout}set delay(e){this.timeout=e}isScheduled(){return-1!==this.timeoutToken}onTimeout(){this.timeoutToken=-1,this.runner&&this.doRun()}doRun(){this.runner&&this.runner()}}export let runWhenIdle;(function(){runWhenIdle="function"!==typeof requestIdleCallback||"function"!==typeof cancelIdleCallback?e=>{setTimeout0((()=>{if(t)return;const i=Date.now()+15;e(Object.freeze({didTimeout:!0,timeRemaining(){return Math.max(0,i-Date.now())}}))}));let t=!1;return{dispose(){t||(t=!0)}}}:(e,t)=>{const i=requestIdleCallback(e,"number"===typeof t?{timeout:t}:void 0);let r=!1;return{dispose(){r||(r=!0,cancelIdleCallback(i))}}}})();export class IdleValue{constructor(e){this._didRun=!1,this._executor=()=>{try{this._value=e()}catch(t){this._error=t}finally{this._didRun=!0}},this._handle=runWhenIdle((()=>this._executor()))}dispose(){this._handle.dispose()}get value(){if(this._didRun||(this._handle.dispose(),this._executor()),this._error)throw this._error;return this._value}get isInitialized(){return this._didRun}}export class DeferredPromise{constructor(){this.rejected=!1,this.resolved=!1,this.p=new Promise(((e,t)=>{this.completeCallback=e,this.errorCallback=t}))}get isRejected(){return this.rejected}get isSettled(){return this.rejected||this.resolved}complete(e){return new Promise((t=>{this.completeCallback(e),this.resolved=!0,t()}))}cancel(){new Promise((e=>{this.errorCallback(new CancellationError),this.rejected=!0,e()}))}}export var Promises;(function(e){function t(e){return __awaiter(this,void 0,void 0,(function*(){let t;const i=yield Promise.all(e.map((e=>e.then((e=>e),(e=>{t||(t=e)})))));if("undefined"!==typeof t)throw t;return i}))}function i(e){return new Promise(((t,i)=>__awaiter(this,void 0,void 0,(function*(){try{yield e(t,i)}catch(r){i(r)}}))))}e.settled=t,e.withAsyncBody=i})(Promises||(Promises={}));export class AsyncIterableObject{constructor(e){this._state=0,this._results=[],this._error=null,this._onStateChanged=new Emitter,queueMicrotask((()=>__awaiter(this,void 0,void 0,(function*(){const t={emitOne:e=>this.emitOne(e),emitMany:e=>this.emitMany(e),reject:e=>this.reject(e)};try{yield Promise.resolve(e(t)),this.resolve()}catch(i){this.reject(i)}finally{t.emitOne=void 0,t.emitMany=void 0,t.reject=void 0}}))))}static fromArray(e){return new AsyncIterableObject((t=>{t.emitMany(e)}))}static fromPromise(e){return new AsyncIterableObject((t=>__awaiter(this,void 0,void 0,(function*(){t.emitMany(yield e)}))))}static fromPromises(e){return new AsyncIterableObject((t=>__awaiter(this,void 0,void 0,(function*(){yield Promise.all(e.map((e=>__awaiter(this,void 0,void 0,(function*(){return t.emitOne(yield e)})))))}))))}static merge(e){return new AsyncIterableObject((t=>__awaiter(this,void 0,void 0,(function*(){yield Promise.all(e.map((e=>{var i,r;return __awaiter(this,void 0,void 0,(function*(){var n,s;try{for(i=__asyncValues(e);r=yield i.next(),!r.done;){const e=r.value;t.emitOne(e)}}catch(o){n={error:o}}finally{try{r&&!r.done&&(s=i.return)&&(yield s.call(i))}finally{if(n)throw n.error}}}))})))}))))}[Symbol.asyncIterator](){let e=0;return{next:()=>__awaiter(this,void 0,void 0,(function*(){do{if(2===this._state)throw this._error;if(e<this._results.length)return{done:!1,value:this._results[e++]};if(1===this._state)return{done:!0,value:void 0};yield Event.toPromise(this._onStateChanged.event)}while(1)}))}}static map(e,t){return new AsyncIterableObject((i=>__awaiter(this,void 0,void 0,(function*(){var r,n;try{for(var s,o=__asyncValues(e);s=yield o.next(),!s.done;){const e=s.value;i.emitOne(t(e))}}catch(l){r={error:l}}finally{try{s&&!s.done&&(n=o.return)&&(yield n.call(o))}finally{if(r)throw r.error}}}))))}map(e){return AsyncIterableObject.map(this,e)}static filter(e,t){return new AsyncIterableObject((i=>__awaiter(this,void 0,void 0,(function*(){var r,n;try{for(var s,o=__asyncValues(e);s=yield o.next(),!s.done;){const e=s.value;t(e)&&i.emitOne(e)}}catch(l){r={error:l}}finally{try{s&&!s.done&&(n=o.return)&&(yield n.call(o))}finally{if(r)throw r.error}}}))))}filter(e){return AsyncIterableObject.filter(this,e)}static coalesce(e){return AsyncIterableObject.filter(e,(e=>!!e))}coalesce(){return AsyncIterableObject.coalesce(this)}static toPromise(e){var t,i,r,n;return __awaiter(this,void 0,void 0,(function*(){const s=[];try{for(t=__asyncValues(e);i=yield t.next(),!i.done;){const e=i.value;s.push(e)}}catch(o){r={error:o}}finally{try{i&&!i.done&&(n=t.return)&&(yield n.call(t))}finally{if(r)throw r.error}}return s}))}toPromise(){return AsyncIterableObject.toPromise(this)}emitOne(e){0===this._state&&(this._results.push(e),this._onStateChanged.fire())}emitMany(e){0===this._state&&(this._results=this._results.concat(e),this._onStateChanged.fire())}resolve(){0===this._state&&(this._state=1,this._onStateChanged.fire())}reject(e){0===this._state&&(this._state=2,this._error=e,this._onStateChanged.fire())}}AsyncIterableObject.EMPTY=AsyncIterableObject.fromArray([]);export class CancelableAsyncIterableObject extends AsyncIterableObject{constructor(e,t){super(t),this._source=e}cancel(){this._source.cancel()}}export function createCancelableAsyncIterable(e){const t=new CancellationTokenSource,i=e(t.token);return new CancelableAsyncIterableObject(t,(e=>__awaiter(this,void 0,void 0,(function*(){var r,n;const s=t.token.onCancellationRequested((()=>{s.dispose(),t.dispose(),e.reject(new CancellationError)}));try{try{for(var o,l=__asyncValues(i);o=yield l.next(),!o.done;){const i=o.value;if(t.token.isCancellationRequested)return;e.emitOne(i)}}catch(a){r={error:a}}finally{try{o&&!o.done&&(n=l.return)&&(yield n.call(l))}finally{if(r)throw r.error}}s.dispose(),t.dispose()}catch(c){s.dispose(),t.dispose(),e.reject(c)}}))))}