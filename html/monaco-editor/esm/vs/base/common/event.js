import{onUnexpectedError}from"./errors.js";import{combinedDisposable,Disposable,DisposableStore,toDisposable}from"./lifecycle.js";import{LinkedList}from"./linkedList.js";import{StopWatch}from"./stopwatch.js";export var Event;(function(e){function t(e){return(t,s=null,i)=>{let n,o=!1;return n=e((e=>{if(!o)return n?n.dispose():o=!0,t.call(s,e)}),null,i),o&&n.dispose(),n}}function s(e,t){return h(((s,i=null,n)=>e((e=>s.call(i,t(e))),null,n)))}function i(e,t){return h(((s,i=null,n)=>e((e=>{t(e),s.call(i,e)}),null,n)))}function n(e,t){return h(((s,i=null,n)=>e((e=>t(e)&&s.call(i,e)),null,n)))}function o(e){return e}function r(...e){return(t,s=null,i)=>combinedDisposable(...e.map((e=>e((e=>t.call(s,e)),null,i))))}function l(e,t,i){let n=i;return s(e,(e=>(n=t(n,e),n)))}function h(e){let t;const s=new Emitter({onFirstListenerAdd(){t=e(s.fire,s)},onLastListenerRemove(){t.dispose()}});return s.event}function u(e,t,s,i=100,n=!1){let o,r,l=0;return e((e=>{l++,o=s(o,e),n&&!r&&(t(o),o=void 0),clearTimeout(r),r=setTimeout((()=>{const e=o;o=void 0,r=void 0,(!n||l>1)&&t(e),l=0}),i)}))}function a(e,t,s=100,i=!1,n){let o,r,l,h=0;const u=new Emitter({leakWarningThreshold:n,onFirstListenerAdd(){o=e((e=>{h++,r=t(r,e),i&&!l&&(u.fire(r),r=void 0),clearTimeout(l),l=setTimeout((()=>{const e=r;r=void 0,l=void 0,(!i||h>1)&&u.fire(e),h=0}),s)}))},onLastListenerRemove(){o.dispose()}});return u.event}function d(e,t=((e,t)=>e===t)){let s,i=!0;return n(e,(e=>{const n=i||!t(e,s);return i=!1,s=e,n}))}function c(t,s){return[e.filter(t,s),e.filter(t,(e=>!s(e)))]}function p(e,t=!1,s=[]){let i=s.slice(),n=e((e=>{i?i.push(e):r.fire(e)}));const o=()=>{i&&i.forEach((e=>r.fire(e))),i=null},r=new Emitter({onFirstListenerAdd(){n||(n=e((e=>r.fire(e))))},onFirstListenerDidAdd(){i&&(t?setTimeout(o):o())},onLastListenerRemove(){n&&n.dispose(),n=null}});return r.event}e.None=()=>Disposable.None,e.once=t,e.map=s,e.forEach=i,e.filter=n,e.signal=o,e.any=r,e.reduce=l,e.debouncedListener=u,e.debounce=a,e.latch=d,e.split=c,e.buffer=p;class v{constructor(e){this.event=e}map(e){return new v(s(this.event,e))}forEach(e){return new v(i(this.event,e))}filter(e){return new v(n(this.event,e))}reduce(e,t){return new v(l(this.event,e,t))}latch(){return new v(d(this.event))}debounce(e,t=100,s=!1,i){return new v(a(this.event,e,t,s,i))}on(e,t,s){return this.event(e,t,s)}once(e,s,i){return t(this.event)(e,s,i)}}function _(e){return new v(e)}function f(e,t,s=(e=>e)){const i=(...e)=>r.fire(s(...e)),n=()=>e.on(t,i),o=()=>e.removeListener(t,i),r=new Emitter({onFirstListenerAdd:n,onLastListenerRemove:o});return r.event}function m(e,t,s=(e=>e)){const i=(...e)=>r.fire(s(...e)),n=()=>e.addEventListener(t,i),o=()=>e.removeEventListener(t,i),r=new Emitter({onFirstListenerAdd:n,onLastListenerRemove:o});return r.event}function L(e){return new Promise((s=>t(e)(s)))}function E(e,t){return t(void 0),e((e=>t(e)))}function w(e,t){let s=null;function i(e){null===s||void 0===s||s.dispose(),s=new DisposableStore,t(e,s)}i(void 0);const n=e((e=>i(e)));return toDisposable((()=>{n.dispose(),null===s||void 0===s||s.dispose()}))}e.chain=_,e.fromNodeEventEmitter=f,e.fromDOMEventEmitter=m,e.toPromise=L,e.runAndSubscribe=E,e.runAndSubscribeWithStore=w})(Event||(Event={}));class EventProfiling{constructor(e){this._listenerCount=0,this._invocationCount=0,this._elapsedOverall=0,this._name=`${e}_${EventProfiling._idPool++}`}start(e){this._stopWatch=new StopWatch(!0),this._listenerCount=e}stop(){if(this._stopWatch){const e=this._stopWatch.elapsed();this._elapsedOverall+=e,this._invocationCount+=1,console.info(`did FIRE ${this._name}: elapsed_ms: ${e.toFixed(5)}, listener: ${this._listenerCount} (elapsed_overall: ${this._elapsedOverall.toFixed(2)}, invocations: ${this._invocationCount})`),this._stopWatch=void 0}}}EventProfiling._idPool=0;let _globalLeakWarningThreshold=-1;class LeakageMonitor{constructor(e,t=Math.random().toString(18).slice(2,5)){this.customThreshold=e,this.name=t,this._warnCountdown=0}dispose(){this._stacks&&this._stacks.clear()}check(e){let t=_globalLeakWarningThreshold;if("number"===typeof this.customThreshold&&(t=this.customThreshold),t<=0||e<t)return;this._stacks||(this._stacks=new Map);const s=(new Error).stack.split("\n").slice(3).join("\n"),i=this._stacks.get(s)||0;if(this._stacks.set(s,i+1),this._warnCountdown-=1,this._warnCountdown<=0){let s;this._warnCountdown=.5*t;let i=0;for(const[e,t]of this._stacks)(!s||i<t)&&(s=e,i=t);console.warn(`[${this.name}] potential listener LEAK detected, having ${e} listeners already. MOST frequent listener (${i}):`),console.warn(s)}return()=>{const e=this._stacks.get(s)||0;this._stacks.set(s,e-1)}}}export class Emitter{constructor(e){var t;this._disposed=!1,this._options=e,this._leakageMon=_globalLeakWarningThreshold>0?new LeakageMonitor(this._options&&this._options.leakWarningThreshold):void 0,this._perfMon=(null===(t=this._options)||void 0===t?void 0:t._profName)?new EventProfiling(this._options._profName):void 0}get event(){return this._event||(this._event=(e,t,s)=>{var i;this._listeners||(this._listeners=new LinkedList);const n=this._listeners.isEmpty();n&&this._options&&this._options.onFirstListenerAdd&&this._options.onFirstListenerAdd(this);const o=this._listeners.push(t?[e,t]:e);n&&this._options&&this._options.onFirstListenerDidAdd&&this._options.onFirstListenerDidAdd(this),this._options&&this._options.onListenerDidAdd&&this._options.onListenerDidAdd(this,e,t);const r=null===(i=this._leakageMon)||void 0===i?void 0:i.check(this._listeners.size),l=toDisposable((()=>{if(r&&r(),!this._disposed&&(o(),this._options&&this._options.onLastListenerRemove)){const e=this._listeners&&!this._listeners.isEmpty();e||this._options.onLastListenerRemove(this)}}));return s instanceof DisposableStore?s.add(l):Array.isArray(s)&&s.push(l),l}),this._event}fire(e){var t,s;if(this._listeners){this._deliveryQueue||(this._deliveryQueue=new LinkedList);for(let t of this._listeners)this._deliveryQueue.push([t,e]);null===(t=this._perfMon)||void 0===t||t.start(this._deliveryQueue.size);while(this._deliveryQueue.size>0){const[e,t]=this._deliveryQueue.shift();try{"function"===typeof e?e.call(void 0,t):e[0].call(e[1],t)}catch(i){onUnexpectedError(i)}}null===(s=this._perfMon)||void 0===s||s.stop()}}dispose(){var e,t,s,i,n;this._disposed||(this._disposed=!0,null===(e=this._listeners)||void 0===e||e.clear(),null===(t=this._deliveryQueue)||void 0===t||t.clear(),null===(i=null===(s=this._options)||void 0===s?void 0:s.onLastListenerRemove)||void 0===i||i.call(s),null===(n=this._leakageMon)||void 0===n||n.dispose())}}export class PauseableEmitter extends Emitter{constructor(e){super(e),this._isPaused=0,this._eventQueue=new LinkedList,this._mergeFn=null===e||void 0===e?void 0:e.merge}pause(){this._isPaused++}resume(){if(0!==this._isPaused&&0===--this._isPaused)if(this._mergeFn){const e=Array.from(this._eventQueue);this._eventQueue.clear(),super.fire(this._mergeFn(e))}else while(!this._isPaused&&0!==this._eventQueue.size)super.fire(this._eventQueue.shift())}fire(e){this._listeners&&(0!==this._isPaused?this._eventQueue.push(e):super.fire(e))}}export class DebounceEmitter extends PauseableEmitter{constructor(e){var t;super(e),this._delay=null!==(t=e.delay)&&void 0!==t?t:100}fire(e){this._handle||(this.pause(),this._handle=setTimeout((()=>{this._handle=void 0,this.resume()}),this._delay)),super.fire(e)}}export class EventBufferer{constructor(){this.buffers=[]}wrapEvent(e){return(t,s,i)=>e((e=>{const i=this.buffers[this.buffers.length-1];i?i.push((()=>t.call(s,e))):t.call(s,e)}),void 0,i)}bufferEvents(e){const t=[];this.buffers.push(t);const s=e();return this.buffers.pop(),t.forEach((e=>e())),s}}export class Relay{constructor(){this.listening=!1,this.inputEvent=Event.None,this.inputEventListener=Disposable.None,this.emitter=new Emitter({onFirstListenerDidAdd:()=>{this.listening=!0,this.inputEventListener=this.inputEvent(this.emitter.fire,this.emitter)},onLastListenerRemove:()=>{this.listening=!1,this.inputEventListener.dispose()}}),this.event=this.emitter.event}set input(e){this.inputEvent=e,this.listening&&(this.inputEventListener.dispose(),this.inputEventListener=e(this.emitter.fire,this.emitter))}dispose(){this.inputEventListener.dispose(),this.emitter.dispose()}}