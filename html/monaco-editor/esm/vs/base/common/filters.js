import{LRUCache}from"./map.js";import*as strings from"./strings.js";export function or(...e){return function(t,r){for(let n=0,o=e.length;n<o;n++){const o=e[n](t,r);if(o)return o}return null}}export const matchesStrictPrefix=_matchesPrefix.bind(void 0,!1);export const matchesPrefix=_matchesPrefix.bind(void 0,!0);function _matchesPrefix(e,t,r){if(!r||r.length<t.length)return null;let n;return n=e?strings.startsWithIgnoreCase(r,t):0===r.indexOf(t),n?t.length>0?[{start:0,end:t.length}]:[]:null}export function matchesContiguousSubString(e,t){const r=t.toLowerCase().indexOf(e.toLowerCase());return-1===r?null:[{start:r,end:r+e.length}]}export function matchesSubString(e,t){return _matchesSubString(e.toLowerCase(),t.toLowerCase(),0,0)}function _matchesSubString(e,t,r,n){if(r===e.length)return[];if(n===t.length)return null;if(e[r]===t[n]){let o=null;return(o=_matchesSubString(e,t,r+1,n+1))?join({start:n,end:n+1},o):null}return _matchesSubString(e,t,r,n+1)}function isLower(e){return 97<=e&&e<=122}export function isUpper(e){return 65<=e&&e<=90}function isNumber(e){return 48<=e&&e<=57}function isWhitespace(e){return 32===e||9===e||10===e||13===e}const wordSeparators=new Set;function isWordSeparator(e){return isWhitespace(e)||wordSeparators.has(e)}function charactersMatch(e,t){return e===t||isWordSeparator(e)&&isWordSeparator(t)}function isAlphanumeric(e){return isLower(e)||isUpper(e)||isNumber(e)}function join(e,t){return 0===t.length?t=[e]:e.end===t[0].start?t[0].start=e.start:t.unshift(e),t}function nextAnchor(e,t){for(let r=t;r<e.length;r++){const t=e.charCodeAt(r);if(isUpper(t)||isNumber(t)||r>0&&!isAlphanumeric(e.charCodeAt(r-1)))return r}return e.length}function _matchesCamelCase(e,t,r,n){if(r===e.length)return[];if(n===t.length)return null;if(e[r]!==t[n].toLowerCase())return null;{let o=null,s=n+1;o=_matchesCamelCase(e,t,r+1,n+1);while(!o&&(s=nextAnchor(t,s))<t.length)o=_matchesCamelCase(e,t,r+1,s),s++;return null===o?null:join({start:n,end:n+1},o)}}function analyzeCamelCaseWord(e){let t=0,r=0,n=0,o=0,s=0;for(let c=0;c<e.length;c++)s=e.charCodeAt(c),isUpper(s)&&t++,isLower(s)&&r++,isAlphanumeric(s)&&n++,isNumber(s)&&o++;const i=t/e.length,a=r/e.length,l=n/e.length,u=o/e.length;return{upperPercent:i,lowerPercent:a,alphaPercent:l,numericPercent:u}}function isUpperCaseWord(e){const{upperPercent:t,lowerPercent:r}=e;return 0===r&&t>.6}function isCamelCaseWord(e){const{upperPercent:t,lowerPercent:r,alphaPercent:n,numericPercent:o}=e;return r>.2&&t<.8&&n>.6&&o<.2}function isCamelCasePattern(e){let t=0,r=0,n=0,o=0;for(let s=0;s<e.length;s++)n=e.charCodeAt(s),isUpper(n)&&t++,isLower(n)&&r++,isWhitespace(n)&&o++;return 0!==t&&0!==r||0!==o?t<=5:e.length<=30}"()[]{}<>`'\"-/;:,.?!".split("").forEach((e=>wordSeparators.add(e.charCodeAt(0))));export function matchesCamelCase(e,t){if(!t)return null;if(t=t.trim(),0===t.length)return null;if(!isCamelCasePattern(e))return null;if(t.length>60)return null;const r=analyzeCamelCaseWord(t);if(!isCamelCaseWord(r)){if(!isUpperCaseWord(r))return null;t=t.toLowerCase()}let n=null,o=0;e=e.toLowerCase();while(o<t.length&&null===(n=_matchesCamelCase(e,t,0,o)))o=nextAnchor(t,o+1);return n}export function matchesWords(e,t,r=!1){if(!t||0===t.length)return null;let n=null,o=0;e=e.toLowerCase(),t=t.toLowerCase();while(o<t.length&&null===(n=_matchesWords(e,t,0,o,r)))o=nextWord(t,o+1);return n}function _matchesWords(e,t,r,n,o){if(r===e.length)return[];if(n===t.length)return null;if(charactersMatch(e.charCodeAt(r),t.charCodeAt(n))){let s=null,i=n+1;if(s=_matchesWords(e,t,r+1,n+1,o),!o)while(!s&&(i=nextWord(t,i))<t.length)s=_matchesWords(e,t,r+1,i,o),i++;return null===s?null:join({start:n,end:n+1},s)}return null}function nextWord(e,t){for(let r=t;r<e.length;r++)if(isWordSeparator(e.charCodeAt(r))||r>0&&isWordSeparator(e.charCodeAt(r-1)))return r;return e.length}const fuzzyContiguousFilter=or(matchesPrefix,matchesCamelCase,matchesContiguousSubString),fuzzySeparateFilter=or(matchesPrefix,matchesCamelCase,matchesSubString),fuzzyRegExpCache=new LRUCache(1e4);export function matchesFuzzy(e,t,r=!1){if("string"!==typeof e||"string"!==typeof t)return null;let n=fuzzyRegExpCache.get(e);n||(n=new RegExp(strings.convertSimple2RegExpPattern(e),"i"),fuzzyRegExpCache.set(e,n));const o=n.exec(t);return o?[{start:o.index,end:o.index+o[0].length}]:r?fuzzySeparateFilter(e,t):fuzzyContiguousFilter(e,t)}export function anyScore(e,t,r,n,o,s){const i=Math.min(13,e.length);for(;r<i;r++){const i=fuzzyScore(e,t,r,n,o,s,!1);if(i)return i}return[0,s]}export function createMatches(e){if("undefined"===typeof e)return[];const t=[],r=e[1];for(let n=e.length-1;n>1;n--){const o=e[n]+r,s=t[t.length-1];s&&s.end===o?s.end=o+1:t.push({start:o,end:o+1})}return t}const _maxLen=128;function initTable(){const e=[],t=[];for(let r=0;r<=_maxLen;r++)t[r]=0;for(let r=0;r<=_maxLen;r++)e.push(t.slice(0));return e}function initArr(e){const t=[];for(let r=0;r<=e;r++)t[r]=0;return t}const _minWordMatchPos=initArr(2*_maxLen),_maxWordMatchPos=initArr(2*_maxLen),_diag=initTable(),_table=initTable(),_arrows=initTable(),_debug=!1;function printTable(e,t,r,n,o){function s(e,t,r=" "){while(e.length<t)e=r+e;return e}let i=` |   |${n.split("").map((e=>s(e,3))).join("|")}\n`;for(let a=0;a<=r;a++)i+=0===a?" |":`${t[a-1]}|`,i+=e[a].slice(0,o+1).map((e=>s(e.toString(),3))).join("|")+"\n";return i}function printTables(e,t,r,n){e=e.substr(t),r=r.substr(n),console.log(printTable(_table,e,e.length,r,r.length)),console.log(printTable(_arrows,e,e.length,r,r.length)),console.log(printTable(_diag,e,e.length,r,r.length))}function isSeparatorAtPos(e,t){if(t<0||t>=e.length)return!1;const r=e.codePointAt(t);switch(r){case 95:case 45:case 46:case 32:case 47:case 92:case 39:case 34:case 58:case 36:case 60:case 40:case 91:return!0;case void 0:return!1;default:return!!strings.isEmojiImprecise(r)}}function isWhitespaceAtPos(e,t){if(t<0||t>=e.length)return!1;const r=e.charCodeAt(t);switch(r){case 32:case 9:return!0;default:return!1}}function isUpperCaseAtPos(e,t,r){return t[e]!==r[e]}export function isPatternInWord(e,t,r,n,o,s,i=!1){while(t<r&&o<s)e[t]===n[o]&&(i&&(_minWordMatchPos[t]=o),t+=1),o+=1;return t===r}export var FuzzyScore;(function(e){function t(e){return!e||2===e.length&&-100===e[0]&&0===e[1]}e.Default=[-100,0],e.isDefault=t})(FuzzyScore||(FuzzyScore={}));export function fuzzyScore(e,t,r,n,o,s,i){const a=e.length>_maxLen?_maxLen:e.length,l=n.length>_maxLen?_maxLen:n.length;if(r>=a||s>=l||a-r>l-s)return;if(!isPatternInWord(t,r,a,o,s,l,!0))return;_fillInMaxWordMatchPos(a,l,r,s,t,o);let u=1,c=1,h=r,f=s;const p=[!1];for(u=1,h=r;h<a;u++,h++){const i=_minWordMatchPos[h],g=_maxWordMatchPos[h],d=h+1<a?_maxWordMatchPos[h+1]:l;for(c=i-s+1,f=i;f<d;c++,f++){let a=Number.MIN_SAFE_INTEGER,d=!1;f<=g&&(a=_doScore(e,t,h,r,n,o,f,l,s,0===_diag[u-1][c-1],p));let m=0;a!==Number.MAX_SAFE_INTEGER&&(d=!0,m=a+_table[u-1][c-1]);const _=f>i,C=_?_table[u][c-1]+(_diag[u][c-1]>0?-5:0):0,x=f>i+1&&_diag[u][c-1]>0,S=x?_table[u][c-2]+(_diag[u][c-2]>0?-5:0):0;if(x&&(!_||S>=C)&&(!d||S>=m))_table[u][c]=S,_arrows[u][c]=3,_diag[u][c]=0;else if(_&&(!d||C>=m))_table[u][c]=C,_arrows[u][c]=2,_diag[u][c]=0;else{if(!d)throw new Error("not possible");_table[u][c]=m,_arrows[u][c]=1,_diag[u][c]=_diag[u-1][c-1]+1}}}if(_debug&&printTables(e,r,n,s),!p[0]&&!i)return;u--,c--;const g=[_table[u][c],s];let d=0,m=0;while(u>=1){let e=c;do{const t=_arrows[u][e];if(3===t)e-=2;else{if(2!==t)break;e-=1}}while(e>=1);d>1&&t[r+u-1]===o[s+c-1]&&!isUpperCaseAtPos(e+s-1,n,o)&&d+1>_diag[u][e]&&(e=c),e===c?d++:d=1,m||(m=e),u--,c=e-1,g.push(c)}l===a&&(g[0]+=2);const _=m-a;return g[0]-=_,g}function _fillInMaxWordMatchPos(e,t,r,n,o,s){let i=e-1,a=t-1;while(i>=r&&a>=n)o[i]===s[a]&&(_maxWordMatchPos[i]=a,i--),a--}function _doScore(e,t,r,n,o,s,i,a,l,u,c){if(t[r]!==s[i])return Number.MIN_SAFE_INTEGER;let h=1,f=!1;return i===r-n?h=e[r]===o[i]?7:5:!isUpperCaseAtPos(i,o,s)||0!==i&&isUpperCaseAtPos(i-1,o,s)?!isSeparatorAtPos(s,i)||0!==i&&isSeparatorAtPos(s,i-1)?(isSeparatorAtPos(s,i-1)||isWhitespaceAtPos(s,i-1))&&(h=5,f=!0):h=5:(h=e[r]===o[i]?7:5,f=!0),h>1&&r===n&&(c[0]=!0),f||(f=isUpperCaseAtPos(i,o,s)||isSeparatorAtPos(s,i-1)||isWhitespaceAtPos(s,i-1)),r===n?i>l&&(h-=f?3:5):h+=u?f?2:0:f?0:1,i+1===a&&(h-=f?3:5),h}export function fuzzyScoreGracefulAggressive(e,t,r,n,o,s,i){return fuzzyScoreWithPermutations(e,t,r,n,o,s,!0,i)}function fuzzyScoreWithPermutations(e,t,r,n,o,s,i,a){let l=fuzzyScore(e,t,r,n,o,s,a);if(l&&!i)return l;if(e.length>=3){const t=Math.min(7,e.length-1);for(let i=r+1;i<t;i++){const t=nextTypoPermutation(e,i);if(t){const e=fuzzyScore(t,t.toLowerCase(),r,n,o,s,a);e&&(e[0]-=3,(!l||e[0]>l[0])&&(l=e))}}}return l}function nextTypoPermutation(e,t){if(t+1>=e.length)return;const r=e[t],n=e[t+1];return r!==n?e.slice(0,t)+n+r+e.slice(t+2):void 0}